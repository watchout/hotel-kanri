#!/usr/bin/env node

/**
 * opsctl - OPS v1 è‡ªå‹•æ•´å‚™ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
 * 
 * ç›®çš„:
 * - ops/policy.yml ã«å¾“ã£ã¦ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’è‡ªå‹•ç”Ÿæˆ
 * - OPS:BEGIN ... OPS:END ãƒ–ãƒ­ãƒƒã‚¯ã‚’ç½®æ›
 * - çŸ›ç›¾ã‚’é˜²æ­¢
 * 
 * ä½¿ç”¨:
 * npm run ops:apply
 */

import fs from 'fs';
import path from 'path';
import yaml from 'yaml';
import { fileURLToPath } from 'url';
import { dirname } from 'path';

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

// ===========================================
// è¨­å®š
// ===========================================

const PROJECT_ROOT = path.resolve(__dirname, '../..');
const POLICY_FILE = path.join(PROJECT_ROOT, 'ops/policy.yml');
const CURSORRULES_FILE = path.join(PROJECT_ROOT, '.cursorrules');

// ===========================================
// ãƒãƒªã‚·ãƒ¼èª­ã¿è¾¼ã¿
// ===========================================

function loadPolicy() {
  console.log('ğŸ“– ops/policy.yml ã‚’èª­ã¿è¾¼ã¿ä¸­...\n');
  
  if (!fs.existsSync(POLICY_FILE)) {
    console.error('âŒ ã‚¨ãƒ©ãƒ¼: ops/policy.yml ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
    process.exit(1);
  }
  
  const content = fs.readFileSync(POLICY_FILE, 'utf8');
  const policy = yaml.parse(content);
  
  console.log(`âœ… ãƒãƒªã‚·ãƒ¼èª­ã¿è¾¼ã¿å®Œäº†`);
  console.log(`   é€²æ—ç®¡ç†ãƒ„ãƒ¼ãƒ«: ${policy.progress.tool}`);
  console.log(`   ã‚«ãƒãƒ‹ã‚«ãƒ«: ${policy.progress.canonical}`);
  console.log(`   é€±æ¬¡ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ: ${policy.progress.weekly_export.enabled}\n`);
  
  return policy;
}

// ===========================================
// ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç”Ÿæˆ
// ===========================================

function generateProgressBlock(policy) {
  const tool = policy.progress.tool;
  const toolName = tool.charAt(0).toUpperCase() + tool.slice(1);
  
  let block = `<!-- OPS:BEGIN progress (auto-generated) -->\n`;
  block += `## ğŸ“Š ã€é€²æ—é‹ç”¨ãƒ«ãƒ¼ãƒ«ã€‘å”¯ä¸€ã®çœŸå®Ÿï¼ˆcanonicalï¼‰\n\n`;
  block += `**åˆ¶å®šæ—¥**: 2025å¹´10æœˆ21æ—¥  \n`;
  block += `**ãƒãƒªã‚·ãƒ¼**: OPS-101 é€²æ—ç®¡ç†ãƒãƒªã‚·ãƒ¼  \n`;
  block += `**è¨­å®š**: ops/policy.yml  \n\n`;
  block += `### ğŸ¯ åŸºæœ¬åŸå‰‡\n\n`;
  block += `**${toolName} ãŒå”¯ä¸€ã®é€²æ—ç®¡ç†ãƒ„ãƒ¼ãƒ«**\n\n`;
  block += `âœ… **${toolName}ã§ã‚„ã‚‹ã“ã¨**:\n`;
  block += `- ã‚¿ã‚¹ã‚¯ã®ä½œæˆãƒ»æ›´æ–°\n`;
  block += `- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç®¡ç†ï¼ˆBacklog â†’ In Progress â†’ Doneï¼‰\n`;
  block += `- å·¥æ•°è¨˜éŒ²ï¼ˆè¦‹ç©ã‚‚ã‚Š + å®Ÿç¸¾ï¼‰\n`;
  block += `- ä¾å­˜é–¢ä¿‚ç®¡ç†ãƒ»ãƒ–ãƒ­ãƒƒã‚«ãƒ¼ç®¡ç†\n`;
  block += `- ãƒ©ãƒ™ãƒ«ç®¡ç†ï¼ˆSSOTä½œæˆ/å®Ÿè£…/ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¢ãƒƒãƒ—ï¼‰\n`;
  block += `- æ‹…å½“è€…ã‚¢ã‚µã‚¤ãƒ³ï¼ˆSun/Luna/Suno/Izaï¼‰\n\n`;
  
  if (tool === 'file') {
    block += `âŒ **ã‚„ã‚‰ãªã„ã“ã¨**:\n`;
    block += `- ä»–ã®ãƒ•ã‚¡ã‚¤ãƒ«ã§ã®é€²æ—ç®¡ç†\n`;
    block += `- ãƒ„ãƒ¼ãƒ«ï¼ˆPlane/Linearï¼‰ã¨ã®ä½µç”¨\n\n`;
    block += `ğŸ“Š **é€²æ—ãƒ•ã‚¡ã‚¤ãƒ«**: \`${policy.progress.file.path}\`\n\n`;
  } else {
    block += `âŒ **ã‚„ã‚‰ãªã„ã“ã¨**:\n`;
    block += `- SSOT_PROGRESS_MASTER.md ã®æ‰‹å‹•æ›´æ–°\n`;
    block += `- Markdownãƒ•ã‚¡ã‚¤ãƒ«ã§ã®é€²æ—ç®¡ç†\n`;
    block += `- ä»–ãƒ„ãƒ¼ãƒ«ã¨ã®ä½µç”¨\n\n`;
    
    if (policy.progress.weekly_export.enabled) {
      block += `### ğŸ“Š é€±æ¬¡ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼ˆå‚ç…§ç”¨ï¼‰\n\n`;
      block += `**ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå…ˆ**: \`${policy.progress.weekly_export.to_file}\`  \n`;
      block += `**ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«**: ${policy.progress.weekly_export.schedule}  \n`;
      block += `**ç”¨é€”**: å‚ç…§ã®ã¿ï¼ˆæ‰‹å‹•æ›´æ–°ç¦æ­¢ï¼‰\n\n`;
    }
  }
  
  block += `### ğŸ¯ ã‚¿ã‚¹ã‚¯é¸æŠãƒ«ãƒ¼ãƒ«ï¼ˆâ˜…â˜…â˜…AIå¿…èª­ï¼‰\n\n`;
  block += `**çµ¶å¯¾ãƒ«ãƒ¼ãƒ«**: ã‚¿ã‚¹ã‚¯ã‚’é–‹å§‹ã™ã‚‹å‰ã«ã€ä»¥ä¸‹ã®é †åºã§é¸æŠã™ã‚‹\n\n`;
  block += `\`\`\`markdown\n`;
  block += `ã€ã‚¿ã‚¹ã‚¯é¸æŠã®å„ªå…ˆé †ä½ã€‘\n\n`;
  block += `Priority 1ï¼ˆæœ€å„ªå…ˆï¼‰: \n`;
  block += `  1. Status = "Backlog" ã¾ãŸã¯ "Spec Ready"\n`;
  block += `  2. Priority = 1ï¼ˆæœ€é«˜å„ªå…ˆåº¦ï¼‰\n`;
  block += `  3. ä¾å­˜é–¢ä¿‚ = ãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ãªã„ï¼ˆBlocked byãªã—ï¼‰\n`;
  block += `  4. Assignee = è‡ªåˆ†ï¼ˆSun/Luna/Suno/Izaï¼‰\n`;
  block += `  \n`;
  block += `Priority 2ï¼ˆé«˜å„ªå…ˆï¼‰:\n`;
  block += `  1. Status = "Backlog" ã¾ãŸã¯ "Spec Ready"\n`;
  block += `  2. Priority = 2\n`;
  block += `  3. ä¾å­˜é–¢ä¿‚ = ãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ãªã„\n`;
  block += `  \n`;
  block += `Priority 3ï¼ˆé€šå¸¸ï¼‰:\n`;
  block += `  1. Status = "Backlog"\n`;
  block += `  2. Priority = 3\n`;
  block += `  3. ä¾å­˜é–¢ä¿‚ = ãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ãªã„\n\n`;
  block += `ã€ã‚¿ã‚¹ã‚¯é¸æŠã®ç¦æ­¢äº‹é …ã€‘\n\n`;
  block += `âŒ çµ¶å¯¾ç¦æ­¢:\n`;
  block += `- ä¾å­˜é–¢ä¿‚ã‚’ç„¡è¦–ã—ã¦ã‚¿ã‚¹ã‚¯ã‚’é–‹å§‹ã™ã‚‹\n`;
  block += `- ã€ŒBlocked byã€ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‚¿ã‚¹ã‚¯ã‚’é–‹å§‹ã™ã‚‹\n`;
  block += `- è‡ªåˆ†ï¼ˆAssigneeï¼‰ä»¥å¤–ã®ã‚¿ã‚¹ã‚¯ã‚’é–‹å§‹ã™ã‚‹\n`;
  block += `- Priorityã‚’ç„¡è¦–ã—ã¦ã‚¿ã‚¹ã‚¯ã‚’é¸æŠã™ã‚‹\n\n`;
  block += `âœ… æ­£ã—ã„å¯¾å¿œ:\n`;
  block += `1. ${toolName}ã§æ¬¡ã®ã‚¿ã‚¹ã‚¯ã‚’æ¤œç´¢\n`;
  block += `2. ä¾å­˜é–¢ä¿‚ã‚’ç¢ºèª\n`;
  block += `3. ãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ãªã„ã‚¿ã‚¹ã‚¯ã‚’é¸æŠ\n`;
  block += `4. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã€Œæ¬¡ã®ã‚¿ã‚¹ã‚¯: XXX-123ã€ã‚’å ±å‘Š\n`;
  block += `5. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ‰¿èªã‚’å¾—ã¦ã‹ã‚‰é–‹å§‹\n`;
  block += `\`\`\`\n\n`;
  block += `**è©³ç´°**: ops/OPS-101-Progress.md\n\n`;
  block += `<!-- OPS:END progress -->`;
  
  return block;
}

// ===========================================
// .cursorrules æ›´æ–°
// ===========================================

function updateCursorrules(policy) {
  console.log('ğŸ“ .cursorrules ã‚’æ›´æ–°ä¸­...\n');
  
  if (!fs.existsSync(CURSORRULES_FILE)) {
    console.error('âŒ ã‚¨ãƒ©ãƒ¼: .cursorrules ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
    process.exit(1);
  }
  
  let content = fs.readFileSync(CURSORRULES_FILE, 'utf8');
  
  // OPS:BEGIN progress ãƒ–ãƒ­ãƒƒã‚¯ã‚’ç½®æ›
  const progressBlock = generateProgressBlock(policy);
  const progressRegex = /<!-- OPS:BEGIN progress[\s\S]*?OPS:END progress -->/;
  
  if (progressRegex.test(content)) {
    // æ—¢å­˜ãƒ–ãƒ­ãƒƒã‚¯ã‚’ç½®æ›
    content = content.replace(progressRegex, progressBlock);
    console.log('âœ… OPS:BEGIN progress ãƒ–ãƒ­ãƒƒã‚¯ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
  } else {
    // ãƒ–ãƒ­ãƒƒã‚¯ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯è¿½åŠ 
    // Linearé‹ç”¨ãƒ«ãƒ¼ãƒ«ã®ç›´å¾Œã«æŒ¿å…¥
    const linearSectionRegex = /## ğŸ“Š \ã€Linearé‹ç”¨ãƒ«ãƒ¼ãƒ«\ã€‘é€²æ—ç®¡ç†ã®å”¯ä¸€ã®çœŸå®Ÿ[\s\S]*?(?=\n##\s|\n---\n|$)/;
    
    if (linearSectionRegex.test(content)) {
      content = content.replace(linearSectionRegex, (match) => {
        return `${progressBlock}\n\n${match}`;
      });
      console.log('âœ… OPS:BEGIN progress ãƒ–ãƒ­ãƒƒã‚¯ã‚’è¿½åŠ ã—ã¾ã—ãŸï¼ˆLinearé‹ç”¨ãƒ«ãƒ¼ãƒ«ã®å‰ï¼‰');
    } else {
      // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼šãƒ•ã‚¡ã‚¤ãƒ«æœ«å°¾ã«è¿½åŠ 
      content += `\n\n${progressBlock}\n`;
      console.log('âœ… OPS:BEGIN progress ãƒ–ãƒ­ãƒƒã‚¯ã‚’è¿½åŠ ã—ã¾ã—ãŸï¼ˆãƒ•ã‚¡ã‚¤ãƒ«æœ«å°¾ï¼‰');
    }
  }
  
  // ãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãè¾¼ã¿
  fs.writeFileSync(CURSORRULES_FILE, content, 'utf8');
  console.log('âœ… .cursorrules ã‚’ä¿å­˜ã—ã¾ã—ãŸ\n');
}

// ===========================================
// ãƒ¡ã‚¤ãƒ³å‡¦ç†
// ===========================================

function main() {
  console.log('ğŸš€ opsctl - OPS v1 è‡ªå‹•æ•´å‚™ã‚¹ã‚¯ãƒªãƒ—ãƒˆ\n');
  console.log('=' .repeat(50) + '\n');
  
  try {
    // ãƒãƒªã‚·ãƒ¼èª­ã¿è¾¼ã¿
    const policy = loadPolicy();
    
    // .cursorrules æ›´æ–°
    updateCursorrules(policy);
    
    console.log('=' .repeat(50));
    console.log('âœ… å®Œäº†ï¼\n');
    console.log('æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—:');
    console.log('1. git diff .cursorrules ã§å¤‰æ›´ã‚’ç¢ºèª');
    console.log('2. npm run ops:lint ã§çŸ›ç›¾ãƒã‚§ãƒƒã‚¯');
    console.log('3. git add / git commit / git push\n');
    
  } catch (error) {
    console.error('\nâŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:\n');
    console.error(error.message);
    console.error(error.stack);
    process.exit(1);
  }
}

main();

