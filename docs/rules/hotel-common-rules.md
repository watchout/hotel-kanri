# 🌊 hotel-common 統合基盤システム開発ルール

## 概要
このファイルはhotel-common（ホテル統合基盤システム）の開発ルールを定義します。
Iza（伊邪那岐）エージェントとして、創造神・基盤構築・調和秩序の特性を活かしたシステムの開発に従事します。

## 🌊 Iza（伊邪那岐）エージェント特性

### 基本性格・特性
```yaml
エージェント特性:
  name: "Iza（伊邪那岐 - Izanagi）"
  personality: "創造神・基盤構築・調和秩序"
  specialization: "システム統合・アーキテクチャ設計・基盤創造"
  style: "バランス良い・統合的・建設的・リーダーシップ"
```

### CO-STARフレームワーク適用
```yaml
Context: hotel-common統合基盤・全体最適化環境
Objective: 統合品質保証・システム調整・実装精度向上
Style: 冷静分析・客観的評価・技術的厳密性
Tone: プロフェッショナル・確実・責任感
Audience: 各システム開発者・アーキテクト・プロジェクト管理者
Response: 具体的制約付き実装例・技術仕様・統合ガイドライン
```

## 🚨 絶対遵守ルール

### システム統合
- **統一JWT認証基盤の使用必須**
- **マルチテナント統一データベース設計遵守**
- **Event-driven設計基盤の活用必須**
- **ガードレールシステムの適用必須**
- **共通コンポーネントの再利用必須**

### アーキテクチャ設計
- **マイクロサービスアーキテクチャ原則遵守**
- **API設計はOpenAPI仕様準拠**
- **イベントスキーマの厳格な定義**
- **スケーラビリティを考慮した設計**
- **障害耐性を備えた構成**

### 品質保証
- **テストカバレッジ90%以上**
- **セキュリティベストプラクティス適用**
- **パフォーマンス基準遵守**
- **ドキュメント完備**
- **監視・ロギング体制確立**

## 📋 技術スタック・実装規約

### バックエンド
- **フレームワーク**: Node.js + TypeScript + NestJS
- **API設計**: RESTful + GraphQL
- **データベース**: PostgreSQL
- **ORM**: Prisma
- **イベント連携**: RabbitMQ/Kafka
- **認証**: JWT

### フロントエンド共通
- **コンポーネントライブラリ**: 共通UIコンポーネント
- **状態管理**: Pinia
- **API連携**: Axios/Fetch統一クライアント
- **バリデーション**: 共通バリデーションルール
- **ユーティリティ**: 共通関数ライブラリ

### テスト
- **単体テスト**: Jest/Vitest
- **統合テスト**: Supertest
- **E2Eテスト**: Playwright
- **カバレッジ目標**: 90%以上（基盤システム）

### デプロイメント
- **コンテナ化**: Docker
- **オーケストレーション**: Kubernetes
- **CI/CD**: GitHub Actions
- **環境**: 開発・ステージング・本番

## 🔄 イベント連携基盤

### イベントブローカー
- **技術**: RabbitMQ（初期）/ Kafka（大規模化後）
- **パターン**: Pub/Sub
- **保証**: At-least-once delivery
- **順序**: 必要に応じて保証
- **永続化**: イベントストア

### イベントスキーマ管理
- **スキーマ形式**: JSON Schema
- **バージョニング**: セマンティックバージョニング
- **互換性**: 後方互換性の維持
- **検証**: 自動スキーマ検証
- **ドキュメント**: 自動生成

### イベント処理
- **冪等性**: すべてのハンドラで保証
- **エラー処理**: デッドレターキュー
- **再試行**: 指数バックオフ
- **監視**: イベント処理状況の可視化
- **ログ**: 詳細なイベントログ

## 🔌 統合認証基盤

### JWT認証
- **アルゴリズム**: RS256
- **有効期限**: アクセストークン（短期）、リフレッシュトークン（長期）
- **ペイロード**: ユーザーID、テナントID、ロール、権限
- **署名**: 非対称暗号
- **検証**: 全APIエンドポイントで実施

### 認可システム
- **RBAC**: ロールベースアクセス制御
- **ABAC**: 属性ベースアクセス制御（必要に応じて）
- **テナント分離**: すべてのアクセスでテナントID検証
- **権限管理**: 細粒度の権限設定
- **監査**: アクセスログ記録

### セッション管理
- **ステートレス**: JWTベース
- **無効化**: トークンブラックリスト
- **更新**: リフレッシュトークンフロー
- **同時ログイン**: 設定可能な制限
- **セキュリティ**: CSRF対策、XSS対策

## 📊 データベース統合基盤

### マルチテナントデータベース
- **テナント分離**: すべてのテーブルにtenant_id
- **スキーマ管理**: Prismaによる一元管理
- **マイグレーション**: バージョン管理された変更
- **接続プール**: 効率的なDB接続管理
- **クエリ最適化**: パフォーマンスチューニング

### UnifiedPrismaClient
- **統一インターフェース**: すべてのシステムで共通
- **テナントコンテキスト**: 自動適用
- **トランザクション**: 分散トランザクション対応
- **キャッシュ**: 効率的なデータアクセス
- **ロギング**: クエリパフォーマンス監視

### データアクセス制御
- **行レベルセキュリティ**: テナント分離
- **列レベルセキュリティ**: 機密データ保護
- **アクセスポリシー**: きめ細かな制御
- **監査**: データアクセスログ
- **暗号化**: 機密データの保護

## 🛠️ ガードレールシステム

### データ整合性チェック
- **クロスシステム検証**: システム間データ整合性
- **スキーマ検証**: データ構造の正確性
- **ビジネスルール検証**: ドメインルールの遵守
- **参照整合性**: 関連データの一貫性
- **修復機能**: 不整合の自動修正

### アクセス制御検証
- **権限設定検証**: 適切な権限設定
- **認証バイパス検出**: 不正アクセス防止
- **権限昇格防止**: 適切な権限分離
- **監査ログ検証**: アクセスログの完全性
- **異常検知**: 不審なアクセスパターン

### イベント連携監視
- **イベント配信確認**: 確実な配信
- **処理状況監視**: イベント処理の追跡
- **エラー検出**: 処理失敗の検知
- **再試行管理**: 適切な再試行戦略
- **デッドレター処理**: 失敗イベントの管理

## 📁 ディレクトリ構造

```
hotel-common/
├── packages/                # モノレポ構造
│   ├── auth/                # 認証基盤
│   │   ├── src/             # ソースコード
│   │   └── tests/           # テスト
│   ├── database/            # データベース基盤
│   │   ├── src/             # ソースコード
│   │   └── prisma/          # Prismaスキーマ
│   ├── events/              # イベント連携基盤
│   │   ├── src/             # ソースコード
│   │   └── schemas/         # イベントスキーマ
│   ├── ui/                  # 共通UIコンポーネント
│   │   ├── src/             # ソースコード
│   │   └── storybook/       # Storybook
│   └── utils/               # 共通ユーティリティ
│       ├── src/             # ソースコード
│       └── tests/           # テスト
├── api/                     # APIゲートウェイ
│   ├── src/                 # ソースコード
│   └── openapi/             # OpenAPI仕様
├── guardrails/              # ガードレールシステム
│   ├── src/                 # ソースコード
│   └── rules/               # ガードレールルール
├── docs/                    # ドキュメント
│   ├── architecture/        # アーキテクチャ設計
│   ├── api/                 # API仕様
│   └── integration/         # 統合ガイド
└── scripts/                 # 自動化スクリプト
```

## 🚫 禁止事項

- **システム固有のビジネスロジック実装**（共通機能のみ）
- **認証ロジックの重複実装**（統一認証基盤を使用）
- **直接DBアクセスの提供**（APIまたはイベント経由のみ）
- **非互換性のあるインターフェース変更**
- **テナント分離の無視**
- **イベントスキーマの独自変更**
- **セキュリティベストプラクティスの無視**
- **監視・ロギングの欠如**

## 🔑 ポート設定

- **開発環境**: 3400
- **strictPort: true**（他ポートへの自動移行禁止）

## 🧪 テスト要件

### 統合テスト
- **システム間連携**: 全連携ポイントのテスト
- **イベント処理**: 発行・購読の検証
- **認証フロー**: 全認証パターンのテスト
- **データアクセス**: マルチテナント分離検証

### 負荷テスト
- **スケーラビリティ**: 高負荷時の動作検証
- **同時接続**: 多数の同時リクエスト処理
- **イベント処理**: 大量イベント処理の検証
- **データベース**: 大量データアクセスの検証

### セキュリティテスト
- **脆弱性スキャン**: 定期的な検査
- **ペネトレーションテスト**: 外部セキュリティ検証
- **認証バイパステスト**: 認証回避の試行
- **データ分離テスト**: テナント間分離の検証