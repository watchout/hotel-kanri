# 本番同等開発ルール

**作成日**: 2025年8月15日  
**最終更新**: 2025年8月15日  
**ステータス**: 強制適用  
**適用範囲**: 全システム（hotel-saas, hotel-pms, hotel-member, hotel-common）  

## 1. 目的

このドキュメントは、モックデータや一時的な実装による開発の問題を解決し、すべての開発が本番環境と同等のクオリティで行われることを保証するためのルールを定義します。

## 2. 背景

現在、以下の問題が発生しています：

- 開発段階でのモック実装が本番実装に置き換えられていない
- APIへの接続がモックデータとの応答と混在している
- 「後で実装する」という前提での一時的な実装が残ったまま
- 開発が中途半端な状態で次の機能開発に移行している

## 3. 基本原則

### 3.1 本番同等の実装原則

すべての開発は、本番環境で動作することを前提として実装すること。「とりあえず動く」実装は認められません。

### 3.2 完了の定義

機能実装の「完了」とは、以下のすべての条件を満たすことを意味します：

1. 実際のAPIと接続し、モックではない
2. エラーハンドリングが完全に実装されている
3. パフォーマンスが最適化されている
4. テストが完了している（単体テスト、統合テスト）
5. コードレビューが完了している

## 4. 禁止事項

以下の開発手法は明示的に禁止します：

1. **モックデータの恒久的使用**: 開発初期段階でのみ許可され、PR前に実際のAPIに接続する実装に置き換えること
2. **TODO/FIXME コメント**: 実装せずにコメントだけ残すことは禁止
3. **「一時的な」実装**: すべての実装は本番品質であること
4. **未テストコード**: テストされていないコードのマージは禁止
5. **ハードコードされた値**: 設定ファイルやデータベースから取得すること

## 5. システム別ルール

### 5.1 hotel-saas（AIコンシェルジュシステム）

- **環境変数**: `OFFLINE_MODE_ENABLED=false` を標準とし、オフラインモードは例外的にのみ使用
- **API接続**: すべてのAPIエンドポイントは実際のサービスに接続すること
- **データ処理**: モックデータの使用は開発初期段階のみ、PRレビュー時には実データを使用すること

### 5.2 hotel-pms（フロント業務システム）

- **環境変数**: `OFFLINE_FIRST=false` を標準とし、オフラインファーストは例外的にのみ使用
- **同期処理**: `SYNC_INTERVAL` は実際のユースケースに基づいて設定し、テスト済みであること
- **API実装**: `dev-api-server.js` は開発用途のみとし、本番環境では実際のAPIを使用すること

### 5.3 hotel-member（会員管理システム）

- **データ保護**: `GDPR_COMPLIANCE=true` を常に維持し、すべてのデータ処理でコンプライアンスを確保
- **認証**: JWT実装は本番環境と同じセキュリティレベルで実装すること
- **API**: FastAPIとフロントエンドの連携は完全に実装し、部分的な実装は認めない

### 5.4 hotel-common（共通基盤システム）

- **データベース**: 統一スキーマを使用し、マイグレーションは完全にテストすること
- **メッセージング**: RabbitMQのイベント処理は完全に実装し、エラーハンドリングを含むこと
- **API**: 他システムが依存するAPIは完全に実装し、ドキュメント化すること

## 6. 開発ワークフロー

### 6.1 機能開発プロセス

1. **計画**: 完全な実装を前提とした計画を立てる
2. **実装**: モックが必要な場合は明示的にマークし、同じPR内で実際の実装に置き換える
3. **テスト**: 単体テスト、統合テストを実施
4. **レビュー**: コードレビューで本番品質を確認
5. **マージ**: すべての条件を満たした後にのみマージ可能

### 6.2 PRレビュー基準

PRは以下の条件をすべて満たす必要があります：

1. モックデータや一時的な実装が残っていないこと
2. すべてのTODO/FIXMEが解決されていること
3. テストカバレッジが基準を満たしていること（最低80%）
4. エラーハンドリングが完全に実装されていること
5. パフォーマンス要件を満たしていること

## 7. 環境変数の管理

### 7.1 開発環境での設定

```yaml
# 開発環境でも本番同等の設定を使用
- OFFLINE_MODE_ENABLED=false  # hotel-saas
- OFFLINE_FIRST=false         # hotel-pms
- MOCK_API=false              # 全システム共通
```

### 7.2 テスト環境での設定

テスト環境でも原則として本番同等の設定を使用し、モックの使用は自動テスト目的のみに制限します。

## 8. 例外プロセス

例外的にモックや一時的な実装が必要な場合は、以下のプロセスに従います：

1. チームリーダーの事前承認を得る
2. 期限付きで実装し、JIRA等でトラッキング
3. 例外の理由と解決計画をドキュメント化
4. 次のスプリントでの解決を必須とする

## 9. コンプライアンス確認

### 9.1 自動チェック

CI/CDパイプラインに以下のチェックを追加：

- モックデータ検出
- 未解決のTODO/FIXMEコメント検出
- テストカバレッジ確認
- 環境変数の検証

### 9.2 定期監査

月次でコードベースの監査を実施し、このルールへの準拠を確認します。

## 10. 施行と罰則

このルールに違反する実装は：

1. PRが承認されない
2. 既存のコードは修正タスクとして優先的に対応
3. 繰り返し違反する場合はチーム内での開発プロセス研修を実施

## 11. 参考資料

- [システム統合仕様書](../integration/unify-dev-spec.md)
- [開発フローのルール](development-flow-rules.md)
- [本番環境デプロイチェックリスト](../checklists/deployment-checklist.md)
