# 🚀 hotel-saas/hotel-common リビルド・ロードマップ

**最終更新**: 2025年11月4日  
**目的**: 既存実装のCRUDエラー多発問題を根本解決  
**方針**: 1から実装し直す（テンプレートベース）

---

## 📊 プロジェクト概要

### 現状の問題

```
既存実装:
- ほぼ全てのCRUD APIでエラー発生
- JWT/Session認証が混在
- $fetch直接使用とcallHotelCommonAPI使用が混在
- パターンが統一されていない
- 修正に時間がかかる（終わりが見えない）
```

### リビルドの目標

```
新規実装:
- 全てのCRUD APIが動作する
- Session認証に統一
- callHotelCommonAPI使用に統一
- テンプレートベースで実装パターンを完全統一
- エラー率5%未満
```

### 時間見積もり

| 項目 | 既存修正 | リビルド | 差分 |
|-----|---------|---------|------|
| 所要時間 | 68時間 | 24時間 | **-44時間** |
| エラー率 | 30% | 5% | -25% |
| コード品質 | 低 | 高 | ++ |

**結論**: リビルドの方が44時間早い

---

## 🎯 Phase 1: 準備（2.5時間）

### 1-0. 新規DB作成（30分） ★追加

- [ ] **hotel_unified_db_rebuild 作成**
- [ ] Prismaマイグレーション実行
- [ ] テストテナント作成
- [ ] 動作確認

**重要**: 既存DBと完全分離（詳細は DATABASE_SETUP.md 参照）

### 1-1. 環境構築（30分）

- [x] hotel-saas-rebuild ディレクトリ作成
- [x] hotel-common-rebuild ディレクトリ作成
- [ ] ポート番号設定（3101, 3401）
- [ ] 新規DB接続設定（DATABASE_URL）
- [x] 依存関係インストール

### 1-2. テンプレート作成（1時間）

- [ ] hotel-common CRUD テンプレート作成
- [ ] hotel-saas プロキシ CRUD テンプレート作成
- [ ] 1機能で動作確認（客室グレード）

### 1-3. 自動テストスクリプト作成（30分）

- [ ] crud-verify.sh 作成
- [ ] 客室グレードで動作確認

**成果物**:
- 新規DB（hotel_unified_db_rebuild）
- テンプレート2種類（完全動作確認済み）
- 自動テストスクリプト

---

## 🏗️ Phase 2: 優先度別実装（20時間）

### 2-1. 最優先機能（5時間）

| 機能 | 所要時間 | 担当AI |
|-----|---------|--------|
| 認証・セッション管理 | 1時間 | 実装AI |
| テナント管理 | 1時間 | 実装AI |
| スタッフ管理 | 1時間 | 実装AI |
| 権限管理 | 1時間 | 実装AI |
| プロフィール管理 | 1時間 | 実装AI |

**完了条件**: ログイン〜管理画面アクセスまで動作

### 2-2. 高優先機能（8時間）

| 機能 | 所要時間 | 担当AI |
|-----|---------|--------|
| 客室グレード管理 | 20分 | 実装AI |
| 客室管理 | 30分 | 実装AI |
| 予約管理 | 2時間 | 実装AI |
| 顧客管理 | 2時間 | 実装AI |
| 料金・プラン管理 | 2時間 | 実装AI |
| 宿泊プラン管理 | 1時間 | 実装AI |

**完了条件**: 予約〜チェックインまで動作

### 2-3. 中優先機能（4時間）

| 機能 | 所要時間 | 担当AI |
|-----|---------|--------|
| キャンペーン管理 | 1時間 | 実装AI |
| 施設・設備管理 | 1時間 | 実装AI |
| アメニティ管理 | 30分 | 実装AI |
| ページ管理 | 1時間 | 実装AI |
| その他 | 30分 | 実装AI |

**完了条件**: 全管理画面が動作

### 2-4. 低優先機能（3時間）

| 機能 | 所要時間 | 担当AI |
|-----|---------|--------|
| ログ管理 | 1時間 | 実装AI |
| ダッシュボード | 1時間 | 実装AI |
| その他補助機能 | 1時間 | 実装AI |

**完了条件**: 全機能が動作

---

## ✅ Phase 3: 統合テスト（2時間）

### 3-1. CRUD統合テスト（1時間）

- [ ] 全機能のCRUD動作確認
- [ ] ./crud-verify-all.sh 実行
- [ ] エラー率5%未満確認

### 3-2. シナリオテスト（1時間）

- [ ] ログイン → テナント作成 → スタッフ作成
- [ ] 客室グレード作成 → 客室作成
- [ ] 顧客登録 → 予約作成 → チェックイン
- [ ] 全シナリオが動作

**完了条件**: エラーゼロ

---

## 🔄 Phase 4: 既存環境への統合（3時間）

### 4-1. バックアップ（30分）

- [ ] hotel-saas の main ブランチをバックアップ
- [ ] hotel-common の main ブランチをバックアップ
- [ ] データベースのバックアップ

### 4-2. コード統合（1時間）

- [ ] hotel-saas-rebuild → hotel-saas へコピー
- [ ] hotel-common-rebuild → hotel-common へコピー
- [ ] コミット・プッシュ

### 4-3. 最終動作確認（1時間）

- [ ] 既存環境（localhost:3100/3400）で動作確認
- [ ] 全機能テスト
- [ ] エラーゼロ確認

### 4-4. クリーンアップ（30分）

- [ ] hotel-saas-rebuild 削除
- [ ] hotel-common-rebuild 削除

**完了条件**: 既存環境で全機能が動作

---

## 📊 進捗管理

### タイムトラッキング

```bash
# 開始時刻記録
echo "Phase X 開始: $(date)" >> /tmp/rebuild-progress.txt

# 終了時刻記録
echo "Phase X 終了: $(date)" >> /tmp/rebuild-progress.txt
```

### チェックリスト

`/Users/kaneko/hotel-kanri/docs/rebuild/CHECKLIST.md` で管理

---

## 🎯 成功の定義

1. **全てのCRUD APIが動作する**
   - Create/Read/Update/Delete 全て動作
   - エラー率5%未満

2. **実装パターンが統一されている**
   - 全てテンプレートベース
   - Session認証統一
   - callHotelCommonAPI統一

3. **既存環境で動作する**
   - localhost:3100/3400 で動作
   - 既存データベース使用
   - エラーゼロ

4. **時間内に完了する**
   - 目標: 24時間
   - 許容: 30時間

---

## 🚨 リスクと対策

### リスク1: テンプレートが動かない

**対策**: Phase 1で1機能完全動作確認

### リスク2: データベース互換性

**対策**: 既存のPrismaスキーマをそのまま使用

### リスク3: 時間オーバー

**対策**: 優先度低い機能は後回し

### リスク4: AIの混乱

**対策**: 完全別ディレクトリ（hotel-saas-rebuild）

---

## 📅 スケジュール例

### Day 1（8時間）

```
09:00-11:00  Phase 1: 準備・テンプレート作成
11:00-12:00  Phase 2-1: 認証・テナント管理
---
12:00-13:00  昼休憩
---
13:00-16:00  Phase 2-1: スタッフ・権限・プロフィール
16:00-17:00  統合テスト
17:00-18:00  予備時間
```

**Day 1 成果**: 最優先機能完了

### Day 2（8時間）

```
09:00-12:00  Phase 2-2: 客室・予約管理
---
12:00-13:00  昼休憩
---
13:00-17:00  Phase 2-2: 顧客・料金・プラン管理
17:00-18:00  統合テスト
```

**Day 2 成果**: 高優先機能完了

### Day 3（8時間）

```
09:00-12:00  Phase 2-3/2-4: 中低優先機能
---
12:00-13:00  昼休憩
---
13:00-15:00  Phase 3: 統合テスト
15:00-18:00  Phase 4: 既存環境への統合
```

**Day 3 成果**: 全機能完了・統合完了

---

## 🎓 教訓・改善点

### 今回学んだこと

1. **既存修正より新規実装の方が早い**（44時間差）
2. **テンプレート化で品質・速度向上**
3. **完全別環境で混乱リスクゼロ**

### 今後の開発方針

1. **SSOT作成時にテンプレート指定**
2. **実装プロンプトにテンプレート使用必須化**
3. **Phase 6: CRUD完全動作確認を徹底**

---

## 📞 問い合わせ

問題・質問がある場合:
- Luna（設計・管理AI）に相談
- `/Users/kaneko/hotel-kanri/docs/rebuild/` を参照

