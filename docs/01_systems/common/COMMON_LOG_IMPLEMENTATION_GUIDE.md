=== hotel-common 統合ログシステム実装ガイド ===

【必読ドキュメント】
★★★ /Users/kaneko/hotel-kanri/docs/01_systems/common/UNIFIED_LOG_SYSTEM_DESIGN.md
★★☆ /Users/kaneko/hotel-kanri/docs/architecture/UNIFIED_LOGGING_STANDARDS.md
★☆☆ /Users/kaneko/hotel-kanri/docs/01_systems/saas/CURRENT_LOG_STATUS_MATRIX.md

【実装順序】
Phase 1: データベーステーブル作成（1-2日）
Phase 2: ログ記録API実装（3-4日）
Phase 3: ログ検索・分析API実装（5-7日）
Phase 4: 監視・アラート機能実装（8-10日）
Phase 5: 既存システムとの統合テスト（11-14日）

【重要な実装方針】
✅ 必須事項
- 全ログ記録は非同期処理（Redis Queue使用）
- テナント分離を必ず実装（Row Level Security）
- API認証は必須（システム間JWT認証）
- ログ検索は管理者権限必須
- 機密情報（パスワード等）は絶対に記録しない

❌ 禁止事項
- 同期的なログ記録（パフォーマンス劣化）
- テナントIDなしでのログ記録
- 平文での機密情報保存
- 認証なしでのAPI提供
- 単一障害点の作成

【Phase 1: データベーステーブル作成】

□ PostgreSQLに以下4つのテーブルを作成
  □ auth_logs（認証ログ）
  □ security_logs（セキュリティログ）
  □ system_batch_logs（システム処理ログ）
  □ integration_logs（システム間連携ログ）

□ 各テーブルにインデックスを作成
  □ 時系列検索用インデックス（created_at）
  □ システム別検索用インデックス（system）
  □ テナント別検索用インデックス（tenant_id）
  □ ユーザー別検索用インデックス（user_id）

□ Row Level Security (RLS) を設定
  □ テナント分離ポリシー作成
  □ システム管理者用ポリシー作成
  □ 読み取り専用ポリシー作成

□ パーティショニング設定（月別）
  □ auth_logs の月別パーティション
  □ security_logs の月別パーティション
  □ 自動パーティション作成スクリプト

【Phase 2: ログ記録API実装】

□ Redis Queue システム構築
  □ ログ記録専用キュー作成
  □ ワーカープロセス実装
  □ 失敗時のリトライ機能

□ ログ記録API実装
  □ POST /api/v1/logs/auth
  □ POST /api/v1/logs/security
  □ POST /api/v1/logs/batch
  □ POST /api/v1/logs/integration

□ バリデーション機能
  □ 必須フィールドチェック
  □ データ型チェック
  □ 文字数制限チェック
  □ 不正データの検出・拒否

□ エラーハンドリング
  □ API呼び出し失敗時の処理
  □ キュー満杯時の処理
  □ DB接続失敗時の処理
  □ 障害通知機能

【Phase 3: ログ検索・分析API実装】

□ ログ検索API実装
  □ GET /api/v1/logs/search
  □ 複数条件での検索機能
  □ ページネーション機能
  □ ソート機能

□ ログ統計API実装
  □ GET /api/v1/logs/stats
  □ 時系列統計機能
  □ システム別統計機能
  □ 重要度別統計機能

□ 権限チェック機能
  □ 管理者権限の確認
  □ テナント権限の確認
  □ システム権限の確認
  □ アクセスログの記録

□ パフォーマンス最適化
  □ クエリ最適化
  □ インデックス活用
  □ キャッシュ機能
  □ レスポンス圧縮

【Phase 4: 監視・アラート機能実装】

□ リアルタイム監視機能
  □ セキュリティログ監視
  □ 認証失敗監視
  □ システム間連携監視
  □ 異常検知アルゴリズム

□ アラート機能
  □ 重要度HIGH以上の即座通知
  □ 認証失敗率異常の通知
  □ システム障害の通知
  □ 通知チャンネル設定（Slack/Email）

□ ダッシュボード機能
  □ リアルタイムログ表示
  □ システム別統計表示
  □ アラート一覧表示
  □ 検索・フィルタ機能

□ レポート機能
  □ 日次セキュリティレポート
  □ 週次システム稼働レポート
  □ 月次統計レポート
  □ カスタムレポート機能

【Phase 5: 既存システムとの統合テスト】

□ hotel-saas との統合テスト
  □ 認証ログ記録テスト
  □ セキュリティログ記録テスト
  □ API呼び出しテスト
  □ パフォーマンステスト

□ hotel-pms との統合テスト
  □ システム間連携ログテスト
  □ バッチ処理ログテスト
  □ 障害時の動作テスト
  □ データ整合性テスト

□ hotel-member との統合テスト
  □ 認証統合テスト
  □ ログ記録テスト
  □ 権限チェックテスト
  □ セキュリティテスト

□ 負荷テスト
  □ 大量ログ記録テスト
  □ 同時アクセステスト
  □ 長時間稼働テスト
  □ 障害復旧テスト

【実装チェックリスト】

□ データベース設計
  □ テーブル作成完了
  □ インデックス作成完了
  □ RLS設定完了
  □ パーティショニング設定完了

□ API実装
  □ ログ記録API実装完了
  □ ログ検索API実装完了
  □ 認証機能実装完了
  □ エラーハンドリング実装完了

□ 非同期処理
  □ Redis Queue設定完了
  □ ワーカープロセス実装完了
  □ 失敗時リトライ機能完了
  □ 監視機能実装完了

□ セキュリティ
  □ API認証実装完了
  □ テナント分離実装完了
  □ 機密情報保護実装完了
  □ アクセス制御実装完了

□ 監視・アラート
  □ リアルタイム監視実装完了
  □ アラート機能実装完了
  □ ダッシュボード実装完了
  □ レポート機能実装完了

□ テスト
  □ 単体テスト完了
  □ 統合テスト完了
  □ 負荷テスト完了
  □ セキュリティテスト完了

【デプロイメント手順】

1. データベース変更適用
   - テーブル作成スクリプト実行
   - インデックス作成スクリプト実行
   - RLS設定スクリプト実行

2. Redis設定
   - ログ記録用キュー設定
   - ワーカープロセス設定
   - 監視設定

3. アプリケーションデプロイ
   - API実装デプロイ
   - ワーカープロセスデプロイ
   - 監視機能デプロイ

4. 設定ファイル更新
   - データベース接続設定
   - Redis接続設定
   - アラート通知設定

5. 動作確認
   - API動作確認
   - ログ記録確認
   - アラート動作確認

【技術的詳細】

★★★ 完全実装詳細: /Users/kaneko/hotel-kanri/docs/01_systems/common/TECHNICAL_IMPLEMENTATION_DETAILS.md

API認証方式: JWT Bearer Token（既存統一認証使用）
データベース: PostgreSQL 14+（既存統合DB使用）
キューシステム: Redis 6+（既存統合Redis使用）
監視: Prometheus + Grafana
アラート: Slack Webhook + SMTP

環境変数:
- LOG_DB_HOST: ログ用データベースホスト
- LOG_DB_NAME: ログ用データベース名
- REDIS_LOG_QUEUE_URL: Redis接続URL
- SLACK_WEBHOOK_URL: Slackアラート用URL
- LOG_RETENTION_DAYS: ログ保持期間（日数）

【重複実装禁止事項】
❌ JWT認証システムの新規実装
❌ 独自データベース接続管理
❌ 独自Redis接続管理
❌ モック・フォールバック実装
❌ 独自エラーハンドリング基盤

【注意事項】

1. パフォーマンス影響を最小化するため、必ず非同期処理を使用
2. テナント分離は必須、漏れがあると重大なセキュリティ問題
3. 機密情報は絶対にログに記録しない
4. 大量ログ処理に備えて十分なディスク容量を確保
5. 定期的なログ削除処理を実装して容量管理を行う

【完了報告】

実装完了後、以下を報告してください：
- 各Phaseの完了日時
- テスト結果サマリー
- パフォーマンス測定結果
- 発見された問題と対応状況
- 運用開始予定日
