# データベース管理体制の改善

**作成日**: 2025年8月18日  
**作成者**: システム管理チーム  
**対象**: 全開発チーム

## 概要

本文書は、最近発見されたデータベーススキーマとマイグレーションの問題を受けて、データベース管理体制の改善策をまとめたものです。これらの改善策は、今後同様の問題が発生するのを防ぎ、より堅牢なデータベース管理プロセスを確立することを目的としています。

## 1. 発見された問題

### 1.1 スキーマとデータベースの不一致

- Prismaスキーマ（`schema.prisma`）と実際のデータベース構造に不一致が存在
- 特に`Staff`テーブルと`service_usage_statistics`テーブルに顕著な不一致
- この不一致により、マイグレーションの適用が失敗し、開発が妨げられていた

### 1.2 マイグレーションの問題

- 同じ日に同名のマイグレーションが複数存在（`add_tenant_service_management`）
- あるマイグレーションでテーブルを削除し、別のマイグレーションで再作成するパターン
- シャドウデータベースとの不整合によるマイグレーションエラー

### 1.3 命名規則の不統一

- スキーマではPascalCase（`Staff`）、データベースではsnake_case（`staff`）が混在
- モデル名とテーブル名のマッピングが不明確

## 2. 実施した対策

### 2.1 短期的対策

- マイグレーションの問題を特定・分析するスクリプトを作成
- 競合するマイグレーションを統合するスクリプトを開発
- スキーマとデータベースを同期させるための計画を策定
- データベース安全規則を文書化

### 2.2 長期的対策

- CI/CDパイプラインでのスキーマ検証を導入
- マイグレーションガイドラインを作成
- スキーマとデータベースの同期化計画を策定
- 定期的なスキーマ検証プロセスを確立

## 3. 新しいデータベース管理ルール

### 3.1 スキーマ変更のプロセス

1. スキーマ変更の提案（プルリクエスト）
2. 変更内容のレビュー
3. マイグレーションの生成と検証
4. テスト環境での適用
5. 本番環境への適用

### 3.2 マイグレーション作成のガイドライン

- 命名規則: `[日付]_[時間]_[簡潔な説明]`
- 1つのマイグレーションで1つの論理的な変更を行う
- テーブルの削除と再作成は避け、可能な限り`ALTER TABLE`を使用
- すべてのマイグレーションにはコメントでその目的を説明

### 3.3 禁止事項

- 直接のSQL実行（`psql`などのツールを使用）
- マイグレーションファイルの手動編集（特別な場合を除く）
- Prismaを経由しないデータベース構造の変更
- 同じ日に同名のマイグレーションを作成

## 4. 開発者向けツール

以下のツールを開発し、開発者が利用できるようにしました：

### 4.1 分析ツール

- `scripts/analyze-migrations.js`: マイグレーションの問題を分析
- `scripts/check-db-schema-consistency.js`: スキーマとデータベースの一致を確認

### 4.2 修正ツール

- `scripts/fix-shadow-database.js`: シャドウデータベースの問題を解決
- `scripts/merge-conflicting-migrations.js`: 競合するマイグレーションを統合
- `scripts/sync-schema-database.js`: スキーマとデータベースを同期

### 4.3 CI/CDツール

- `scripts/ci-schema-validation.js`: CI/CDパイプラインでのスキーマ検証
- `.github/workflows/schema-validation.yml`: GitHub Actionsワークフロー

## 5. 今後の展望

### 5.1 定期的な監査

- 四半期ごとにデータベーススキーマの監査を実施
- マイグレーション履歴の整合性チェック
- 不要なインデックスやテーブルの特定

### 5.2 自動化の強化

- スキーマ変更の影響分析ツールの開発
- マイグレーションのパフォーマンス予測ツールの導入
- データベース構造の可視化ツールの導入

### 5.3 知識の共有

- データベース設計とマイグレーションに関するワークショップの開催
- ベストプラクティスの文書化と共有
- 定期的なデータベース関連の技術勉強会の実施

## 6. 結論

今回の取り組みにより、データベース管理体制が大幅に改善されました。新しいルールとツールを活用することで、今後同様の問題が発生するリスクを最小限に抑え、より効率的かつ安全なデータベース管理が可能になります。

すべての開発者がこれらのルールとガイドラインを理解し、遵守することが重要です。質問や懸念がある場合は、システム管理チームにお問い合わせください。

## 付録

- [データベース安全規則](./DATABASE_SAFETY_RULES.md)
- [マイグレーションガイドライン](./database-migration-guidelines.md)
- [スキーマとデータベース同期化計画](./schema-database-synchronization-plan.md)
- [マイグレーション問題分析](./migration-issue-analysis.md)
