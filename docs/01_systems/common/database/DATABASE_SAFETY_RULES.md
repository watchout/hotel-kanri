# データベース安全性ルール

**作成日**: 2025年8月15日  
**バージョン**: 1.0  
**対象**: 全開発者・運用担当者

## 1. 基本方針

当プロジェクトでは、データベースの整合性と安全性を確保するため、以下の基本方針を定めます：

1. **Prismaを唯一のデータベースアクセス手段とする**
2. **直接的なSQL操作は原則として禁止**
3. **スキーマ変更はマイグレーションを通じてのみ実施**

## 2. 禁止事項

### 2.1 直接SQLの実行禁止

以下の操作は明示的に禁止します：

- `psql`、`pgAdmin`などのツールを使った直接のSQL実行
- データベースへの直接接続によるテーブル構造の変更
- マイグレーションファイル以外での`ALTER TABLE`、`CREATE TABLE`などのDDL操作
- Prismaを経由しない`INSERT`、`UPDATE`、`DELETE`などのDML操作

### 2.2 例外ケース

以下の場合のみ、事前承認を得た上で例外的に直接SQLの実行を許可します：

- 緊急障害対応時のデータ修復
- パフォーマンス分析のための読み取り専用クエリ
- 複雑な集計レポート生成

例外的にSQLを実行する場合も、必ず以下のプロセスに従ってください：
1. チームリーダーの承認を得る
2. 実行内容を文書化する
3. 実行後にスキーマの同期状態を確認する

## 3. 正しいデータベース変更手順

### 3.1 スキーマ変更手順

1. Prismaスキーマファイル（`schema.prisma`）を編集
2. マイグレーションを生成
   ```
   npx prisma migrate dev --name 変更内容を表す名前
   ```
3. 生成されたマイグレーションファイルをレビュー
4. 承認後、マイグレーションを適用

### 3.2 既存データベースとの同期手順

データベースとスキーマの間に不一致がある場合：

1. 現在のデータベース構造を取得
   ```
   npx prisma db pull
   ```
2. 生成されたスキーマを確認・編集
3. 最終的なスキーマを確定
4. 新しいマイグレーションを作成
   ```
   npx prisma migrate dev --name sync_schema
   ```

### 3.3 環境間の移行

1. 開発環境でマイグレーションをテスト
2. ステージング環境で検証
3. 本番環境へのデプロイ前に最終確認
4. 本番環境へのマイグレーション適用
   ```
   npx prisma migrate deploy
   ```

## 4. スキーマ設計ガイドライン

### 4.1 命名規則

- モデル名: パスカルケース (`UserProfile`)
- フィールド名: キャメルケース (`createdAt`)
- データベースマッピング: スネークケース (`@map("created_at")`)

### 4.2 必須フィールド

全テーブルに以下のフィールドを含めることを推奨：

- `id`: 主キー
- `created_at`: 作成日時
- `updated_at`: 更新日時

### 4.3 インデックス

- 頻繁に検索されるフィールドにはインデックスを設定
- 複合インデックスは慎重に設計
- インデックスの過剰設定に注意

## 5. トラブルシューティング

### 5.1 スキーマとDBの不一致

不一致を検出した場合：

1. `npx prisma db pull` で現状を確認
2. スキーマファイルを更新
3. 必要に応じてマイグレーションを作成

### 5.2 マイグレーションの失敗

マイグレーションが失敗した場合：

1. エラーログを確認
2. 必要に応じてロールバック
3. マイグレーションファイルを修正
4. 再度マイグレーションを実行

## 6. 定期的な確認

以下の確認を定期的に実施してください：

1. スキーマとデータベースの同期状態確認
2. インデックスのパフォーマンス分析
3. データ整合性チェック

## 7. 責任者

データベース構造の変更に関する最終承認者：

- 開発環境: チームリーダー
- ステージング環境: プロジェクトマネージャー
- 本番環境: システム管理者およびプロジェクトマネージャー

## 8. 違反時の対応

このルールに違反した場合：

1. 即座にチームリーダーに報告
2. 影響範囲の特定
3. 修復計画の策定と実行
4. 再発防止策の検討

---

このガイドラインは、プロジェクトの安全性とデータ整合性を確保するために作成されました。
全ての開発者・運用担当者はこのルールを理解し、遵守する責任があります。