# データベーススキーマ管理ルール

## 1. 概要

このドキュメントは、`hotel-common`、`hotel-saas`、`hotel-pms`、`hotel-member`の各プロジェクトにおけるデータベーススキーマの管理ルールを定義します。これらのルールに従うことで、スキーマの変更によるデータ損失やシステム障害を防ぎ、安全かつ効率的な開発を実現します。

## 2. スキーマ変更の基本原則

### 2.1 マイグレーションベースの変更管理

* **原則**: すべてのスキーマ変更は、Prismaマイグレーションを通じて行う
* **禁止事項**: `prisma db push --force-reset`の本番環境での使用
* **推奨コマンド**: `prisma migrate dev --name <変更の説明>`

### 2.2 変更の分類と対応

| 変更タイプ | リスクレベル | 必要な承認 | 実施方法 |
|------------|--------------|------------|----------|
| テーブル追加 | 低 | 技術リード | マイグレーション |
| 非NULL列追加（デフォルト値あり） | 低 | 技術リード | マイグレーション |
| NULL許容列追加 | 低 | 技術リード | マイグレーション |
| 列名変更 | 中 | 技術リード + DB管理者 | マイグレーション + データ移行 |
| 列タイプ変更 | 中〜高 | 技術リード + DB管理者 | マイグレーション + データ変換 |
| 非NULL制約追加 | 高 | 技術リード + DB管理者 + プロジェクト管理者 | データ検証 + マイグレーション |
| 列削除 | 高 | 技術リード + DB管理者 + プロジェクト管理者 | 段階的アプローチ |
| テーブル削除 | 最高 | 全ステークホルダー | バックアップ + 段階的アプローチ |

## 3. 環境別運用ルール

### 3.1 開発環境

* **スキーマ変更方法**: `prisma migrate dev`
* **データリセット**: 開発者の判断で可能
* **注意点**: 共有開発環境では事前に他の開発者に通知

### 3.2 テスト環境

* **スキーマ変更方法**: `prisma migrate dev`（開発完了後）または`prisma migrate deploy`（CI/CD）
* **データリセット**: 専用スクリプトを使用し、テストデータを再生成
* **注意点**: テスト実行中の変更は避ける

### 3.3 ステージング環境

* **スキーマ変更方法**: `prisma migrate deploy`
* **データリセット**: 原則禁止、必要な場合は本番に近いデータセットで再構築
* **注意点**: 本番環境と同じ手順でマイグレーションを検証

### 3.4 本番環境

* **スキーマ変更方法**: `prisma migrate deploy`（メンテナンス時間内）
* **データリセット**: 厳格に禁止
* **注意点**: 必ずバックアップを取得し、ロールバック計画を準備

## 4. マイグレーション作成のベストプラクティス

### 4.1 マイグレーションファイルの命名規則

```
YYYYMMDD<連番>_<変更内容を簡潔に>.sql
```

例: `20250801001_add_user_preferences_column.sql`

### 4.2 マイグレーションの粒度

* 1つの機能や関連する変更ごとにマイグレーションを作成
* 複雑な変更は複数のマイグレーションに分割

### 4.3 ロールバックの考慮

* 各マイグレーションにはロールバック手順を含める
* `down`関数や`rollback_sql`フィールドを活用

## 5. スキーマ変更ワークフロー

1. **提案**: スキーマ変更の必要性と内容を文書化
2. **影響分析**: 変更の影響範囲を特定
3. **計画**: マイグレーション計画を作成
4. **レビュー**: 技術レビューを実施
5. **テスト**: 開発環境でテスト
6. **検証**: ステージング環境で検証
7. **適用**: 本番環境に適用
8. **監視**: 適用後の動作を監視

## 6. スキーマ同期のルール

### 6.1 `db pull`の使用制限

* **原則**: `prisma db pull`は既存のスキーマファイルを上書きするため、使用を制限
* **許可される場合**:
  - 新規プロジェクト立ち上げ時の初期インポート
  - 参照用の一時的なスキーマ生成（元のスキーマファイルを上書きしない）
* **禁止される場合**:
  - 既存のスキーマファイルの更新
  - マイグレーション履歴がある状態での使用

### 6.2 `db push`の使用制限

* **原則**: `prisma db push`は開発初期段階のみ使用
* **許可される場合**:
  - プロトタイピング
  - 開発の初期段階（マイグレーション履歴がない状態）
* **禁止される場合**:
  - マイグレーション履歴がある状態での使用
  - `--force-reset`オプションの本番/ステージング環境での使用

### 6.3 `prisma generate`の実行タイミング

* スキーマ変更後
* `git pull`でスキーマ変更を取得した後
* CI/CDパイプラインのビルドステップ

## 7. バックアップと復旧

### 7.1 バックアップの種類と頻度

| 環境 | バックアップ種類 | 頻度 | 保持期間 |
|------|------------------|------|----------|
| 開発 | スナップショット | 週次 | 1週間 |
| テスト | スナップショット | 日次 | 1週間 |
| ステージング | フル + 増分 | 日次 + 6時間ごと | 2週間 |
| 本番 | フル + 増分 + WAL | 日次 + 1時間ごと + リアルタイム | 1ヶ月 |

### 7.2 復旧手順

1. 最新のフルバックアップを復元
2. 必要に応じて増分バックアップを適用
3. WALを使用してポイントインタイムリカバリを実行
4. データ整合性チェックを実施
5. アプリケーションの動作確認

## 8. スキーマドキュメント化

### 8.1 必須ドキュメント

* ER図（システム全体および主要モジュール）
* テーブル定義書
* インデックス一覧
* 外部キー制約一覧

### 8.2 更新タイミング

* スキーマ変更のPRマージ時
* 四半期ごとの定期レビュー時

## 9. チェックリスト

### 9.1 スキーマ変更前チェックリスト

- [ ] 変更の必要性と目的が明確か
- [ ] 影響を受けるシステムとコンポーネントを特定したか
- [ ] 既存データへの影響を分析したか
- [ ] パフォーマンスへの影響を考慮したか
- [ ] マイグレーション計画を作成したか
- [ ] ロールバック計画を準備したか

### 9.2 スキーマ変更後チェックリスト

- [ ] マイグレーションが正常に適用されたか
- [ ] データ整合性に問題はないか
- [ ] アプリケーションが正常に動作するか
- [ ] パフォーマンスに問題はないか
- [ ] ドキュメントを更新したか
- [ ] 関連するチームに通知したか

## 10. 緊急時の対応手順

1. 問題の特定と影響範囲の評価
2. 緊急対応チームの招集
3. 必要に応じてシステムの一時停止
4. バックアップからの復旧またはホットフィックスの適用
5. 復旧確認とシステム再開
6. 事後分析と再発防止策の策定

## 11. 教育とトレーニング

* 新メンバーへのオンボーディング時にスキーマ管理ルールを説明
* 四半期ごとにベストプラクティスの共有セッションを実施
* マイグレーション演習を定期的に実施

## 12. ルール違反時の対応

1. 違反の検出と報告
2. 影響の評価
3. 修正計画の策定と実施
4. 再発防止策の実施
5. 必要に応じてルールの見直し

## 13. 定期的なレビューと改善

* 四半期ごとにルールの有効性をレビュー
* 新たな課題や改善点を特定
* ルールの更新と周知

---

このルールは、すべてのプロジェクトメンバーが遵守すべきものです。ルールに関する質問や提案がある場合は、データベース管理者または技術リードに相談してください。