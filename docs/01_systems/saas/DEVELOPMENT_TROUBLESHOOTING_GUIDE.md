# 開発トラブルシューティングガイド

## 🚨 今回の会話で発生した問題と再発防止策

### 1. ページルーティング競合問題

#### 問題
- `pages/admin/front-desk/accounting.vue`が`accounting/[id].vue`や`accounting/receipt/[id].vue`より優先されてしまう
- Nuxtのファイルベースルーティングでの競合により、詳細ページが表示されない

#### 再発防止策
1. **ファイル命名規則の厳格化**
   ```
   ❌ 悪い例: accounting.vue（サブルートと競合）
   ✅ 良い例: accounting-list.vue または index.vue
   ```

2. **ルーティング設計チェックリスト**
   - [ ] 新しいページ作成時は必ずルーティング競合をチェック
   - [ ] `[id].vue`や`[slug].vue`を使う場合は親ディレクトリ構造を確認
   - [ ] 同階層に同名ファイルがないか確認

3. **自動チェックスクリプト作成**
   ```bash
   # scripts/check-routing-conflicts.js
   # ページ作成時に自動実行してルーティング競合を検出
   ```

### 2. SSRエラー問題

#### 問題
- 領収書ページで「Cannot read properties of undefined (reading 'meta')」エラー
- `layout: 'blank'`設定が原因でSSRエラー発生

#### 再発防止策
1. **レイアウト設定の標準化**
   ```vue
   <!-- ❌ 悪い例 -->
   <script setup>
   definePageMeta({
     layout: 'blank'
   })
   </script>

   <!-- ✅ 良い例 -->
   <script setup>
   definePageMeta({
     layout: false
   })
   </script>
   ```

2. **SSR問題対応のルールルール**
   - 印刷専用ページは必ず`layout: false`を使用
   - `nuxt.config.ts`でSSR無効化設定を追加
   - `app.vue`のNuxtLayoutを安全にラップ

### 3. トースト重複問題

#### 問題
- 複数箇所に`UiToast`コンポーネントが配置され、トーストが重複表示される
- `app.vue`、レイアウト、ページの3箇所に存在

#### 再発防止策
1. **トーストの一元管理**
   ```
   ✅ app.vue にのみ UiToast を配置
   ❌ レイアウトやページに重複配置しない
   ```

2. **UI状態管理の原則**
   - グローバル状態（トースト、モーダル）は必ずapp.vueで管理
   - レイアウトやページでは状態管理のみ行う
   - コンポーネント重複チェックを開発時に実施

### 4. ブラウザデフォルトUI使用問題

#### 問題
- `alert()`、`confirm()`などのブラウザデフォルトUIを使用
- UX品質の低下とデザイン統一性の欠如

#### 再発防止策
1. **禁止UIの一覧化**
   ```javascript
   // ❌ 絶対に使用禁止
   alert()
   confirm() 
   prompt()
   
   // ✅ 代替手段
   showSuccessToast()
   showErrorToast()
   削除確認モーダル
   ```

2. **ESLintルール追加**
   ```json
   {
     "rules": {
       "no-alert": "error",
       "no-confirm": "error"
     }
   }
   ```

### 5. データベース操作の安全性問題

#### 問題
- 一時的なデータリセットスクリプトが残存
- データベース操作の記録が不十分

#### 再発防止策
1. **データベース操作の記録**
   ```bash
   # 全てのDB操作をログ記録
   echo "$(date): データリセット実行" >> db-operations.log
   ```

2. **一時スクリプトの自動削除**
   ```javascript
   // スクリプト末尾に自動削除機能追加
   process.on('exit', () => {
     fs.unlinkSync(__filename)
   })
   ```

### 6. 設定管理の問題

#### 問題
- 事業者情報、領収書設定など、複数の設定が分散
- 設定の整合性チェックが不十分

#### 再発防止策
1. **設定の統合管理**
   ```
   /admin/settings/
   ├── basic.vue          # 基本設定
   ├── business-info.vue  # 事業者情報
   ├── receipt-settings.vue # 領収書設定
   ├── payment-methods.vue  # 支払い方法
   └── hotel-info.vue     # ホテル情報
   ```

2. **設定バリデーション**
   - 必須項目の入力チェック
   - 設定間の整合性チェック
   - デフォルト値の自動設定

## 🔧 開発時チェックリスト

### 新機能開発前
- [ ] 既存機能への影響範囲を確認
- [ ] データベーススキーマ変更の必要性を確認
- [ ] ルーティング競合の可能性をチェック
- [ ] 共通コンポーネントの再利用を検討

### コード作成時
- [ ] ブラウザデフォルトUI（alert, confirm）を使用していない
- [ ] トーストやモーダルの重複配置がない
- [ ] アイコンは`heroicons:`プレフィックス付きで統一
- [ ] エラーハンドリングが適切に実装されている

### テスト前
- [ ] 開発サーバーがポート3000で起動することを確認
- [ ] ルーティングが正しく動作することを確認
- [ ] データベース操作が安全に実行されることを確認
- [ ] 既存機能が正常に動作することを確認

### リリース前
- [ ] 一時ファイルやデバッグコードが削除されている
- [ ] ログレベルが本番環境用に設定されている
- [ ] セキュリティ設定が適切に構成されている
- [ ] パフォーマンスに問題がないことを確認

## 🛠 自動化ツール

### 1. ルーティング競合チェッカー
```bash
npm run check:routing
```

### 2. コンポーネント重複チェッカー
```bash
npm run check:duplicates
```

### 3. 禁止UI使用チェッカー
```bash
npm run check:ui-violations
```

### 4. データベース整合性チェッカー
```bash
npm run check:db-integrity
```

## 📋 問題発生時の対応手順

### 1. ルーティング問題
1. `npm run build`でビルドエラーを確認
2. `pages/`ディレクトリ構造を見直し
3. 競合するファイルを特定して名前変更
4. 開発サーバー再起動

### 2. SSRエラー
1. ブラウザのコンソールエラーを確認
2. `nuxt.config.ts`のrouteRulesを確認
3. レイアウト設定を見直し
4. 必要に応じてSSR無効化

### 3. データベース問題
1. `npx prisma studio`でデータを確認
2. `npx prisma generate`でクライアント再生成
3. `npx prisma db push`でスキーマ同期
4. バックアップからの復旧を検討

### 4. UI重複問題
1. 該当コンポーネントの配置場所を全て確認
2. 不要な配置を削除
3. 状態管理の一元化を実施
4. テストで動作確認

## 🎯 品質向上のための継続的改善

### 1. 定期レビュー
- 週次でコードレビューを実施
- 月次で設計パターンの見直し
- 四半期でアーキテクチャの評価

### 2. ドキュメント更新
- 新しい問題が発生したら必ずこのガイドを更新
- 解決策の効果を検証して改善
- チーム間での知識共有を促進

### 3. 自動化の拡充
- より多くのチェックを自動化
- CI/CDパイプラインに組み込み
- 開発効率の継続的改善

---

このガイドは実際の問題発生時の経験に基づいて作成されており、同様の問題の再発防止に役立てることができます。 