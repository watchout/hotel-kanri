# レイアウト新規作成機能 詳細仕様書

## 概要

レイアウト新規作成機能は、ユーザーが直感的にページレイアウトを作成できる機能です。3つの作成方式（空白から作成、テンプレートから作成、既存レイアウト複製）を提供し、効率的なレイアウト制作を支援します。

## アクセス情報

- **URL**: `/admin/layouts/create`
- **メソッド**: GET（表示）、POST（作成処理）
- **権限**: 管理者権限が必要
- **レイアウト**: `admin`レイアウトを使用

## ページ構成

### 1. ページヘッダー
```
┌─────────────────────────────────────────────────────────────┐
│ パンくずリスト: レイアウト管理 > 新規作成                      │
│ タイトル: レイアウト新規作成                                  │
│ 説明: 新しいページレイアウトを作成します                       │
│                                            [一覧に戻る] ボタン │
└─────────────────────────────────────────────────────────────┘
```

### 2. 作成方式選択セクション
```
┌─────────────────────────────────────────────────────────────┐
│ 作成方法を選択                                               │
│ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐            │
│ │[📄] 空白から  │ │[📐] テンプレート│ │[📋] 既存レイアウト│         │
│ │     作成      │ │  から作成     │ │     を複製    │            │
│ └─────────────┘ └─────────────┘ └─────────────┘            │
└─────────────────────────────────────────────────────────────┘
```

### 3. 条件選択セクション（動的表示）

#### 3.1 テンプレート選択（テンプレート作成時）
```
┌─────────────────────────────────────────────────────────────┐
│ テンプレート選択                                             │
│ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐            │
│ │ シンプルページ │ │  情報ページ   │ │  カスタム   │            │
│ │ テンプレート   │ │ テンプレート   │ │ テンプレート │            │
│ │  [✓選択中]    │ │              │ │              │            │
│ └─────────────┘ └─────────────┘ └─────────────┘            │
│                                                             │
│ テンプレートがない場合:                                        │
│ 「利用可能なテンプレートがありません」                         │
│ [サンプルテンプレートを作成する] リンク                        │
└─────────────────────────────────────────────────────────────┘
```

#### 3.2 既存レイアウト選択（複製作成時）
```
┌─────────────────────────────────────────────────────────────┐
│ 複製元レイアウト選択                                          │
│ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐            │
│ │ トップページ  │ │ お知らせページ │ │ イベントページ │           │
│ │    [公開]    │ │    [下書き]   │ │    [公開]    │            │
│ │  [✓選択中]   │ │              │ │              │            │
│ └─────────────┘ └─────────────┘ └─────────────┘            │
└─────────────────────────────────────────────────────────────┘
```

### 4. 基本情報入力フォーム
```
┌─────────────────────────────────────────────────────────────┐
│ 基本情報                                                    │
│ ┌─────────────────┐ ┌─────────────────┐                    │
│ │ レイアウト名 *    │ │ スラッグ *       │                    │
│ │ [入力フィールド]  │ │ [入力フィールド] │                    │
│ └─────────────────┘ └─────────────────┘                    │
│ ┌─────────────────┐ ┌─────────────────┐                    │
│ │ カテゴリ          │ │ タイプ          │                    │
│ │ [選択フィールド]  │ │ [選択フィールド] │                    │
│ └─────────────────┘ └─────────────────┘                    │
│ ┌─────────────────────────────────────┐                    │
│ │ 説明                                 │                    │
│ │ [テキストエリア]                     │                    │
│ └─────────────────────────────────────┘                    │
│ ☑ このレイアウトをテンプレートとして保存                      │
│                           [キャンセル] [レイアウトを作成]    │
└─────────────────────────────────────────────────────────────┘
```

## 機能詳細

### 1. 作成方式選択

#### 1.1 空白から作成
- **説明**: 何もない状態から新しくレイアウトを作成
- **用途**: 完全にオリジナルのレイアウトを作成したい場合
- **初期状態**: 空の要素配列でレイアウトを初期化

#### 1.2 テンプレートから作成
- **説明**: 既存のテンプレートをベースに作成
- **動作**: 
  1. `isTemplate: true`のレイアウト一覧を取得
  2. `status: 'published'`のテンプレートのみ表示
  3. テンプレート選択時、そのデータ構造をコピー
- **フォールバック**: テンプレートがない場合、サンプル作成機能を提供

#### 1.3 既存レイアウト複製
- **説明**: 既存のレイアウトをコピーして新しいレイアウトを作成
- **動作**:
  1. `isTemplate: false`のレイアウト一覧を取得
  2. 全ステータスのレイアウトを表示（ステータス表示付き）
  3. 選択したレイアウトのデータ構造をコピー

### 2. テンプレート管理

#### 2.1 テンプレート一覧取得
```typescript
// API呼び出し
const result = await getLayouts({ 
  isTemplate: true, 
  status: 'published' 
})
```

#### 2.2 サンプルテンプレート作成
```typescript
const sampleTemplate = {
  name: 'シンプルページテンプレート',
  slug: 'simple-page-template',
  description: 'ヘッダー、メインコンテンツ、フッターの基本構成',
  type: 'template',
  category: 'basic',
  data: {
    elements: [
      {
        id: 'header',
        type: 'header',
        content: { title: 'サイトタイトル' },
        style: { backgroundColor: '#f8f9fa', padding: '20px' }
      },
      {
        id: 'main',
        type: 'main',
        content: { text: 'メインコンテンツエリア' },
        style: { padding: '40px 20px' }
      },
      {
        id: 'footer',
        type: 'footer',
        content: { text: '© 2024 Hotel System' },
        style: { backgroundColor: '#343a40', color: 'white', padding: '20px' }
      }
    ]
  },
  settings: {},
  isTemplate: true,
  authorId: 'admin-user'
}
```

### 3. フォームバリデーション

#### 3.1 必須項目
- **レイアウト名**: 1文字以上100文字以下
- **スラッグ**: 英数字、ハイフン、アンダースコアのみ許可

#### 3.2 スラッグ自動生成
```typescript
const generateSlug = () => {
  if (form.value.name) {
    form.value.slug = form.value.name
      .toLowerCase()
      .replace(/[^a-z0-9\s-]/g, '')
      .replace(/\s+/g, '-')
      .replace(/-+/g, '-')
      .trim()
  }
}
```

#### 3.3 フォーム有効性チェック
```typescript
const isFormValid = computed(() => {
  const hasBasicInfo = form.value.name.trim() && form.value.slug.trim()
  
  if (creationMethod.value === 'template') {
    return hasBasicInfo && selectedTemplate.value
  }
  
  if (creationMethod.value === 'duplicate') {
    return hasBasicInfo && selectedLayout.value
  }
  
  return hasBasicInfo
})
```

### 4. 作成処理フロー

#### 4.1 空白から作成
```typescript
const createData = {
  name: form.value.name,
  slug: form.value.slug,
  description: form.value.description,
  type: form.value.type,
  category: form.value.category,
  data: {
    elements: [],
    settings: {},
    styles: {}
  },
  settings: {},
  isTemplate: form.value.isTemplate,
  authorId: 'admin-user'
}

const newLayout = await createLayoutApi(createData)
```

#### 4.2 テンプレート・複製から作成
```typescript
// 1. 複製処理
const newLayout = await duplicateLayout(
  selectedTemplate.value.id,
  'admin-user',
  form.value.name
)

// 2. 基本情報更新
await updateLayout(newLayout.id, {
  name: form.value.name,
  slug: form.value.slug,
  description: form.value.description,
  category: form.value.category,
  type: form.value.type,
  isTemplate: form.value.isTemplate,
  updateBy: 'admin-user'
})
```

### 5. 選択肢定義

#### 5.1 カテゴリ選択肢
```typescript
const categories = [
  { value: '', label: 'カテゴリを選択' },
  { value: 'top', label: 'TOPページ' },
  { value: 'info', label: 'インフォメーション' },
  { value: 'custom', label: 'カスタム' }
]
```

#### 5.2 タイプ選択肢
```typescript
const types = [
  { value: 'page', label: 'ページ' },
  { value: 'template', label: 'テンプレート' },
  { value: 'component', label: 'コンポーネント' }
]
```

#### 5.3 ステータス表示
```typescript
const statusConfig = {
  published: {
    class: 'bg-green-100 text-green-800',
    label: '公開'
  },
  draft: {
    class: 'bg-gray-100 text-gray-800',
    label: '下書き'
  },
  archived: {
    class: 'bg-red-100 text-red-800',
    label: 'アーカイブ'
  }
}
```

## UI/UX 仕様

### 1. レスポンシブ対応
- **デスクトップ**: 3カラムグリッドで作成方式を表示
- **タブレット**: 1カラムで縦並び表示
- **モバイル**: 1カラムで縦並び表示

### 2. インタラクション

#### 2.1 作成方式選択
- **ホバー効果**: 背景色を薄いグレーに変更
- **選択状態**: 青いボーダーと背景、チェックアイコン表示
- **クリック**: 即座に選択状態を更新、関連セクション表示

#### 2.2 テンプレート/レイアウト選択
- **ローディング**: スピナーアイコン付きローディング表示
- **グリッドレイアウト**: デスクトップで3カラム、タブレットで2カラム
- **ホバー効果**: 軽いシャドウ効果
- **選択状態**: ボーダー色変更とチェックアイコン

#### 2.3 フォーム操作
- **自動スラッグ生成**: レイアウト名入力時にリアルタイム生成
- **バリデーション**: リアルタイムエラー表示
- **送信ボタン**: 無効状態では非活性表示

### 3. フィードバック

#### 3.1 成功フィードバック
```typescript
useNuxtApp().$toast.success('レイアウトを作成しました')
await navigateTo(`/admin/layouts/${newLayout.id}/edit`)
```

#### 3.2 エラーフィードバック
```typescript
useNuxtApp().$toast.error('レイアウトの作成に失敗しました')
```

#### 3.3 ローディング状態
- **ボタン**: スピナーアイコン付き「作成中...」表示
- **全体**: 作成処理中は操作を無効化

## エラーハンドリング

### 1. API エラー
- **ネットワークエラー**: 接続エラーメッセージ表示
- **サーバーエラー**: サーバーエラーメッセージ表示
- **バリデーションエラー**: フィールド別エラー表示

### 2. データ取得エラー
- **テンプレート取得失敗**: エラーメッセージとリトライボタン
- **レイアウト取得失敗**: エラーメッセージとリトライボタン

### 3. 作成処理エラー
- **重複エラー**: スラッグ重複時の警告
- **権限エラー**: 権限不足時の警告
- **一般エラー**: 予期しないエラーの汎用メッセージ

## パフォーマンス要件

### 1. 初期表示
- **目標**: 2秒以内でページ表示完了
- **計測**: Core Web Vitals に準拠

### 2. テンプレート読み込み
- **目標**: 1秒以内でテンプレート一覧表示
- **最適化**: ページネーション、遅延読み込み検討

### 3. 作成処理
- **目標**: 3秒以内で作成完了
- **フィードバック**: 1秒以内にローディング表示

## セキュリティ要件

### 1. 入力値検証
- **サニタイゼーション**: XSS攻撃対策
- **文字数制限**: DoS攻撃対策
- **文字種制限**: インジェクション攻撃対策

### 2. 認証・認可
- **セッション確認**: 有効なセッションの確認
- **権限確認**: 管理者権限の確認
- **CSRFトークン**: フォーム送信時の確認

### 3. ファイルアップロード（将来）
- **ファイル形式制限**: 画像ファイルのみ許可
- **ファイルサイズ制限**: 最大10MB
- **ウイルススキャン**: アップロード時のスキャン

## テスト仕様

### 1. 単体テスト
- **フォームバリデーション**: 各項目の検証ロジック
- **スラッグ生成**: 文字列変換ロジック
- **API呼び出し**: モック使用のAPI通信テスト

### 2. 統合テスト
- **作成フロー**: 各作成方式の完全フロー
- **エラーハンドリング**: 各種エラーケース
- **状態管理**: データの整合性確認

### 3. E2Eテスト
- **ユーザーフロー**: 実際の操作フロー
- **ブラウザ互換性**: 主要ブラウザでの動作確認
- **レスポンシブ**: 各デバイスサイズでの確認

## 保守・運用

### 1. ログ出力
- **操作ログ**: 作成処理の詳細ログ
- **エラーログ**: エラー発生時の詳細情報
- **パフォーマンスログ**: 処理時間の記録

### 2. 監視項目
- **作成成功率**: 成功/失敗の比率
- **応答時間**: 各処理の所要時間
- **エラー頻度**: エラー発生パターン

### 3. メンテナンス
- **データクリーンアップ**: 不要データの定期削除
- **パフォーマンス最適化**: クエリの最適化
- **セキュリティ更新**: 定期的なセキュリティ修正

## 今後の拡張計画

### 1. インポート機能
- **ファイルインポート**: JSONファイルからのレイアウト読み込み
- **外部連携**: 他システムからのデータ移行
- **一括作成**: CSVからの複数レイアウト作成

### 2. プレビュー機能
- **作成前プレビュー**: テンプレート選択時のプレビュー
- **比較機能**: 複数テンプレートの比較表示
- **カスタマイズプレビュー**: 基本設定反映のプレビュー

### 3. ワークフロー
- **下書き保存**: 作成途中での一時保存
- **承認フロー**: 作成前の承認プロセス
- **履歴管理**: 作成履歴の詳細管理

この仕様書に基づいて、レイアウト新規作成機能の継続的な改善と拡張を行います。