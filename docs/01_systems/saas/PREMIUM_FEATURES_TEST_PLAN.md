# プレミアム機能テスト計画書

## 1. テスト対象

以下の新機能および変更点をテスト対象とします：

1. **商品マスタと販売データの分離**
   - PriceRuleテーブルの追加
   - 価格ルール管理API
   - 価格計算ロジック

2. **ガチャメニュー機能**
   - GachaMenuテーブルの追加
   - ガチャメニュー管理API
   - ガチャ実行ロジック
   - キッチン表示

3. **プレミアム機能制限**
   - TenantSubscriptionテーブルの拡張
   - プラン制限チェック
   - UI制限

## 2. テスト環境

- **開発環境**: SQLiteデータベース
- **ステージング環境**: PostgreSQLデータベース
- **テストユーザー**:
  - Economy プランユーザー
  - Professional プランユーザー
  - Enterprise プランユーザー

## 3. テスト項目

### 3.1 商品マスタと販売データの分離テスト

#### 3.1.1 単体テスト

| テストID | テスト内容 | 期待結果 |
|---------|----------|---------|
| UT-PR-001 | PriceRule作成API | 正常に価格ルールが作成されること |
| UT-PR-002 | PriceRule更新API | 正常に価格ルールが更新されること |
| UT-PR-003 | PriceRule削除API | 正常に価格ルールが削除されること |
| UT-PR-004 | デフォルト価格ルールの自動設定 | 同一メニューアイテムの他のデフォルト価格が解除されること |
| UT-PR-005 | 価格計算ロジック | 優先順位に基づいて正しい価格が選択されること |
| UT-PR-006 | 期間指定価格ルール | 期間内のみ適用されること |
| UT-PR-007 | 会員ランク別価格ルール | 会員ランクに応じて適用されること |

#### 3.1.2 統合テスト

| テストID | テスト内容 | 期待結果 |
|---------|----------|---------|
| IT-PR-001 | 商品取得APIと価格表示 | 適切な価格が商品情報に含まれること |
| IT-PR-002 | 注文処理と価格計算 | 注文時に正しい価格で計算されること |
| IT-PR-003 | キャンペーン連携 | キャンペーン期間中は特別価格が適用されること |

#### 3.1.3 E2Eテスト

| テストID | テスト内容 | 期待結果 |
|---------|----------|---------|
| E2E-PR-001 | 価格ルール管理UI | 価格ルールの作成・編集・削除が正常に行えること |
| E2E-PR-002 | 商品一覧での価格表示 | 適切な価格が表示されること |
| E2E-PR-003 | 注文フロー | 正しい価格で注文が完了すること |

### 3.2 ガチャメニュー機能テスト

#### 3.2.1 単体テスト

| テストID | テスト内容 | 期待結果 |
|---------|----------|---------|
| UT-GM-001 | GachaMenu作成API | 正常にガチャメニューが作成されること |
| UT-GM-002 | GachaMenu更新API | 正常にガチャメニューが更新されること |
| UT-GM-003 | GachaMenu削除API | 正常にガチャメニューが削除されること |
| UT-GM-004 | GachaMenuItem追加API | 正常にガチャメニューアイテムが追加されること |
| UT-GM-005 | GachaMenuItem更新API | 正常にガチャメニューアイテムが更新されること |
| UT-GM-006 | GachaMenuItem削除API | 正常にガチャメニューアイテムが削除されること |
| UT-GM-007 | ガチャ実行ロジック | 重みに基づいて正しく選択されること |

#### 3.2.2 統合テスト

| テストID | テスト内容 | 期待結果 |
|---------|----------|---------|
| IT-GM-001 | ガチャメニュー一覧取得 | アクティブなガチャメニューのみ取得されること |
| IT-GM-002 | ガチャ実行と注文処理 | ガチャ結果の商品が正しく注文されること |
| IT-GM-003 | キッチン表示連携 | キッチン画面に「（ガチャメニュー）」と表示されること |

#### 3.2.3 E2Eテスト

| テストID | テスト内容 | 期待結果 |
|---------|----------|---------|
| E2E-GM-001 | ガチャメニュー管理UI | ガチャメニューの作成・編集・削除が正常に行えること |
| E2E-GM-002 | ガチャメニューアイテム管理UI | アイテムの追加・確率設定・削除が正常に行えること |
| E2E-GM-003 | ガチャ実行UI | アニメーションとともにガチャが実行され、結果が表示されること |
| E2E-GM-004 | 注文フローとキッチン表示 | ガチャ結果の商品がキッチンに正しく表示されること |

### 3.3 プレミアム機能制限テスト

#### 3.3.1 単体テスト

| テストID | テスト内容 | 期待結果 |
|---------|----------|---------|
| UT-PF-001 | checkPremiumFeatureAccess関数 | プラン・機能フラグに基づいて正しく判定されること |
| UT-PF-002 | シークレットメニューAPI制限 | Economyプランでアクセス拒否されること |
| UT-PF-003 | ガチャメニューAPI制限 | Economyプランでアクセス拒否されること |

#### 3.3.2 統合テスト

| テストID | テスト内容 | 期待結果 |
|---------|----------|---------|
| IT-PF-001 | プラン変更時の機能アクセス | プランアップグレード後に機能が利用可能になること |
| IT-PF-002 | プランダウングレード時の警告 | プレミアム機能使用中の場合に警告が表示されること |

#### 3.3.3 E2Eテスト

| テストID | テスト内容 | 期待結果 |
|---------|----------|---------|
| E2E-PF-001 | Economyプランでの管理画面表示 | プレミアム機能がロックされて表示されること |
| E2E-PF-002 | Professionalプランでの管理画面表示 | プレミアム機能が利用可能になっていること |
| E2E-PF-003 | プラン変更UI | プラン変更後に適切に機能制限が反映されること |

## 4. テスト手順

### 4.1 自動テスト

#### 4.1.1 単体テスト

```bash
# Vitestによる単体テスト実行
npm run test:unit
```

#### 4.1.2 統合テスト

```bash
# 統合テスト実行
npm run test:integration
```

#### 4.1.3 E2Eテスト

```bash
# Playwrightによるブラウザテスト実行
npm run test:e2e
```

### 4.2 手動テスト

#### 4.2.1 商品マスタと販売データの分離

1. 管理画面で商品を選択し、複数の価格ルールを設定
2. 期間限定価格、会員価格を設定
3. 商品一覧で価格表示を確認
4. 注文を行い、正しい価格で計算されることを確認

#### 4.2.2 ガチャメニュー機能

1. 管理画面でガチャメニューを作成
2. 複数の商品を追加し、異なる確率を設定
3. ガチャを実行し、結果が表示されることを確認
4. 注文し、キッチン画面で「（ガチャメニュー）」と表示されることを確認

#### 4.2.3 プレミアム機能制限

1. Economyプランでログインし、プレミアム機能にアクセスできないことを確認
2. Professionalプランにアップグレードし、プレミアム機能にアクセスできることを確認
3. Economyプランにダウングレードし、警告が表示されることを確認

## 5. テスト環境構築

### 5.1 テスト用データベース

```bash
# テスト用データベースのセットアップ
npm run setup:test-db

# テストデータの投入
npm run seed:test-data
```

### 5.2 テスト用アカウント

| ユーザー名 | パスワード | プラン |
|----------|----------|------|
| economy@example.com | password123 | LEISURE_Economy |
| professional@example.com | password123 | LEISURE_Professional |
| enterprise@example.com | password123 | LEISURE_Enterprise |

## 6. テスト実行スケジュール

1. **単体テスト**: 2025年8月1日～8月3日
2. **統合テスト**: 2025年8月4日～8月6日
3. **E2Eテスト**: 2025年8月7日～8月9日
4. **手動テスト**: 2025年8月10日～8月12日
5. **バグ修正**: 2025年8月13日～8月15日
6. **リグレッションテスト**: 2025年8月16日～8月17日

## 7. バグ報告プロセス

1. バグを発見したら、以下の情報を含めて報告:
   - テストID
   - 再現手順
   - 期待結果と実際の結果
   - スクリーンショットまたはログ
2. バグの重要度を設定:
   - Critical: サービス停止につながるバグ
   - Major: 主要機能が使用できないバグ
   - Minor: 機能は使用できるが不便なバグ
   - Trivial: 見た目の問題など軽微なバグ
3. Jiraチケットを作成し、担当者にアサイン

## 8. 受け入れ基準

- 全ての単体テストが成功すること
- 全ての統合テストが成功すること
- 全てのE2Eテストが成功すること
- Criticalバグが0件であること
- Majorバグが0件であること
- Minorバグが3件以下であること
