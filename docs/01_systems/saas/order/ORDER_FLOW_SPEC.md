# 🚚 商品購入〜配達フロー仕様 – MVP

_Last updated: 2025-05-18_

---

## 1. 概要

ホテル客室からの注文後、キッチン → 配膳完了までを **リアルタイム可視化** する。ユーザー体験向上のため、以下機能を必須とする。

1. **販売提供時間外マスク** – グレー半透明 & 追加不可  
2. **年齢確認フロー** – 年齢制限タグ付与品のみポップアップ認証  
3. **アップセル提案** – カート追加直後に関連商品を表示  
4. **カテゴリ内ランキング** – 売上上位順タブ切替  
5. **進捗インジケータ & 通知** – 右上ステータス + ポップアップ + 効果音  
6. **デバイス自動認証** – IPまたはMACアドレスを用いた認証の自動化
7. **表示期間制御** – 商品の販売/表示期間を制御し、事前公開機能を提供
8. **裏メニュー** – 特別なアクセスコードが必要な限定メニューを提供

---

## 2. 販売提供時間ロジック

| フィールド   | 説明                     |
|--------------|--------------------------|
| `startTime`  | `HH:mm` 24h 形式        |
| `endTime`    | `HH:mm`                 |

- UI で範囲外の場合、`.opacity-40 pointer-events-none` を適用  
- Tooltip: `提供時間外です (10:00 – 22:30)`

---

## 3. 年齢確認フロー

| ステップ | UI                             | 詳細 |
|----------|--------------------------------|------|
| 1        | カート追加クリック             | 商品に `ageRestricted:true` タグがある場合発火 |
| 2        | モーダル表示                   | ☐ 生年月日入力 (📅 picker) |
| 3        | バリデーション                 | 20歳未満 → NG toast／OK → カート追加 |
| 4        | 24h キャッシュ                 | `localStorage.ageVerified=true` |

---

## 4. アップセル提案

| トリガー | アルゴリズム |
|----------|-------------|
| カート追加 | 同カテゴリで `isUpsell:true` を優先表示 |

- Modal 最大 3 件 (`grid-cols-1 md:grid-cols-3`)  
- CTA: `こちらもいかがですか？`

---

## 5. ランキングタブ

### API
`GET /api/v1/menus?sort=top&category={path}&period={day|month|year}` – 期間別売上降順

### UI
- タブ: `おすすめ` / `ランキング (日)` / `ランキング (月)` / `ランキング (年)`  
- デフォルトは `おすすめ`

#2025.5.9変更
- タブ: `おすすめ` / `週間ランキング` / `月間ランキング` / `年間ランキング`  

#2025.5.10変更・実装完了
- カテゴリ選択時にそのカテゴリ内のランキング表示対応
- タグベースでのカテゴリフィルタリング実装（カテゴリパス階層対応）

---

## 6. 進捗インジケータ

> **📋 更新履歴 (2025年1月27日)**  
> **客室サービスログ統合対応** - hotel-common統合管理による更新  
> 詳細仕様: [客室サービスログ連携仕様書](/Users/kaneko/hotel-common/docs/saas/room-service-log-integration-spec.md)

| ステータス   | 表示          | カラー           | 効果音      |
|--------------|--------------|-----------------|-------------|
| `received`   | 受付済み      | `bg-gray-500`   | –           |
| `cooking`    | 準備中        | `bg-amber-500`  | `cook.mp3`  |
| `ready`      | 準備完了      | `bg-green-600`  | –           |
| `delivering` | 配達中        | `bg-blue-500`   | `ding.mp3`  |
| `done`       | 配達完了      | `bg-green-600`  | `done.mp3`  |

- WebSocket `/ws/orders` で `status` 更新  
- `OrderStatusBadge.vue` (`fixed top-4 right-4`)  
- 変更時にポップアップ＋音再生

#### **v2.0 サービスログ連携対応 (2025年1月27日追加)**

**hotel-common連携用サービスアクション**:
- ルームサービス: `ROOM_SERVICE_ORDER`, `ROOM_SERVICE_DELIVERED`, `ROOM_SERVICE_CANCELLED`
- アメニティ・備品: `ROOM_AMENITY_RESTOCK`, `ROOM_SUPPLIES_DELIVERY`, `ROOM_AMENITY_REQUEST`
- コンシェルジュ: `CONCIERGE_SERVICE_START`, `CONCIERGE_SERVICE_COMPLETE`, `GUEST_INQUIRY_RESOLVED`
- 品質管理: `SERVICE_QUALITY_CHECK`, `GUEST_SATISFACTION_SURVEY`, `SERVICE_FEEDBACK_RECEIVED`

**ログ送信**: 各ステータス変更時にhotel-commonへ自動送信し、統合的なサービス履歴管理を実現

---

## 7. 表示期間制御

### 目的
期間限定メニューや新メニューの事前告知など、商品の表示/販売期間を柔軟に制御する。

### データモデル
```prisma
model MenuItem {
  // 既存フィールド
  showFrom    DateTime?  // 表示開始日時
  showTo      DateTime?  // 表示終了日時
  isPreview   Boolean    @default(false) // 事前公開フラグ
  taxRate     Int        // 消費税率（%）
}
```

### 動作仕様
| 状態 | 条件 | UI表示 |
|------|------|-------|
| 通常表示 | 現在時刻が showFrom と showTo の間 | 通常表示・購入可能 |
| 表示前 | 現在時刻 < showFrom | isPreview=true なら表示するが購入不可。false なら非表示 |
| 表示終了 | 現在時刻 > showTo | 非表示 |
| 事前公開 | isPreview=true & 現在時刻 < showFrom | 通常カードと同じレイアウト。カートボタン代わりに「🗓 5/20〜販売」ラベル表示（bg-amber-100 text-amber-700） |

### 処理フロー
1. クライアント側で時刻に基づくフィルタリング
2. バックエンド側でも時刻チェック（整合性担保）
3. 1時間ごとのCronジョブで表示状態を自動更新

### 消費税設定
- 管理画面で税率を選択可能（8%軽減税率、10%標準税率）
- 税込価格は自動計算して表示
- 客室UIでは税込価格で表示し、「税込」表記を明示

### 画像・動画アップロード
- 画像：PNG, JPG, GIF対応（最大10MB）
- 動画：MP4, MOV, AVI対応（最大50MB）
- ドラッグ&ドロップ対応
- プレビュー表示機能
- 削除機能

---

## 8. 裏メニュー

### 目的
特別な顧客やVIP向けに、通常メニューに表示されない特別メニューを提供する。

### データモデル
```prisma
model MenuItem {
  // 既存フィールド
  isSecret    Boolean    @default(false) // 裏メニューフラグ
  secretCode  String?    // 6文字のアクセスコード
}
```

### 動作仕様
| 状態 | 条件 | UI表示 |
|------|------|-------|
| 通常メニュー | isSecret=false | 通常表示 |
| 裏メニュー | isSecret=true | 半透明マスク（opacity-40）で表示。クリック時にコード入力ダイアログ表示 |
| コード認証済 | localStorage にコード保存済 | 通常表示・購入可能 |

### 認証フロー
1. 裏メニューカードをクリック
2. コード入力ダイアログ表示
3. 正しいコード入力で認証成功
4. localStorage.secretMenu_[menuId]=true で24時間記憶
5. 認証済みメニューは通常表示

### API
```
POST /api/v1/menus/secret
{
  "menuId": 123,
  "code": "ABC123"
}
```

レスポンス（成功）:
```json
{
  "success": true,
  "menuItem": { ... }
}
```

レスポンス（失敗）:
```json
{
  "success": false,
  "error": "無効なコードです"
}
```

---

## 9. データモデル差分

```prisma
model Order {
  id        Int         @id @default(autoincrement())
  roomId    String
  items     Json
  status    OrderStatus @default(received)
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
}

enum OrderStatus {
  received
  cooking
  ready
  delivering
  done
  cancelled
}
```

## 10. フロントエンド TODO
- **components/menu/AvailabilityMask.vue** … 提供時間外マスク  
- **components/order/AgeGate.vue** … 年齢確認モーダル  
- **components/order/UpsellModal.vue** … アップセル提案モーダル  
- **components/category/SortTabs.vue** … 並び替えタブ（日・月・年）  
- **components/order/OrderStatusBadge.vue** … 右上ステータス＋効果音  
- **components/menu/PreviewBadge.vue** … 事前公開表示バッジ
- **components/menu/SecretMenuDialog.vue** … 裏メニューコード入力ダイアログ
- **stores/order.ts** … WebSocket 購読・状態管理  
- **server/api/menus.top.get.ts** … ランキング API モック
- **middleware/deviceAuth.ts** … デバイス自動認証ミドルウェア
- **server/api/menus/secret.post.ts** … 裏メニューコード検証API

---

## 11. 決定事項 ✅
- **効果音ファイル格納場所**：`/sounds/` ルート直下に統一  
- **ランキング期間切替**：日・月・年の 3 タブ／API `?period=` パラメータ  
- **通知メッセージの多言語**：必須（JA / EN）→ `i18n/messages` にキー追加
- **認証方式**：部屋番号・パスワード認証から、デバイスIP/MAC認証へ移行（2025.5.12決定）
- **表示期間制御**：事前公開フラグ付きのメニューは「近日発売」バッジ付きで表示（2025.5.18決定）
- **裏メニュー**：6文字のアルファベット・数字コードで認証。24時間記憶（2025.5.18決定）

---

## 12. 商品メタデータ & ダイエタリーフラグ
- **目的**：アレルゲン・ヴィーガン・ハラール等をタグで管理し、DB 変更を避ける  
- **タグ形式**：`diet:vegan`, `allergy:milk` など  
- **API フィルタ例**  
  - `GET /menus?filter=diet:vegan` → ヴィーガン商品のみ  
  - `GET /menus?filter=allergy:milk-exclude` → 乳成分を含まない商品  
- **UI 表示**  
  - アレルゲン：赤系バッジ `bg-red-200 text-red-800 text-xs`  
  - ヴィーガン：緑系バッジ `bg-green-200 text-green-800 text-xs` (🥦)  
- **購入時チェック**  
  1. カート追加時にアレルゲン警告ダイアログ  
  2. 承認後 24h は `localStorage.allergyAck=true` でスキップ

---

## 13. 商品単位の調理状態管理と1オーダー1配膳制

### 目的
MVPでは「1オーダー＝1配膳」の原則に基づき、キッチンでの調理状態を商品ごとに個別管理し、全ての商品が準備完了になった時点で配膳を行う方式を採用する。

### 具体的な仕様
1. **キッチン管理UI**
   - 商品ごとに独立したブロックで表示
   - 各商品に対して準備状態（pending→cooking→ready）を個別に管理
   - 商品ブロック内に注文IDを表示（どの注文の商品かを明示）
   - ステータスごとに色分け表示（準備待ち: 黄色、準備中: 青、準備完了: 緑）

2. **ステータス管理**
   - 各商品の調理状態は独立して管理される
   - 同一注文内の全商品が「準備完了」になると、配膳可能状態に
   - 配膳担当者は全商品がそろった注文のみを配膳

3. **ワークフロー**
   - 商品ごとに「準備待ち」→「準備中」→「準備完了」と進む
   - キッチンスタッフは各商品の状態を個別に更新
   - 全商品が「準備完了」になった注文のみが配膳対象となる

### データモデル
```prisma
model OrderItem {
  id        Int      @id @default(autoincrement())
  orderId   Int
  order     Order    @relation(fields: [orderId], references: [id])
  menuItemId Int
  name      String
  quantity  Int
  status    String   @default("pending") // "pending", "cooking", "ready"
  // 他のフィールド
}
```

### 画面レイアウト
- キッチン管理画面では商品ごとに独立したカードを表示
- 各カードには商品名、数量、注文ID、部屋番号、メモを表示
- ステータス変更ボタンも商品ごとに表示
- ステータスごとに色分けして視覚的に区別しやすく

### 将来的な拡張
将来的には以下のような拡張も検討：
- 商品カテゴリごとの担当者割り当て
- 複数注文の同一商品をまとめて調理するバッチ処理機能
- 配膳優先度の設定と表示

### 実装メモ
- UX上は「1オーダー1配膳」であることを明確に
- システム内部では各商品の状態を個別に追跡
- UIでは商品単位の操作性を重視

---

## 追加実装項目
- 2025.5.9
商品ごとに説明文を入力できるように
商品画像は複数登録可能としたい
商品画像と一緒に動画も登録可能としたい
カートに追加押下後はカートにリンクする
オーダーTOPページにオーダー履歴ボタン表示→クリックしてオーダー履歴確認可能
オーダー注文完了〜オーダー提供完了までは提供ステータスをオーダーTOPの最上部に表示する
ステータスに関しては、客室・フロント画面に **「宅配便の配達状況」風** のステップトラッカーを実装する。 status ∈ 'received' | 'cooking' | 'cooked' | 'delivering'

- 2025.5.10追加・実装完了
ステップトラッカーの表示は番号でなく、アイコンにしたい
オーダートップとカートページに税込表示である説明の一文をいれる
カテゴリの一番最初に「全て」を表示し、デフォルトはすべてとする
注文履歴は上から新しい順に表示する
注文履歴ページの上部に注文履歴にある注文の合計額を表示する
L1,L2,L3共通でカテゴリの数が増えたり、スマホなど横幅が狭くなった場合、カテゴリを改行するのではなく、左右にスライドしてカテゴリを選択できる形式にする

- 2025.5.12追加
デバイス自動認証: IPアドレス/MACアドレスに基づく自動認証により、客室からのアクセス時にログイン操作不要とする
オーダー履歴ページとカートページにも自動認証を適用
チェックイン/チェックアウト時のデバイス・部屋紐づけはフロント管理システムと連携

- 2025.5.18追加
表示期間制御: 販売期間の設定と事前公開機能によるメニュー表示管理
裏メニュー: 特別なアクセスコードを必要とする限定メニューの実装

## UI設計ルール

### 新規登録・編集ページの統一
新規登録ページと編集ページは基本的に同じ構成でなければならない。これにより、ユーザーの混乱を防ぎ、一貫性のあるユーザーエクスペリエンスを提供する。

#### 統一すべき要素
1. **セクション構成**: 基本情報、価格・税率設定、在庫・販売設定、販売期間設定、ランキング表示設定、おすすめ設定、画像・動画アップロードの順序
2. **入力フィールドの配置**: グリッドレイアウトの統一（col-span-6、sm:col-span-3など）
3. **ラベルとヘルプテキスト**: 同じ項目には同じ説明文を使用
4. **バリデーションメッセージ**: エラー表示の形式と内容の統一
5. **ボタンの配置とスタイル**: 送信ボタン、キャンセルボタンの位置とデザイン

#### カテゴリタグとタグの入力方式
- **カテゴリタグ**: 入力フィールド + サジェスト機能（新規登録の方式が正）
- **タグ**: 入力フィールド + サジェスト機能（新規登録の方式が正）
- **事前公開**: 「販売開始前でも客室UIに『近日発売』として表示されます」の説明文（新規登録の方式が正）
- **画像・動画**: ドラッグ&ドロップ対応のモダンなUI（編集ページの方式が正）