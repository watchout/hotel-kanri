# デバイス管理機能テスト計画書
*Status: draft — 2025-07-XX*

## 1. 概要

本文書は、Google TVストリーマーのデバイス管理機能のテスト計画を定義します。テストは機能の正常動作、エラー処理、セキュリティ、パフォーマンスの観点から実施します。

## 2. テスト環境

### 2.1 ハードウェア環境

- **Google TVストリーマー**: DO（デバイスオーナー）モード有効化済み
- **テスト用ホテル客室**: 実際の設置環境を模した環境
- **管理用端末**: 管理画面アクセス用PC/タブレット

### 2.2 ソフトウェア環境

- **hotel-saas**: 最新開発版
- **ADB**: Android Debug Bridge 最新版
- **TestDPC**: Android Enterprise テスト用Device Policy Controller

## 3. テスト項目

### 3.1 WebSocket通信テスト

| ID | テスト項目 | 期待結果 | 確認方法 |
|----|-----------|---------|---------|
| WS-01 | WebSocket接続確立 | クライアントからサーバーへのWebSocket接続が確立される | コンソールログ確認 |
| WS-02 | チェックイン時のイベント送信 | `GUEST_CHECKIN`イベントがデバイスに送信される | コンソールログ確認 |
| WS-03 | チェックアウト時のイベント送信 | `GUEST_CHECKOUT`イベントがデバイスに送信される | コンソールログ確認 |
| WS-04 | 接続切断時の再接続 | 接続が切断された場合に自動的に再接続される | ネットワーク切断テスト |
| WS-05 | 認証エラー時の処理 | 認証エラー時に適切なエラーメッセージが表示される | 無効な認証情報でテスト |

### 3.2 デバイスリセット機能テスト

| ID | テスト項目 | 期待結果 | 確認方法 |
|----|-----------|---------|---------|
| DR-01 | クライアント側リセット | localStorage, sessionStorage, IndexedDB, キャッシュがクリアされる | ブラウザ開発ツール確認 |
| DR-02 | ADBコマンドによるリセット | WebViewデータ、ブラウザデータ、キャッシュがクリアされる | ADBコマンド実行ログ確認 |
| DR-03 | チェックアウト時の自動リセット | チェックアウト処理でリセットが自動実行される | 管理画面からチェックアウト実行 |
| DR-04 | 手動リセット | 管理画面からの手動リセットが正常に動作する | 管理画面からリセット実行 |
| DR-05 | リセット失敗時の処理 | リセット失敗時に適切なエラーメッセージが表示される | ADB接続切断状態でテスト |

### 3.3 隠しコマンド機能テスト

| ID | テスト項目 | 期待結果 | 確認方法 |
|----|-----------|---------|---------|
| HC-01 | コマンドシーケンス検出 | 正しいキー入力シーケンスで設定画面へのアクセスが可能 | リモコン操作でテスト |
| HC-02 | PIN認証 | 正しいPINコードでのみ設定画面へのアクセスが許可される | 正誤両方のPINでテスト |
| HC-03 | 設定画面表示 | 設定画面が正しく表示される | 画面表示確認 |
| HC-04 | 設定画面からのリセット | 設定画面からのリセット機能が正常に動作する | 設定画面からリセット実行 |
| HC-05 | 設定画面からの戻り | 設定画面から正常にメイン画面に戻れる | 戻るボタン操作確認 |

### 3.4 管理画面機能テスト

| ID | テスト項目 | 期待結果 | 確認方法 |
|----|-----------|---------|---------|
| AM-01 | デバイス一覧表示 | 登録されたデバイスが一覧で表示される | 管理画面アクセス |
| AM-02 | デバイス追加 | 新規デバイスが正常に追加される | デバイス追加操作 |
| AM-03 | デバイス編集 | デバイス情報が正常に更新される | デバイス編集操作 |
| AM-04 | デバイスリセット | 管理画面からのリセットが正常に動作する | リセットボタン操作 |
| AM-05 | デバイスチェックアウト | 管理画面からのチェックアウトが正常に動作する | チェックアウトボタン操作 |
| AM-06 | オンライン状態表示 | デバイスのオンライン/オフライン状態が正しく表示される | 接続状態変更テスト |
| AM-07 | 検索・フィルター | 検索やフィルター機能が正常に動作する | 検索・フィルター操作 |

### 3.5 統合テスト

| ID | テスト項目 | 期待結果 | 確認方法 |
|----|-----------|---------|---------|
| IT-01 | チェックイン〜チェックアウトフロー | 一連のフローが正常に動作する | エンドツーエンドテスト |
| IT-02 | 複数デバイス同時操作 | 複数デバイスの同時操作が正常に動作する | 複数デバイス環境でテスト |
| IT-03 | ネットワーク切断時の回復性 | ネットワーク切断後も正常に回復する | ネットワーク切断テスト |
| IT-04 | 長期運用安定性 | 長時間の運用でも安定して動作する | 24時間連続運用テスト |
| IT-05 | 異常系からの回復 | エラー発生後も正常に回復する | 各種エラー発生テスト |

## 4. セキュリティテスト

| ID | テスト項目 | 期待結果 | 確認方法 |
|----|-----------|---------|---------|
| ST-01 | 認証チェック | 未認証ユーザーが管理機能にアクセスできない | 未認証状態でのアクセス試行 |
| ST-02 | PIN保護 | 正しいPINコードでのみ設定画面にアクセスできる | 不正PINでのアクセス試行 |
| ST-03 | データ削除の確実性 | チェックアウト時にすべての個人データが確実に削除される | データ残存チェック |
| ST-04 | APIアクセス制限 | 管理APIが適切に保護されている | 未認証APIアクセス試行 |
| ST-05 | WebSocket接続保護 | WebSocket接続が適切に保護されている | 不正接続試行 |

## 5. パフォーマンステスト

| ID | テスト項目 | 期待結果 | 確認方法 |
|----|-----------|---------|---------|
| PT-01 | リセット処理速度 | リセット処理が3秒以内に完了する | 処理時間計測 |
| PT-02 | WebSocket応答速度 | WebSocketメッセージが500ms以内に処理される | 応答時間計測 |
| PT-03 | 管理画面表示速度 | 管理画面が2秒以内に表示される | 表示時間計測 |
| PT-04 | 複数デバイス同時処理 | 10台以上のデバイスを同時に処理できる | 負荷テスト |
| PT-05 | メモリ使用量 | メモリリークが発生しない | 長時間運用時のメモリ監視 |

## 6. テスト手順

### 6.1 テスト前準備

1. テスト環境のセットアップ
   - Google TVストリーマーをDOモードで設定
   - `setup_device.sh`スクリプトを実行
   - テスト用アカウントを準備

2. テストデータの準備
   - テスト用デバイスを登録
   - テスト用客室を設定
   - テスト用ユーザーを作成

### 6.2 テスト実施手順

1. 単体テスト
   - 各コンポーネントの単体テストを実行
   - 自動テストスクリプトを実行

2. 統合テスト
   - チェックイン〜チェックアウトの一連のフローをテスト
   - エラーケースのテスト
   - 境界値テスト

3. セキュリティテスト
   - 認証バイパステスト
   - データ漏洩テスト
   - 不正アクセステスト

4. パフォーマンステスト
   - 負荷テスト
   - 長時間運用テスト
   - リソース使用量モニタリング

### 6.3 テスト結果記録

テスト結果は以下の形式で記録します：

```
テストID: WS-01
テスト日時: 2025-07-XX 10:00
テスト担当者: 山田太郎
テスト環境: 開発環境
テスト結果: 合格/不合格
詳細: WebSocket接続が正常に確立されることを確認。接続時間は平均300ms。
```

## 7. テスト自動化

以下のテストは自動化します：

1. WebSocket通信テスト
2. デバイスリセット機能テスト（クライアント側）
3. 管理画面機能テスト
4. APIテスト

自動テストは以下のコマンドで実行します：

```bash
npm run test:device-management
```

## 8. 受け入れ基準

デバイス管理機能は以下の条件を満たした場合に受け入れとします：

1. すべての必須テスト項目が合格
2. 致命的なバグが0件
3. セキュリティ上の脆弱性が0件
4. パフォーマンス要件を満たしている
5. ユーザビリティ要件を満たしている

## 9. テストスケジュール

| フェーズ | 開始日 | 終了日 | 担当者 |
|---------|-------|-------|-------|
| テスト計画策定 | 2025-07-XX | 2025-07-XX | プロジェクトマネージャー |
| テスト環境準備 | 2025-07-XX | 2025-07-XX | インフラチーム |
| 単体テスト | 2025-07-XX | 2025-07-XX | 開発チーム |
| 統合テスト | 2025-07-XX | 2025-07-XX | QAチーム |
| セキュリティテスト | 2025-07-XX | 2025-07-XX | セキュリティチーム |
| パフォーマンステスト | 2025-07-XX | 2025-07-XX | パフォーマンスチーム |
| バグ修正 | 2025-07-XX | 2025-07-XX | 開発チーム |
| 最終検証 | 2025-07-XX | 2025-07-XX | QAチーム |

## 10. リスクと対策

| リスク | 影響度 | 発生確率 | 対策 |
|-------|-------|---------|-----|
| ADB接続失敗 | 高 | 中 | クライアント側リセットをフォールバックとして実装 |
| WebSocket接続切断 | 中 | 高 | 自動再接続機能の実装 |
| データ削除の不完全性 | 高 | 低 | 複数層でのデータクリア実装 |
| PIN漏洩 | 中 | 低 | PIN定期変更の仕組み実装 |
| パフォーマンス低下 | 中 | 中 | 定期的なパフォーマンスモニタリング |

## 11. 結論

本テスト計画書に基づいてデバイス管理機能のテストを実施することで、機能の品質、セキュリティ、パフォーマンスを確保します。テスト結果は定期的にレビューし、必要に応じて計画を調整します。

## 更新履歴
- 2025-07-XX: 初版作成
