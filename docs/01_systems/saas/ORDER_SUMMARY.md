# 1オーダー1配膳制 実装仕様

## 概要

ホテルサービスにおいて、1つの注文（オーダー）に対して1回の配膳で全ての商品を届ける「1オーダー1配膳制」を実装しました。この方式はホテルのルームサービスで一般的なアプローチであり、効率的な配膳管理を実現します。

## 実装済み機能

### 1. 注文ステータス管理
- 注文は以下のステータス遷移に従って管理されます：
  - `received`（受付済み）→ `cooking`（調理中）→ `ready`（配達待ち）→ `delivering`（配達中）→ `done`（配達完了）
- 各ステータスはデータベースで管理され、リアルタイムで更新されます

### 2. 配膳管理画面
- 管理者向けの配膳管理画面（`/admin/delivery/manage`）を実装
- 注文ステータスごとのカラム表示（看板方式）
- 各商品の提供状態をチェックリストで管理
- 全ての商品がチェックされるまで配達開始ができない仕組み

### 3. リアルタイム通知
- WebSocketを使用したリアルタイム更新
- 注文ステータス変更時の自動更新
- 効果音による通知機能
- デスクトップ通知（ブラウザの許可が必要）

### 4. 顧客向け画面
- 現在の注文状況をリアルタイムで表示
- ステータスバッジによる視覚的なフィードバック
- 各ステータス変更時のサウンド通知

### 5. 商品ごとの準備状態管理
- 新しい管理画面（`/admin/kitchen/items`）で商品ごとの準備状態を管理可能
- 商品ごとに個別のステータス（`pending`, `cooking`, `ready`）を設定
- カテゴリ別フィルタリング機能
- 商品ごとのステータス更新時に注文全体のステータスと自動同期

## 技術的実装

### データモデル
- `Order`モデルで注文全体を管理
- `OrderItem`モデルで注文内の個々の商品を管理
  - 各商品に独自のステータスフィールドを持つ
  - 商品ごとの詳細情報（名前、価格、数量など）を保持
- 注文ステータスは`status`フィールドで一元管理

### ステータス更新API
- 注文全体: `/api/v1/admin/orders/[id]/status`
- 個別商品: `/api/v1/admin/orders/[id]/items/[itemId]/status`
- 有効なステータス遷移のみを許可する検証機能
- 更新時にWebSocketを通じて全クライアントに通知

### WebSocket通信
- 管理者、キッチン、配膳スタッフ、客室ごとに分離された通信チャネル
- 接続管理と自動再接続機能
- サーバーサイドイベント発行による通知

## 使用方法

### キッチンスタッフ向け
1. 商品別準備管理画面（`/admin/kitchen/items`）にアクセス
2. カテゴリフィルターで担当カテゴリを選択
3. 「準備待ち」から「準備中」→「準備完了」と各商品の状態を更新
4. 全商品の準備が完了すると、注文全体が「準備完了」状態に自動更新

### 配膳スタッフ向け
1. 配膳管理画面（`/admin/delivery/manage`）にアクセス
2. 「配達待ち」カラムに表示された注文の準備
3. 各商品の提供をチェックリストで確認
4. 全商品の確認後「配達開始」ボタンをクリック
5. 配達完了後「配達完了」ボタンをクリック

### 顧客向け
1. 注文完了後、画面右上のステータスバッジで現在の状態を確認
2. ステータス変更時には効果音で通知
3. 配達完了後は「配達完了」状態に変わります

## 将来の拡張計画

### UIの改善
- 商品カテゴリごとの色分け表示
- ドラッグ&ドロップによるステータス変更
- 配達予定時間の自動計算と表示

## 注意事項
- 現在の実装では、注文はキャンセルできますが、一度「配達完了」状態になった注文はステータスを変更できません
- WebSocket接続が切断された場合は、自動的に再接続を試みます
- 音声通知はブラウザの設定によってブロックされる可能性があります 