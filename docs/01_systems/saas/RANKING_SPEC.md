# 🏆 ランキング機能 仕様

_Last updated: 2025-05-18_

---

## 1. 概要

メニュー人気ランキングを実装し、客室UI上で表示します。ランキングは日間・週間・月間の3種類を提供し、それぞれ定期的に更新されます。

## 2. ランキング計算

### 2.1 集計間隔

- **バッチ計算間隔**: 6時間ごと (00:00 / 06:00 / 12:00 / 18:00 JST)
- **キャッシュTTL**: 30分（Redisキャッシュ）

### 2.2 集計期間

| ランキングタイプ | 対象期間       | 説明 |
|--------------|--------------|------|
| `day`        | 24時間       | 直近24時間の注文数 |
| `week`       | 7日間        | 直近7日間の注文数 |
| `month`      | 30日間       | 直近30日間の注文数 |

### 2.3 計算アルゴリズム

1. 対象期間内の各メニューの注文数を集計
2. 注文数が多い順にソート
3. 同数の場合は、新しいメニューを優先
4. 上位30商品までをランキングとして保存

## 3. データ保存

### 3.1 Redis キャッシュ

```
ranking:day -> [{"id":101,"count":45},{"id":203,"count":32},...]
ranking:week -> [{"id":101,"count":130},{"id":305,"count":129},...]
ranking:month -> [{"id":305,"count":520},{"id":101,"count":480},...]
```

### 3.2 更新履歴テーブル

```prisma
model RankingLog {
  id        Int      @id @default(autoincrement())
  type      String   // "day", "week", "month"
  data      Json     // ランキングデータ
  createdAt DateTime @default(now())
  
  @@index([type, createdAt])
}
```

## 4. API 仕様

### 4.1 クライアント向け API

```
GET /api/v1/menus?ranking=day&limit=10
GET /api/v1/menus?ranking=week&limit=10
GET /api/v1/menus?ranking=month&limit=10
```

レスポンス例:

```json
{
  "items": [
    {
      "id": 101,
      "name_ja": "モーニングセット",
      "name_en": "Morning Set",
      "price": 1200,
      "rank": 1,
      "orderCount": 45
    },
    ...
  ],
  "lastUpdated": "2025-05-18T12:00:00Z",
  "nextUpdate": "2025-05-18T18:00:00Z"
}
```

### 4.2 管理者向け API

```
GET /api/v1/admin/ranking
POST /api/v1/admin/ranking/recalculate // 手動再計算
```

### 4.3 バッチ処理 API

```
POST /api/_cron/ranking // Cronジョブ用エンドポイント
```

## 5. UI 実装

### 5.1 客室 UI

- カテゴリタブ右に「ランキング」タブを追加
- サブタブで「日間」「週間」「月間」を切り替え
- ランキング表示時は商品カードに順位バッジ表示 (金/銀/銅 + 数字)
- 最終更新日時とリアルタイム性の注釈を表示

### 5.2 管理者 UI

- 各メニュー編集画面でランキング表示設定（チェックボックス）
- ランキング設定画面で手動更新ボタン
- ランキング履歴閲覧機能

## 6. 実装詳細

### 6.1 バッチ処理フロー

1. Cronサービスが6時間ごとに `/api/_cron/ranking` を呼び出し
2. 期間ごとの注文データをDBから集計
3. Redisにランキングデータを保存
4. ログテーブルに履歴を記録

### 6.2 クライアント表示

1. ランキング表示リクエスト時にRedisからデータ取得
2. Redis障害時はDBのログテーブルから最新データをフォールバック取得
3. メニュー情報とランキング情報をマージして返却

## 7. 注意点・制約事項

1. **パフォーマンス**
   - 大量データ処理時はクエリ最適化（インデックス活用）
   - Redisキャッシュによる負荷軽減

2. **データ整合性**
   - 削除メニューの扱い（集計からは除外）
   - メニューID変更時の履歴データ整合性

3. **運用考慮**
   - 定期バッチ失敗時のリトライ機構
   - キャッシュ破損時の復旧手順
   - ログローテーション（古いランキングログは定期削除） 