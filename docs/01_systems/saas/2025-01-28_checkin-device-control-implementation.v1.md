# チェックイン端末制御機能実装の議論記録

**Doc-ID**: MIN-2025-001
**Version**: 1.0
**Status**: Active
**Owner**: 金子裕司
**Linked-Docs**: SPEC-2025-002, REL-2025-001

---

## 📅 **実装セッション記録**

**日時**: 2025-01-28
**参加者**: 金子裕司, AI Assistant (Sun)
**議題**: チェックイン成功後の端末制御とウェルカムムービー再生機能の実装

## 🎯 **議論内容**

### **要求事項の確認**
- チェックイン処理成功 → 端末をチェックイン状態に変更
- ウェルカムムービーの自動再生
- エミュレーション環境での検証機能
- 実機での動作は後日、エミュレーションでの検証は即座に実施

### **技術方針の決定**
1. **WebSocketイベント「GUEST_CHECKIN」の導入**
   - チェックインAPI成功時に自動送信
   - ウェルカムムービー設定を含む包括的データ構造

2. **端末状態管理の実装**
   - `useDeviceCheckin` composableによる状態管理
   - ローカルストレージでの状態永続化
   - WebSocketイベントの自動受信・処理

3. **ウェルカムムービー機能**
   - 全画面での動画再生
   - 自動スキップ機能（設定可能）
   - 手動スキップボタン
   - エラーハンドリング

### **実装アプローチの合意**
- **段階的実装**: エミュレーション → 実機対応
- **hotel-common統合**: 客室状態更新APIとの連携
- **テスト環境**: 専用テストページでの検証機能

## 🔧 **技術的決定事項**

### **WebSocketイベント構造**
```typescript
{
  type: 'GUEST_CHECKIN',
  data: {
    roomNumber: string,
    roomId: string,
    guestCount: number,
    checkinDate: string,
    welcomeVideo: {
      shouldPlay: boolean,
      videoUrl: string,
      duration: number,
      autoSkip: boolean
    }
  }
}
```

### **状態管理設計**
- **チェックイン状態**: boolean + 詳細情報
- **ウェルカムムービー状態**: 再生中フラグ + 再生済みフラグ
- **WebSocket接続状態**: 接続監視 + 自動再接続

### **API統合方針**
- hotel-commonの客室状態更新APIを使用
- 客室番号 → 客室ID特定 → 状態更新のフロー
- WebSocketイベント送信は状態更新成功後

## 📝 **実装成果**

### **作成ファイル**
1. **`server/api/v1/admin/front-desk/checkin.post.ts`**
   - hotel-common API統合
   - WebSocketイベント送信
   - エラーハンドリング

2. **`composables/useDeviceCheckin.ts`**
   - 端末状態管理
   - ウェルカムムービー制御
   - WebSocket接続管理

3. **`pages/device-checkin-test.vue`**
   - エミュレーション検証用テストページ
   - リアルタイム状態監視
   - API テスト機能

### **機能特徴**
- ✅ 統合チェックインフロー
- ✅ WebSocketイベント「GUEST_CHECKIN」
- ✅ 端末状態管理（永続化対応）
- ✅ ウェルカムムービー再生（全画面・スキップ対応）
- ✅ エミュレーション検証機能

## 🧪 **検証方法**

### **エミュレーション検証**
1. テストページアクセス: `http://localhost:3100/device-checkin-test`
2. WebSocket接続状態確認
3. チェックインAPI テスト実行
4. ウェルカムムービー再生確認
5. 状態変化ログ監視

### **実機検証（将来）**
- 客室端末での `useDeviceCheckin()` 使用
- 管理画面からのチェックイン操作
- 自動的な端末制御とムービー再生

## 🔄 **今後の拡張計画**

### **PMSとの統合**
- 予約ベースチェックインでも同じフロー
- 統一されたWebSocketイベント
- 一貫したUI/UX

### **追加機能**
- 多言語ウェルカムムービー
- ゲスト情報に基づくパーソナライズ
- チェックイン完了通知
- デバイス制御ログの記録

## ✅ **決定事項サマリ**

1. **技術スタック**: WebSocket + Composable + hotel-common API
2. **実装方針**: エミュレーション優先、段階的実機対応
3. **検証方法**: 専用テストページでの包括的検証
4. **拡張性**: PMS統合・多言語対応を考慮した設計

## 📋 **次回アクション**

- [ ] 実機環境での動作確認
- [ ] ウェルカムムービーファイルの準備
- [ ] 多言語対応の検討
- [ ] PMSとの統合仕様策定
