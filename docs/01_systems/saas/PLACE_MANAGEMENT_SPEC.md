# プレイス管理機能 仕様書

## 概要

ホテルの客室、飲食店の客席とデバイスを結びつけ、属性別グルーピングによる統計・分析機能を提供するプレイス管理システム。

## 目的

- 既存のデバイス管理を拡張し、より柔軟なプレイス（場所）管理を実現
- プレイスタイプ、グループ分類による統計・分析基盤の構築
- 導入先ごとの自由な設定・カスタマイズを可能にする

## データベース設計

### 新規テーブル

#### PlaceType（プレイスタイプ）
```sql
- id: 主キー
- name: タイプ名（ユニーク）例：「客室」「レストラン席」「会議室」
- description: 説明
- color: UI表示用の色コード
- icon: アイコン名
- order: 表示順序
- isActive: 有効フラグ
- 作成・更新・削除フラグ
```

#### Place（プレイス）
```sql
- id: 主キー
- code: 識別コード（ユニーク）例：「301」「A-12」
- name: 表示名 例：「301号室」「テーブルA-12」
- placeTypeId: プレイスタイプID（外部キー）
- description: 説明
- attributes: 自由設定可能な属性（JSON）
- floor: 階数
- capacity: 収容人数
- area: 面積
- order: 表示順序
- isActive: 有効フラグ
- 作成・更新・削除フラグ
```

#### PlaceGroup（プレイスグループ）
```sql
- id: 主キー
- name: グループ名 例：「VIPフロア」「禁煙席」「窓側席」
- description: 説明
- color: UI表示用の色コード
- order: 表示順序
- isActive: 有効フラグ
- 作成・更新・削除フラグ
```

#### PlaceGroupMember（グループメンバー）
```sql
- id: 主キー
- placeId: プレイスID（外部キー）
- groupId: グループID（外部キー）
- order: グループ内表示順序
- createdAt: 作成日時
```

### 既存テーブル拡張

#### DeviceRoom
```sql
+ placeId: プレイスID（外部キー、NULL許可）
```

## データ移行方針

### Phase 1: 基本データ作成

1. **デフォルトプレイスタイプの作成**
   ```javascript
   {
     name: "客室",
     description: "ホテル客室",
     color: "#3B82F6",
     icon: "bed",
     order: 1
   }
   ```

2. **既存DeviceRoomからPlaceへの自動変換**
   ```javascript
   // roomId: "301" → Place: { code: "301", name: "301号室" }
   // roomId: "999" → Place: { code: "999", name: "999号室" }
   ```

3. **DeviceRoomとPlaceの関連付け**
   - 既存のDeviceRoomレコードに対応するPlaceのIDを設定

### Phase 2: データ整合性確保

- 全てのDeviceRoomが適切なPlaceに関連付けられていることを確認
- 重複するroomIdの処理
- 無効なデータのクリーンアップ

## 機能要件

### Phase 1: 基本CRUD機能

#### プレイスタイプ管理 (`/admin/place-types`)
- **一覧表示**: アクティブなプレイスタイプを表示順序で表示
- **作成**: 新しいプレイスタイプの作成
- **編集**: 既存プレイスタイプの編集
- **削除**: ソフトデリート（関連プレイスがある場合は削除不可）
- **並び替え**: ドラッグ&ドロップによる表示順序変更

#### プレイス管理 (`/admin/places`)
- **一覧表示**: 
  - プレイスタイプ別フィルタリング
  - グループ別フィルタリング
  - 検索機能（コード、名前）
  - ページネーション
- **作成**: 新しいプレイスの作成
- **編集**: 既存プレイスの編集
- **削除**: ソフトデリート（関連デバイスがある場合は削除不可）
- **一括操作**: 複数プレイスの一括編集・削除
- **デバイス関連付け**: プレイスとデバイスの関連付け管理

#### プレイスグループ管理 (`/admin/place-groups`)
- **一覧表示**: アクティブなグループを表示順序で表示
- **作成**: 新しいグループの作成
- **編集**: 既存グループの編集
- **削除**: ソフトデリート
- **メンバー管理**: グループへのプレイス追加・削除

### Phase 2: 統計・分析機能（後日実装）
- プレイス別売上統計
- グループ別分析
- 利用率分析
- レポート機能

## API設計

### プレイスタイプAPI
```
GET    /api/admin/place-types          # 一覧取得
POST   /api/admin/place-types          # 作成
GET    /api/admin/place-types/:id      # 詳細取得
PUT    /api/admin/place-types/:id      # 更新
DELETE /api/admin/place-types/:id      # 削除
PUT    /api/admin/place-types/reorder  # 並び替え
```

### プレイスAPI
```
GET    /api/admin/places               # 一覧取得
POST   /api/admin/places               # 作成
GET    /api/admin/places/:id           # 詳細取得
PUT    /api/admin/places/:id           # 更新
DELETE /api/admin/places/:id           # 削除
PUT    /api/admin/places/bulk          # 一括更新
```

### プレイスグループAPI
```
GET    /api/admin/place-groups         # 一覧取得
POST   /api/admin/place-groups         # 作成
GET    /api/admin/place-groups/:id     # 詳細取得
PUT    /api/admin/place-groups/:id     # 更新
DELETE /api/admin/place-groups/:id     # 削除
POST   /api/admin/place-groups/:id/members    # メンバー追加
DELETE /api/admin/place-groups/:id/members/:placeId # メンバー削除
```

## UI/UX設計

### 管理画面構成

#### サイドバーメニュー
```
📍 プレイス管理
  ├── プレイス一覧 (/admin/places)
  ├── プレイスタイプ (/admin/place-types)
  └── プレイスグループ (/admin/place-groups)
```

#### プレイス一覧画面
- **フィルター**: プレイスタイプ、グループ、アクティブ状態
- **検索**: コード、名前での検索
- **表示項目**: コード、名前、タイプ、グループ、デバイス数、状態
- **アクション**: 編集、削除、デバイス管理

#### プレイス編集画面
- **基本情報**: コード、名前、タイプ、説明
- **詳細情報**: 階数、収容人数、面積
- **属性設定**: JSON形式での自由属性設定
- **グループ設定**: 所属グループの選択
- **デバイス関連付け**: 関連デバイスの管理

### レスポンシブ対応
- デスクトップ: テーブル表示
- タブレット: カード表示
- モバイル: リスト表示

## セキュリティ要件

- 管理画面へのアクセス制御
- CSRF対策
- 入力値検証
- SQLインジェクション対策

## パフォーマンス要件

- 一覧表示: 1000件まで快適に表示
- 検索機能: 500ms以内でレスポンス
- 一括操作: 100件まで同時処理可能

## 実装優先順位

### Phase 1: 基本機能（今回実装）
1. データベーススキーマ適用
2. データ移行スクリプト作成・実行
3. プレイスタイプ管理機能
4. プレイス管理機能
5. プレイスグループ管理機能
6. 既存デバイス管理画面の統合

### Phase 2: 拡張機能（後日実装）
1. 統計・分析機能
2. レポート機能
3. 高度な検索・フィルタリング
4. インポート・エクスポート機能

## 注意事項

### データベース管理ルール遵守
- 単一データベースファイルの原則を維持
- Prismaクライアントを使用したデータ操作
- データ変更前のバックアップ実施

### 既存機能への影響
- 既存のデバイス認証機能は維持
- 注文システムとの連携は現状維持
- 段階的な移行でサービス停止を回避

## 成功指標

- 既存DeviceRoomデータの100%移行完了
- 管理画面での基本CRUD操作の正常動作
- 既存機能（注文、デバイス認証）の正常動作維持
- レスポンス時間の要件達成 