# docs/sync-log.md  
OmotenasuAI PMS "Tsukuyomi"  
データ同期処理のログ記録仕様・管理者UI方針

---

## 🎯 目的

このドキュメントは、Tsukuyomi PMS の**同期処理に関するログ構造・保管・表示設計**を定義します。  
通信環境が不安定な現場においても、「何がいつ失敗し、なぜ成功したのか」を記録・再確認できるようにすることが目的です。

---

## 📚 ログの種類と内容

| ログ種別 | 説明 | 記録レベル |
|----------|------|------------|
| 成功ログ | 正常にサーバーへ同期されたデータ | Info |
| エラーログ | 同期失敗（タイムアウト、400/500系） | Error |
| 警告ログ | 再送処理・競合発生など | Warn |
| 通信状態ログ | オフライン検知／復旧／再接続履歴 | Info |

---

## 🧱 ログ構造（JSON）

```json
{
  "logId": "a8c2e9b0-719d-41a4-b519-b2e8fae1b7c9",
  "timestamp": "2025-07-15T12:34:56+09:00",
  "userId": "front001",
  "deviceId": "FRONT_PC_1",
  "operation": "check_out",
  "status": "error",
  "errorCode": "SERVER_TIMEOUT",
  "message": "Server did not respond within 10 seconds.",
  "payloadSummary": {
    "roomNumber": "305",
    "total": 14800
  },
  "retryCount": 2,
  "synced": false
}
```

---

## 📁 ログ保存場所・期間

| 対象 | 保存先 | 保持期間 | 備考 |
|------|--------|----------|------|
| ローカル端末 | IndexedDB／SQLite | 90日間（自動ローテーション） | バックアップ可能 |
| クラウド同期 | MongoDB／ログ専用DB | 1年（管理者閲覧用） | 管理画面でフィルタ可 |

---

## 📊 管理者用ログ閲覧UI（予定）

| 項目 | 説明 |
|------|------|
| フィルター | 日付、ユーザーID、ステータス（成功／失敗） |
| 一覧表示 | 操作名、部屋番号、時刻、結果、デバイス名 |
| 詳細表示 | JSON構造でペイロード確認＋再送リンク |
| エクスポート | CSV形式でのダウンロード機能（管理者のみ） |
| ソート機能 | タイムスタンプ／ユーザー／部屋番号順など |

---

## 🔁 再送・リカバリ機能との連携

- 同期失敗ログには「🔁再送信」ボタン付き（queue-state-ui.md と連携）
- エラー種別ごとに復旧アドバイスを表示（例：401 → ログインし直し）

---

## 🔐 セキュリティ設計

| 項目 | 方針 |
|------|------|
| ログへのアクセス | 管理者ロールのみ（フロントでは不可） |
| ユーザーIDマスキング | 一般スタッフが見られる画面では匿名化表示 |
| 改ざん防止 | ログにはUUID／署名付きで整合性チェック実施予定 |

---

## 🔔 通知連携（ログトリガー）

- **エラーログが一定件数以上発生**：
  - 「システム通知」＋管理者向けLINE/メール通知
  - 短時間に多数の通信失敗 → 「ネットワーク障害の可能性あり」警告バナー

---

## 📈 将来的な拡張（Phase 3 以降）

- ダッシュボードでの可視化（棒グラフ／ヒートマップ）
- **「同期健全性スコア」**の自動算出（過去7日間の成功率など）
- 異常検知AIによるレポート自動生成（例：深夜帯にだけ失敗率が高い等）

---

## 🧪 開発者向け備考

- ログ表示UIは console.log ベースの開発時ログとは完全に分離
- 開発・ステージング環境ではDEBUG=true時のみ詳細出力可
- API連携：POST /logs/sync にてサーバー側へ送信（バッチ or リアルタイム）

--- 