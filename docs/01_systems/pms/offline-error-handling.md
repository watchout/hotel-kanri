# オフライン運用時のエラー処理・通知仕様定義

## OmotenasuAI PMS "Tsukuyomi"  
オフライン運用時のエラー処理・通知仕様定義

---

## 🎯 目的

このドキュメントは、Tsukuyomi PMS において発生しうる**オフライン状態や通信障害時のエラー種別とその対応方法**を定義します。

フロント業務・会計処理・同期動作に影響するリスクを最小化し、  
**「通信が不安定でも業務が止まらない」**という運用信頼性を実現するための指針とします。

---

## 🔎 エラー分類と概要

| エラー分類 | 発生タイミング | 代表的な原因 |
|------------|----------------|--------------|
| **通信断検知** | ログイン時・同期時 | ネットワーク切断、ルータ障害 |
| **API失敗** | 同期中・再送時 | サーバーダウン、タイムアウト |
| **認証エラー** | トークン期限切れ | ログイン情報失効、オフライン長期利用 |
| **書き込み失敗** | IndexedDB/SQLite破損 | ローカルDB破損、容量超過 |
| **バージョン不整合** | schema差異 | サーバーとローカルアプリの整合性喪失 |

---

## 🚨 各エラーのUI表示・処理方針

### 1. 通信断エラー（navigator.onLine = false）

| 内容 | 対応方法 |
|------|----------|
| **通信断検知時** | 画面上に「🔌 オフライン中」バナー常時表示（赤色） |
| **操作時** | オフライン対応機能は通常動作<br>それ以外は「オフライン中のため一時使用不可」とグレーアウト |
| **復旧時** | 自動で「🔁 オンライン接続を検知しました」バナー表示し、同期開始 |

---

### 2. API同期失敗（送信エラー）

| 内容 | 対応方法 |
|------|----------|
| **サーバーエラー（5xx）** | リトライ3回＋失敗記録（キューに残す） |
| **タイムアウト** | 同様に保留・ログ表示 |
| **UI** | 「同期エラーがあります」通知アイコン＋詳細確認画面へリンク表示 |
| **再送** | 手動で再送ボタン表示（キュー画面から） |

---

### 3. 認証トークン失効

| 内容 | 対応方法 |
|------|----------|
| **トークン有効期限切れ** | オフライン時でも一時的に操作継続可（**ローカルPIN認証を導入予定**） |
| **UI** | 「セッション期限が切れています。再接続時に自動再ログインを行います。」と表示 |
| **再接続時** | サイレント再認証 or ログイン再入力（設定による） |

---

### 4. ローカルDBエラー（書き込み失敗）

| 内容 | 対応方法 |
|------|----------|
| **IndexedDBエラー** | try/catchで捕捉 → 再試行 or 再構築をユーザーに提案 |
| **容量超過** | エラーバナー「保存領域がいっぱいです。古いデータの削除を検討してください」 |
| **UI** | 管理画面から「ローカルデータ初期化」「エクスポート」など操作可能にする予定 |

---

### 5. バージョン不整合（スキーマ不一致）

| 内容 | 対応方法 |
|------|----------|
| **ローカルDBバージョンが古い** | 起動時に検知 → バージョン警告＋アップデート促進 |
| **同期時にバージョン不一致** | エラー内容表示＋アップデート誘導 |
| **UI** | 「この端末のデータ構造が古いため、同期できません。最新バージョンにアップデートしてください」など表示 |

---

## 🔔 通知・アラート設計（エラー時）

| 種類 | 表示方法 | 備考 |
|------|-----------|------|
| **通信断検知** | フッター／ヘッダー常時表示（赤） | 通知センターにも記録 |
| **同期失敗** | 「未同期データがあります」ポップアップ通知 | 詳細画面あり |
| **認証エラー** | モーダル or スライド表示で再認証を促す | 通常操作は継続可能 |
| **DBエラー** | 即時バナー表示 | 修復方法の案内リンク付き |

---

## 🧠 エラー時の業務継続方針（Fail-Safe設計）

| 機能 | 通信断中の対応方針 |
|------|------------------|
| **チェックイン／アウト** | **完全ローカル処理可（同期保留）** |
| **日報入力** | ローカル保存→復旧時に一括同期 |
| **客室状況表示** | キャッシュで表示、更新もローカル反映 |
| **帳票出力** | ローカルからPDF出力可能（プリンタ接続） |
| **アラート通知** | 一時保留 → 復旧時に通知送信 |

---

## ✅ 補足：障害対応フロー例

```plaintext
[ネットワーク断検知]
    ↓
[画面に「オフライン中」バナー表示]
    ↓
[通常操作継続（ローカルDBへ保存）]
    ↓
[通信復旧検知]
    ↓
[同期プロセス起動 → 成功 or エラー振り分け]
    ↓
[失敗時は通知アイコン＋手動再送ボタン表示]
```

---

## 📌 将来的な改善アイデア（Phase 2以降）

- **ローカルキャッシュ状況を可視化するダッシュボード**
- **DB自己修復ルーチン（自動復元提案）**
- **AIによる「異常パターン予測と先回りガイド」** 