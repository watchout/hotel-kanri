# 🔐 ログインシステム強化計画書 v1.0

## OmotenasuAI PMS "Tsukuyomi" ログイン方式改善計画

**作成日**: 2025-01-17  
**対象**: Phase 1.5 ログインシステム強化  
**根拠**: ホテル現場ヒアリング結果

---

## 🎯 ヒアリング結果サマリー

### 📋 現在の実装課題

| 課題項目 | 現状 | 影響度 | 緊急度 |
|----------|------|--------|--------|
| **PINのみ認証** | 4桁PIN単体での認証 | ★★★★★ | ★★★★★ |
| **重複PIN問題** | 複数スタッフが同じPINを使用可能 | ★★★★☆ | ★★★★★ |
| **識別不全** | 操作者の特定ができない | ★★★★★ | ★★★★☆ |
| **操作ログ精度不足** | PIN単位の記録のみ | ★★★★☆ | ★★★☆☆ |
| **権限管理不十分** | レベル別制御が未実装 | ★★★☆☆ | ★★★☆☆ |

### 🗣 ホテル現場の声（分類別）

#### 🏩 レジャーホテル系（バリアン系）
- **課題**: 「PINが被って後から操作した人が誰か分からないことがある」
- **要望**: 「スタッフの顔写真一覧からタップしてPINを入れたい」
- **優先機能**: 視覚的スタッフ選択、操作者特定

#### 🏨 ビジネスホテル系（アパ・東横INN系）  
- **課題**: 「深夜帯は学生1人で回していて、ログが残らないのが困る」
- **要望**: 「カードリーダーまでは無理だから、番号＋PINでまずは個人識別を」
- **優先機能**: 個人識別、操作履歴管理

#### 🏢 高級ホテル系（帝国ホテル系）
- **課題**: 「派遣・契約・社員など多様なスタッフ構成なので権限分離が必須」
- **要望**: 「VIP情報の閲覧記録などまで監査対象にしたい」
- **優先機能**: 詳細権限制御、監査ログ

#### 🧑‍🔧 全ホテル共通要望
- スタッフID/PINの変更・履歴管理の柔軟性
- 再雇用時の識別情報引き継ぎ
- 紙ベースのPIN管理からの脱却

---

## 🚨 問題分析フェーズ

### 根本原因分析
1. **認証方式の限界**: PIN単体では一意性が保証できない
2. **UI設計の問題**: 顔写真などの視覚的要素が不足
3. **データ設計の不備**: スタッフ識別情報の不足
4. **ログ設計の不完全**: 個人単位の操作追跡ができない

### 影響範囲
- **即座の影響**: 操作者不明、責任の所在不明確
- **中期的影響**: 監査対応困難、セキュリティリスク
- **長期的影響**: コンプライアンス違反、信頼性低下

### 緊急度評価
- **最高優先**: PINのみ認証の解決
- **高優先**: 操作ログ強化
- **中優先**: 権限制御強化
- **低優先**: 顔認証・ICカード（将来実装）

---

## 🎯 解決策検討フェーズ

### Phase 1.5 実装要件

#### 1️⃣ **スタッフ番号 + PIN方式**（必須度: ★★★★★）
```typescript
interface StaffAuth {
  staff_number: string;    // S001, S002等の固有識別子
  pin: string;            // 4-6桁の個人PIN
  display_name: string;   // 表示用氏名
  photo_url?: string;     // 顔写真URL（任意）
}
```

#### 2️⃣ **視覚的ログインUI**（必須度: ★★★★☆）
- スタッフ一覧表示（顔写真付き）
- タップ選択 → PIN入力の2段階認証
- タッチデバイス最適化

#### 3️⃣ **操作ログ強化**（必須度: ★★★★★）

> **📋 更新履歴 (2025年1月27日)**  
> **客室状態変更ログの詳細化対応** - hotel-common統合管理による更新  
> 詳細仕様: [客室状態変更ログ統合仕様書](/Users/kaneko/hotel-common/docs/integration/specifications/room-operation-log-specification.md)

```typescript
interface OperationLog {
  id: string;
  staff_id: string;       // スタッフ一意識別子
  staff_number: string;   // スタッフ番号
  operation: string;      // 操作内容
  target_data?: any;      // 操作対象データ
  timestamp: Date;        // 操作日時
  ip_address?: string;    // 接続元IP
  session_id: string;     // セッション識別子
}
```

#### **v2.0 客室操作ログ連携対応 (2025年1月27日追加)**

**詳細な客室操作アクション**:
- 清掃関連: `ROOM_CLEANING_START`, `ROOM_CLEANING_COMPLETE`, `ROOM_CLEANING_INSPECTION`, `ROOM_CLEANING_FAILED`
- メンテナンス関連: `ROOM_MAINTENANCE_START`, `ROOM_MAINTENANCE_COMPLETE`, `ROOM_REPAIR_REQUEST`, `ROOM_REPAIR_COMPLETE`
- 客室管理関連: `ROOM_BLOCK`, `ROOM_UNBLOCK`, `ROOM_OUT_OF_ORDER`, `ROOM_BACK_IN_SERVICE`
- 業務操作関連: `ROOM_INSPECTION`, `ROOM_SETUP_COMPLETE`, `ROOM_AMENITY_RESTOCK`, `ROOM_DEEP_CLEANING`

**hotel-common連携**: 客室操作時に自動的にhotel-commonへログ送信し、統合的なログ管理を実現（v2.0: details.staff_id は必須、staff_name は送信しない）

#### 4️⃣ **権限レベル分離**（必須度: ★★★★☆）
```typescript
enum PermissionLevel {
  STAFF = 1,      // 基本操作（チェックイン・アウト）
  SUPERVISOR = 2, // 主任（日報、一部管理機能）  
  MANAGER = 3,    // マネージャー（全管理機能）
  ADMIN = 4       // システム管理者（全権限）
}
```

### Phase 2 将来実装

#### 5️⃣ **ハードウェア認証**（必須度: ★★☆☆☆）
- ICカードリーダー連携
- 顔認証システム連携
- 生体認証（指紋等）

#### 6️⃣ **統合認証**（必須度: ★★★☆☆）
- hotel-common JWT基盤との統合
- シングルサインオン（SSO）
- hotel-member・hotel-saas連携

---

## 🚧 実装計画フェーズ

### 実行前確認事項

#### データベース影響
- **staff テーブル拡張**: `staff_number`, `photo_url` カラム追加
- **operation_logs テーブル新規作成**: 操作ログ専用テーブル
- **既存データ移行**: 現在のPINベースデータの変換

#### UI/UX変更範囲
- **Login.vue 大幅改修**: スタッフ選択画面の追加
- **認証フロー変更**: 2段階認証の実装
- **ダッシュボード**: ログイン中スタッフ表示の改善

#### API・ストア変更
- **auth.ts**: 認証ロジックの全面見直し
- **新規store**: operationLogs.ts の作成
- **権限チェック**: コンポーネント全体での権限制御実装

### 実装スケジュール（Phase 1.5）

| Week | 実装項目 | 担当・備考 |
|------|----------|------------|
| **Week 1** | ① 緊急修正（Tailwind CSS） | 開発環境安定化 |
|            | ② データベース設計・拡張 | スキーマ変更・マイグレーション |
| **Week 2** | ③ スタッフ管理機能強化 | 番号割り当て・写真管理 |
|            | ④ ログイン画面改修 | 2段階認証UI実装 |
| **Week 3** | ⑤ 操作ログ機能実装 | ログ記録・表示機能 |
|            | ⑥ 権限制御強化 | レベル別アクセス制御 |
| **Week 4** | ⑦ テスト・調整 | 統合テスト・UI調整 |
|            | ⑧ ドキュメント更新 | 運用マニュアル作成 |

### リスク評価・対策

| リスク項目 | 確率 | 影響度 | 対策 |
|------------|------|--------|------|
| **データ移行失敗** | 中 | 高 | バックアップ必須・段階的移行 |
| **UI変更によるユーザー混乱** | 高 | 中 | デモモード・段階的切替 |
| **認証ロジックのバグ** | 中 | 高 | 十分なテストケース作成 |
| **パフォーマンス劣化** | 低 | 中 | 操作ログの非同期処理 |

---

## 📊 成功指標（KPI）

### 定量指標
- **識別精度**: 100%（スタッフ番号での一意特定）
- **操作ログ取得率**: 100%（全操作の記録）
- **ログイン時間**: 10秒以内（2段階認証込み）
- **エラー率**: 1%未満（認証エラー・UI操作エラー）

### 定性指標
- **現場満足度**: ヒアリング要望の90%以上対応
- **運用改善**: 責任者特定にかかる時間の大幅短縮
- **セキュリティ向上**: 監査対応の完全性確保

---

## 🔗 関連ドキュメント

- [database-schema.md](./database-schema.md) - データベース設計詳細
- [integration-requirements-questions.md](./integration-requirements-questions.md) - システム連携要件
- [phase-1-use-case-definition.md](./phase-1-use-case-definition.md) - Phase 1 要件定義
- [offline-error-handling.md](./offline-error-handling.md) - エラー処理仕様

---

**承認者**: プロジェクトマネージャー  
**レビュー予定**: 実装開始前  
**更新責任者**: 開発チームリーダー 