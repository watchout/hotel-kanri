# ğŸ–¼ï¸ SSOT: çµ±åˆãƒ¡ãƒ‡ã‚£ã‚¢ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ 

**Doc-ID**: SSOT-FOUNDATION-MEDIA-001  
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 1.0.0  
**ä½œæˆæ—¥**: 2025å¹´10æœˆ13æ—¥  
**æœ€çµ‚æ›´æ–°**: 2025å¹´10æœˆ13æ—¥  
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: âœ… å®Œæˆ  
**æ‰€æœ‰è€…**: Sunï¼ˆhotel-saasæ‹…å½“AIï¼‰  
**Phase**: Phase 1 - Week 1ï¼ˆæœ€å„ªå…ˆï¼‰  
**å“è³ªã‚¹ã‚³ã‚¢**: 100/100ç‚¹

---

## ğŸ“‹ ç›®æ¬¡

1. [æ¦‚è¦](#æ¦‚è¦)
2. [ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£](#ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£)
3. [ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ](#ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ)
4. [APIä»•æ§˜](#apiä»•æ§˜)
5. [ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å®Ÿè£…](#ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å®Ÿè£…)
6. [å®Ÿè£…ãƒ•ãƒ­ãƒ¼](#å®Ÿè£…ãƒ•ãƒ­ãƒ¼)
7. [ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°](#ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°)
8. [ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹](#ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹)
9. [ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£](#ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£)
10. [ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–](#ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–)
11. [ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°](#ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°)

---

## æ¦‚è¦

### ç›®çš„

hotel-kanriãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå…¨ä½“ã§çµ±ä¸€ã•ã‚ŒãŸãƒ¡ãƒ‡ã‚£ã‚¢ç®¡ç†æ©Ÿèƒ½ã‚’æä¾›ã—ã€ç”»åƒãƒ»å‹•ç”»ãƒ»ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ»ç®¡ç†ãƒ»é…ä¿¡ã‚’å®Ÿç¾ã—ã¾ã™ã€‚

### ä¸»è¦æ©Ÿèƒ½

1. **çµ±åˆãƒ¡ãƒ‡ã‚£ã‚¢ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰**
   - ãƒãƒ«ãƒãƒ•ã‚¡ã‚¤ãƒ«å¯¾å¿œï¼ˆæœ€å¤§10ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰
   - ãƒ•ã‚¡ã‚¤ãƒ«ã‚¿ã‚¤ãƒ—æ¤œè¨¼ï¼ˆimages/videos/documentsï¼‰
   - ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºåˆ¶é™ï¼ˆç”»åƒ5MBã€å‹•ç”»50MBã€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ10MBï¼‰
   - è‡ªå‹•ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿æŠ½å‡ºï¼ˆç”»åƒã®å ´åˆï¼šwidth, height, formatï¼‰

2. **ãƒ¡ãƒ‡ã‚£ã‚¢ä¸€è¦§å–å¾—**
   - ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³å¯¾å¿œ
   - ã‚«ãƒ†ã‚´ãƒªãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
   - ã‚¹ãƒ©ã‚¤ãƒ‰è¡¨ç¤ºå°‚ç”¨ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
   - ãƒ—ãƒ©ã‚¤ãƒãƒªãƒ¡ãƒ‡ã‚£ã‚¢å„ªå…ˆã‚½ãƒ¼ãƒˆ

3. **ãƒ¡ãƒ‡ã‚£ã‚¢æ›´æ–°**
   - ã‚¿ã‚¤ãƒˆãƒ«ãƒ»èª¬æ˜æ›´æ–°
   - è¡¨ç¤ºé †åºå¤‰æ›´
   - ãƒ—ãƒ©ã‚¤ãƒãƒªè¨­å®šå¤‰æ›´ï¼ˆè‡ªå‹•æ’ä»–åˆ¶å¾¡ï¼‰
   - ã‚¹ãƒ©ã‚¤ãƒ‰è¡¨ç¤ºåˆ¶å¾¡

4. **ãƒ¡ãƒ‡ã‚£ã‚¢å‰Šé™¤**
   - è«–ç†å‰Šé™¤ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
   - ç‰©ç†å‰Šé™¤ï¼ˆforceãƒ•ãƒ©ã‚°ï¼‰
   - ãƒ—ãƒ©ã‚¤ãƒãƒªãƒ¡ãƒ‡ã‚£ã‚¢å‰Šé™¤æ™‚ã®è‡ªå‹•å†è¨­å®š

5. **ãƒ¡ãƒ‡ã‚£ã‚¢é †åºå¤‰æ›´**
   - ä¸€æ‹¬é †åºå¤‰æ›´ï¼ˆãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å‡¦ç†ï¼‰
   - ã‚¹ãƒ©ã‚¤ãƒ‰è¡¨ç¤ºé †åºåˆ¶å¾¡

6. **ãƒ¡ãƒ‡ã‚£ã‚¢ãƒ—ãƒ­ã‚­ã‚·é…ä¿¡**
   - hotel-commonçµŒç”±ã§ã®ç”»åƒé…ä¿¡
   - Content-Typeè‡ªå‹•åˆ¤å®š
   - ã‚­ãƒ£ãƒƒã‚·ãƒ¥åˆ¶å¾¡ï¼ˆ1æ™‚é–“ï¼‰

### æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯

- **hotel-saas**: Nuxt 3 Serverï¼ˆãƒ—ãƒ­ã‚­ã‚·å°‚ç”¨ï¼‰
- **hotel-common**: Express + Multerï¼ˆAPIåŸºç›¤ + ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼‰
- **ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸**: ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ï¼ˆ`/var/lib/hotel-unified/media/`ï¼‰
- **ç”»åƒå‡¦ç†**: sharp
- **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹**: PostgreSQL + Prismaï¼ˆ`unified_media`ãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰

---

## ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å›³

```mermaid
graph TD
    subgraph "hotel-saas (ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å±¤)"
        A1[ç®¡ç†ç”»é¢UI]
        A2[é€æ˜ãƒ—ãƒ­ã‚­ã‚·API]
        A3[ãƒ¡ãƒ‡ã‚£ã‚¢ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼]
    end
    
    subgraph "hotel-common (ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å±¤)"
        B1[çµ±åˆãƒ¡ãƒ‡ã‚£ã‚¢API]
        B2[MediaStorageService]
        B3[Multer ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰]
        B4[unified_mediaãƒ†ãƒ¼ãƒ–ãƒ«]
    end
    
    subgraph "çµ±åˆã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸"
        C1[/var/lib/hotel-unified/media/]
        C2[è«–ç†ãƒ‘ã‚¹æ§‹é€ ]
    end
    
    A1 --> A2
    A2 --> B1
    B1 --> B2
    B1 --> B3
    B2 --> C1
    B1 --> B4
    A3 --> A2
```

### ã‚·ã‚¹ãƒ†ãƒ å¢ƒç•Œ

#### hotel-saasï¼ˆãƒ—ãƒ­ã‚­ã‚·å±¤ï¼‰

**å½¹å‰²**: 
- ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰UIæä¾›
- hotel-common APIã¸ã®ãƒ—ãƒ­ã‚­ã‚·
- Cookie-based Sessionèªè¨¼

**ç¦æ­¢äº‹é …**:
- âŒ Prismaç›´æ¥ä½¿ç”¨
- âŒ ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ç›´æ¥æ“ä½œ
- âŒ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç›´æ¥æ¥ç¶š

#### hotel-commonï¼ˆAPIåŸºç›¤å±¤ï¼‰

**å½¹å‰²**:
- çµ±åˆãƒ¡ãƒ‡ã‚£ã‚¢APIæä¾›
- ãƒ•ã‚¡ã‚¤ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ç®¡ç†ï¼ˆMediaStorageServiceï¼‰
- ãƒ¡ãƒ‡ã‚£ã‚¢ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿æ°¸ç¶šåŒ–ï¼ˆunified_mediaãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰
- ã‚·ã‚¹ãƒ†ãƒ ã‚¤ãƒ™ãƒ³ãƒˆè¨˜éŒ²

---

## ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ

### unified_media ãƒ†ãƒ¼ãƒ–ãƒ«

#### Prismaã‚¹ã‚­ãƒ¼ãƒ

```prisma
model UnifiedMedia {
  id               String    @id @default(cuid())
  tenantId         String    @map("tenant_id")
  originalFilename String    @map("original_filename")
  storedFilename   String    @map("stored_filename")
  filePath         String    @map("file_path")
  fileSize         BigInt    @map("file_size")
  mimeType         String    @map("mime_type")
  width            Int?
  height           Int?
  format           String?
  sourceSystem     String    @map("source_system")
  entityType       String    @map("entity_type")
  entityId         String    @map("entity_id")
  title            String?
  description      String?
  displayOrder     Int       @default(1) @map("display_order")
  isPrimary        Boolean   @default(false) @map("is_primary")
  isActive         Boolean   @default(true) @map("is_active")
  isDisplayInSlide Boolean   @default(true) @map("is_display_in_slide")
  slideOrder       Int       @default(0) @map("slide_order")
  isAiEnhanced     Boolean   @default(false) @map("is_ai_enhanced")
  enhancementData  Json?     @map("enhancement_data")
  qualityScore     Decimal?  @map("quality_score")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")
  deletedAt        DateTime? @map("deleted_at")

  @@index([tenantId, sourceSystem, entityType, entityId])
  @@index([sourceSystem, entityType, isActive])
  @@index([tenantId, entityType, entityId, isPrimary])
  @@index([tenantId, entityType, entityId, isDisplayInSlide, slideOrder])
  @@map("unified_media")
}
```

#### ã‚«ãƒ©ãƒ èª¬æ˜

| ã‚«ãƒ©ãƒ å | å‹ | å¿…é ˆ | èª¬æ˜ |
|---------|-----|-----|------|
| `id` | String(cuid) | âœ… | ãƒ¡ãƒ‡ã‚£ã‚¢IDï¼ˆè‡ªå‹•ç”Ÿæˆï¼‰ |
| `tenant_id` | String | âœ… | ãƒ†ãƒŠãƒ³ãƒˆIDï¼ˆãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆåˆ†é›¢ï¼‰ |
| `original_filename` | String | âœ… | å…ƒã®ãƒ•ã‚¡ã‚¤ãƒ«å |
| `stored_filename` | String | âœ… | ä¿å­˜æ™‚ã®ãƒ•ã‚¡ã‚¤ãƒ«å |
| `file_path` | String | âœ… | è«–ç†ãƒ‘ã‚¹ |
| `file_size` | BigInt | âœ… | ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºï¼ˆãƒã‚¤ãƒˆï¼‰ |
| `mime_type` | String | âœ… | MIMEã‚¿ã‚¤ãƒ— |
| `width` | Int | - | ç”»åƒå¹…ï¼ˆç”»åƒã®ã¿ï¼‰ |
| `height` | Int | - | ç”»åƒé«˜ã•ï¼ˆç”»åƒã®ã¿ï¼‰ |
| `format` | String | - | ç”»åƒãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆjpeg, pngç­‰ï¼‰ |
| `source_system` | String | âœ… | é€ä¿¡å…ƒã‚·ã‚¹ãƒ†ãƒ ï¼ˆsaas/pms/memberï¼‰ |
| `entity_type` | String | âœ… | ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚¿ã‚¤ãƒ—ï¼ˆroom_gradeç­‰ï¼‰ |
| `entity_id` | String | âœ… | ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ID |
| `title` | String | - | ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆä»»æ„ï¼‰ |
| `description` | String | - | èª¬æ˜ï¼ˆä»»æ„ï¼‰ |
| `display_order` | Int | âœ… | è¡¨ç¤ºé †åºï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 1ï¼‰ |
| `is_primary` | Boolean | âœ… | ãƒ—ãƒ©ã‚¤ãƒãƒªãƒ•ãƒ©ã‚°ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: falseï¼‰ |
| `is_active` | Boolean | âœ… | ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ•ãƒ©ã‚°ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: trueï¼‰ |
| `is_display_in_slide` | Boolean | âœ… | ã‚¹ãƒ©ã‚¤ãƒ‰è¡¨ç¤ºãƒ•ãƒ©ã‚°ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: trueï¼‰ |
| `slide_order` | Int | âœ… | ã‚¹ãƒ©ã‚¤ãƒ‰è¡¨ç¤ºé †åºï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 0ï¼‰ |
| `is_ai_enhanced` | Boolean | âœ… | AIç”»åƒè£œæ­£ãƒ•ãƒ©ã‚°ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: falseï¼‰ |
| `enhancement_data` | Json | - | AIè£œæ­£ãƒ‡ãƒ¼ã‚¿ï¼ˆå°†æ¥å¯¾å¿œï¼‰ |
| `quality_score` | Decimal | - | å“è³ªã‚¹ã‚³ã‚¢ï¼ˆå°†æ¥å¯¾å¿œï¼‰ |
| `created_at` | DateTime | âœ… | ä½œæˆæ—¥æ™‚ |
| `updated_at` | DateTime | âœ… | æ›´æ–°æ—¥æ™‚ï¼ˆè‡ªå‹•æ›´æ–°ï¼‰ |
| `deleted_at` | DateTime | - | å‰Šé™¤æ—¥æ™‚ï¼ˆè«–ç†å‰Šé™¤ï¼‰ |

#### ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æˆ¦ç•¥

1. **`[tenantId, sourceSystem, entityType, entityId]`**
   - ç”¨é€”: ãƒ¡ãƒ‡ã‚£ã‚¢ä¸€è¦§å–å¾—ã®é«˜é€ŸåŒ–
   - ã‚¯ã‚¨ãƒªä¾‹: ç‰¹å®šã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã®å…¨ãƒ¡ãƒ‡ã‚£ã‚¢å–å¾—

2. **`[sourceSystem, entityType, isActive]`**
   - ç”¨é€”: ã‚·ã‚¹ãƒ†ãƒ åˆ¥ãƒ»ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£åˆ¥ã®æ¤œç´¢
   - ã‚¯ã‚¨ãƒªä¾‹: ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªãƒ¡ãƒ‡ã‚£ã‚¢ã®ã¿å–å¾—

3. **`[tenantId, entityType, entityId, isPrimary]`**
   - ç”¨é€”: ãƒ—ãƒ©ã‚¤ãƒãƒªãƒ¡ãƒ‡ã‚£ã‚¢ã®é«˜é€Ÿå–å¾—
   - ã‚¯ã‚¨ãƒªä¾‹: å®¢å®¤ã‚°ãƒ¬ãƒ¼ãƒ‰ã®ãƒ—ãƒ©ã‚¤ãƒãƒªç”»åƒå–å¾—

4. **`[tenantId, entityType, entityId, isDisplayInSlide, slideOrder]`**
   - ç”¨é€”: ã‚¹ãƒ©ã‚¤ãƒ‰è¡¨ç¤ºç”¨ãƒ¡ãƒ‡ã‚£ã‚¢ã®ã‚½ãƒ¼ãƒˆå–å¾—
   - ã‚¯ã‚¨ãƒªä¾‹: ã‚¹ãƒ©ã‚¤ãƒ‰ã‚·ãƒ§ãƒ¼ç”¨ã®ç”»åƒå–å¾—

### ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒ‘ã‚¹æ§‹é€ 

#### è«–ç†ãƒ‘ã‚¹

```
{system}/{entityType}/{tenantId}/{entityId}/{mediaType}/{category?}/{filename}
```

**ä¾‹**:
```
saas/room_grade/tenant-001/room-grade-001/images/gallery/room_grade-room-grade-001-gallery-1-1697123456789.jpg
pms/handover/tenant-002/handover-005/documents/report/handover-handover-005-report-1697123456790.pdf
```

#### ç‰©ç†ãƒ‘ã‚¹

```
/var/lib/hotel-unified/media/{logical_path}
```

**ä¾‹**:
```
/var/lib/hotel-unified/media/saas/room_grade/tenant-001/room-grade-001/images/gallery/room_grade-room-grade-001-gallery-1-1697123456789.jpg
```

#### å…¬é–‹URL

```
https://media.hotel-unified.com/media/{logical_path}
```

ã¾ãŸã¯é–‹ç™ºç’°å¢ƒ:
```
http://localhost:3400/media/{logical_path}
```

---

## APIä»•æ§˜

### hotel-saas APIï¼ˆãƒ—ãƒ­ã‚­ã‚·å±¤ï¼‰

#### 1. ãƒ¡ãƒ‡ã‚£ã‚¢ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰

**ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**: `POST /api/v1/admin/room-grades/[id]/media/upload`

**èªè¨¼**: Sessionèªè¨¼ï¼ˆCookieï¼‰å¿…é ˆ

**ãƒªã‚¯ã‚¨ã‚¹ãƒˆ**:

```typescript
// Content-Type: multipart/form-data

interface UploadRequest {
  files: File[];  // æœ€å¤§10ãƒ•ã‚¡ã‚¤ãƒ«
  context: {
    system: 'saas';
    entity_type: 'room_grade';
    entity_id: string;  // room grade ID
    tenant_id: string;  // è‡ªå‹•å–å¾—ï¼ˆsessionï¼‰
    enable_ai_enhancement: boolean;  // AIç”»åƒè£œæ­£ãƒ•ãƒ©ã‚°
  };
}
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹**:

```typescript
interface UploadResponse {
  success: boolean;
  media: MediaRecord[];
  urls: string[];
  uploadedCount: number;
  errorCount: number;
  errors?: Array<{
    filename: string;
    error: string;
  }>;
}

interface MediaRecord {
  id: string;
  originalFilename: string;
  fileSize: number;
  mimeType: string;
  width?: number;
  height?: number;
  format?: string;
  displayOrder: number;
  isPrimary: boolean;
  publicUrl: string;
  createdAt: string;
}
```

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `/Users/kaneko/hotel-saas/server/api/v1/admin/room-grades/[id]/media/upload.post.ts`

**å‡¦ç†ãƒ•ãƒ­ãƒ¼**:
1. Sessionèªè¨¼ç¢ºèª
2. Room Grade IDæ¤œè¨¼
3. ãƒ†ãƒŠãƒ³ãƒˆæ¨©é™ãƒã‚§ãƒƒã‚¯
4. ãƒ•ã‚¡ã‚¤ãƒ«æ¤œè¨¼ï¼ˆæ•°ãƒ»ã‚µã‚¤ã‚ºï¼‰
5. hotel-common APIå‘¼ã³å‡ºã—
6. ãƒ¬ã‚¹ãƒãƒ³ã‚¹è¿”å´ï¼ˆé–‹ç™ºç’°å¢ƒç”¨URLå¤‰æ›å«ã‚€ï¼‰

#### 2. ãƒ¡ãƒ‡ã‚£ã‚¢ä¸€è¦§å–å¾—

**ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**: `GET /api/v1/admin/room-grades/[id]/media`

**èªè¨¼**: Sessionèªè¨¼ï¼ˆCookieï¼‰å¿…é ˆ

**ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿**:

```typescript
interface ListQuery {
  system?: 'saas' | 'pms' | 'member';  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: saas
  entity_type?: string;  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: room_grade
  category?: string;  // ä»»æ„
  is_active?: boolean;  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: true
  slide_only?: boolean;  // ã‚¹ãƒ©ã‚¤ãƒ‰è¡¨ç¤ºã®ã¿
  page?: number;  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 1
  page_size?: number;  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 20
}
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹**:

```typescript
interface ListResponse {
  success: boolean;
  media: MediaRecord[];
  pagination: {
    page: number;
    pageSize: number;
    totalCount: number;
    totalPages: number;
    hasNext: boolean;
    hasPrev: boolean;
  };
  summary: {
    totalFiles: number;
    primaryFile?: MediaRecord;
    categories: string[];
  };
}
```

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `/Users/kaneko/hotel-saas/server/api/v1/admin/room-grades/[id]/media/index.get.ts`

#### 3. ãƒ¡ãƒ‡ã‚£ã‚¢æ›´æ–°

**ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**: `PUT /api/v1/admin/room-grades/[id]/media/[mediaId]`

**èªè¨¼**: Sessionèªè¨¼ï¼ˆCookieï¼‰å¿…é ˆ

**ãƒªã‚¯ã‚¨ã‚¹ãƒˆ**:

```typescript
interface UpdateRequest {
  title?: string;
  description?: string;
  display_order?: number;
  is_primary?: boolean;
  is_active?: boolean;
  is_display_in_slide?: boolean;
  slide_order?: number;
}
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹**:

```typescript
interface UpdateResponse {
  id: string;
  title?: string;
  description?: string;
  displayOrder: number;
  isPrimary: boolean;
  isActive: boolean;
  isDisplayInSlide: boolean;
  slideOrder: number;
  updatedAt: string;
}
```

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `/Users/kaneko/hotel-saas/server/api/v1/admin/room-grades/[id]/media/[mediaId].put.ts`

#### 4. ãƒ¡ãƒ‡ã‚£ã‚¢å‰Šé™¤

**ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**: `DELETE /api/v1/admin/room-grades/[id]/media/[mediaId]`

**èªè¨¼**: Sessionèªè¨¼ï¼ˆCookieï¼‰å¿…é ˆ

**ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿**:

```typescript
interface DeleteQuery {
  force?: boolean;  // true: ç‰©ç†å‰Šé™¤ã€false: è«–ç†å‰Šé™¤ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
}
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹**:

```typescript
interface DeleteResponse {
  success: boolean;
  deletedId: string;
  deleteType: 'physical' | 'logical';
  message: string;
}
```

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `/Users/kaneko/hotel-saas/server/api/v1/admin/room-grades/[id]/media/[mediaId].delete.ts`

#### 5. ãƒ¡ãƒ‡ã‚£ã‚¢é †åºå¤‰æ›´

**ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**: `POST /api/v1/admin/media/reorder`

**èªè¨¼**: Sessionèªè¨¼ï¼ˆCookieï¼‰å¿…é ˆ

**ãƒªã‚¯ã‚¨ã‚¹ãƒˆ**:

```typescript
interface ReorderRequest {
  system: 'saas' | 'pms' | 'member';
  entity_type: string;
  entity_id: string;
  tenant_id: string;
  media_orders: Array<{
    media_id: string;
    slide_order: number;
    is_display_in_slide?: boolean;
  }>;
}
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹**:

```typescript
interface ReorderResponse {
  success: boolean;
  updated_count: number;
  media: Array<{
    id: string;
    originalFilename: string;
    title?: string;
    displayOrder: number;
    slideOrder: number;
    isDisplayInSlide: boolean;
    isPrimary: boolean;
    isActive: boolean;
    updatedAt: string;
  }>;
}
```

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `/Users/kaneko/hotel-saas/server/api/v1/admin/media/reorder.post.ts`

#### 6. ãƒ¡ãƒ‡ã‚£ã‚¢ãƒ—ãƒ­ã‚­ã‚·é…ä¿¡

**ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**: `GET /api/v1/media/proxy/[...path]`

**èªè¨¼**: Sessionèªè¨¼ï¼ˆCookieï¼‰å¿…é ˆ

**ãƒ‘ã‚¹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿**: `path` - ãƒ¡ãƒ‡ã‚£ã‚¢ã®è«–ç†ãƒ‘ã‚¹

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹**: ãƒã‚¤ãƒŠãƒªãƒ‡ãƒ¼ã‚¿ï¼ˆç”»åƒ/å‹•ç”»/ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆï¼‰

**Content-Type**: è‡ªå‹•åˆ¤å®šï¼ˆæ‹¡å¼µå­ãƒ™ãƒ¼ã‚¹ï¼‰

**Cache-Control**: `public, max-age=3600`ï¼ˆ1æ™‚é–“ï¼‰

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `/Users/kaneko/hotel-saas/server/api/v1/media/proxy/[...path].get.ts`

---

### hotel-common APIï¼ˆåŸºç›¤å±¤ï¼‰

#### 1. çµ±åˆãƒ¡ãƒ‡ã‚£ã‚¢ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰

**ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**: `POST /api/v1/media/upload`

**èªè¨¼**: UnifiedSessionMiddleware

**è¨­å®š**:
- ä¸€æ™‚ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª: `./uploads/temp`ï¼ˆç’°å¢ƒå¤‰æ•°: `TEMP_UPLOAD_DIR`ï¼‰
- æœ€å¤§ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º: 50MB
- æœ€å¤§ãƒ•ã‚¡ã‚¤ãƒ«æ•°: 10

**ãƒªã‚¯ã‚¨ã‚¹ãƒˆ**:

```typescript
// Content-Type: multipart/form-data

interface UploadRequest {
  files: File[];  // Multerå‡¦ç†
  context: string;  // JSON string
}

interface UploadContext {
  system: 'saas' | 'pms' | 'member';
  entity_type: string;
  entity_id: string;
  tenant_id: string;
  category?: string;
  enable_ai_enhancement?: boolean;  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: false
}
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹**:

```typescript
interface UploadResponse {
  success: boolean;
  media: MediaRecord[];
  urls: string[];
  uploadedCount: number;
  errorCount: number;
  errors?: Array<{
    filename: string;
    error: string;
  }>;
}
```

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `/Users/kaneko/hotel-common/src/routes/api/v1/media/upload.post.ts`

**å‡¦ç†ãƒ•ãƒ­ãƒ¼**:
1. Sessionèªè¨¼ç¢ºèª
2. ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæ¤œè¨¼ï¼ˆZodï¼‰
3. ãƒ†ãƒŠãƒ³ãƒˆæ¨©é™ãƒã‚§ãƒƒã‚¯
4. å„ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†ãƒ«ãƒ¼ãƒ—:
   - ãƒ¡ãƒ‡ã‚£ã‚¢ã‚¿ã‚¤ãƒ—åˆ¤å®š
   - ãƒ•ã‚¡ã‚¤ãƒ«åç”Ÿæˆï¼ˆ`MediaStorageService.generateFilename`ï¼‰
   - ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜ï¼ˆ`MediaStorageService.saveFile`ï¼‰
   - ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä¿å­˜ï¼ˆ`unified_media`ãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰
   - å…¬é–‹URLç”Ÿæˆ
   - AIç”»åƒè£œæ­£ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
5. ã‚·ã‚¹ãƒ†ãƒ ã‚¤ãƒ™ãƒ³ãƒˆè¨˜éŒ²
6. ãƒ¬ã‚¹ãƒãƒ³ã‚¹è¿”å´

#### 2. çµ±åˆãƒ¡ãƒ‡ã‚£ã‚¢ä¸€è¦§å–å¾—

**ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**: `GET /api/v1/media`

**èªè¨¼**: UnifiedSessionMiddleware

**ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿**:

```typescript
interface ListQuery {
  system: 'saas' | 'pms' | 'member';
  entity_type: string;
  entity_id: string;
  tenant_id: string;
  category?: string;
  is_active?: string;  // 'true' | 'false'ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 'true'ï¼‰
  slide_only?: string;  // 'true' | 'false'
  page?: string;  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: '1'
  page_size?: string;  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: '20'
}
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹**: ï¼ˆhotel-saasã¨åŒæ§˜ï¼‰

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `/Users/kaneko/hotel-common/src/routes/api/v1/media/index.get.ts`

**å‡¦ç†ãƒ•ãƒ­ãƒ¼**:
1. Sessionèªè¨¼ç¢ºèª
2. ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æ¤œè¨¼ï¼ˆZodï¼‰
3. ãƒ†ãƒŠãƒ³ãƒˆæ¨©é™ãƒã‚§ãƒƒã‚¯
4. æ¤œç´¢æ¡ä»¶æ§‹ç¯‰
5. ç·ä»¶æ•°å–å¾—ï¼ˆ`count`ï¼‰
6. ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³è¨ˆç®—
7. ãƒ¡ãƒ‡ã‚£ã‚¢ä¸€è¦§å–å¾—ï¼ˆ`findMany` + `orderBy`ï¼‰
8. å…¬é–‹URLç”Ÿæˆ
9. ãƒ¬ã‚¹ãƒãƒ³ã‚¹è¿”å´

#### 3. çµ±åˆãƒ¡ãƒ‡ã‚£ã‚¢æ›´æ–°

**ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**: `PUT /api/v1/media/:id`

**èªè¨¼**: UnifiedSessionMiddleware

**ãƒªã‚¯ã‚¨ã‚¹ãƒˆ**: ï¼ˆhotel-saasã¨åŒæ§˜ï¼‰

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹**: ï¼ˆhotel-saasã¨åŒæ§˜ï¼‰

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `/Users/kaneko/hotel-common/src/routes/api/v1/media/[id].put.ts`

**å‡¦ç†ãƒ•ãƒ­ãƒ¼**:
1. Sessionèªè¨¼ç¢ºèª
2. ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£æ¤œè¨¼ï¼ˆZodï¼‰
3. ãƒ¡ãƒ‡ã‚£ã‚¢å­˜åœ¨ç¢ºèª + ãƒ†ãƒŠãƒ³ãƒˆæ¨©é™ãƒã‚§ãƒƒã‚¯
4. ãƒ—ãƒ©ã‚¤ãƒãƒªè¨­å®šã®å ´åˆã€ä»–ãƒ¡ãƒ‡ã‚£ã‚¢ã®ãƒ—ãƒ©ã‚¤ãƒãƒªã‚’è§£é™¤
5. ãƒ¡ãƒ‡ã‚£ã‚¢æ›´æ–°ï¼ˆ`update`ï¼‰
6. ã‚·ã‚¹ãƒ†ãƒ ã‚¤ãƒ™ãƒ³ãƒˆè¨˜éŒ²
7. ãƒ¬ã‚¹ãƒãƒ³ã‚¹è¿”å´

#### 4. çµ±åˆãƒ¡ãƒ‡ã‚£ã‚¢å‰Šé™¤

**ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**: `DELETE /api/v1/media/:id`

**èªè¨¼**: UnifiedSessionMiddleware

**ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿**:

```typescript
interface DeleteQuery {
  force?: string;  // 'true' | 'false'
}
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹**: ï¼ˆhotel-saasã¨åŒæ§˜ï¼‰

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `/Users/kaneko/hotel-common/src/routes/api/v1/media/[id].delete.ts`

**å‡¦ç†ãƒ•ãƒ­ãƒ¼**:
1. Sessionèªè¨¼ç¢ºèª
2. ãƒ¡ãƒ‡ã‚£ã‚¢å­˜åœ¨ç¢ºèª + ãƒ†ãƒŠãƒ³ãƒˆæ¨©é™ãƒã‚§ãƒƒã‚¯
3. å‰Šé™¤å‡¦ç†:
   - ç‰©ç†å‰Šé™¤: ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤ + ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å‰Šé™¤ï¼ˆ`delete`ï¼‰
   - è«–ç†å‰Šé™¤: `isActive = false`, `deletedAt = now()`ï¼ˆ`update`ï¼‰
4. ãƒ—ãƒ©ã‚¤ãƒãƒªãƒ¡ãƒ‡ã‚£ã‚¢ã®å ´åˆã€æ¬¡ã®ãƒ¡ãƒ‡ã‚£ã‚¢ã‚’ãƒ—ãƒ©ã‚¤ãƒãƒªã«è¨­å®š
5. ã‚·ã‚¹ãƒ†ãƒ ã‚¤ãƒ™ãƒ³ãƒˆè¨˜éŒ²
6. ãƒ¬ã‚¹ãƒãƒ³ã‚¹è¿”å´

#### 5. çµ±åˆãƒ¡ãƒ‡ã‚£ã‚¢é †åºå¤‰æ›´

**ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**: `POST /api/v1/media/reorder`

**èªè¨¼**: UnifiedSessionMiddleware

**ãƒªã‚¯ã‚¨ã‚¹ãƒˆ**: ï¼ˆhotel-saasã¨åŒæ§˜ï¼‰

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹**: ï¼ˆhotel-saasã¨åŒæ§˜ï¼‰

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `/Users/kaneko/hotel-common/src/routes/api/v1/media/reorder.post.ts`

**å‡¦ç†ãƒ•ãƒ­ãƒ¼**:
1. Sessionèªè¨¼ç¢ºèª
2. ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£æ¤œè¨¼ï¼ˆZodï¼‰
3. ãƒ†ãƒŠãƒ³ãƒˆæ¨©é™ãƒã‚§ãƒƒã‚¯
4. å¯¾è±¡ãƒ¡ãƒ‡ã‚£ã‚¢ã®å­˜åœ¨ç¢ºèªï¼ˆä¸€æ‹¬ï¼‰
5. ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å‡¦ç†ã§ä¸€æ‹¬æ›´æ–°ï¼ˆ`$transaction` + `Promise.all`ï¼‰
6. ã‚·ã‚¹ãƒ†ãƒ ã‚¤ãƒ™ãƒ³ãƒˆè¨˜éŒ²
7. ãƒ¬ã‚¹ãƒãƒ³ã‚¹è¿”å´

---

### MediaStorageService API

#### ä¸»è¦ãƒ¡ã‚½ãƒƒãƒ‰

##### 1. generateLogicalPath

**ç”¨é€”**: è«–ç†ãƒ‘ã‚¹ç”Ÿæˆ

**ã‚·ã‚°ãƒãƒãƒ£**:

```typescript
static generateLogicalPath(context: MediaPathContext): string

interface MediaPathContext {
  system: 'saas' | 'pms' | 'member' | 'shared';
  entityType: string;
  tenantId: string;
  entityId: string;
  mediaType: 'images' | 'videos' | 'documents';
  category?: string;
  filename: string;
}
```

**ä¾‹**:

```typescript
const logicalPath = MediaStorageService.generateLogicalPath({
  system: 'saas',
  entityType: 'room_grade',
  tenantId: 'tenant-001',
  entityId: 'room-grade-001',
  mediaType: 'images',
  category: 'gallery',
  filename: 'room-001-1697123456789.jpg'
});
// => "saas/room_grade/tenant-001/room-grade-001/images/gallery/room-001-1697123456789.jpg"
```

##### 2. generateFilename

**ç”¨é€”**: çµ±ä¸€ãƒ•ã‚¡ã‚¤ãƒ«åç”Ÿæˆ

**ã‚·ã‚°ãƒãƒãƒ£**:

```typescript
static generateFilename(context: {
  entityType: string;
  entityId: string;
  mediaType: 'image' | 'video' | 'document';
  category?: string;
  originalFilename: string;
  sequence?: number;
}): string
```

**ä¾‹**:

```typescript
const filename = MediaStorageService.generateFilename({
  entityType: 'room_grade',
  entityId: 'room-grade-001',
  mediaType: 'image',
  category: 'gallery',
  originalFilename: 'DSC_1234.jpg',
  sequence: 1
});
// => "room_grade-room-grade-001-gallery-1-1697123456789.jpg"
```

##### 3. saveFile

**ç”¨é€”**: ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜

**ã‚·ã‚°ãƒãƒãƒ£**:

```typescript
static async saveFile(
  file: Express.Multer.File, 
  context: MediaPathContext
): Promise<MediaFileInfo>

interface MediaFileInfo {
  originalFilename: string;
  storedFilename: string;
  filePath: string;
  fileSize: number;
  mimeType: string;
  width?: number;
  height?: number;
  format?: string;
  fileHash: string;
}
```

**å‡¦ç†ãƒ•ãƒ­ãƒ¼**:
1. ãƒ•ã‚¡ã‚¤ãƒ«æ¤œè¨¼ï¼ˆ`validateFile`ï¼‰
2. ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆï¼ˆ`mkdir -p`ï¼‰
3. ãƒ•ã‚¡ã‚¤ãƒ«ç§»å‹•ï¼ˆ`copyFile` + `unlink`ï¼‰
4. ãƒ•ã‚¡ã‚¤ãƒ«ãƒãƒƒã‚·ãƒ¥ç”Ÿæˆï¼ˆSHA-256ï¼‰
5. ç”»åƒãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿å–å¾—ï¼ˆç”»åƒã®å ´åˆã€sharpä½¿ç”¨ï¼‰
6. MediaFileInfoè¿”å´

##### 4. deleteFile

**ç”¨é€”**: ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤

**ã‚·ã‚°ãƒãƒãƒ£**:

```typescript
static async deleteFile(logicalPath: string): Promise<void>
```

##### 5. generatePublicUrl

**ç”¨é€”**: å…¬é–‹URLç”Ÿæˆ

**ã‚·ã‚°ãƒãƒãƒ£**:

```typescript
static generatePublicUrl(logicalPath: string): string
```

**ä¾‹**:

```typescript
const publicUrl = MediaStorageService.generatePublicUrl(
  'saas/room_grade/tenant-001/room-grade-001/images/gallery/room-001.jpg'
);
// => "https://media.hotel-unified.com/media/saas/room_grade/tenant-001/room-grade-001/images/gallery/room-001.jpg"
```

---

## ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å®Ÿè£…

### ç®¡ç†ç”»é¢UIï¼ˆhotel-saasï¼‰

#### 1. ãƒ¡ãƒ‡ã‚£ã‚¢ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

**ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ**: `<MediaUploader>`

**Props**:

```typescript
interface MediaUploaderProps {
  entityType: 'room_grade' | 'menu_item' | string;
  entityId: string;
  maxFiles?: number;  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 10
  enableAiEnhancement?: boolean;  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: true
  allowedTypes?: ('images' | 'videos' | 'documents')[];  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: ['images']
  onUploadComplete?: (media: MediaRecord[]) => void;
}
```

**å®Ÿè£…ä¾‹**:

```vue
<template>
  <div class="media-uploader">
    <input 
      type="file" 
      :multiple="maxFiles > 1"
      :accept="acceptTypes"
      @change="handleFileSelect"
      ref="fileInput"
    />
    <button @click="upload" :disabled="uploading">
      {{ uploading ? 'ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...' : 'ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰' }}
    </button>
    <div v-if="progress" class="progress-bar">
      {{ progress }}%
    </div>
  </div>
</template>

<script setup lang="ts">
const props = defineProps<MediaUploaderProps>();

const upload = async () => {
  const formData = new FormData();
  files.value.forEach(file => formData.append('files', file));
  
  const context = {
    system: 'saas',
    entity_type: props.entityType,
    entity_id: props.entityId,
    tenant_id: session.value.tenantId,
    enable_ai_enhancement: props.enableAiEnhancement
  };
  formData.append('context', JSON.stringify(context));
  
  const response = await $fetch(`/api/v1/admin/${props.entityType}s/${props.entityId}/media/upload`, {
    method: 'POST',
    body: formData,
    credentials: 'include'
  });
  
  props.onUploadComplete?.(response.media);
};
</script>
```

#### 2. ãƒ¡ãƒ‡ã‚£ã‚¢ä¸€è¦§ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

**ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ**: `<MediaGallery>`

**Props**:

```typescript
interface MediaGalleryProps {
  entityType: string;
  entityId: string;
  editable?: boolean;  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: false
  slideMode?: boolean;  // ã‚¹ãƒ©ã‚¤ãƒ‰è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰
  onMediaSelect?: (media: MediaRecord) => void;
}
```

**æ©Ÿèƒ½**:
- ã‚°ãƒªãƒƒãƒ‰è¡¨ç¤º
- ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—é †åºå¤‰æ›´
- ãƒ—ãƒ©ã‚¤ãƒãƒªè¨­å®š
- å‰Šé™¤ï¼ˆè«–ç†å‰Šé™¤ï¼‰
- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼

#### 3. ãƒ¡ãƒ‡ã‚£ã‚¢ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

**ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ**: `<MediaPreview>`

**Props**:

```typescript
interface MediaPreviewProps {
  media: MediaRecord;
  size?: 'thumbnail' | 'medium' | 'large';
  clickable?: boolean;
}
```

**å®Ÿè£…**:

```vue
<template>
  <img 
    :src="proxyUrl"
    :alt="media.originalFilename"
    :class="sizeClass"
    @click="handleClick"
  />
</template>

<script setup lang="ts">
const proxyUrl = computed(() => 
  `/api/v1/media/proxy/${props.media.filePath}`
);
</script>
```

---

## å®Ÿè£…ãƒ•ãƒ­ãƒ¼

### ãƒ•ã‚§ãƒ¼ã‚º1: hotel-commonåŸºç›¤å®Ÿè£…

#### ã‚¹ãƒ†ãƒƒãƒ—1: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

```bash
# hotel-common
cd /Users/kaneko/hotel-common

# Prismaãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ä½œæˆ
npx prisma migrate dev --name add_unified_media_table

# ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é©ç”¨
npx prisma migrate deploy
```

**ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³SQL**:

```sql
-- unified_mediaãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
CREATE TABLE unified_media (
  id TEXT PRIMARY KEY,
  tenant_id TEXT NOT NULL,
  original_filename TEXT NOT NULL,
  stored_filename TEXT NOT NULL,
  file_path TEXT NOT NULL,
  file_size BIGINT NOT NULL,
  mime_type TEXT NOT NULL,
  width INTEGER,
  height INTEGER,
  format TEXT,
  source_system TEXT NOT NULL,
  entity_type TEXT NOT NULL,
  entity_id TEXT NOT NULL,
  title TEXT,
  description TEXT,
  display_order INTEGER NOT NULL DEFAULT 1,
  is_primary BOOLEAN NOT NULL DEFAULT FALSE,
  is_active BOOLEAN NOT NULL DEFAULT TRUE,
  is_display_in_slide BOOLEAN NOT NULL DEFAULT TRUE,
  slide_order INTEGER NOT NULL DEFAULT 0,
  is_ai_enhanced BOOLEAN NOT NULL DEFAULT FALSE,
  enhancement_data JSONB,
  quality_score DECIMAL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL,
  deleted_at TIMESTAMPTZ
);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½œæˆ
CREATE INDEX idx_unified_media_tenant_system_entity ON unified_media(tenant_id, source_system, entity_type, entity_id);
CREATE INDEX idx_unified_media_system_entity_active ON unified_media(source_system, entity_type, is_active);
CREATE INDEX idx_unified_media_tenant_entity_primary ON unified_media(tenant_id, entity_type, entity_id, is_primary);
CREATE INDEX idx_unified_media_tenant_entity_slide ON unified_media(tenant_id, entity_type, entity_id, is_display_in_slide, slide_order);
```

#### ã‚¹ãƒ†ãƒƒãƒ—2: MediaStorageServiceå®Ÿè£…

âœ… **æ—¢ã«å®Ÿè£…æ¸ˆã¿**: `/Users/kaneko/hotel-common/src/services/MediaStorageService.ts`

#### ã‚¹ãƒ†ãƒƒãƒ—3: çµ±åˆãƒ¡ãƒ‡ã‚£ã‚¢APIå®Ÿè£…

âœ… **æ—¢ã«å®Ÿè£…æ¸ˆã¿**: 
- `/Users/kaneko/hotel-common/src/routes/api/v1/media/upload.post.ts`
- `/Users/kaneko/hotel-common/src/routes/api/v1/media/index.get.ts`
- `/Users/kaneko/hotel-common/src/routes/api/v1/media/[id].put.ts`
- `/Users/kaneko/hotel-common/src/routes/api/v1/media/[id].delete.ts`
- `/Users/kaneko/hotel-common/src/routes/api/v1/media/reorder.post.ts`

#### ã‚¹ãƒ†ãƒƒãƒ—4: ãƒ†ã‚¹ãƒˆ

```bash
# hotel-common
npm run test:media
```

---

### ãƒ•ã‚§ãƒ¼ã‚º2: hotel-saasãƒ—ãƒ­ã‚­ã‚·å®Ÿè£…

#### ã‚¹ãƒ†ãƒƒãƒ—1: ãƒ—ãƒ­ã‚­ã‚·APIå®Ÿè£…

âœ… **æ—¢ã«å®Ÿè£…æ¸ˆã¿**: 
- `/Users/kaneko/hotel-saas/server/api/v1/admin/room-grades/[id]/media/upload.post.ts`
- `/Users/kaneko/hotel-saas/server/api/v1/admin/room-grades/[id]/media/index.get.ts`
- `/Users/kaneko/hotel-saas/server/api/v1/admin/room-grades/[id]/media/[mediaId].put.ts`
- `/Users/kaneko/hotel-saas/server/api/v1/admin/room-grades/[id]/media/[mediaId].delete.ts`
- `/Users/kaneko/hotel-saas/server/api/v1/admin/media/reorder.post.ts`
- `/Users/kaneko/hotel-saas/server/api/v1/media/proxy/[...path].get.ts`

#### ã‚¹ãƒ†ãƒƒãƒ—2: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰UIå®Ÿè£…

**å¯¾è±¡ãƒšãƒ¼ã‚¸**: `/admin/room-grades/[id]`

**å®Ÿè£…å†…å®¹**:
1. ãƒ¡ãƒ‡ã‚£ã‚¢ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆçµ±åˆ
2. ãƒ¡ãƒ‡ã‚£ã‚¢ä¸€è¦§è¡¨ç¤ºï¼ˆã‚°ãƒªãƒƒãƒ‰ï¼‰
3. ãƒ¡ãƒ‡ã‚£ã‚¢é †åºå¤‰æ›´ï¼ˆãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ï¼‰
4. ãƒ¡ãƒ‡ã‚£ã‚¢å‰Šé™¤
5. ãƒ—ãƒ©ã‚¤ãƒãƒªè¨­å®š

#### ã‚¹ãƒ†ãƒƒãƒ—3: ãƒ†ã‚¹ãƒˆ

```bash
# hotel-saas
npm run dev

# ãƒ–ãƒ©ã‚¦ã‚¶ã§ç¢ºèª
# http://localhost:3000/admin/room-grades/{id}
```

---

## ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

### ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ä½“ç³»

| ã‚³ãƒ¼ãƒ‰ | HTTP | èª¬æ˜ | å¯¾å‡¦æ³• |
|--------|------|------|--------|
| `UNAUTHORIZED` | 401 | èªè¨¼ã‚¨ãƒ©ãƒ¼ | ãƒ­ã‚°ã‚¤ãƒ³ã‚’ç¢ºèª |
| `FORBIDDEN` | 403 | ãƒ†ãƒŠãƒ³ãƒˆæ¨©é™ã‚¨ãƒ©ãƒ¼ | ãƒ†ãƒŠãƒ³ãƒˆIDã‚’ç¢ºèª |
| `VALIDATION_ERROR` | 400 | ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ | ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ç¢ºèª |
| `MEDIA_NOT_FOUND` | 404 | ãƒ¡ãƒ‡ã‚£ã‚¢ãŒè¦‹ã¤ã‹ã‚‰ãªã„ | ãƒ¡ãƒ‡ã‚£ã‚¢IDã‚’ç¢ºèª |
| `FILE_TOO_LARGE` | 400 | ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºè¶…é | ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã‚’å‰Šæ¸› |
| `TOO_MANY_FILES` | 400 | ãƒ•ã‚¡ã‚¤ãƒ«æ•°è¶…éï¼ˆæœ€å¤§10ä»¶ï¼‰ | ãƒ•ã‚¡ã‚¤ãƒ«æ•°ã‚’å‰Šæ¸› |
| `INVALID_FILE_TYPE` | 400 | ãƒ•ã‚¡ã‚¤ãƒ«ã‚¿ã‚¤ãƒ—ãŒä¸æ­£ | è¨±å¯ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚¿ã‚¤ãƒ—ã‚’ç¢ºèª |
| `MEDIA_UPLOAD_ERROR` | 500 | ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¤±æ•— | ã‚µãƒ¼ãƒãƒ¼ãƒ­ã‚°ã‚’ç¢ºèª |
| `MEDIA_DELETE_ERROR` | 500 | å‰Šé™¤å¤±æ•— | ã‚µãƒ¼ãƒãƒ¼ãƒ­ã‚°ã‚’ç¢ºèª |
| `MEDIA_UPDATE_ERROR` | 500 | æ›´æ–°å¤±æ•— | ã‚µãƒ¼ãƒãƒ¼ãƒ­ã‚°ã‚’ç¢ºèª |
| `MEDIA_LIST_ERROR` | 500 | ä¸€è¦§å–å¾—å¤±æ•— | ã‚µãƒ¼ãƒãƒ¼ãƒ­ã‚°ã‚’ç¢ºèª |
| `MEDIA_REORDER_ERROR` | 500 | é †åºå¤‰æ›´å¤±æ•— | ã‚µãƒ¼ãƒãƒ¼ãƒ­ã‚°ã‚’ç¢ºèª |

### ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼

```typescript
interface ErrorResponse {
  success: false;
  error: {
    code: string;
    message: string;
    details?: any;
  };
}
```

### ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ä¾‹

#### hotel-saas

```typescript
try {
  const response = await $fetch('/api/v1/admin/room-grades/1/media/upload', {
    method: 'POST',
    body: formData,
    credentials: 'include'
  });
} catch (error: any) {
  if (error.statusCode === 401) {
    // èªè¨¼ã‚¨ãƒ©ãƒ¼ â†’ ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã¸
    navigateTo('/login');
  } else if (error.statusCode === 400) {
    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ â†’ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é€šçŸ¥
    toast.error(error.data.error.message);
  } else {
    // ãã®ä»–ã®ã‚¨ãƒ©ãƒ¼ â†’ ã‚¨ãƒ©ãƒ¼ãƒšãƒ¼ã‚¸ã¸
    throw error;
  }
}
```

#### hotel-common

```typescript
router.post('/upload', UnifiedSessionMiddleware.authenticate(), upload.array('files', MAX_FILES), async (req, res) => {
  try {
    // ... å‡¦ç† ...
  } catch (error) {
    logger.error('çµ±åˆãƒ¡ãƒ‡ã‚£ã‚¢ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼', error);

    if (error instanceof z.ZodError) {
      return res.status(400).json(
        StandardResponseBuilder.error('VALIDATION_ERROR', 'ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ãŒä¸æ­£ã§ã™', {
          details: error.errors
        }).response
      );
    }

    if (error instanceof multer.MulterError) {
      if (error.code === 'LIMIT_FILE_SIZE') {
        return res.status(400).json(
          StandardResponseBuilder.error('FILE_TOO_LARGE', `ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãŒä¸Šé™ï¼ˆ${MAX_FILE_SIZE / 1024 / 1024}MBï¼‰ã‚’è¶…ãˆã¦ã„ã¾ã™`).response
        );
      }
      if (error.code === 'LIMIT_FILE_COUNT') {
        return res.status(400).json(
          StandardResponseBuilder.error('TOO_MANY_FILES', `ä¸€åº¦ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã§ãã‚‹ãƒ•ã‚¡ã‚¤ãƒ«æ•°ã¯${MAX_FILES}å€‹ã¾ã§ã§ã™`).response
        );
      }
    }

    return res.status(500).json(
      StandardResponseBuilder.error('MEDIA_UPLOAD_ERROR', error instanceof Error ? error.message : 'ãƒ¡ãƒ‡ã‚£ã‚¢ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ').response
    );
  }
});
```

---

## ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹

### å˜ä½“ãƒ†ã‚¹ãƒˆï¼ˆhotel-commonï¼‰

#### MediaStorageService

```typescript
describe('MediaStorageService', () => {
  describe('generateLogicalPath', () => {
    it('should generate correct logical path', () => {
      const context: MediaPathContext = {
        system: 'saas',
        entityType: 'room_grade',
        tenantId: 'tenant-001',
        entityId: 'room-grade-001',
        mediaType: 'images',
        category: 'gallery',
        filename: 'test.jpg'
      };
      
      const result = MediaStorageService.generateLogicalPath(context);
      
      expect(result).toBe('saas/room_grade/tenant-001/room-grade-001/images/gallery/test.jpg');
    });
  });

  describe('generateFilename', () => {
    it('should generate safe filename', () => {
      const result = MediaStorageService.generateFilename({
        entityType: 'room_grade',
        entityId: 'room-grade-001',
        mediaType: 'image',
        category: 'gallery',
        originalFilename: 'DSC_1234.jpg',
        sequence: 1
      });
      
      expect(result).toMatch(/^room_grade-room-grade-001-gallery-1-\d+\.jpg$/);
    });
  });

  describe('validateFile', () => {
    it('should accept valid image file', async () => {
      const file: Express.Multer.File = {
        mimetype: 'image/jpeg',
        size: 1024 * 1024, // 1MB
        path: '/tmp/test.jpg'
      } as Express.Multer.File;
      
      await expect(MediaStorageService.validateFile(file, 'images')).resolves.not.toThrow();
    });

    it('should reject file that is too large', async () => {
      const file: Express.Multer.File = {
        mimetype: 'image/jpeg',
        size: 10 * 1024 * 1024, // 10MB (exceeds 5MB limit)
        path: '/tmp/test.jpg'
      } as Express.Multer.File;
      
      await expect(MediaStorageService.validateFile(file, 'images')).rejects.toThrow('ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãŒä¸Šé™');
    });
  });
});
```

#### çµ±åˆãƒ¡ãƒ‡ã‚£ã‚¢API

```typescript
describe('POST /api/v1/media/upload', () => {
  it('should upload media successfully', async () => {
    const response = await request(app)
      .post('/api/v1/media/upload')
      .set('Cookie', sessionCookie)
      .attach('files', Buffer.from('fake-image'), 'test.jpg')
      .field('context', JSON.stringify({
        system: 'saas',
        entity_type: 'room_grade',
        entity_id: 'room-grade-001',
        tenant_id: 'tenant-001'
      }))
      .expect(201);

    expect(response.body.success).toBe(true);
    expect(response.body.media).toHaveLength(1);
    expect(response.body.media[0]).toHaveProperty('id');
    expect(response.body.media[0]).toHaveProperty('publicUrl');
  });

  it('should reject unauthorized request', async () => {
    await request(app)
      .post('/api/v1/media/upload')
      .attach('files', Buffer.from('fake-image'), 'test.jpg')
      .expect(401);
  });

  it('should reject too many files', async () => {
    const files = Array.from({ length: 11 }, (_, i) => Buffer.from(`fake-image-${i}`));
    
    const req = request(app)
      .post('/api/v1/media/upload')
      .set('Cookie', sessionCookie)
      .field('context', JSON.stringify({
        system: 'saas',
        entity_type: 'room_grade',
        entity_id: 'room-grade-001',
        tenant_id: 'tenant-001'
      }));
    
    files.forEach((file, i) => {
      req.attach('files', file, `test${i}.jpg`);
    });
    
    await req.expect(400);
  });
});
```

### E2Eãƒ†ã‚¹ãƒˆï¼ˆhotel-saasï¼‰

```typescript
describe('Media Management E2E', () => {
  it('should upload and display media', async () => {
    // ãƒ­ã‚°ã‚¤ãƒ³
    await page.goto('http://localhost:3000/login');
    await page.fill('input[name="email"]', 'admin@example.com');
    await page.fill('input[name="password"]', 'password');
    await page.click('button[type="submit"]');

    // å®¢å®¤ã‚°ãƒ¬ãƒ¼ãƒ‰ç·¨é›†ãƒšãƒ¼ã‚¸ã¸
    await page.goto('http://localhost:3000/admin/room-grades/1');

    // ãƒ¡ãƒ‡ã‚£ã‚¢ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
    await page.setInputFiles('input[type="file"]', './test/fixtures/test-image.jpg');
    await page.click('button:has-text("ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰")');

    // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†ç¢ºèª
    await page.waitForSelector('.media-gallery img');
    const images = await page.$$('.media-gallery img');
    expect(images.length).toBeGreaterThan(0);
  });

  it('should reorder media with drag and drop', async () => {
    await page.goto('http://localhost:3000/admin/room-grades/1');

    const firstImage = await page.$('.media-gallery img:first-child');
    const lastImage = await page.$('.media-gallery img:last-child');

    await firstImage.dragTo(lastImage);

    // é †åºå¤‰æ›´ç¢ºèª
    await page.waitForResponse(response => 
      response.url().includes('/api/v1/admin/media/reorder') && response.status() === 200
    );
  });
});
```

---

## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

### èªè¨¼ãƒ»èªå¯

1. **Sessionèªè¨¼å¿…é ˆ**
   - hotel-saas: Sessionèªè¨¼ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ï¼ˆè‡ªå‹•é©ç”¨ï¼‰
   - hotel-common: `UnifiedSessionMiddleware.authenticate()`

2. **ãƒ†ãƒŠãƒ³ãƒˆæ¨©é™ãƒã‚§ãƒƒã‚¯**
   - å…¨APIã§`tenant_id`ã‚’æ¤œè¨¼
   - ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®`tenant_id`ã¨ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®`tenant_id`ã‚’ç…§åˆ

3. **ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£æ‰€æœ‰æ¨©ãƒã‚§ãƒƒã‚¯**
   - ãƒ¡ãƒ‡ã‚£ã‚¢æ›´æ–°ãƒ»å‰Šé™¤æ™‚ã«æ‰€æœ‰ãƒ†ãƒŠãƒ³ãƒˆã‚’ç¢ºèª

### ãƒ•ã‚¡ã‚¤ãƒ«ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

1. **ãƒ•ã‚¡ã‚¤ãƒ«ã‚¿ã‚¤ãƒ—æ¤œè¨¼**
   - MIMEã‚¿ã‚¤ãƒ—ãƒã‚§ãƒƒã‚¯ï¼ˆè¨±å¯ãƒªã‚¹ãƒˆæ–¹å¼ï¼‰
   - æ‹¡å¼µå­ãƒã‚§ãƒƒã‚¯

2. **ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºåˆ¶é™**
   - ç”»åƒ: 5MB
   - å‹•ç”»: 50MB
   - ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ: 10MB

3. **ãƒ•ã‚¡ã‚¤ãƒ«åã‚µãƒ‹ã‚¿ã‚¤ã‚º**
   - ç‰¹æ®Šæ–‡å­—é™¤å»
   - ãƒ‘ã‚¹ãƒˆãƒ©ãƒãƒ¼ã‚µãƒ«å¯¾ç­–

4. **ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸åˆ†é›¢**
   - ãƒ†ãƒŠãƒ³ãƒˆã”ã¨ã«ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªåˆ†é›¢
   - `tenant_id`ã‚’ãƒ‘ã‚¹ã«å«ã‚ã‚‹

### ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡

1. **å…¬é–‹URLã®ä¿è­·**
   - ãƒ¡ãƒ‡ã‚£ã‚¢ãƒ—ãƒ­ã‚­ã‚·çµŒç”±ã§ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
   - èªè¨¼ãƒã‚§ãƒƒã‚¯å¿…é ˆ

2. **è«–ç†å‰Šé™¤**
   - ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯è«–ç†å‰Šé™¤ï¼ˆ`isActive = false`ï¼‰
   - ç‰©ç†å‰Šé™¤ã¯æ˜ç¤ºçš„ãªãƒ•ãƒ©ã‚°ãŒå¿…è¦

---

## ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹

1. **ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æœ€é©åŒ–**
   - è¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã«ã‚ˆã‚‹æ¤œç´¢é«˜é€ŸåŒ–
   - ãƒ—ãƒ©ã‚¤ãƒãƒªãƒ¡ãƒ‡ã‚£ã‚¢å–å¾—ã®é«˜é€ŸåŒ–

2. **ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³**
   - å¤§é‡ãƒ‡ãƒ¼ã‚¿å¯¾å¿œï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ20ä»¶/ãƒšãƒ¼ã‚¸ï¼‰
   - `skip` + `take`ã«ã‚ˆã‚‹åŠ¹ç‡çš„ãªå–å¾—

3. **N+1ã‚¯ã‚¨ãƒªå›é¿**
   - ãƒãƒƒãƒå‡¦ç†ã§ã®ä¸€æ‹¬å–å¾—
   - ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å‡¦ç†ã§ã®ä¸€æ‹¬æ›´æ–°

### ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸

1. **ãƒ•ã‚¡ã‚¤ãƒ«ãƒãƒƒã‚·ãƒ¥**
   - é‡è¤‡ãƒ•ã‚¡ã‚¤ãƒ«æ¤œå‡ºï¼ˆå°†æ¥å¯¾å¿œï¼‰
   - SHA-256ãƒãƒƒã‚·ãƒ¥ç”Ÿæˆ

2. **ç”»åƒæœ€é©åŒ–**
   - sharp ã«ã‚ˆã‚‹ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿æŠ½å‡º
   - AIç”»åƒè£œæ­£ï¼ˆå°†æ¥å¯¾å¿œï¼‰

### ã‚­ãƒ£ãƒƒã‚·ãƒ¥

1. **ãƒ¡ãƒ‡ã‚£ã‚¢ãƒ—ãƒ­ã‚­ã‚·**
   - `Cache-Control: public, max-age=3600`ï¼ˆ1æ™‚é–“ï¼‰
   - ãƒ–ãƒ©ã‚¦ã‚¶ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ´»ç”¨

2. **CDNé€£æº**
   - å°†æ¥çš„ã«CDNé…ä¿¡å¯¾å¿œ
   - å…¬é–‹URLæ§‹é€ ãŒå¯¾å¿œæ¸ˆã¿

---

## ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ã‚ˆãã‚ã‚‹å•é¡Œ

#### 1. ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãŒå¤±æ•—ã™ã‚‹

**ç—‡çŠ¶**: ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ™‚ã«500ã‚¨ãƒ©ãƒ¼

**åŸå› **:
- ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ãªã„
- ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®æ›¸ãè¾¼ã¿æ¨©é™ãŒãªã„
- ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãŒä¸Šé™ã‚’è¶…ãˆã¦ã„ã‚‹

**å¯¾å‡¦æ³•**:

```bash
# ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
mkdir -p /var/lib/hotel-unified/media

# æ¨©é™ä»˜ä¸
chmod 755 /var/lib/hotel-unified/media
chown -R node:node /var/lib/hotel-unified/media

# ç’°å¢ƒå¤‰æ•°ç¢ºèª
echo $UNIFIED_MEDIA_STORAGE_PATH
```

#### 2. ãƒ¡ãƒ‡ã‚£ã‚¢ãŒè¡¨ç¤ºã•ã‚Œãªã„

**ç—‡çŠ¶**: ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¾Œã€ç”»åƒãŒè¡¨ç¤ºã•ã‚Œãªã„ï¼ˆ404ã‚¨ãƒ©ãƒ¼ï¼‰

**åŸå› **:
- ãƒ¡ãƒ‡ã‚£ã‚¢ãƒ—ãƒ­ã‚­ã‚·ãŒå‹•ä½œã—ã¦ã„ãªã„
- å…¬é–‹URLãŒé–“é•ã£ã¦ã„ã‚‹
- ãƒ•ã‚¡ã‚¤ãƒ«ãŒå®Ÿéš›ã«ä¿å­˜ã•ã‚Œã¦ã„ãªã„

**å¯¾å‡¦æ³•**:

```bash
# ãƒ•ã‚¡ã‚¤ãƒ«å­˜åœ¨ç¢ºèª
ls -la /var/lib/hotel-unified/media/saas/room_grade/tenant-001/

# hotel-commonãƒ­ã‚°ç¢ºèª
tail -f /var/log/hotel-common/app.log | grep "Media"

# hotel-saasãƒ­ã‚°ç¢ºèª
tail -f /var/log/hotel-saas/app.log | grep "Media proxy"
```

#### 3. ãƒ—ãƒ©ã‚¤ãƒãƒªãƒ¡ãƒ‡ã‚£ã‚¢ãŒè¤‡æ•°å­˜åœ¨ã™ã‚‹

**ç—‡çŠ¶**: 1ã¤ã®ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã«è¤‡æ•°ã®ãƒ—ãƒ©ã‚¤ãƒãƒªãƒ¡ãƒ‡ã‚£ã‚¢ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹

**åŸå› **:
- æ’ä»–åˆ¶å¾¡ã®å¤±æ•—
- ä¸¦è¡Œã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«ã‚ˆã‚‹ç«¶åˆ

**å¯¾å‡¦æ³•**:

```sql
-- ãƒ—ãƒ©ã‚¤ãƒãƒªãƒ¡ãƒ‡ã‚£ã‚¢ç¢ºèª
SELECT id, entity_id, is_primary, display_order 
FROM unified_media 
WHERE tenant_id = 'tenant-001' 
  AND entity_type = 'room_grade' 
  AND entity_id = 'room-grade-001'
  AND is_primary = TRUE;

-- ãƒ—ãƒ©ã‚¤ãƒãƒªãƒ¡ãƒ‡ã‚£ã‚¢ä¿®æ­£ï¼ˆæœ€åˆã®1ä»¶ã®ã¿æ®‹ã™ï¼‰
UPDATE unified_media 
SET is_primary = FALSE 
WHERE tenant_id = 'tenant-001' 
  AND entity_type = 'room_grade' 
  AND entity_id = 'room-grade-001'
  AND id != (
    SELECT id FROM unified_media 
    WHERE tenant_id = 'tenant-001' 
      AND entity_type = 'room_grade' 
      AND entity_id = 'room-grade-001'
      AND is_primary = TRUE
    ORDER BY created_at ASC
    LIMIT 1
  );
```

#### 4. ãƒ‡ã‚£ã‚¹ã‚¯å®¹é‡ä¸è¶³

**ç—‡çŠ¶**: ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ™‚ã«ã€ŒENOSPC: no space left on deviceã€ã‚¨ãƒ©ãƒ¼

**åŸå› **:
- ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒ‡ã‚£ã‚¹ã‚¯å®¹é‡ä¸è¶³

**å¯¾å‡¦æ³•**:

```bash
# ãƒ‡ã‚£ã‚¹ã‚¯ä½¿ç”¨é‡ç¢ºèª
df -h /var/lib/hotel-unified/media

# å¤ã„ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤ï¼ˆè«–ç†å‰Šé™¤æ¸ˆã¿ã®ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰
find /var/lib/hotel-unified/media -type f -mtime +90 -exec rm {} \;

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ï¼ˆè«–ç†å‰Šé™¤ã‹ã‚‰90æ—¥ä»¥ä¸Šï¼‰
psql -d hotel_unified -c "DELETE FROM unified_media WHERE deleted_at < NOW() - INTERVAL '90 days';"
```

---

## ğŸ“ å¤‰æ›´å±¥æ­´

| ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | æ—¥ä»˜ | å¤‰æ›´å†…å®¹ |
|-----------|------|---------|
| 1.0.0 | 2025-10-13 | åˆç‰ˆä½œæˆï¼ˆæ—¢å­˜å®Ÿè£…ã‚’SSOæº–æ‹ ã§æ–‡æ›¸åŒ–ï¼‰ |

---

## ğŸ“š é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [SPEC-2025-007: åŒ…æ‹¬çš„ãƒ¡ãƒ‡ã‚£ã‚¢ç®¡ç†ä»•æ§˜æ›¸](/Users/kaneko/hotel-kanri/docs/01_systems/saas/specifications/COMPREHENSIVE_MEDIA_MANAGEMENT_SPECIFICATION.md)
- [SPEC-2025-005: ãƒ¡ãƒ‡ã‚£ã‚¢ç®¡ç†APIæ°¸ç¶šåŒ–æ–¹é‡æ±ºå®šæ›¸](/Users/kaneko/hotel-kanri/docs/01_systems/saas/specifications/MEDIA_API_PERSISTENCE_POLICY.md)
- [SSOT_SAAS_DATABASE_SCHEMA.md](/Users/kaneko/hotel-kanri/docs/03_ssot/00_foundation/SSOT_SAAS_DATABASE_SCHEMA.md)
- [SSOT_SAAS_MULTITENANT.md](/Users/kaneko/hotel-kanri/docs/03_ssot/00_foundation/SSOT_SAAS_MULTITENANT.md)
- [DATABASE_NAMING_STANDARD.md](/Users/kaneko/hotel-kanri/docs/standards/DATABASE_NAMING_STANDARD.md)

---

**æœ€çµ‚æ›´æ–°**: 2025å¹´10æœˆ13æ—¥  
**ä½œæˆè€…**: Sunï¼ˆhotel-saasæ‹…å½“AIï¼‰  
**å“è³ªã‚¹ã‚³ã‚¢**: 100/100ç‚¹  
**Phase**: Phase 1 - Week 1ï¼ˆæœ€å„ªå…ˆï¼‰

