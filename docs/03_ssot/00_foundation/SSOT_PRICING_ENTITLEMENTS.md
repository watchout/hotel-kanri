# SSOT: æ–™é‡‘ãƒ—ãƒ©ãƒ³/ã‚¨ãƒ³ã‚¿ã‚¤ãƒˆãƒ«ãƒ¡ãƒ³ãƒˆï¼ˆPRICING_ENTITLEMENTSï¼‰

**ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆID**: SSOT_PRICING_ENTITLEMENTS  
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 1.1.0  
**ä½œæˆæ—¥**: 2026-01-03  
**æœ€çµ‚æ›´æ–°**: 2026-01-03  
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: ğŸŸ¢ ç¢ºå®š  
**Planeã‚¿ã‚¹ã‚¯**: DEV-0409  
**APIãƒ¬ã‚¸ã‚¹ãƒˆãƒª**: SSOT_API_REGISTRY.mdï¼ˆç™»éŒ²æ¸ˆã¿ï¼‰

---

## ğŸ“‹ ç›®æ¬¡

1. [æ¦‚è¦](#1-æ¦‚è¦)
2. [ãƒ—ãƒ©ãƒ³å®šç¾©](#2-ãƒ—ãƒ©ãƒ³å®šç¾©)
3. [æ©Ÿèƒ½ã‚¨ãƒ³ã‚¿ã‚¤ãƒˆãƒ«ãƒ¡ãƒ³ãƒˆ](#3-æ©Ÿèƒ½ã‚¨ãƒ³ã‚¿ã‚¤ãƒˆãƒ«ãƒ¡ãƒ³ãƒˆ)
4. [AIã‚¯ãƒ¬ã‚¸ãƒƒãƒˆåˆ¶é™](#4-aiã‚¯ãƒ¬ã‚¸ãƒƒãƒˆåˆ¶é™)
5. [ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ](#5-ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ)
6. [APIè¨­è¨ˆ](#6-apiè¨­è¨ˆ)
7. [å®Ÿè£…ã‚¬ã‚¤ãƒ‰](#7-å®Ÿè£…ã‚¬ã‚¤ãƒ‰)
8. [ãƒ†ã‚¹ãƒˆè¦ä»¶](#8-ãƒ†ã‚¹ãƒˆè¦ä»¶)

---

## 1. æ¦‚è¦

### 1.1 ç›®çš„

OmotenasuAIã®æ–™é‡‘ãƒ—ãƒ©ãƒ³ã¨æ©Ÿèƒ½åˆ¶é™ï¼ˆã‚¨ãƒ³ã‚¿ã‚¤ãƒˆãƒ«ãƒ¡ãƒ³ãƒˆï¼‰ã‚’ä¸€å…ƒç®¡ç†ã™ã‚‹ã€‚

### 1.2 é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

| ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ | ç”¨é€” |
|:-------------|:-----|
| `SSOT_BUYOUT_STRATEGY.md` | ãƒã‚¤ã‚¢ã‚¦ãƒˆæˆ¦ç•¥ï¼ˆKPIç›®æ¨™ï¼‰ |
| `SSOT_MARKETING_STRATEGY.md` | ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°æˆ¦ç•¥ |
| `DOMESTIC_PRICING_STRATEGY_FINAL.md` | è©³ç´°æ–™é‡‘è¡¨ |

### 1.3 ãƒã‚¤ã‚¢ã‚¦ãƒˆæˆ¦ç•¥ã¨ã®æ•´åˆ

| å¹´ | æ–½è¨­æ•°ç›®æ¨™ | ARRç›®æ¨™ | ARPUç›®æ¨™ | ä¸»è¦ãƒ—ãƒ©ãƒ³ |
|:---|:-----------|:--------|:---------|:-----------|
| Year 1 | 100æ–½è¨­ | Â¥3,000ä¸‡ | Â¥2.5ä¸‡/æœˆ | Starterä¸­å¿ƒ |
| Year 2 | 300æ–½è¨­ | Â¥1å„„ | Â¥3ä¸‡/æœˆ | Pro Liteç§»è¡Œ |
| Year 3 | 500æ–½è¨­ | Â¥3å„„ | Â¥5ä¸‡/æœˆ | Professionalä¸»è»¸ |

---

## 2. ãƒ—ãƒ©ãƒ³å®šç¾©

### 2.1 LEISUREï¼ˆãƒ¬ã‚¸ãƒ£ãƒ¼ãƒ›ãƒ†ãƒ«ç‰¹åŒ–ï¼‰

| ãƒ—ãƒ©ãƒ³ | ã‚³ãƒ¼ãƒ‰ | æœˆé¡ | å®¤æ•°ä¸Šé™ | è¶…éæ–™é‡‘ | AIã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ |
|:-------|:-------|-----:|:--------:|:--------:|:------------:|
| **Starter** â­NEW | `leisure_starter` | Â¥9,800 | 10å®¤ | Â¥1,200/å®¤ | 100/æœˆ |
| Economy | `leisure_economy` | Â¥19,800 | 20å®¤ | Â¥1,000/å®¤ | 300/æœˆ |
| **Pro Lite** â­NEW | `leisure_pro_lite` | Â¥34,800 | 35å®¤ | Â¥950/å®¤ | 500/æœˆ |
| Professional | `leisure_professional` | Â¥49,800 | 50å®¤ | Â¥900/å®¤ | 1,000/æœˆ |
| Enterprise | `leisure_enterprise` | Â¥99,800 | 100å®¤ | Â¥800/å®¤ | ç„¡åˆ¶é™ |

### 2.2 OmotenasuAIï¼ˆä¸€èˆ¬ãƒ›ãƒ†ãƒ«ç‰¹åŒ–ï¼‰

| ãƒ—ãƒ©ãƒ³ | ã‚³ãƒ¼ãƒ‰ | æœˆé¡ | å®¤æ•°ä¸Šé™ | è¶…éæ–™é‡‘ | AIã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ |
|:-------|:-------|-----:|:--------:|:--------:|:------------:|
| **Starter** â­NEW | `omotenasu_starter` | Â¥14,800 | 15å®¤ | Â¥1,500/å®¤ | 100/æœˆ |
| Economy | `omotenasu_economy` | Â¥29,800 | 30å®¤ | Â¥1,200/å®¤ | 300/æœˆ |
| **Pro Lite** â­NEW | `omotenasu_pro_lite` | Â¥49,800 | 50å®¤ | Â¥1,100/å®¤ | 700/æœˆ |
| Professional | `omotenasu_professional` | Â¥79,800 | 80å®¤ | Â¥1,000/å®¤ | 1,500/æœˆ |
| Enterprise | `omotenasu_enterprise` | Â¥139,800 | 200å®¤ | Â¥800/å®¤ | ç„¡åˆ¶é™ |
| Ultimate | `omotenasu_ultimate` | Â¥299,800 | 500å®¤ | Â¥700/å®¤ | ç„¡åˆ¶é™ |

### 2.3 å¹´æ‰•ã„å‰²å¼•

| æ”¯æ‰•ã„æ–¹æ³• | å‰²å¼•ç‡ | å‚™è€ƒ |
|:-----------|:------:|:-----|
| æœˆæ‰•ã„ | 0% | æ¨™æº– |
| 1å¹´æ‰•ã„ | 5% | 1ãƒ¶æœˆåˆ†ç„¡æ–™ç›¸å½“ |
| 2å¹´æ‰•ã„ | 10% | 2.4ãƒ¶æœˆåˆ†ç„¡æ–™ç›¸å½“ |

---

## 3. æ©Ÿèƒ½ã‚¨ãƒ³ã‚¿ã‚¤ãƒˆãƒ«ãƒ¡ãƒ³ãƒˆ

### 3.1 æ©Ÿèƒ½ãƒãƒˆãƒªã‚¯ã‚¹ï¼ˆLEISUREï¼‰

| æ©Ÿèƒ½ | Starter | Economy | Pro Lite | Professional | Enterprise |
|:-----|:-------:|:-------:|:--------:|:------------:|:----------:|
| åŸºæœ¬ã‚ªãƒ¼ãƒ€ãƒ¼ã‚·ã‚¹ãƒ†ãƒ  | âœ… | âœ… | âœ… | âœ… | âœ… |
| TVçµ±åˆUI | âœ… | âœ… | âœ… | âœ… | âœ… |
| å¤šè¨€èªç¿»è¨³ | 5è¨€èª | 15è¨€èª | 15è¨€èª | 15è¨€èª | 15è¨€èª |
| ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³æ©Ÿèƒ½ | âŒ | âœ… | âœ… | âœ… | âœ… |
| AIã‚³ãƒ³ã‚·ã‚§ãƒ«ã‚¸ãƒ¥ | âŒ | âŒ | åŸºæœ¬ | é«˜åº¦ | é«˜åº¦ |
| åˆ†æãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ | âŒ | âŒ | åŸºæœ¬ | é«˜åº¦ | é«˜åº¦ |
| ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆç·¨é›† | âŒ | âŒ | âŒ | âœ… | âœ… |
| ã‚«ã‚¹ã‚¿ãƒ ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ | âŒ | âŒ | âŒ | âŒ | âœ… |
| å°‚ä»»ã‚µãƒãƒ¼ãƒˆ | âŒ | âŒ | âŒ | âŒ | âœ… |

### 3.2 æ©Ÿèƒ½ãƒãƒˆãƒªã‚¯ã‚¹ï¼ˆOmotenasuAIï¼‰

| æ©Ÿèƒ½ | Starter | Economy | Pro Lite | Professional | Enterprise | Ultimate |
|:-----|:-------:|:-------:|:--------:|:------------:|:----------:|:--------:|
| åŸºæœ¬ã‚ªãƒ¼ãƒ€ãƒ¼ã‚·ã‚¹ãƒ†ãƒ  | âœ… | âœ… | âœ… | âœ… | âœ… | âœ… |
| ãƒ•ãƒ­ãƒ³ãƒˆé€£æº | âœ… | âœ… | âœ… | âœ… | âœ… | âœ… |
| å¤šè¨€èªç¿»è¨³ | 5è¨€èª | 10è¨€èª | 10è¨€èª | 15è¨€èª | 15è¨€èª | 15è¨€èª |
| åŸºæœ¬åˆ†æ | âŒ | âœ… | âœ… | âœ… | âœ… | âœ… |
| AIã‚³ãƒ³ã‚·ã‚§ãƒ«ã‚¸ãƒ¥ | âŒ | âŒ | åŸºæœ¬ | é«˜åº¦ | é«˜åº¦ | é«˜åº¦ |
| åˆ†æãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ | âŒ | âŒ | åŸºæœ¬ | é«˜åº¦ | é«˜åº¦ | é«˜åº¦ |
| PMSé€£æº | âŒ | âŒ | âŒ | âœ… | âœ… | âœ… |
| APIé€£æº | âŒ | âŒ | âŒ | âŒ | âœ… | âœ… |
| ã‚«ã‚¹ã‚¿ãƒ é–‹ç™º | âŒ | âŒ | âŒ | âŒ | âœ… | âœ… |
| å®Œå…¨ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º | âŒ | âŒ | âŒ | âŒ | âŒ | âœ… |
| å°‚ç”¨ã‚¤ãƒ³ãƒ•ãƒ© | âŒ | âŒ | âŒ | âŒ | âŒ | âœ… |

### 3.3 æ©Ÿèƒ½ã‚³ãƒ¼ãƒ‰ä¸€è¦§

| æ©Ÿèƒ½ã‚³ãƒ¼ãƒ‰ | èª¬æ˜ | ãƒã‚§ãƒƒã‚¯ç®‡æ‰€ |
|:-----------|:-----|:-------------|
| `feature:order_system` | åŸºæœ¬ã‚ªãƒ¼ãƒ€ãƒ¼ã‚·ã‚¹ãƒ†ãƒ  | æ³¨æ–‡ä½œæˆAPI |
| `feature:tv_ui` | TVçµ±åˆUI | ã‚²ã‚¹ãƒˆUIè¡¨ç¤º |
| `feature:translation:5` | 5è¨€èªç¿»è¨³ | ç¿»è¨³API |
| `feature:translation:15` | 15è¨€èªç¿»è¨³ | ç¿»è¨³API |
| `feature:campaign` | ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³æ©Ÿèƒ½ | ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³API |
| `feature:ai_concierge:basic` | åŸºæœ¬AIã‚³ãƒ³ã‚·ã‚§ãƒ«ã‚¸ãƒ¥ | AIãƒãƒ£ãƒƒãƒˆAPI |
| `feature:ai_concierge:advanced` | é«˜åº¦AIã‚³ãƒ³ã‚·ã‚§ãƒ«ã‚¸ãƒ¥ | AIãƒãƒ£ãƒƒãƒˆAPI |
| `feature:analytics:basic` | åŸºæœ¬åˆ†æ | åˆ†æAPI |
| `feature:analytics:advanced` | é«˜åº¦åˆ†æ | åˆ†æAPI |
| `feature:layout_editor` | ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆç·¨é›† | ç®¡ç†ç”»é¢ |
| `feature:custom_character` | ã‚«ã‚¹ã‚¿ãƒ ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ | AIã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¨­å®š |
| `feature:pms_integration` | PMSé€£æº | PMS API |
| `feature:api_access` | APIé€£æº | å¤–éƒ¨API |
| `feature:custom_dev` | ã‚«ã‚¹ã‚¿ãƒ é–‹ç™º | è¦ç›¸è«‡ |
| `feature:dedicated_infra` | å°‚ç”¨ã‚¤ãƒ³ãƒ•ãƒ© | ã‚¤ãƒ³ãƒ•ãƒ©è¨­å®š |

---

## 4. AIã‚¯ãƒ¬ã‚¸ãƒƒãƒˆåˆ¶é™

### 4.1 ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆå®šç¾©

| æ“ä½œ | æ¶ˆè²»ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ | èª¬æ˜ |
|:-----|:--------------:|:-----|
| AIãƒãƒ£ãƒƒãƒˆï¼ˆ1ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼‰ | 1 | 1å›ã®ä¼šè©± |
| ç¿»è¨³ï¼ˆ1ãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼‰ | 1 | 1ãƒ†ã‚­ã‚¹ãƒˆç¿»è¨³ |
| ãƒ¬ã‚³ãƒ¡ãƒ³ãƒ‰ç”Ÿæˆ | 2 | ãŠã™ã™ã‚ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”Ÿæˆ |
| ç”»åƒç”Ÿæˆï¼ˆå°†æ¥ï¼‰ | 10 | AIç”»åƒç”Ÿæˆ |

### 4.2 æœˆæ¬¡ãƒªã‚»ãƒƒãƒˆ

- **ãƒªã‚»ãƒƒãƒˆã‚¿ã‚¤ãƒŸãƒ³ã‚°**: æ¯æœˆ1æ—¥ 00:00 JST
- **æœªä½¿ç”¨åˆ†**: ç¹°ã‚Šè¶Šã—ãªã—
- **è¶…éæ™‚**: è¿½åŠ è³¼å…¥ or ç¿Œæœˆã¾ã§å¾…æ©Ÿ

### 4.3 è¿½åŠ ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆè³¼å…¥

| ãƒ‘ãƒƒã‚¯ | ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆæ•° | ä¾¡æ ¼ | å˜ä¾¡ |
|:-------|:------------:|-----:|:----:|
| 100ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ | 100 | Â¥1,000 | Â¥10 |
| 500ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ | 500 | Â¥4,000 | Â¥8 |
| 1,000ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ | 1,000 | Â¥7,000 | Â¥7 |

---

## 5. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ

### 5.0 æ—¢å­˜ãƒ†ãƒ¼ãƒ–ãƒ«ã¨ã®é–¢ä¿‚

> **é‡è¦**: SSOT_SAAS_MULTITENANT.md ã§å®šç¾©ã•ã‚ŒãŸæ—¢å­˜ãƒ†ãƒ¼ãƒ–ãƒ«ã¨ã®é–¢ä¿‚ã‚’æ˜ç¢ºã«ã™ã‚‹

#### æ—¢å­˜ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆSSOT_SAAS_MULTITENANT.mdï¼‰

| ãƒ†ãƒ¼ãƒ–ãƒ« | ç”¨é€” | æœ¬SSOTã¨ã®é–¢ä¿‚ |
|:---------|:-----|:---------------|
| `tenant_system_plan` | ãƒ†ãƒŠãƒ³ãƒˆÃ—ã‚·ã‚¹ãƒ†ãƒ Ã—ãƒ—ãƒ©ãƒ³ | **ç½®æ›**: `tenant_subscriptions`ã«çµ±åˆ |
| `system_plan_restrictions` | ãƒ—ãƒ©ãƒ³åˆ¶é™å®šç¾© | **çµ±åˆ**: `subscription_plans.features`ï¼ˆJSONé…åˆ—ï¼‰ã«å¸å |

#### ç§»è¡Œæ–¹é‡

```markdown
ã€Phase 1: ä¸¦è¡Œé‹ç”¨ã€‘
1. æ–°ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆsubscription_plans, tenant_subscriptionsï¼‰ã‚’ä½œæˆ
2. æ—¢å­˜ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆtenant_system_plan, system_plan_restrictionsï¼‰ã¯æ®‹ç½®
3. æ–°è¦ãƒ†ãƒŠãƒ³ãƒˆã¯æ–°ãƒ†ãƒ¼ãƒ–ãƒ«ã§ç®¡ç†

ã€Phase 2: ãƒ‡ãƒ¼ã‚¿ç§»è¡Œã€‘
1. æ—¢å­˜ãƒ†ãƒŠãƒ³ãƒˆã®ãƒ‡ãƒ¼ã‚¿ã‚’æ–°ãƒ†ãƒ¼ãƒ–ãƒ«ã«ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
2. ç§»è¡Œå®Œäº†å¾Œã€æ—¢å­˜ãƒ†ãƒ¼ãƒ–ãƒ«ã¯å‚ç…§ã®ã¿

ã€Phase 3: å®Œå…¨ç§»è¡Œã€‘
1. å…¨ãƒ†ãƒŠãƒ³ãƒˆç§»è¡Œå®Œäº†ã‚’ç¢ºèª
2. æ—¢å­˜ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å‰Šé™¤ï¼ˆã¾ãŸã¯ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ï¼‰
```

#### ç§»è¡ŒSQLï¼ˆå‚è€ƒï¼‰

```sql
-- tenant_system_plan â†’ tenant_subscriptions ã¸ã®ç§»è¡Œ
INSERT INTO tenant_subscriptions (tenant_id, plan_id, status)
SELECT 
  tsp.tenant_id,
  sp.id,
  'active'
FROM tenant_system_plan tsp
JOIN subscription_plans sp ON sp.code = CONCAT(
  CASE WHEN tsp.system_id = 'leisure' THEN 'leisure_' ELSE 'omotenasu_' END,
  LOWER(tsp.plan_name)
);
```

---

### 5.1 ãƒ†ãƒ¼ãƒ–ãƒ«: subscription_plans

```sql
CREATE TABLE subscription_plans (
  id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  code            VARCHAR(50) UNIQUE NOT NULL,  -- 'leisure_starter' ç­‰
  name            VARCHAR(100) NOT NULL,        -- 'Starter Plan'
  product_line    VARCHAR(20) NOT NULL,         -- 'leisure' or 'omotenasu'
  monthly_price   INT NOT NULL,                 -- 9800 (å††)
  room_limit      INT NOT NULL,                 -- 10
  overage_price   INT NOT NULL,                 -- 1200 (å††/å®¤)
  ai_credits      INT,                          -- 100 (NULL=ç„¡åˆ¶é™)
  features        JSONB NOT NULL DEFAULT '[]',  -- æ©Ÿèƒ½ã‚³ãƒ¼ãƒ‰é…åˆ—
  display_order   INT NOT NULL DEFAULT 0,
  is_active       BOOLEAN NOT NULL DEFAULT true,
  created_at      TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at      TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_subscription_plans_code ON subscription_plans(code);
CREATE INDEX idx_subscription_plans_product_line ON subscription_plans(product_line);
```

### 5.2 ãƒ†ãƒ¼ãƒ–ãƒ«: tenant_subscriptions

```sql
CREATE TABLE tenant_subscriptions (
  id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id       VARCHAR(100) NOT NULL REFERENCES tenants(id),
  plan_id         UUID NOT NULL REFERENCES subscription_plans(id),
  billing_cycle   VARCHAR(20) NOT NULL DEFAULT 'monthly',  -- 'monthly', 'yearly', '2yearly'
  discount_rate   DECIMAL(5,4) NOT NULL DEFAULT 0,         -- 0.05 = 5%
  current_rooms   INT NOT NULL DEFAULT 0,
  ai_credits_used INT NOT NULL DEFAULT 0,
  ai_credits_reset_at TIMESTAMPTZ,
  started_at      TIMESTAMPTZ NOT NULL DEFAULT now(),
  expires_at      TIMESTAMPTZ,
  status          VARCHAR(20) NOT NULL DEFAULT 'active',   -- 'active', 'cancelled', 'expired'
  created_at      TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at      TIMESTAMPTZ NOT NULL DEFAULT now(),
  
  UNIQUE(tenant_id)  -- 1ãƒ†ãƒŠãƒ³ãƒˆ1ãƒ—ãƒ©ãƒ³
);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_tenant_subscriptions_tenant ON tenant_subscriptions(tenant_id);
CREATE INDEX idx_tenant_subscriptions_status ON tenant_subscriptions(status);
```

### 5.3 ãƒ†ãƒ¼ãƒ–ãƒ«: ai_credit_transactions

```sql
CREATE TABLE ai_credit_transactions (
  id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id       VARCHAR(100) NOT NULL REFERENCES tenants(id),
  operation       VARCHAR(50) NOT NULL,         -- 'chat', 'translation', 'recommend'
  credits_used    INT NOT NULL,
  balance_after   INT NOT NULL,
  metadata        JSONB,                        -- è¿½åŠ æƒ…å ±
  created_at      TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_ai_credit_transactions_tenant ON ai_credit_transactions(tenant_id);
CREATE INDEX idx_ai_credit_transactions_created ON ai_credit_transactions(created_at);
```

### 5.4 Prismaã‚¹ã‚­ãƒ¼ãƒ

```prisma
model SubscriptionPlan {
  id            String   @id @default(cuid())
  code          String   @unique
  name          String
  productLine   String   @map("product_line")
  monthlyPrice  Int      @map("monthly_price")
  roomLimit     Int      @map("room_limit")
  overagePrice  Int      @map("overage_price")
  aiCredits     Int?     @map("ai_credits")
  features      Json     @default("[]")
  displayOrder  Int      @default(0) @map("display_order")
  isActive      Boolean  @default(true) @map("is_active")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
  
  tenantSubscriptions TenantSubscription[]
  
  @@map("subscription_plans")
}

model TenantSubscription {
  id              String   @id @default(cuid())
  tenantId        String   @unique @map("tenant_id")
  planId          String   @map("plan_id")
  billingCycle    String   @default("monthly") @map("billing_cycle")
  discountRate    Decimal  @default(0) @map("discount_rate")
  currentRooms    Int      @default(0) @map("current_rooms")
  aiCreditsUsed   Int      @default(0) @map("ai_credits_used")
  aiCreditsResetAt DateTime? @map("ai_credits_reset_at")
  startedAt       DateTime @default(now()) @map("started_at")
  expiresAt       DateTime? @map("expires_at")
  status          String   @default("active")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  
  tenant Tenant @relation(fields: [tenantId], references: [id])
  plan   SubscriptionPlan @relation(fields: [planId], references: [id])
  
  @@map("tenant_subscriptions")
}

model AiCreditTransaction {
  id           String   @id @default(cuid())
  tenantId     String   @map("tenant_id")
  operation    String
  creditsUsed  Int      @map("credits_used")
  balanceAfter Int      @map("balance_after")
  metadata     Json?
  createdAt    DateTime @default(now()) @map("created_at")
  
  @@index([tenantId])
  @@index([createdAt])
  @@map("ai_credit_transactions")
}
```

### 5.5 Tenantãƒ¢ãƒ‡ãƒ«ã¸ã®é€†ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

> **é‡è¦**: æ—¢å­˜ã®Tenantãƒ¢ãƒ‡ãƒ«ã«é€†ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™

```prisma
// æ—¢å­˜ã®Tenantãƒ¢ãƒ‡ãƒ«ã«è¿½åŠ 
model Tenant {
  // ... æ—¢å­˜ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
  
  // â˜…ã‚¨ãƒ³ã‚¿ã‚¤ãƒˆãƒ«ãƒ¡ãƒ³ãƒˆç”¨ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³è¿½åŠ 
  subscription TenantSubscription?  // 1:1 ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
  
  // ... æ—¢å­˜ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
}
```

**å®Ÿè£…æ™‚ã®æ³¨æ„**:
- `hotel-common-rebuild/prisma/schema.prisma` ã® `Tenant` ãƒ¢ãƒ‡ãƒ«ã‚’æ›´æ–°
- ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ä½œæˆ: `npx prisma migrate dev --name add_subscription_relation`

---

## 6. APIè¨­è¨ˆ

> **å‚ç…§**: ä»¥ä¸‹ã®APIã¯ `SSOT_API_REGISTRY.md` ã«ã‚‚ç™»éŒ²æ¸ˆã¿  
> **å®Ÿè£…ã‚¿ã‚¹ã‚¯**: DEV-0430ï¼ˆã‚¨ãƒ³ã‚¿ã‚¤ãƒˆãƒ«ãƒ¡ãƒ³ãƒˆåŸºç›¤å®Ÿè£…ï¼‰

### 6.1 ã‚¨ãƒ³ã‚¿ã‚¤ãƒˆãƒ«ãƒ¡ãƒ³ãƒˆç¢ºèªAPI

**ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**: `GET /api/v1/admin/entitlements`  
**èªè¨¼**: Sessionèªè¨¼ï¼ˆAdminå‘ã‘ï¼‰

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹**:
```json
{
  "success": true,
  "data": {
    "plan": {
      "code": "leisure_starter",
      "name": "Starter Plan",
      "productLine": "leisure"
    },
    "limits": {
      "rooms": {
        "limit": 10,
        "current": 8,
        "remaining": 2
      },
      "aiCredits": {
        "limit": 100,
        "used": 45,
        "remaining": 55,
        "resetsAt": "2026-02-01T00:00:00Z"
      }
    },
    "features": {
      "orderSystem": true,
      "tvUi": true,
      "translationLanguages": 5,
      "campaign": false,
      "aiConcierge": null,
      "analytics": null,
      "layoutEditor": false
    }
  }
}
```

### 6.2 æ©Ÿèƒ½ãƒã‚§ãƒƒã‚¯API

**ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**: `GET /api/v1/admin/entitlements/check/:featureCode`

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼ˆè¨±å¯ï¼‰**:
```json
{
  "success": true,
  "data": {
    "allowed": true,
    "feature": "feature:ai_concierge:basic"
  }
}
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼ˆæ‹’å¦ï¼‰**:
```json
{
  "success": false,
  "error": {
    "code": "FEATURE_NOT_AVAILABLE",
    "message": "ã“ã®æ©Ÿèƒ½ã¯Pro Liteä»¥ä¸Šã®ãƒ—ãƒ©ãƒ³ã§åˆ©ç”¨ã§ãã¾ã™",
    "upgradeUrl": "/admin/settings/subscription/upgrade"
  }
}
```

### 6.3 AIã‚¯ãƒ¬ã‚¸ãƒƒãƒˆæ¶ˆè²»API

**ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**: `POST /api/v1/admin/entitlements/consume-credit`

**ãƒªã‚¯ã‚¨ã‚¹ãƒˆ**:
```json
{
  "operation": "chat",
  "credits": 1
}
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼ˆæˆåŠŸï¼‰**:
```json
{
  "success": true,
  "data": {
    "consumed": 1,
    "remaining": 54
  }
}
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼ˆä¸Šé™åˆ°é”ï¼‰**:
```json
{
  "success": false,
  "error": {
    "code": "CREDIT_LIMIT_EXCEEDED",
    "message": "ä»Šæœˆã®AIã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚’ä½¿ã„åˆ‡ã‚Šã¾ã—ãŸ",
    "purchaseUrl": "/admin/settings/subscription/credits"
  }
}
```

---

## 7. å®Ÿè£…ã‚¬ã‚¤ãƒ‰

### 7.1 ã‚¨ãƒ³ã‚¿ã‚¤ãƒˆãƒ«ãƒ¡ãƒ³ãƒˆãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢

```typescript
// hotel-common-rebuild/src/middleware/entitlement.middleware.ts

import { Request, Response, NextFunction } from 'express'
import { prisma } from '../lib/prisma'

export function requireFeature(featureCode: string) {
  return async (req: Request, res: Response, next: NextFunction) => {
    const tenantId = req.tenantId
    
    const subscription = await prisma.tenantSubscription.findUnique({
      where: { tenantId },
      include: { plan: true }
    })
    
    if (!subscription || subscription.status !== 'active') {
      return res.status(403).json({
        success: false,
        error: {
          code: 'NO_ACTIVE_SUBSCRIPTION',
          message: 'ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“'
        }
      })
    }
    
    const features = subscription.plan.features as string[]
    if (!features.includes(featureCode)) {
      return res.status(403).json({
        success: false,
        error: {
          code: 'FEATURE_NOT_AVAILABLE',
          message: 'ã“ã®æ©Ÿèƒ½ã¯ç¾åœ¨ã®ãƒ—ãƒ©ãƒ³ã§ã¯åˆ©ç”¨ã§ãã¾ã›ã‚“',
          upgradeUrl: '/admin/settings/subscription/upgrade'
        }
      })
    }
    
    next()
  }
}
```

### 7.2 å®¤æ•°åˆ¶é™ãƒã‚§ãƒƒã‚¯

```typescript
// hotel-common-rebuild/src/services/entitlement.service.ts

export async function checkRoomLimit(tenantId: string): Promise<{
  allowed: boolean
  current: number
  limit: number
}> {
  const subscription = await prisma.tenantSubscription.findUnique({
    where: { tenantId },
    include: { plan: true }
  })
  
  if (!subscription) {
    return { allowed: false, current: 0, limit: 0 }
  }
  
  const currentRooms = await prisma.rooms.count({
    where: { tenantId, isDeleted: false }
  })
  
  return {
    allowed: currentRooms < subscription.plan.roomLimit,
    current: currentRooms,
    limit: subscription.plan.roomLimit
  }
}
```

### 7.3 AIã‚¯ãƒ¬ã‚¸ãƒƒãƒˆæ¶ˆè²»

```typescript
// hotel-common-rebuild/src/services/ai-credit.service.ts

import { Redis } from 'ioredis'

const redis = new Redis(process.env.REDIS_URL)

export async function consumeAiCredit(
  tenantId: string,
  operation: string,
  credits: number = 1
): Promise<{ success: boolean; remaining: number }> {
  const key = `ai_credits:${tenantId}:${getCurrentMonth()}`
  
  // Redisã§é«˜é€Ÿã‚«ã‚¦ãƒ³ãƒˆ
  const used = await redis.incrby(key, credits)
  
  // ãƒ—ãƒ©ãƒ³ä¸Šé™ã‚’å–å¾—
  const subscription = await prisma.tenantSubscription.findUnique({
    where: { tenantId },
    include: { plan: true }
  })
  
  const limit = subscription?.plan.aiCredits ?? Infinity
  
  if (used > limit) {
    // ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯
    await redis.decrby(key, credits)
    return { success: false, remaining: 0 }
  }
  
  // ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ãƒ­ã‚°è¨˜éŒ²ï¼ˆéåŒæœŸï¼‰
  prisma.aiCreditTransaction.create({
    data: {
      tenantId,
      operation,
      creditsUsed: credits,
      balanceAfter: limit - used
    }
  }).catch(console.error)
  
  return { success: true, remaining: limit - used }
}

function getCurrentMonth(): string {
  const now = new Date()
  return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`
}
```

---

## 8. ãƒ†ã‚¹ãƒˆè¦ä»¶

### 8.1 å˜ä½“ãƒ†ã‚¹ãƒˆ

| ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ | æœŸå¾…çµæœ |
|:-------------|:---------|
| Starterãƒ—ãƒ©ãƒ³ã§å®¤æ•°10å®¤ä»¥ä¸‹ | âœ… è¨±å¯ |
| Starterãƒ—ãƒ©ãƒ³ã§å®¤æ•°11å®¤ç›®è¿½åŠ  | âŒ æ‹’å¦ + ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰æ¡ˆå†… |
| AIã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ100æ¶ˆè²»å¾Œã®101å›ç›® | âŒ æ‹’å¦ + è³¼å…¥æ¡ˆå†… |
| æœˆåˆã«AIã‚¯ãƒ¬ã‚¸ãƒƒãƒˆãƒªã‚»ãƒƒãƒˆ | âœ… æ®‹é«˜100ã«å¾©å¸° |

### 8.2 çµ±åˆãƒ†ã‚¹ãƒˆ

```bash
# å®¤æ•°åˆ¶é™ãƒ†ã‚¹ãƒˆ
curl -X POST http://localhost:3401/api/v1/admin/rooms \
  -H 'Content-Type: application/json' \
  -H 'Cookie: hotel_session=xxx' \
  -d '{"roomNumber": "11"}'
# æœŸå¾…: 403 ROOM_LIMIT_EXCEEDED

# AIã‚¯ãƒ¬ã‚¸ãƒƒãƒˆæ¶ˆè²»ãƒ†ã‚¹ãƒˆ
curl -X POST http://localhost:3401/api/v1/ai/chat \
  -H 'Content-Type: application/json' \
  -d '{"message": "ãŠã™ã™ã‚ãƒ¡ãƒ‹ãƒ¥ãƒ¼"}'
# æœŸå¾…: 200 + remainingCreditsè¡¨ç¤º
```

---

## ğŸ“ å¤‰æ›´å±¥æ­´

| ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | æ—¥ä»˜ | å¤‰æ›´å†…å®¹ |
|:-----------|:-----|:---------|
| 1.1.0 | 2026-01-03 | APIãƒ¬ã‚¸ã‚¹ãƒˆãƒªç™»éŒ²ã€æ—¢å­˜ãƒ†ãƒ¼ãƒ–ãƒ«é–¢ä¿‚æ˜è¨˜ã€Tenanté€†ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³è¿½åŠ  |
| 1.0.0 | 2026-01-03 | åˆç‰ˆä½œæˆï¼ˆDEV-0409ï¼‰ |

