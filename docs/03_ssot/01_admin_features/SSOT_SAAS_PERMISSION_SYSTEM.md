# ğŸ” SSOT: hotel-saas æ¨©é™ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ 

**Doc-ID**: SSOT-SAAS-PERMISSION-001  
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 2.2.0  
**ä½œæˆæ—¥**: 2025å¹´10æœˆ8æ—¥  
**æœ€çµ‚æ›´æ–°**: 2025å¹´10æœˆ20æ—¥ï¼ˆæ¨©é™éšå±¤æ§‹é€ ã®è¿½åŠ ï¼‰  
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: ğŸ”´ æ‰¿èªæ¸ˆã¿ï¼ˆæœ€é«˜æ¨©å¨ï¼‰  
**æ‰€æœ‰è€…**: Sunï¼ˆhotel-saasæ‹…å½“AIï¼‰

**v2.0.0 å¤‰æ›´å†…å®¹**:
- âœ… è¦ä»¶IDä½“ç³»é©ç”¨ï¼ˆPERM-001ã€œï¼‰
- âœ… Acceptï¼ˆåˆæ ¼æ¡ä»¶ï¼‰ã‚’å…¨æ©Ÿèƒ½ã«æ˜è¨˜
- âœ… ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ä¾‹ã‚’è¿½åŠ 
- âœ… å‹å®šç¾©ä¾‹ã‚’è¿½åŠ 
- âŒ ãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰ä»•æ§˜ã¯å‰Šé™¤ï¼ˆv2.1.0ã§å»ƒæ­¢ï¼‰

**v2.1.0 å¤‰æ›´å†…å®¹**ï¼ˆ2025-10-20ï¼‰:
- âŒ **ãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰å…¨æ¨©é™ã‚’å»ƒæ­¢**ï¼ˆ`*:*:*` ç­‰ï¼‰
- âœ… **å€‹åˆ¥æ¨©é™ã®ã¿ã«çµ±ä¸€**
- âœ… å®Ÿè£…ã®å˜ç´”åŒ–ãƒ»ãƒã‚°å‰Šæ¸›
- âœ… PERM-002, PERM-003, PERM-004 å‰Šé™¤
- âœ… æ¨©é™ãƒã‚§ãƒƒã‚¯ãƒ­ã‚¸ãƒƒã‚¯ç°¡ç´ åŒ–

**v2.2.0 å¤‰æ›´å†…å®¹**ï¼ˆ2025-10-20ï¼‰:
- âœ… **æ¨©é™éšå±¤æ§‹é€ ã®è¿½åŠ **ï¼ˆPERM-009ï¼‰
- âœ… ä¸Šä½æ¨©é™é¸æŠæ™‚ã®ä¸‹ä½æ¨©é™è‡ªå‹•ä»˜ä¸æ©Ÿèƒ½
- âœ… ä¸‹ä½æ¨©é™è§£é™¤æ™‚ã®ä¸Šä½æ¨©é™è‡ªå‹•è§£é™¤æ©Ÿèƒ½
- âœ… å®Œå…¨ãªéšå±¤ãƒãƒƒãƒ—å®šç¾©ï¼ˆhotel-saas, system, hotel-pmså…¨ã‚«ãƒ†ã‚´ãƒªï¼‰
- âœ… UIå®Ÿè£…è¦ä»¶è¿½åŠ ï¼ˆPERM-UI-006, PERM-UI-007ï¼‰
- âœ… ãƒ¬ãƒ™ãƒ«ãƒãƒƒã‚¸ãƒ»ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆè¡¨ç¤ºã«ã‚ˆã‚‹UXå‘ä¸Š

**é–¢é€£SSOT**:
- [SSOT_SAAS_MULTITENANT.md](../00_foundation/SSOT_SAAS_MULTITENANT.md) - ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆåŸºç›¤
- [SSOT_SAAS_ADMIN_AUTHENTICATION.md](../00_foundation/SSOT_SAAS_ADMIN_AUTHENTICATION.md) - ç®¡ç†ç”»é¢èªè¨¼
- [SSOT_SAAS_DATABASE_SCHEMA.md](../00_foundation/SSOT_SAAS_DATABASE_SCHEMA.md) - ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒ

---

## ğŸ“‹ ç›®æ¬¡

1. [è¦ä»¶IDä¸€è¦§](#è¦ä»¶idä¸€è¦§) â­ **NEW**
2. [æ¦‚è¦](#æ¦‚è¦)
3. [ã‚¹ã‚³ãƒ¼ãƒ—](#ã‚¹ã‚³ãƒ¼ãƒ—)
4. [åŸºæœ¬æ–¹é‡](#åŸºæœ¬æ–¹é‡)
5. [ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ](#ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ)
6. [APIä»•æ§˜](#apiä»•æ§˜)
7. [ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å®Ÿè£…](#ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å®Ÿè£…)
8. [æ¨©é™ãƒã‚§ãƒƒã‚¯å®Ÿè£…](#æ¨©é™ãƒã‚§ãƒƒã‚¯å®Ÿè£…)
9. [æ¥­æ…‹åˆ¥ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ](#æ¥­æ…‹åˆ¥ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ)
10. [ã‚°ãƒ«ãƒ¼ãƒ—ãƒ»ãƒ–ãƒ©ãƒ³ãƒ‰é€£æº](#ã‚°ãƒ«ãƒ¼ãƒ—ãƒ–ãƒ©ãƒ³ãƒ‰é€£æº)
11. [ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£](#ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£)
12. [ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ‰‹é †](#ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ‰‹é †)
13. [å®Ÿè£…ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ](#å®Ÿè£…ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ)

---

## ğŸ¯ è¦ä»¶IDä¸€è¦§

### ã‚³ã‚¢æ©Ÿèƒ½

| è¦ä»¶ID | æ©Ÿèƒ½ | æ¦‚è¦ | çŠ¶æ…‹ |
|--------|------|------|------|
| **PERM-001** | æ¨©é™ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ | `{category}:{resource}:{action}` å½¢å¼ | âœ… æœ‰åŠ¹ |
| ~~**PERM-002**~~ | ~~ãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰å…¨æ¨©é™~~ | ~~`*:*:*` ã«ã‚ˆã‚‹å…¨ã‚·ã‚¹ãƒ†ãƒ æ¨©é™~~ | âŒ **å»ƒæ­¢** |
| ~~**PERM-003**~~ | ~~ãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰ã‚«ãƒ†ã‚´ãƒª~~ | ~~`hotel-saas:*:*` ç­‰ã®ã‚«ãƒ†ã‚´ãƒªä¸€æ‹¬~~ | âŒ **å»ƒæ­¢** |
| ~~**PERM-004**~~ | ~~ãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰ãƒªã‚½ãƒ¼ã‚¹~~ | ~~`hotel-saas:menu:*` ç­‰ã®ãƒªã‚½ãƒ¼ã‚¹ä¸€æ‹¬~~ | âŒ **å»ƒæ­¢** |
| **PERM-005** | å½¹è·CRUD | å½¹è·ã®ä½œæˆãƒ»èª­å–ãƒ»æ›´æ–°ãƒ»å‰Šé™¤ | âœ… æœ‰åŠ¹ |
| **PERM-006** | æ¨©é™ãƒãƒƒãƒ”ãƒ³ã‚° | å½¹è·ã¨æ¨©é™ã®ç´ä»˜ã‘ï¼ˆå€‹åˆ¥æ¨©é™ã®ã¿ï¼‰ | âœ… æœ‰åŠ¹ |
| **PERM-007** | UIå®Ÿè£… | å…¨ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹è¡¨ç¤º | âœ… æœ‰åŠ¹ |
| **PERM-008** | æ¨©é™ãƒã‚§ãƒƒã‚¯ | `checkPermission()` ã«ã‚ˆã‚‹æ¤œè¨¼ï¼ˆé…åˆ—æ¤œç´¢ï¼‰ | âœ… æœ‰åŠ¹ |
| **PERM-009** | æ¨©é™éšå±¤æ§‹é€  | ä¸Šä½æ¨©é™é¸æŠæ™‚ã«ä¸‹ä½æ¨©é™ã‚‚è‡ªå‹•ä»˜ä¸ | âœ… æœ‰åŠ¹ |

### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹

| è¦ä»¶ID | æ©Ÿèƒ½ | æ¦‚è¦ |
|--------|------|------|
| **PERM-DB-001** | rolesãƒ†ãƒ¼ãƒ–ãƒ« | å½¹è·ãƒã‚¹ã‚¿ |
| **PERM-DB-002** | permissionsãƒ†ãƒ¼ãƒ–ãƒ« | æ¨©é™ãƒã‚¹ã‚¿ |
| **PERM-DB-003** | role_permissionsãƒ†ãƒ¼ãƒ–ãƒ« | ç´ä»˜ã‘ãƒ†ãƒ¼ãƒ–ãƒ« |

### API

| è¦ä»¶ID | æ©Ÿèƒ½ | æ¦‚è¦ |
|--------|------|------|
| **PERM-API-001** | GET /roles | å½¹è·ä¸€è¦§å–å¾— |
| **PERM-API-002** | GET /roles/:id | å½¹è·è©³ç´°å–å¾— |
| **PERM-API-003** | POST /roles | å½¹è·ä½œæˆ |
| **PERM-API-004** | PUT /roles/:id | å½¹è·æ›´æ–° |
| **PERM-API-005** | DELETE /roles/:id | å½¹è·å‰Šé™¤ |
| **PERM-API-006** | PUT /roles/permissions | æ¨©é™ä¿å­˜ |
| **PERM-API-007** | GET /permissions | æ¨©é™ä¸€è¦§å–å¾— |

### UI

| è¦ä»¶ID | æ©Ÿèƒ½ | æ¦‚è¦ |
|--------|------|------|
| **PERM-UI-001** | å½¹è·ä¸€è¦§ç”»é¢ | `/admin/roles` |
| **PERM-UI-002** | æ¨©é™ãƒãƒˆãƒªãƒƒã‚¯ã‚¹ç”»é¢ | `/admin/roles/:id/permissions` |
| **PERM-UI-003** | å…¨æ¨©é™ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ | ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰ |
| **PERM-UI-004** | ã‚«ãƒ†ã‚´ãƒªä¸€æ‹¬é¸æŠ | ã‚«ãƒ†ã‚´ãƒªãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰ |
| **PERM-UI-005** | å®ŸåŠ¹æ¨©é™ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ | ãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰å±•é–‹è¡¨ç¤º |
| **PERM-UI-006** | æ¨©é™éšå±¤ã‚°ãƒ«ãƒ¼ãƒ”ãƒ³ã‚°è¡¨ç¤º | ãƒªã‚½ãƒ¼ã‚¹å˜ä½ã§éšå±¤è¡¨ç¤º |
| **PERM-UI-007** | æ¨©é™ãƒ¬ãƒ™ãƒ«è¦–è¦šåŒ– | ãƒ¬ãƒ™ãƒ«ãƒãƒƒã‚¸ãƒ»ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆè¡¨ç¤º |

---

## ğŸ“– æ¦‚è¦

### ç›®çš„

hotel-saasç®¡ç†ç”»é¢ã«ãŠã‘ã‚‹ã€ãƒ†ãƒŠãƒ³ãƒˆï¼ˆãƒ›ãƒ†ãƒ«ï¼‰ã”ã¨ã®æŸ”è»Ÿãªå½¹è·ãƒ»æ¨©é™ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã®å®Œå…¨ãªä»•æ§˜ã‚’å®šç¾©ã™ã‚‹ã€‚

### é©ç”¨ç¯„å›²

- âœ… hotel-saasç®¡ç†ç”»é¢ã®æ¨©é™åˆ¶å¾¡ï¼ˆ`hotel-saas`ã€`system`ã‚«ãƒ†ã‚´ãƒªï¼‰
- âœ… hotel-common APIã®æ¨©é™ãƒã‚¹ã‚¿ç®¡ç†ï¼ˆå…¨ã‚«ãƒ†ã‚´ãƒªï¼‰
- âœ… ãƒ†ãƒŠãƒ³ãƒˆåˆ¥ã®å½¹è·ãƒ»æ¨©é™ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º
- âœ… ã‚°ãƒ«ãƒ¼ãƒ—ãƒ»ãƒ–ãƒ©ãƒ³ãƒ‰ï¼ˆãƒã‚§ãƒ¼ãƒ³ï¼‰é–“ã®æ¨©é™ã‚³ãƒ”ãƒ¼
- ğŸ”„ hotel-pmsã€hotel-memberã¸ã®æ¨©é™é€£æºï¼ˆå°†æ¥å¯¾å¿œï¼‰

### ğŸ“Œ é‡è¦ãªè¨­è¨ˆæ–¹é‡

**ã“ã®SSOTã¯hotel-saasç®¡ç†ç”»é¢ã®å®Ÿè£…ä»•æ§˜ã§ã™ãŒã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆã¨APIä»•æ§˜ã¯å…¨ã‚·ã‚¹ãƒ†ãƒ å…±é€šã§ã™ã€‚**

#### å„ã‚·ã‚¹ãƒ†ãƒ ã®è²¬å‹™

| ã‚·ã‚¹ãƒ†ãƒ  | è²¬å‹™ | ç®¡ç†ç”»é¢ã§æ‰±ã†ã‚«ãƒ†ã‚´ãƒª |
|---------|------|---------------------|
| **hotel-common** | æ¨©é™ãƒã‚¹ã‚¿DBç®¡ç†ã€çµ±ä¸€APIæä¾› | ï¼ˆç®¡ç†ç”»é¢ãªã—ï¼‰ |
| **hotel-saas** | SaaSæ©Ÿèƒ½ã®æ¨©é™è¨­å®šUI | `hotel-saas`, `system` |
| **hotel-pms** | PMSæ©Ÿèƒ½ã®æ¨©é™è¨­å®šUI | `hotel-pms`, `system` |

#### hotel-pmså®Ÿè£…æ™‚ã®æ³¨æ„äº‹é …

**hotel-pmsç®¡ç†ç”»é¢ã‚’å®Ÿè£…ã™ã‚‹éš›ã¯ã€æœ¬SSOTã‚’å‚è€ƒã«ã—ã¦ãã ã•ã„ï¼š**

- âœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆï¼ˆ`roles`, `permissions`, `role_permissions`ï¼‰ã¯å…±é€š
- âœ… APIä»•æ§˜ï¼ˆhotel-commonï¼‰ã¯å…±é€š
- âœ… ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆå½¹è·ä¸€è¦§ã€æ¨©é™ãƒãƒˆãƒªãƒƒã‚¯ã‚¹ç­‰ï¼‰ã¯æµç”¨å¯èƒ½
- âš ï¸ è¡¨ç¤ºã™ã‚‹æ¨©é™ã‚«ãƒ†ã‚´ãƒªã®ã¿å¤‰æ›´:
  - hotel-saas â†’ `hotel-saas`, `system`
  - hotel-pms â†’ `hotel-pms`, `system`
- âš ï¸ ã‚¿ãƒ–æ§‹æˆã¯ä¸è¦:
  - hotel-saas: è‡ªã‚·ã‚¹ãƒ†ãƒ ã®ã‚«ãƒ†ã‚´ãƒªã®ã¿è¡¨ç¤ºï¼ˆã‚¿ãƒ–åˆ†ã‘ä¸è¦ï¼‰
  - hotel-pms: è‡ªã‚·ã‚¹ãƒ†ãƒ ã®ã‚«ãƒ†ã‚´ãƒªã®ã¿è¡¨ç¤ºï¼ˆã‚¿ãƒ–åˆ†ã‘ä¸è¦ï¼‰

**hotel-pmså®Ÿè£…æ™‚ã«ã¯ã€å¿…è¦ã«å¿œã˜ã¦`SSOT_PMS_PERMISSION_UI.md`ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚**

### æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯

- **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹**: PostgreSQL (çµ±ä¸€DB)
- **ORM**: Prisma
- **ãƒ†ãƒ¼ãƒ–ãƒ«**: `roles`, `permissions`, `role_permissions`, `staff_tenant_memberships`
- **èªè¨¼æ–¹å¼**: Sessionèªè¨¼ï¼ˆRedis + HttpOnly Cookieï¼‰
- **ã‚­ãƒ£ãƒƒã‚·ãƒ¥**: Redisï¼ˆæ¨©é™æƒ…å ±ã®é«˜é€Ÿå–å¾—ï¼‰

---

## ğŸ¯ ã‚¹ã‚³ãƒ¼ãƒ—

### å¯¾è±¡æ©Ÿèƒ½

- âœ… å½¹è·ã®ä½œæˆãƒ»ç·¨é›†ãƒ»å‰Šé™¤ï¼ˆãƒ†ãƒŠãƒ³ãƒˆã”ã¨ï¼‰
- âœ… æ¨©é™ã®å®šç¾©ãƒ»ç®¡ç†ï¼ˆã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ï¼‰
- âœ… å½¹è·ã¨æ¨©é™ã®ãƒãƒƒãƒ”ãƒ³ã‚°ï¼ˆãƒ†ãƒŠãƒ³ãƒˆã”ã¨ï¼‰
- âœ… ã‚¹ã‚¿ãƒƒãƒ•ã¸ã®å½¹è·å‰²ã‚Šå½“ã¦ï¼ˆ`staff_tenant_memberships`çµŒç”±ï¼‰
- âœ… æ¥­æ…‹åˆ¥ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå½¹è·ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼ˆãƒ›ãƒ†ãƒ«ã€æ—…é¤¨ï¼‰
- âœ… ã‚¹ãƒ¼ãƒ‘ãƒ¼ã‚¢ãƒ‰ãƒŸãƒ³ã«ã‚ˆã‚‹ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç®¡ç†
- âœ… ãƒ–ãƒ©ãƒ³ãƒ‰ï¼ˆãƒã‚§ãƒ¼ãƒ³ï¼‰é–“ã§ã®å½¹è·ã‚³ãƒ”ãƒ¼æ©Ÿèƒ½

### å¯¾è±¡å¤–æ©Ÿèƒ½

- âŒ ãƒ›ãƒ†ãƒ«ã‚°ãƒ«ãƒ¼ãƒ—å…¨ä½“ã®çµ±ä¸€æ¨©é™ç®¡ç†ï¼ˆPhase 2ä»¥é™ï¼‰
- âŒ å¤–éƒ¨ã‚·ã‚¹ãƒ†ãƒ ï¼ˆOTAç­‰ï¼‰ã¨ã®æ¨©é™é€£æº
- âŒ ã‚²ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ¨©é™ç®¡ç†

---

## ğŸ¯ åŸºæœ¬æ–¹é‡

### 1. ãƒ¬ãƒ™ãƒ«æ¦‚å¿µã®å»ƒæ­¢

**é‡è¦**: å¾“æ¥ã®ã€Œãƒ¬ãƒ™ãƒ«1-5ã€ã«ã‚ˆã‚‹éšå±¤ç®¡ç†ã¯**å»ƒæ­¢**ã—ã¾ã™ã€‚

**ç†ç”±**:
- å›ºå®šéšå±¤ã§ã¯æŸ”è»Ÿãªå½¹è·ç®¡ç†ãŒã§ããªã„
- å½¹è·åã¨æ¨©é™ã®ãƒãƒƒãƒ”ãƒ³ã‚°ã§ååˆ†ã«ç®¡ç†å¯èƒ½
- è¡¨ç¤ºé †åºã¯`sort_order`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã§ç®¡ç†

**ç§»è¡Œæ–¹é‡**:
```typescript
// âŒ æ—§å®Ÿè£…ï¼ˆãƒ¬ãƒ™ãƒ«å›ºå®šï¼‰
level: 1 // OWNER
level: 2 // ADMIN
level: 3 // MANAGER
level: 4 // STAFF
level: 5 // READONLY

// âœ… æ–°å®Ÿè£…ï¼ˆæŸ”è»Ÿãªå½¹è·ç®¡ç†ï¼‰
roles: [
  { 
    name: 'æ”¯é…äºº', 
    sortOrder: 100, 
    permissions: [
      // å…¨49å€‹ã®å€‹åˆ¥æ¨©é™ã‚’åˆ—æŒ™
      'hotel-saas:order:view',
      'hotel-saas:order:create',
      'hotel-saas:order:update',
      'hotel-saas:order:delete',
      // ...ï¼ˆå…¨æ¨©é™ï¼‰
    ] 
  },
  { name: 'ãƒ•ãƒ­ãƒ³ãƒˆä¸»ä»»', sortOrder: 90, permissions: [...] },
  { name: 'ãƒ•ãƒ­ãƒ³ãƒˆã‚¹ã‚¿ãƒƒãƒ•', sortOrder: 80, permissions: [...] },
  { name: 'æ¸…æƒã‚¹ã‚¿ãƒƒãƒ•', sortOrder: 70, permissions: [...] }
]
```

---

### 2. æ¨©é™ã‚³ãƒ¼ãƒ‰ä½“ç³»

**å½¢å¼**: `system:resource:action`

**ä¾‹**:
```typescript
'hotel-pms:reservation:view'    // PMS: äºˆç´„é–²è¦§
'hotel-pms:reservation:create'  // PMS: äºˆç´„ä½œæˆ
'hotel-pms:billing:refund'      // PMS: è¿”é‡‘å‡¦ç†
'hotel-saas:order:view'         // SaaS: æ³¨æ–‡é–²è¦§
'hotel-saas:ai:use'             // SaaS: AIæ©Ÿèƒ½ä½¿ç”¨
'system:settings:update'        // ã‚·ã‚¹ãƒ†ãƒ è¨­å®šæ›´æ–°
```

~~**ãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰**~~ï¼ˆv2.1.0ã§å»ƒæ­¢ï¼‰:
```typescript
// âŒ å»ƒæ­¢ï¼šå®Ÿè£…ãŒè¤‡é›‘ã§ãƒã‚°ãŒå¤šç™ºã™ã‚‹ãŸã‚ä½¿ç”¨ä¸å¯
// '*:*:*'                 // å…¨æ¨©é™ï¼ˆæ”¯é…äººç­‰ï¼‰
// 'hotel-pms:*:*'         // PMSã®å…¨æ¨©é™
// 'hotel-pms:billing:*'   // ä¼šè¨ˆã®å…¨æ“ä½œ

// âœ… å€‹åˆ¥æ¨©é™ã®ã¿ä½¿ç”¨
'hotel-pms:billing:view'
'hotel-pms:billing:create'
'hotel-pms:billing:update'
// ...å…¨ã¦å€‹åˆ¥ã«åˆ—æŒ™
```

---

## ğŸ“ è¦ä»¶è©³ç´°ä»•æ§˜

### PERM-001: æ¨©é™ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ

**Acceptï¼ˆåˆæ ¼æ¡ä»¶ï¼‰**:
- âœ… æ¨©é™ã‚³ãƒ¼ãƒ‰ã¯ `{category}:{resource}:{action}` å½¢å¼ã§ã‚ã‚‹
- âœ… categoryã¯ `hotel-saas`, `hotel-pms`, `system` ã®ã„ãšã‚Œã‹
- âœ… resourceã¨actionã¯è‹±æ•°å­—ã¨ãƒã‚¤ãƒ•ãƒ³ã®ã¿ä½¿ç”¨å¯èƒ½
- âŒ ã‚³ãƒ­ãƒ³ï¼ˆ`:`ï¼‰ã¯åŒºåˆ‡ã‚Šæ–‡å­—ã¨ã—ã¦3ã¤ã®ã¿
- âŒ ç©ºæ–‡å­—åˆ—ã‚„ä¸æ­£ãªãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã¯æ‹’å¦

**Example**:
```typescript
// âœ… æ­£ã—ã„
'hotel-saas:order:view'
'hotel-pms:reservation:create'
'system:settings:update'

// âŒ é–“é•ã„
'hotel-saas-order-view'    // ã‚³ãƒ­ãƒ³ä¸è¶³
'hotel-saas:order'          // actionä¸è¶³
'hotel_saas:order:view'     // ã‚¢ãƒ³ãƒ€ãƒ¼ã‚¹ã‚³ã‚¢ä¸å¯
```

**Test Cases**:
```typescript
describe('PERM-001: æ¨©é™ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆæ¤œè¨¼', () => {
  it('æ­£ã—ã„ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã¯å—ç†ã•ã‚Œã‚‹', () => {
    expect(validatePermissionFormat('hotel-saas:order:view')).toBe(true)
  })

  it('ã‚³ãƒ­ãƒ³ä¸è¶³ã¯æ‹’å¦ã•ã‚Œã‚‹', () => {
    expect(validatePermissionFormat('hotel-saas-order')).toBe(false)
  })

  it('ä¸æ­£ãªæ–‡å­—ã¯æ‹’å¦ã•ã‚Œã‚‹', () => {
    expect(validatePermissionFormat('hotel_saas:order:view')).toBe(false)
  })
})
```

**Type**:
```typescript
type PermissionCode = `${Category}:${Resource}:${Action}`
type Category = 'hotel-saas' | 'hotel-pms' | 'system'
type Resource = string
type Action = 'create' | 'read' | 'update' | 'delete' | 'use' | string
```

---

### PERM-002: å€‹åˆ¥æ¨©é™ã®ã¿ï¼ˆãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰å»ƒæ­¢ï¼‰

**å»ƒæ­¢ç†ç”±**: 
- âŒ ãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰ï¼ˆ`*:*:*` ç­‰ï¼‰ã¯å®Ÿè£…ãŒè¤‡é›‘ã™ãã‚‹
- âŒ ãƒã‚°ãŒå¤šç™ºã—ã€ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ã‚³ã‚¹ãƒˆãŒé«˜ã„
- âŒ å€‹åˆ¥æ¨©é™ã¨ã®æ··åœ¨å‡¦ç†ãŒå›°é›£

**Acceptï¼ˆåˆæ ¼æ¡ä»¶ï¼‰**:
- âœ… æ¨©é™ã¯å¸¸ã«å€‹åˆ¥æ¨©é™ã¨ã—ã¦ä¿å­˜ã•ã‚Œã‚‹
- âœ… å…¨æ¨©é™ã‚’æŒã¤å½¹è·ã‚‚ã€å…¨ã¦ã®å€‹åˆ¥æ¨©é™ã‚’åˆ—æŒ™ã—ã¦ä¿å­˜
- âœ… ãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰ï¼ˆ`*`, `*:*:*`, `hotel-saas:*:*` ç­‰ï¼‰ã¯ä½¿ç”¨ä¸å¯
- âœ… æ¨©é™ãƒã‚§ãƒƒã‚¯ã¯å˜ç´”ãªé…åˆ—æ¤œç´¢ã®ã¿ï¼ˆ`includes()`ï¼‰
- âŒ ãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰ã‚’å«ã‚€æ¨©é™ã‚³ãƒ¼ãƒ‰ã¯ä¿å­˜æ™‚ã«ã‚¨ãƒ©ãƒ¼

**Example**:
```typescript
// âœ… æ­£ã—ã„ï¼šå€‹åˆ¥æ¨©é™ã®ã¿
role.permissions = [
  'hotel-saas:order:view',
  'hotel-saas:order:create',
  'hotel-saas:order:update',
  'hotel-saas:order:delete',
  'hotel-saas:menu:view',
  'hotel-saas:menu:create',
  // ... å…¨ã¦å€‹åˆ¥ã«åˆ—æŒ™ï¼ˆæ”¯é…äººã®å ´åˆã¯49å€‹ï¼‰
]

// âŒ å»ƒæ­¢ï¼šãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰
role.permissions = ['*:*:*']              // ä½¿ç”¨ä¸å¯
role.permissions = ['hotel-saas:*:*']     // ä½¿ç”¨ä¸å¯
role.permissions = ['hotel-saas:menu:*']  // ä½¿ç”¨ä¸å¯
```

**Test Cases**:
```typescript
describe('PERM-002: å€‹åˆ¥æ¨©é™ã®ã¿', () => {
  it('å€‹åˆ¥æ¨©é™ã¯æ­£å¸¸ã«ä¿å­˜ã•ã‚Œã‚‹', async () => {
    const role = {
      permissions: [
        'hotel-saas:order:view',
        'hotel-saas:order:create'
      ]
    }
    
    const saved = await saveRole(role)
    expect(saved.permissions).toEqual(role.permissions)
  })

  it('ãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰ã‚’å«ã‚€æ¨©é™ã¯ã‚¨ãƒ©ãƒ¼', async () => {
    const role = {
      permissions: ['*:*:*']
    }
    
    await expect(saveRole(role)).rejects.toThrow('ãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰ã¯ä½¿ç”¨ã§ãã¾ã›ã‚“')
  })

  it('æ¨©é™ãƒã‚§ãƒƒã‚¯ã¯é…åˆ—æ¤œç´¢ã®ã¿', async () => {
    const role = {
      permissions: ['hotel-saas:order:view', 'hotel-saas:order:create']
    }
    
    expect(await checkPermission(user, 'hotel-saas:order:view')).toBe(true)
    expect(await checkPermission(user, 'hotel-saas:order:update')).toBe(false)
  })
})
```

**Type**:
```typescript
import { z } from 'zod'

// ãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰ã‚’ç¦æ­¢
const PermissionCodeSchema = z.string()
  .regex(/^[a-z-]+:[a-z-]+:[a-z-]+$/)
  .refine(
    (val) => !val.includes('*'),
    { message: 'ãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰ã¯ä½¿ç”¨ã§ãã¾ã›ã‚“' }
  )

const PermissionsSchema = z.array(PermissionCodeSchema)

type Permissions = z.infer<typeof PermissionsSchema>
```

**Implementation**:
```typescript
// è¦ä»¶ID: PERM-002
// ã‚·ãƒ³ãƒ—ãƒ«ãªé…åˆ—æ¤œç´¢ã®ã¿
function checkPermission(
  userPermissions: string[],
  requiredPermission: string
): boolean {
  return userPermissions.includes(requiredPermission)
}

// ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
function validatePermissions(permissions: string[]): void {
  for (const perm of permissions) {
    if (perm.includes('*')) {
      throw new Error(`ãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰ã¯ä½¿ç”¨ã§ãã¾ã›ã‚“: ${perm}`)
    }
    
    const parts = perm.split(':')
    if (parts.length !== 3) {
      throw new Error(`ä¸æ­£ãªæ¨©é™ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ: ${perm}`)
    }
  }
}
```

---

### PERM-009: æ¨©é™éšå±¤æ§‹é€ 

**ç›®çš„**: æ¨©é™ã«ã¯æ˜ç¢ºãªãƒ©ãƒ³ã‚¯ï¼ˆéšå±¤ï¼‰ãŒã‚ã‚Šã€ä¸Šä½æ¨©é™ã‚’æŒã¤ã«ã¯ä¸‹ä½æ¨©é™ãŒå¿…é ˆã§ã‚ã‚‹ä»•çµ„ã¿ã‚’å®Ÿè£…ã™ã‚‹ã€‚

**Acceptï¼ˆåˆæ ¼æ¡ä»¶ï¼‰**:
- âœ… ä¸Šä½æ¨©é™ã‚’é¸æŠã™ã‚‹ã¨ã€ä¸‹ä½æ¨©é™ã‚‚è‡ªå‹•çš„ã«é¸æŠã•ã‚Œã‚‹
- âœ… ä¸‹ä½æ¨©é™ã‚’è§£é™¤ã™ã‚‹ã¨ã€ãã‚Œã«ä¾å­˜ã™ã‚‹ä¸Šä½æ¨©é™ã‚‚è‡ªå‹•çš„ã«è§£é™¤ã•ã‚Œã‚‹
- âœ… UIã§éšå±¤æ§‹é€ ãŒè¦–è¦šçš„ã«è¡¨ç¾ã•ã‚Œã‚‹ï¼ˆã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆã€ãƒ¬ãƒ™ãƒ«ãƒãƒƒã‚¸ï¼‰
- âœ… éšå±¤ãƒãƒƒãƒ—ã¯å…¨ã¦ã®ç®¡ç†ç³»æ¨©é™ã‚’ã‚«ãƒãƒ¼ã™ã‚‹
- âŒ éšå±¤ã«åã™ã‚‹æ¨©é™ã®çµ„ã¿åˆã‚ã›ã¯è¨±å¯ã—ãªã„ï¼ˆä¾‹: ä½œæˆæ¨©é™ãªã—ã§ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ¨©é™ã®ã¿ï¼‰

**éšå±¤ã®è€ƒãˆæ–¹**:
```
Lv.4 (æœ€ä¸Šä½)  å‰Šé™¤ãƒ»ã‚­ãƒ£ãƒ³ã‚»ãƒ«ç­‰ã®ç ´å£Šçš„æ“ä½œ
  â†“ è‡ªå‹•çš„ã«ä»¥ä¸‹ã‚‚ä»˜ä¸
Lv.3          æ›´æ–°ãƒ»ç·¨é›†
  â†“ è‡ªå‹•çš„ã«ä»¥ä¸‹ã‚‚ä»˜ä¸
Lv.2          ä½œæˆ
  â†“ è‡ªå‹•çš„ã«ä»¥ä¸‹ã‚‚ä»˜ä¸
Lv.1 (æœ€ä¸‹ä½)  é–²è¦§
```

**Example**:
```typescript
// æ³¨æ–‡ç®¡ç†ã®éšå±¤æ§‹é€ 
const hierarchyExample = {
  'hotel-saas:order:cancel': {        // Lv.4 - æœ€ä¸Šä½
    requires: [
      'hotel-saas:order:update-status',  // Lv.3
      'hotel-saas:order:create',         // Lv.2
      'hotel-saas:order:view'            // Lv.1
    ]
  },
  'hotel-saas:order:update-status': {  // Lv.3
    requires: [
      'hotel-saas:order:create',         // Lv.2
      'hotel-saas:order:view'            // Lv.1
    ]
  },
  'hotel-saas:order:create': {         // Lv.2
    requires: [
      'hotel-saas:order:view'            // Lv.1
    ]
  },
  'hotel-saas:order:view': {           // Lv.1 - æœ€ä¸‹ä½ï¼ˆä¾å­˜ãªã—ï¼‰
    requires: []
  }
}

// âœ… ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã‚’é¸æŠ â†’ æ›´æ–°ãƒ»ä½œæˆãƒ»é–²è¦§ã‚‚è‡ªå‹•é¸æŠ
selectPermission('hotel-saas:order:cancel')
// â†’ ['hotel-saas:order:cancel', 'hotel-saas:order:update-status', 'hotel-saas:order:create', 'hotel-saas:order:view']

// âœ… ä½œæˆã‚’è§£é™¤ â†’ æ›´æ–°ãƒ»ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã‚‚è‡ªå‹•è§£é™¤
deselectPermission('hotel-saas:order:create')
// â†’ ['hotel-saas:order:view'] ã®ã¿æ®‹ã‚‹
```

**Test Cases**:
```typescript
describe('PERM-009: æ¨©é™éšå±¤æ§‹é€ ', () => {
  it('ä¸Šä½æ¨©é™é¸æŠæ™‚ã€ä¸‹ä½æ¨©é™ã‚‚è‡ªå‹•é¸æŠã•ã‚Œã‚‹', () => {
    const permissions = []
    selectPermission(permissions, 'hotel-saas:order:cancel')
    
    expect(permissions).toContain('hotel-saas:order:cancel')
    expect(permissions).toContain('hotel-saas:order:update-status')
    expect(permissions).toContain('hotel-saas:order:create')
    expect(permissions).toContain('hotel-saas:order:view')
  })
  
  it('ä¸‹ä½æ¨©é™è§£é™¤æ™‚ã€ä¸Šä½æ¨©é™ã‚‚è‡ªå‹•è§£é™¤ã•ã‚Œã‚‹', () => {
    const permissions = [
      'hotel-saas:order:cancel',
      'hotel-saas:order:update-status',
      'hotel-saas:order:create',
      'hotel-saas:order:view'
    ]
    
    deselectPermission(permissions, 'hotel-saas:order:create')
    
    expect(permissions).not.toContain('hotel-saas:order:cancel')
    expect(permissions).not.toContain('hotel-saas:order:update-status')
    expect(permissions).not.toContain('hotel-saas:order:create')
    expect(permissions).toContain('hotel-saas:order:view')
  })
  
  it('éšå±¤ãƒãƒƒãƒ—ãŒå…¨æ¨©é™ã‚’ã‚«ãƒãƒ¼ã—ã¦ã„ã‚‹', () => {
    const allPermissions = getAllPermissions()
    const mappedPermissions = Object.keys(permissionHierarchy)
    
    // ç®¡ç†ç³»æ¨©é™ï¼ˆcreate, update, delete, manageç­‰ï¼‰ã¯å…¨ã¦ãƒãƒƒãƒ—ã«å­˜åœ¨
    const managePermissions = allPermissions.filter(p => 
      p.includes(':create') || p.includes(':update') || 
      p.includes(':delete') || p.includes(':manage') ||
      p.includes(':cancel') || p.includes(':refund')
    )
    
    managePermissions.forEach(perm => {
      expect(mappedPermissions).toContain(perm)
    })
  })
})
```

**Type**:
```typescript
/**
 * æ¨©é™éšå±¤ãƒãƒƒãƒ—ã®å‹å®šç¾©
 * ã‚­ãƒ¼: æ¨©é™ã‚³ãƒ¼ãƒ‰
 * å€¤: ã“ã®æ¨©é™ã‚’é¸æŠã—ãŸæ™‚ã«è‡ªå‹•çš„ã«å¿…è¦ã¨ãªã‚‹ä¸‹ä½æ¨©é™ã®ãƒªã‚¹ãƒˆ
 */
type PermissionHierarchyMap = Record<string, string[]>

interface PermissionWithLevel {
  code: string
  name: string
  level: 1 | 2 | 3 | 4 | 5  // 1ãŒæœ€ä¸‹ä½ï¼ˆé–²è¦§ï¼‰ã€5ãŒæœ€ä¸Šä½ï¼ˆå‰Šé™¤ï¼‰
  requires: string[]         // å¿…è¦ãªä¸‹ä½æ¨©é™ã®ãƒªã‚¹ãƒˆ
}
```

**å®Œå…¨ãªéšå±¤ãƒãƒƒãƒ—**:

#### hotel-saas ã‚«ãƒ†ã‚´ãƒª

##### hotel-saas:orderï¼ˆæ³¨æ–‡ç®¡ç†ï¼‰4éšå±¤
| Lv | æ¨©é™ã‚³ãƒ¼ãƒ‰ | æ“ä½œ | å¿…è¦ãªä¸‹ä½æ¨©é™ |
|----|----------|------|--------------|
| 4 | `hotel-saas:order:cancel` | ã‚­ãƒ£ãƒ³ã‚»ãƒ« | update-status, create, view |
| 3 | `hotel-saas:order:update-status` | æ›´æ–° | create, view |
| 2 | `hotel-saas:order:create` | ä½œæˆ | view |
| 1 | `hotel-saas:order:view` | é–²è¦§ | ãªã—ï¼ˆåŸºæœ¬æ¨©é™ï¼‰ |

##### hotel-saas:menuï¼ˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ç®¡ç†ï¼‰2éšå±¤
| Lv | æ¨©é™ã‚³ãƒ¼ãƒ‰ | æ“ä½œ | å¿…è¦ãªä¸‹ä½æ¨©é™ |
|----|----------|------|--------------|
| 2 | `hotel-saas:menu:manage` | ç®¡ç† | view |
| 1 | `hotel-saas:menu:view` | é–²è¦§ | ãªã— |

##### hotel-saas:aiï¼ˆAIæ©Ÿèƒ½ï¼‰2éšå±¤
| Lv | æ¨©é™ã‚³ãƒ¼ãƒ‰ | æ“ä½œ | å¿…è¦ãªä¸‹ä½æ¨©é™ |
|----|----------|------|--------------|
| 2 | `hotel-saas:ai:manage` | ç®¡ç† | use |
| 1 | `hotel-saas:ai:use` | ä½¿ç”¨ | ãªã— |

##### hotel-saas:layoutï¼ˆãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆç·¨é›†ï¼‰2éšå±¤
| Lv | æ¨©é™ã‚³ãƒ¼ãƒ‰ | æ“ä½œ | å¿…è¦ãªä¸‹ä½æ¨©é™ |
|----|----------|------|--------------|
| 2 | `hotel-saas:layout:publish` | å…¬é–‹ | edit |
| 1 | `hotel-saas:layout:edit` | ç·¨é›† | ãªã— |

#### system ã‚«ãƒ†ã‚´ãƒª

##### system:settingsï¼ˆã‚·ã‚¹ãƒ†ãƒ è¨­å®šï¼‰2éšå±¤
| Lv | æ¨©é™ã‚³ãƒ¼ãƒ‰ | æ“ä½œ | å¿…è¦ãªä¸‹ä½æ¨©é™ |
|----|----------|------|--------------|
| 2 | `system:settings:update` | æ›´æ–° | view |
| 1 | `system:settings:view` | é–²è¦§ | ãªã— |

##### system:staffï¼ˆã‚¹ã‚¿ãƒƒãƒ•ç®¡ç†ï¼‰3éšå±¤
| Lv | æ¨©é™ã‚³ãƒ¼ãƒ‰ | æ“ä½œ | å¿…è¦ãªä¸‹ä½æ¨©é™ |
|----|----------|------|--------------|
| 3 | `system:staff:delete` | å‰Šé™¤ | manage, view |
| 2 | `system:staff:manage` | ç®¡ç† | view |
| 1 | `system:staff:view` | é–²è¦§ | ãªã— |

##### system:rolesï¼ˆå½¹è·ç®¡ç†ï¼‰2éšå±¤
| Lv | æ¨©é™ã‚³ãƒ¼ãƒ‰ | æ“ä½œ | å¿…è¦ãªä¸‹ä½æ¨©é™ |
|----|----------|------|--------------|
| 2 | `system:roles:manage` | ç®¡ç† | view |
| 1 | `system:roles:view` | é–²è¦§ | ãªã— |

##### system:logsï¼ˆãƒ­ã‚°ç®¡ç†ï¼‰2éšå±¤
| Lv | æ¨©é™ã‚³ãƒ¼ãƒ‰ | æ“ä½œ | å¿…è¦ãªä¸‹ä½æ¨©é™ |
|----|----------|------|--------------|
| 2 | `system:logs:export` | ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ | view |
| 1 | `system:logs:view` | é–²è¦§ | ãªã— |

#### hotel-pms ã‚«ãƒ†ã‚´ãƒª

##### hotel-pms:reservationï¼ˆäºˆç´„ç®¡ç†ï¼‰5éšå±¤
| Lv | æ¨©é™ã‚³ãƒ¼ãƒ‰ | æ“ä½œ | å¿…è¦ãªä¸‹ä½æ¨©é™ |
|----|----------|------|--------------|
| 5 | `hotel-pms:reservation:delete` | å‰Šé™¤ | cancel, update, create, view |
| 4 | `hotel-pms:reservation:cancel` | ã‚­ãƒ£ãƒ³ã‚»ãƒ« | update, create, view |
| 3 | `hotel-pms:reservation:update` | æ›´æ–° | create, view |
| 2 | `hotel-pms:reservation:create` | ä½œæˆ | view |
| 1 | `hotel-pms:reservation:view` | é–²è¦§ | ãªã— |

##### hotel-pms:roomï¼ˆå®¢å®¤ç®¡ç†ï¼‰3éšå±¤
| Lv | æ¨©é™ã‚³ãƒ¼ãƒ‰ | æ“ä½œ | å¿…è¦ãªä¸‹ä½æ¨©é™ |
|----|----------|------|--------------|
| 3 | `hotel-pms:room:manage` | è¨­å®šç®¡ç† | status-update, view |
| 2 | `hotel-pms:room:status-update` | çŠ¶æ…‹æ›´æ–° | view |
| 1 | `hotel-pms:room:view` | é–²è¦§ | ãªã— |

##### hotel-pms:billingï¼ˆä¼šè¨ˆç®¡ç†ï¼‰4éšå±¤
| Lv | æ¨©é™ã‚³ãƒ¼ãƒ‰ | æ“ä½œ | å¿…è¦ãªä¸‹ä½æ¨©é™ |
|----|----------|------|--------------|
| 4 | `hotel-pms:billing:correct` | è¨‚æ­£ | refund, create, view |
| 3 | `hotel-pms:billing:refund` | è¿”é‡‘ | create, view |
| 2 | `hotel-pms:billing:create` | ä½œæˆ | view |
| 1 | `hotel-pms:billing:view` | é–²è¦§ | ãªã— |

##### hotel-pms:checkin/checkoutï¼ˆå˜ç‹¬æ©Ÿèƒ½ï¼‰
| Lv | æ¨©é™ã‚³ãƒ¼ãƒ‰ | æ“ä½œ | å¿…è¦ãªä¸‹ä½æ¨©é™ |
|----|----------|------|--------------|
| 1 | `hotel-pms:checkin:execute` | ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ | ãªã—ï¼ˆå˜ç‹¬æ©Ÿèƒ½ï¼‰ |
| 1 | `hotel-pms:checkout:execute` | ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ | ãªã—ï¼ˆå˜ç‹¬æ©Ÿèƒ½ï¼‰ |

##### hotel-pms:reportï¼ˆãƒ¬ãƒãƒ¼ãƒˆï¼‰2éšå±¤
| Lv | æ¨©é™ã‚³ãƒ¼ãƒ‰ | æ“ä½œ | å¿…è¦ãªä¸‹ä½æ¨©é™ |
|----|----------|------|--------------|
| 2 | `hotel-pms:report:export` | ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ | view |
| 1 | `hotel-pms:report:view` | é–²è¦§ | ãªã— |

**Implementation**:
```typescript
// è¦ä»¶ID: PERM-009
/**
 * æ¨©é™ã®éšå±¤æ§‹é€ ãƒãƒƒãƒ—
 * ã‚­ãƒ¼: æ¨©é™ã‚³ãƒ¼ãƒ‰
 * å€¤: ã“ã®æ¨©é™ã‚’é¸æŠã—ãŸæ™‚ã«è‡ªå‹•çš„ã«å¿…è¦ã¨ãªã‚‹ä¸‹ä½æ¨©é™ã®ãƒªã‚¹ãƒˆ
 */
export const permissionHierarchy: Record<string, string[]> = {
  // hotel-saas ã‚«ãƒ†ã‚´ãƒª
  'hotel-saas:order:cancel': [
    'hotel-saas:order:update-status',
    'hotel-saas:order:create',
    'hotel-saas:order:view'
  ],
  'hotel-saas:order:update-status': [
    'hotel-saas:order:create',
    'hotel-saas:order:view'
  ],
  'hotel-saas:order:create': ['hotel-saas:order:view'],
  
  'hotel-saas:menu:manage': ['hotel-saas:menu:view'],
  'hotel-saas:ai:manage': ['hotel-saas:ai:use'],
  'hotel-saas:layout:publish': ['hotel-saas:layout:edit'],
  
  // system ã‚«ãƒ†ã‚´ãƒª
  'system:settings:update': ['system:settings:view'],
  
  'system:staff:delete': [
    'system:staff:manage',
    'system:staff:view'
  ],
  'system:staff:manage': ['system:staff:view'],
  
  'system:roles:manage': ['system:roles:view'],
  'system:logs:export': ['system:logs:view'],
  
  // hotel-pms ã‚«ãƒ†ã‚´ãƒª
  'hotel-pms:reservation:delete': [
    'hotel-pms:reservation:cancel',
    'hotel-pms:reservation:update',
    'hotel-pms:reservation:create',
    'hotel-pms:reservation:view'
  ],
  'hotel-pms:reservation:cancel': [
    'hotel-pms:reservation:update',
    'hotel-pms:reservation:create',
    'hotel-pms:reservation:view'
  ],
  'hotel-pms:reservation:update': [
    'hotel-pms:reservation:create',
    'hotel-pms:reservation:view'
  ],
  'hotel-pms:reservation:create': ['hotel-pms:reservation:view'],
  
  'hotel-pms:room:manage': [
    'hotel-pms:room:status-update',
    'hotel-pms:room:view'
  ],
  'hotel-pms:room:status-update': ['hotel-pms:room:view'],
  
  'hotel-pms:billing:correct': [
    'hotel-pms:billing:refund',
    'hotel-pms:billing:create',
    'hotel-pms:billing:view'
  ],
  'hotel-pms:billing:refund': [
    'hotel-pms:billing:create',
    'hotel-pms:billing:view'
  ],
  'hotel-pms:billing:create': ['hotel-pms:billing:view'],
  
  'hotel-pms:report:export': ['hotel-pms:report:view'],
}

/**
 * æ¨©é™ã‚’é¸æŠã—ãŸæ™‚ã®å‡¦ç†ï¼ˆéšå±¤æ§‹é€ å¯¾å¿œï¼‰
 */
export function selectPermission(
  currentPermissions: string[],
  permissionCode: string
): string[] {
  const result = [...currentPermissions]
  
  // è‡ªèº«ã‚’è¿½åŠ 
  if (!result.includes(permissionCode)) {
    result.push(permissionCode)
  }
  
  // ä¸‹ä½éšå±¤ã®æ¨©é™ã‚’è‡ªå‹•è¿½åŠ 
  const lowerPermissions = permissionHierarchy[permissionCode] || []
  lowerPermissions.forEach(lowerCode => {
    if (!result.includes(lowerCode)) {
      result.push(lowerCode)
    }
  })
  
  return result
}

/**
 * æ¨©é™ã‚’è§£é™¤ã—ãŸæ™‚ã®å‡¦ç†ï¼ˆéšå±¤æ§‹é€ å¯¾å¿œï¼‰
 */
export function deselectPermission(
  currentPermissions: string[],
  permissionCode: string
): string[] {
  let result = [...currentPermissions]
  
  // ã“ã®æ¨©é™ã«ä¾å­˜ã—ã¦ã„ã‚‹ä¸Šä½æ¨©é™ã‚’æ¢ã™
  const upperPermissions = Object.entries(permissionHierarchy)
    .filter(([_, lowerPerms]) => lowerPerms.includes(permissionCode))
    .map(([code]) => code)
    .filter(code => result.includes(code))
  
  // ä¸Šä½æ¨©é™ã‚‚ä¸€ç·’ã«å¤–ã™
  upperPermissions.forEach(upperCode => {
    result = result.filter(p => p !== upperCode)
  })
  
  // è‡ªèº«ã‚’å‰Šé™¤
  result = result.filter(p => p !== permissionCode)
  
  return result
}
```

**UIå®Ÿè£…è¦ä»¶ï¼ˆPERM-UI-006, PERM-UI-007ï¼‰**:
```vue
<template>
  <div class="permission-resource border rounded-lg p-4 mb-4">
    <h4 class="font-semibold mb-3">æ³¨æ–‡ç®¡ç†</h4>
    
    <div class="space-y-2">
      <!-- Lv.4: æœ€ä¸Šä½ -->
      <div class="permission-item pl-0">
        <label class="flex items-center gap-2">
          <input type="checkbox" @change="togglePermission" />
          <span>ã‚­ãƒ£ãƒ³ã‚»ãƒ«</span>
          <span class="text-xs px-2 py-0.5 bg-red-100 text-red-700 rounded">Lv.4</span>
        </label>
      </div>
      
      <!-- Lv.3 -->
      <div class="permission-item pl-4 border-l-2 border-orange-200">
        <label class="flex items-center gap-2">
          <input type="checkbox" @change="togglePermission" />
          <span>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°</span>
          <span class="text-xs px-2 py-0.5 bg-orange-100 text-orange-700 rounded">Lv.3</span>
        </label>
      </div>
      
      <!-- Lv.2 -->
      <div class="permission-item pl-8 border-l-2 border-blue-200">
        <label class="flex items-center gap-2">
          <input type="checkbox" @change="togglePermission" />
          <span>ä½œæˆ</span>
          <span class="text-xs px-2 py-0.5 bg-blue-100 text-blue-700 rounded">Lv.2</span>
        </label>
      </div>
      
      <!-- Lv.1: æœ€ä¸‹ä½ -->
      <div class="permission-item pl-12 border-l-2 border-green-200">
        <label class="flex items-center gap-2">
          <input type="checkbox" @change="togglePermission" />
          <span>é–²è¦§</span>
          <span class="text-xs px-2 py-0.5 bg-green-100 text-green-700 rounded">Lv.1</span>
        </label>
      </div>
    </div>
    
    <div class="mt-3 pt-3 border-t text-xs text-gray-600">
      <Icon name="heroicons:information-circle" class="w-4 h-4 inline mr-1" />
      ä¸Šä½ã®æ¨©é™ã‚’é¸æŠã™ã‚‹ã¨ã€ãã‚Œä»¥ä¸‹ã®æ¨©é™ã‚‚è‡ªå‹•çš„ã«é¸æŠã•ã‚Œã¾ã™
    </div>
  </div>
</template>
```

---

### 3. ãƒ†ãƒŠãƒ³ãƒˆåˆ¥å½¹è·ç®¡ç†

**é‡è¦**: å½¹è·ã¯ãƒ†ãƒŠãƒ³ãƒˆã”ã¨ã«å®Œå…¨ã«ç‹¬ç«‹ã—ã¦ç®¡ç†ã•ã‚Œã¾ã™ã€‚

**å®Ÿè£…ä¾‹**:
```typescript
// ãƒ›ãƒ†ãƒ«Aï¼ˆãƒ“ã‚¸ãƒã‚¹ãƒ›ãƒ†ãƒ«ï¼‰
tenant_id: 'hotel-a'
roles: [
  { name: 'ãƒ•ãƒ­ãƒ³ãƒˆä¸»ä»»', permissions: [...] },
  { name: 'ãƒ•ãƒ­ãƒ³ãƒˆã‚¹ã‚¿ãƒƒãƒ•', permissions: [...] },
  { name: 'æ¸…æƒã‚¹ã‚¿ãƒƒãƒ•', permissions: [...] }
]

// ãƒ›ãƒ†ãƒ«Bï¼ˆãƒ¬ã‚¸ãƒ£ãƒ¼ãƒ›ãƒ†ãƒ«ï¼‰
tenant_id: 'hotel-b'
roles: [
  { name: 'æ”¯é…äºº', permissions: [...] },
  { name: 'ã‚­ãƒ£ã‚¹ãƒˆãƒªãƒ¼ãƒ€ãƒ¼', permissions: [...] },
  { name: 'ã‚­ãƒ£ã‚¹ãƒˆ', permissions: [...] },
  { name: 'ãƒ‡ã‚£ãƒƒã‚·ãƒ£ãƒ¼', permissions: [...] }
]

// ãƒ›ãƒ†ãƒ«Cï¼ˆé«˜ç´šæ—…é¤¨ï¼‰
tenant_id: 'hotel-c'
roles: [
  { name: 'å¥³å°†', permissions: [...] },
  { name: 'ç•ªé ­', permissions: [...] },
  { name: 'ä»²å±…', permissions: [...] },
  { name: 'æ¿å‰', permissions: [...] }
]
```

---

## ğŸ—„ï¸ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ

### 1. `roles` ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆå½¹è·ãƒã‚¹ã‚¿ï¼‰

**ãƒ†ãƒ¼ãƒ–ãƒ«å**: `roles`

**ç›®çš„**: ãƒ†ãƒŠãƒ³ãƒˆã”ã¨ã®å½¹è·ã‚’ç®¡ç†

**ã‚¹ã‚­ãƒ¼ãƒ**:
```sql
CREATE TABLE roles (
  id              TEXT PRIMARY KEY,
  tenant_id       TEXT NOT NULL,
  
  -- å½¹è·æƒ…å ±
  name            TEXT NOT NULL,
  description     TEXT,
  
  -- è¡¨ç¤ºé †åºï¼ˆå¤§ãã„é †ã«è¡¨ç¤ºï¼‰
  sort_order      INTEGER DEFAULT 0,
  
  -- ç®¡ç†ãƒ•ãƒ©ã‚°
  is_active       BOOLEAN DEFAULT true,
  is_default      BOOLEAN DEFAULT false,  -- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå½¹è·ãƒ•ãƒ©ã‚°
  
  -- ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
  created_at      TIMESTAMP DEFAULT NOW(),
  updated_at      TIMESTAMP DEFAULT NOW(),
  created_by      TEXT,
  updated_by      TEXT,
  
  CONSTRAINT fk_roles_tenant FOREIGN KEY (tenant_id) REFERENCES tenants(id) ON DELETE CASCADE,
  CONSTRAINT unq_roles_tenant_id_name UNIQUE (tenant_id, name)
);

CREATE INDEX idx_roles_tenant_id ON roles(tenant_id);
CREATE INDEX idx_roles_is_active ON roles(is_active);
CREATE INDEX idx_roles_is_default ON roles(is_default);
CREATE INDEX idx_roles_sort_order ON roles(sort_order DESC);
```

**Prismaãƒ¢ãƒ‡ãƒ«**:
```prisma
model Role {
  id              String    @id @default(uuid())
  tenantId        String    @map("tenant_id")
  
  name            String
  description     String?
  
  sortOrder       Int       @default(0) @map("sort_order")
  
  isActive        Boolean   @default(true) @map("is_active")
  isDefault       Boolean   @default(false) @map("is_default")
  
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  createdBy       String?   @map("created_by")
  updatedBy       String?   @map("updated_by")
  
  // ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
  tenant          Tenant                 @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  permissions     RolePermission[]
  memberships     StaffTenantMembership[]
  
  @@unique([tenantId, name], map: "unq_roles_tenant_id_name")
  @@index([tenantId], map: "idx_roles_tenant_id")
  @@index([isActive], map: "idx_roles_is_active")
  @@index([isDefault], map: "idx_roles_is_default")
  @@index([sortOrder], map: "idx_roles_sort_order")
  @@map("roles")
}
```

**é‡è¦ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰**:
- `tenant_id`: ãƒ†ãƒŠãƒ³ãƒˆåˆ†é›¢å¿…é ˆ
- `name`: å½¹è·åï¼ˆãƒ†ãƒŠãƒ³ãƒˆå†…ãƒ¦ãƒ‹ãƒ¼ã‚¯ï¼‰
- `sort_order`: è¡¨ç¤ºé †åºï¼ˆå¤§ãã„å€¤ã»ã©ä¸Šä½ã«è¡¨ç¤ºï¼‰
- `is_default`: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå½¹è·ãƒ•ãƒ©ã‚°ï¼ˆæ–°è¦ã‚¹ã‚¿ãƒƒãƒ•ä½œæˆæ™‚ã«è‡ªå‹•å‰²ã‚Šå½“ã¦ï¼‰

---

### 2. `permissions` ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆæ¨©é™ãƒã‚¹ã‚¿ï¼‰

**ãƒ†ãƒ¼ãƒ–ãƒ«å**: `permissions`

**ç›®çš„**: ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã®æ¨©é™å®šç¾©ã‚’ç®¡ç†

**ã‚¹ã‚­ãƒ¼ãƒ**:
```sql
CREATE TABLE permissions (
  id              TEXT PRIMARY KEY,
  
  -- æ¨©é™ã‚³ãƒ¼ãƒ‰ï¼ˆsystem:resource:actionï¼‰
  code            TEXT NOT NULL UNIQUE,
  
  -- æ¨©é™æƒ…å ±
  name            TEXT NOT NULL,
  description     TEXT,
  
  -- åˆ†é¡
  category        TEXT NOT NULL,  -- 'hotel-pms', 'hotel-saas', 'system'
  
  -- ç®¡ç†ãƒ•ãƒ©ã‚°
  is_active       BOOLEAN DEFAULT true,
  
  -- ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
  created_at      TIMESTAMP DEFAULT NOW(),
  updated_at      TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_permissions_code ON permissions(code);
CREATE INDEX idx_permissions_category ON permissions(category);
CREATE INDEX idx_permissions_is_active ON permissions(is_active);
```

**Prismaãƒ¢ãƒ‡ãƒ«**:
```prisma
model Permission {
  id              String    @id @default(uuid())
  
  code            String    @unique
  
  name            String
  description     String?
  
  category        String
  
  isActive        Boolean   @default(true) @map("is_active")
  
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  
  // ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
  rolePermissions RolePermission[]
  
  @@index([code], map: "idx_permissions_code")
  @@index([category], map: "idx_permissions_category")
  @@index([isActive], map: "idx_permissions_is_active")
  @@map("permissions")
}
```

**ã‚«ãƒ†ã‚´ãƒªåˆ¥æ¨©é™ä¾‹**:

```typescript
// hotel-pms ã‚«ãƒ†ã‚´ãƒª
'hotel-pms:reservation:view'
'hotel-pms:reservation:create'
'hotel-pms:reservation:update'
'hotel-pms:reservation:delete'
'hotel-pms:checkin:execute'
'hotel-pms:checkout:execute'
'hotel-pms:billing:view'
'hotel-pms:billing:create'
'hotel-pms:billing:refund'

// hotel-saas ã‚«ãƒ†ã‚´ãƒª
'hotel-saas:order:view'
'hotel-saas:order:create'
'hotel-saas:menu:manage'
'hotel-saas:ai:use'
'hotel-saas:layout:edit'

// system ã‚«ãƒ†ã‚´ãƒª
'system:settings:view'
'system:settings:update'
'system:staff:manage'
'system:roles:manage'
'system:logs:view'
```

**å®Œå…¨ãªæ¨©é™ã‚³ãƒ¼ãƒ‰ä¸€è¦§**:

æ¨©é™ã‚³ãƒ¼ãƒ‰ã®å®Œå…¨ãªå®šç¾©ã¯ã€ä»¥ä¸‹ã®ã‚·ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã«è¨˜è¼‰ã•ã‚Œã¦ã„ã¾ã™:
- `/Users/kaneko/hotel-common/prisma/seeds/permissions.seed.ts`

ä¸»è¦ãªæ¨©é™ã‚«ãƒ†ã‚´ãƒª:

#### hotel-pms ã‚«ãƒ†ã‚´ãƒªï¼ˆäºˆç´„ãƒ»ãƒ•ãƒ­ãƒ³ãƒˆç®¡ç†ï¼‰

| ãƒªã‚½ãƒ¼ã‚¹ | æ¨©é™ã‚³ãƒ¼ãƒ‰ | èª¬æ˜ |
|---------|----------|------|
| **äºˆç´„ç®¡ç†** | `hotel-pms:reservation:view` | äºˆç´„æƒ…å ±ã®é–²è¦§ |
| | `hotel-pms:reservation:create` | äºˆç´„ã®ä½œæˆ |
| | `hotel-pms:reservation:update` | äºˆç´„ã®æ›´æ–° |
| | `hotel-pms:reservation:delete` | äºˆç´„ã®å‰Šé™¤ |
| | `hotel-pms:reservation:cancel` | äºˆç´„ã®ã‚­ãƒ£ãƒ³ã‚»ãƒ« |
| | `hotel-pms:reservation:*` | äºˆç´„ç®¡ç†ã®å…¨æ¨©é™ |
| **ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³/ã‚¢ã‚¦ãƒˆ** | `hotel-pms:checkin:execute` | ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³å‡¦ç† |
| | `hotel-pms:checkout:execute` | ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆå‡¦ç† |
| | `hotel-pms:checkin:*` | ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³/ã‚¢ã‚¦ãƒˆã®å…¨æ¨©é™ |
| **å®¢å®¤ç®¡ç†** | `hotel-pms:room:view` | å®¢å®¤æƒ…å ±ã®é–²è¦§ |
| | `hotel-pms:room:status-update` | å®¢å®¤çŠ¶æ…‹ã®æ›´æ–° |
| | `hotel-pms:room:manage` | å®¢å®¤è¨­å®šã®ç®¡ç† |
| | `hotel-pms:room:*` | å®¢å®¤ç®¡ç†ã®å…¨æ¨©é™ |
| **ä¼šè¨ˆç®¡ç†** | `hotel-pms:billing:view` | ä¼šè¨ˆæƒ…å ±ã®é–²è¦§ |
| | `hotel-pms:billing:create` | ä¼šè¨ˆå‡¦ç†ã®å®Ÿè¡Œ |
| | `hotel-pms:billing:refund` | è¿”é‡‘å‡¦ç† |
| | `hotel-pms:billing:correct` | ä¼šè¨ˆè¨‚æ­£ |
| | `hotel-pms:billing:*` | ä¼šè¨ˆç®¡ç†ã®å…¨æ¨©é™ |
| **ãƒ¬ãƒãƒ¼ãƒˆ** | `hotel-pms:report:view` | ãƒ¬ãƒãƒ¼ãƒˆé–²è¦§ |
| | `hotel-pms:report:export` | ãƒ¬ãƒãƒ¼ãƒˆã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ |

#### hotel-saas ã‚«ãƒ†ã‚´ãƒªï¼ˆæ³¨æ–‡ãƒ»AIã‚µãƒ¼ãƒ“ã‚¹ï¼‰

| ãƒªã‚½ãƒ¼ã‚¹ | æ¨©é™ã‚³ãƒ¼ãƒ‰ | èª¬æ˜ |
|---------|----------|------|
| **æ³¨æ–‡ç®¡ç†** | `hotel-saas:order:view` | æ³¨æ–‡æƒ…å ±ã®é–²è¦§ |
| | `hotel-saas:order:create` | æ³¨æ–‡ã®ä½œæˆ |
| | `hotel-saas:order:update-status` | æ³¨æ–‡ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®æ›´æ–° |
| | `hotel-saas:order:cancel` | æ³¨æ–‡ã®ã‚­ãƒ£ãƒ³ã‚»ãƒ« |
| | `hotel-saas:order:*` | æ³¨æ–‡ç®¡ç†ã®å…¨æ¨©é™ |
| **ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç®¡ç†** | `hotel-saas:menu:view` | ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®é–²è¦§ |
| | `hotel-saas:menu:manage` | ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ç®¡ç† |
| | `hotel-saas:menu:*` | ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç®¡ç†ã®å…¨æ¨©é™ |
| **AIæ©Ÿèƒ½** | `hotel-saas:ai:use` | AIæ©Ÿèƒ½ã®ä½¿ç”¨ |
| | `hotel-saas:ai:manage` | AIè¨­å®šã®ç®¡ç† |
| **ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆç·¨é›†** | `hotel-saas:layout:edit` | ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã®ç·¨é›† |
| | `hotel-saas:layout:publish` | ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã®å…¬é–‹ |

#### system ã‚«ãƒ†ã‚´ãƒªï¼ˆã‚·ã‚¹ãƒ†ãƒ è¨­å®šï¼‰

| ãƒªã‚½ãƒ¼ã‚¹ | æ¨©é™ã‚³ãƒ¼ãƒ‰ | èª¬æ˜ |
|---------|----------|------|
| **ã‚·ã‚¹ãƒ†ãƒ è¨­å®š** | `system:settings:view` | è¨­å®šã®é–²è¦§ |
| | `system:settings:update` | è¨­å®šã®æ›´æ–° |
| | `system:settings:*` | è¨­å®šç®¡ç†ã®å…¨æ¨©é™ |
| **ã‚¹ã‚¿ãƒƒãƒ•ç®¡ç†** | `system:staff:view` | ã‚¹ã‚¿ãƒƒãƒ•æƒ…å ±ã®é–²è¦§ |
| | `system:staff:manage` | ã‚¹ã‚¿ãƒƒãƒ•ã®ç®¡ç† |
| | `system:staff:delete` | ã‚¹ã‚¿ãƒƒãƒ•ã®å‰Šé™¤ |
| | `system:staff:*` | ã‚¹ã‚¿ãƒƒãƒ•ç®¡ç†ã®å…¨æ¨©é™ |
| **å½¹è·ãƒ»æ¨©é™ç®¡ç†** | `system:roles:view` | å½¹è·ã®é–²è¦§ |
| | `system:roles:manage` | å½¹è·ã®ç®¡ç† |
| | `system:roles:*` | å½¹è·ç®¡ç†ã®å…¨æ¨©é™ |
| **ãƒ­ã‚°ãƒ»ç›£æŸ»** | `system:logs:view` | ãƒ­ã‚°ã®é–²è¦§ |
| | `system:logs:export` | ãƒ­ã‚°ã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ |
| | `system:audit:view` | ç›£æŸ»ãƒ­ã‚°ã®é–²è¦§ |

~~#### ãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰æ¨©é™~~ï¼ˆv2.1.0ã§å»ƒæ­¢ï¼‰

| æ¨©é™ã‚³ãƒ¼ãƒ‰ | èª¬æ˜ | çŠ¶æ…‹ |
|----------|------|------|
| ~~`*:*:*`~~ | ~~å…¨ã‚·ã‚¹ãƒ†ãƒ ã®å…¨æ¨©é™~~ | âŒ **å»ƒæ­¢** |
| ~~`hotel-pms:*:*`~~ | ~~PMSå…¨æ©Ÿèƒ½ã®å…¨æ¨©é™~~ | âŒ **å»ƒæ­¢** |
| ~~`hotel-saas:*:*`~~ | ~~SaaSå…¨æ©Ÿèƒ½ã®å…¨æ¨©é™~~ | âŒ **å»ƒæ­¢** |
| ~~`system:*:*`~~ | ~~ã‚·ã‚¹ãƒ†ãƒ è¨­å®šã®å…¨æ¨©é™~~ | âŒ **å»ƒæ­¢** |
| ~~`hotel-pms:reservation:*`~~ | ~~äºˆç´„ç®¡ç†ã®å…¨æ“ä½œ~~ | âŒ **å»ƒæ­¢** |
| ~~`hotel-pms:billing:*`~~ | ~~ä¼šè¨ˆã®å…¨æ“ä½œ~~ | âŒ **å»ƒæ­¢** |

**âš ï¸ v2.1.0 å¤‰æ›´å†…å®¹**:
- âŒ ãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰æ¨©é™ã¯å…¨ã¦å»ƒæ­¢ã•ã‚Œã¾ã—ãŸ
- âœ… å€‹åˆ¥æ¨©é™ã®ã¿ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„
- âœ… å…¨æ¨©é™ãŒå¿…è¦ãªå½¹è·ï¼ˆæ”¯é…äººç­‰ï¼‰ã¯ã€å…¨ã¦ã®å€‹åˆ¥æ¨©é™ã‚’åˆ—æŒ™ã—ã¦ä¿å­˜ã—ã¦ãã ã•ã„

**æ³¨è¨˜**: 
- æ¨©é™ã‚³ãƒ¼ãƒ‰ã¯`permissions`ãƒ†ãƒ¼ãƒ–ãƒ«ã«äº‹å‰ç™»éŒ²ã•ã‚Œã€ã‚¹ãƒ¼ãƒ‘ãƒ¼ã‚¢ãƒ‰ãƒŸãƒ³ãŒç®¡ç†ã—ã¾ã™
- æ–°è¦æ¨©é™ã®è¿½åŠ ã¯ã€ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆæ™‚ã«ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§å®Ÿè¡Œã•ã‚Œã¾ã™
- **ãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰ï¼ˆ`*`ã‚’å«ã‚€ï¼‰æ¨©é™ã‚³ãƒ¼ãƒ‰ã®ç™»éŒ²ã¯ä¸å¯**

---

### 3. `role_permissions` ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆå½¹è·ãƒ»æ¨©é™ãƒãƒƒãƒ”ãƒ³ã‚°ï¼‰

**ãƒ†ãƒ¼ãƒ–ãƒ«å**: `role_permissions`

**ç›®çš„**: å½¹è·ã¨æ¨©é™ã®å¤šå¯¾å¤šé–¢ä¿‚ã‚’ç®¡ç†

**ã‚¹ã‚­ãƒ¼ãƒ**:
```sql
CREATE TABLE role_permissions (
  id              TEXT PRIMARY KEY,
  role_id         TEXT NOT NULL,
  permission_id   TEXT NOT NULL,
  
  -- ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
  created_at      TIMESTAMP DEFAULT NOW(),
  created_by      TEXT,
  
  CONSTRAINT fk_role_permissions_role FOREIGN KEY (role_id) REFERENCES roles(id) ON DELETE CASCADE,
  CONSTRAINT fk_role_permissions_permission FOREIGN KEY (permission_id) REFERENCES permissions(id) ON DELETE CASCADE,
  CONSTRAINT unq_role_permissions UNIQUE (role_id, permission_id)
);

CREATE INDEX idx_role_permissions_role_id ON role_permissions(role_id);
CREATE INDEX idx_role_permissions_permission_id ON role_permissions(permission_id);
```

**Prismaãƒ¢ãƒ‡ãƒ«**:
```prisma
model RolePermission {
  id              String      @id @default(uuid())
  roleId          String      @map("role_id")
  permissionId    String      @map("permission_id")
  
  createdAt       DateTime    @default(now()) @map("created_at")
  createdBy       String?     @map("created_by")
  
  // ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
  role            Role        @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission      Permission  @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  
  @@unique([roleId, permissionId], map: "unq_role_permissions")
  @@index([roleId], map: "idx_role_permissions_role_id")
  @@index([permissionId], map: "idx_role_permissions_permission_id")
  @@map("role_permissions")
}
```

---

### 4. `staff_tenant_memberships` ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆã‚¹ã‚¿ãƒƒãƒ•ãƒ»å½¹è·å‰²ã‚Šå½“ã¦ï¼‰

**ãƒ†ãƒ¼ãƒ–ãƒ«å**: `staff_tenant_memberships`ï¼ˆæ—¢å­˜ãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰

**å¤‰æ›´ç‚¹**: `role`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’`role_id`ã«å¤‰æ›´ã—ã€`roles`ãƒ†ãƒ¼ãƒ–ãƒ«ã¨é€£æº

**ã‚¹ã‚­ãƒ¼ãƒ**:
```sql
CREATE TABLE staff_tenant_memberships (
  id              TEXT PRIMARY KEY,
  staff_id        TEXT NOT NULL,
  tenant_id       TEXT NOT NULL,
  
  -- âœ… å¤‰æ›´: role_idï¼ˆrolesãƒ†ãƒ¼ãƒ–ãƒ«ã¸ã®å¤–éƒ¨ã‚­ãƒ¼ï¼‰
  role_id         TEXT NOT NULL,
  
  -- å€‹åˆ¥æ¨©é™ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
  custom_permissions JSONB DEFAULT '[]',
  
  -- ãƒ•ãƒ©ã‚°
  is_active       BOOLEAN DEFAULT true,
  is_primary      BOOLEAN DEFAULT false,
  
  -- ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
  joined_at       TIMESTAMP DEFAULT NOW(),
  created_at      TIMESTAMP DEFAULT NOW(),
  updated_at      TIMESTAMP DEFAULT NOW(),
  
  CONSTRAINT fk_membership_staff FOREIGN KEY (staff_id) REFERENCES staff(id) ON DELETE CASCADE,
  CONSTRAINT fk_membership_tenant FOREIGN KEY (tenant_id) REFERENCES tenants(id) ON DELETE CASCADE,
  CONSTRAINT fk_membership_role FOREIGN KEY (role_id) REFERENCES roles(id) ON DELETE RESTRICT,
  CONSTRAINT uniq_staff_tenant UNIQUE (staff_id, tenant_id)
);

CREATE INDEX idx_memberships_staff_id ON staff_tenant_memberships(staff_id);
CREATE INDEX idx_memberships_tenant_id ON staff_tenant_memberships(tenant_id);
CREATE INDEX idx_memberships_role_id ON staff_tenant_memberships(role_id);
CREATE INDEX idx_memberships_is_active ON staff_tenant_memberships(is_active);
CREATE INDEX idx_memberships_is_primary ON staff_tenant_memberships(is_primary);
```

**Prismaãƒ¢ãƒ‡ãƒ«**:
```prisma
model StaffTenantMembership {
  id                  String    @id @default(uuid())
  staffId             String    @map("staff_id")
  tenantId            String    @map("tenant_id")
  
  roleId              String    @map("role_id")
  customPermissions   Json      @default("[]") @map("custom_permissions")
  
  isActive            Boolean   @default(true) @map("is_active")
  isPrimary           Boolean   @default(false) @map("is_primary")
  
  joinedAt            DateTime  @default(now()) @map("joined_at")
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")
  
  // ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
  staff               Staff     @relation(fields: [staffId], references: [id], onDelete: Cascade)
  tenant              Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  role                Role      @relation(fields: [roleId], references: [id], onDelete: Restrict)
  
  @@unique([staffId, tenantId], map: "uniq_staff_tenant")
  @@index([staffId], map: "idx_memberships_staff_id")
  @@index([tenantId], map: "idx_memberships_tenant_id")
  @@index([roleId], map: "idx_memberships_role_id")
  @@index([isActive], map: "idx_memberships_is_active")
  @@index([isPrimary], map: "idx_memberships_is_primary")
  @@map("staff_tenant_memberships")
}
```

**é‡è¦å¤‰æ›´ç‚¹**:
- `role`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆæ–‡å­—åˆ—ï¼‰â†’ `role_id`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆå¤–éƒ¨ã‚­ãƒ¼ï¼‰
- `permissions`, `level`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯å‰Šé™¤ï¼ˆ`roles`ãƒ†ãƒ¼ãƒ–ãƒ«ã§ç®¡ç†ï¼‰
- `custom_permissions`: å€‹åˆ¥ã‚¹ã‚¿ãƒƒãƒ•ã¸ã®æ¨©é™ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰

---

### 5. `role_templates` ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç®¡ç†ï¼‰

**ãƒ†ãƒ¼ãƒ–ãƒ«å**: `role_templates`

**ç›®çš„**: æ¥­æ…‹åˆ¥ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå½¹è·ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ç®¡ç†ï¼ˆã‚¹ãƒ¼ãƒ‘ãƒ¼ã‚¢ãƒ‰ãƒŸãƒ³ç®¡ç†ï¼‰

**ã‚¹ã‚­ãƒ¼ãƒ**:
```sql
CREATE TABLE role_templates (
  id              TEXT PRIMARY KEY,
  
  -- ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæƒ…å ±
  business_type   TEXT NOT NULL,  -- 'hotel', 'ryokan', 'resort', 'leisure'
  name            TEXT NOT NULL,
  description     TEXT,
  
  -- å½¹è·å®šç¾©ï¼ˆJSONé…åˆ—ï¼‰
  roles_definition JSONB NOT NULL,
  
  -- ç®¡ç†ãƒ•ãƒ©ã‚°
  is_active       BOOLEAN DEFAULT true,
  is_system       BOOLEAN DEFAULT false,  -- ã‚·ã‚¹ãƒ†ãƒ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
  
  -- ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
  created_at      TIMESTAMP DEFAULT NOW(),
  updated_at      TIMESTAMP DEFAULT NOW(),
  created_by      TEXT,
  updated_by      TEXT,
  
  CONSTRAINT unq_role_templates_business_type_name UNIQUE (business_type, name)
);

CREATE INDEX idx_role_templates_business_type ON role_templates(business_type);
CREATE INDEX idx_role_templates_is_active ON role_templates(is_active);
CREATE INDEX idx_role_templates_is_system ON role_templates(is_system);
```

**Prismaãƒ¢ãƒ‡ãƒ«**:
```prisma
model RoleTemplate {
  id                String    @id @default(uuid())
  
  businessType      String    @map("business_type")
  name              String
  description       String?
  
  rolesDefinition   Json      @map("roles_definition")
  
  isActive          Boolean   @default(true) @map("is_active")
  isSystem          Boolean   @default(false) @map("is_system")
  
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")
  createdBy         String?   @map("created_by")
  updatedBy         String?   @map("updated_by")
  
  @@unique([businessType, name], map: "unq_role_templates_business_type_name")
  @@index([businessType], map: "idx_role_templates_business_type")
  @@index([isActive], map: "idx_role_templates_is_active")
  @@index([isSystem], map: "idx_role_templates_is_system")
  @@map("role_templates")
}
```

**roles_definitionæ§‹é€ ä¾‹**:
```json
{
  "roles": [
    {
      "name": "æ”¯é…äºº",
      "description": "ãƒ›ãƒ†ãƒ«å…¨ä½“ã®ç®¡ç†è²¬ä»»è€…",
      "sortOrder": 100,
      "permissions": [
        "hotel-saas:order:view",
        "hotel-saas:order:create",
        "hotel-saas:order:update",
        "hotel-saas:order:delete",
        "hotel-saas:menu:view",
        "hotel-saas:menu:create",
        "hotel-saas:menu:update",
        "hotel-saas:menu:delete",
        "hotel-saas:ai:use",
        "system:staff:view",
        "system:staff:create",
        "system:staff:update",
        "system:staff:delete",
        "system:roles:view",
        "system:roles:create",
        "system:roles:update",
        "system:roles:delete",
        "system:settings:view",
        "system:settings:update",
        "system:logs:view"
      ]
    },
    {
      "name": "ãƒ•ãƒ­ãƒ³ãƒˆä¸»ä»»",
      "description": "ãƒ•ãƒ­ãƒ³ãƒˆæ¥­å‹™å…¨èˆ¬ã®ç®¡ç†",
      "sortOrder": 90,
      "permissions": [
        "hotel-pms:reservation:*",
        "hotel-pms:checkin:*",
        "hotel-pms:billing:view",
        "hotel-saas:order:view"
      ]
    },
    {
      "name": "ãƒ•ãƒ­ãƒ³ãƒˆã‚¹ã‚¿ãƒƒãƒ•",
      "description": "åŸºæœ¬çš„ãªãƒ•ãƒ­ãƒ³ãƒˆæ¥­å‹™",
      "sortOrder": 80,
      "permissions": [
        "hotel-pms:reservation:view",
        "hotel-pms:checkin:execute",
        "hotel-saas:order:view"
      ]
    }
  ]
}
```

---

## ğŸ”Œ APIä»•æ§˜

### 1. å½¹è·ç®¡ç†API

#### `GET /api/v1/admin/roles`

**ç›®çš„**: ãƒ†ãƒŠãƒ³ãƒˆã®å½¹è·ä¸€è¦§å–å¾—

**ãƒªã‚¯ã‚¨ã‚¹ãƒˆ**:
```
GET /api/v1/admin/roles?tenantId={tenantId}&isActive=true
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹**:
```json
{
  "success": true,
  "data": [
    {
      "id": "role-001",
      "tenantId": "hotel-a",
      "name": "ãƒ•ãƒ­ãƒ³ãƒˆä¸»ä»»",
      "description": "ãƒ•ãƒ­ãƒ³ãƒˆæ¥­å‹™å…¨èˆ¬ã®ç®¡ç†",
      "sortOrder": 90,
      "isActive": true,
      "isDefault": false,
      "permissionCount": 25,
      "assignedStaffCount": 3,
      "createdAt": "2025-01-01T00:00:00Z",
      "updatedAt": "2025-01-01T00:00:00Z"
    }
  ]
}
```

---

#### `GET /api/v1/admin/roles/:id`

**ç›®çš„**: å½¹è·è©³ç´°å–å¾—ï¼ˆæ¨©é™ä¸€è¦§å«ã‚€ï¼‰

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹**:
```json
{
  "success": true,
  "data": {
    "id": "role-001",
    "tenantId": "hotel-a",
    "name": "ãƒ•ãƒ­ãƒ³ãƒˆä¸»ä»»",
    "description": "ãƒ•ãƒ­ãƒ³ãƒˆæ¥­å‹™å…¨èˆ¬ã®ç®¡ç†",
    "sortOrder": 90,
    "isActive": true,
    "isDefault": false,
    "permissions": [
      {
        "id": "perm-001",
        "code": "hotel-pms:reservation:view",
        "name": "äºˆç´„é–²è¦§",
        "category": "hotel-pms"
      },
      {
        "id": "perm-002",
        "code": "hotel-pms:reservation:create",
        "name": "äºˆç´„ä½œæˆ",
        "category": "hotel-pms"
      }
    ],
    "assignedStaff": [
      {
        "staffId": "staff-001",
        "staffName": "å±±ç”°å¤ªéƒ",
        "email": "yamada@example.com",
        "isPrimary": true
      }
    ],
    "createdAt": "2025-01-01T00:00:00Z",
    "updatedAt": "2025-01-01T00:00:00Z"
  }
}
```

---

#### `POST /api/v1/admin/roles`

**ç›®çš„**: å½¹è·ä½œæˆ

**ãƒªã‚¯ã‚¨ã‚¹ãƒˆ**:
```json
{
  "tenantId": "hotel-a",
  "name": "ãƒ•ãƒ­ãƒ³ãƒˆä¸»ä»»",
  "description": "ãƒ•ãƒ­ãƒ³ãƒˆæ¥­å‹™å…¨èˆ¬ã®ç®¡ç†",
  "sortOrder": 90,
  "permissionIds": ["perm-001", "perm-002", "perm-003"]
}
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹**:
```json
{
  "success": true,
  "data": {
    "id": "role-001",
    "tenantId": "hotel-a",
    "name": "ãƒ•ãƒ­ãƒ³ãƒˆä¸»ä»»",
    "createdAt": "2025-01-01T00:00:00Z"
  }
}
```

---

#### `PUT /api/v1/admin/roles/:id`

**ç›®çš„**: å½¹è·æ›´æ–°

**ãƒªã‚¯ã‚¨ã‚¹ãƒˆ**:
```json
{
  "name": "ãƒ•ãƒ­ãƒ³ãƒˆä¸»ä»»",
  "description": "ãƒ•ãƒ­ãƒ³ãƒˆæ¥­å‹™å…¨èˆ¬ã®ç®¡ç†ï¼ˆæ›´æ–°ï¼‰",
  "sortOrder": 95,
  "permissionIds": ["perm-001", "perm-002", "perm-004"]
}
```

---

#### `DELETE /api/v1/admin/roles/:id`

**ç›®çš„**: å½¹è·å‰Šé™¤

**é‡è¦**: ã‚¹ã‚¿ãƒƒãƒ•ãŒå‰²ã‚Šå½“ã¦ã‚‰ã‚Œã¦ã„ã‚‹å ´åˆã¯å‰Šé™¤ä¸å¯

**å‡¦ç†ãƒ•ãƒ­ãƒ¼**:
```typescript
// 1. ã‚¹ã‚¿ãƒƒãƒ•å‰²ã‚Šå½“ã¦ç¢ºèª
const assignedStaffCount = await prisma.staffTenantMembership.count({
  where: { roleId: roleId }
});

if (assignedStaffCount > 0) {
  return res.status(400).json({
    success: false,
    error: {
      code: 'ROLE_IN_USE',
      message: `ã“ã®å½¹è·ã«ã¯${assignedStaffCount}äººã®ã‚¹ã‚¿ãƒƒãƒ•ãŒå‰²ã‚Šå½“ã¦ã‚‰ã‚Œã¦ã„ã¾ã™ã€‚å‰Šé™¤ã™ã‚‹å‰ã«ã€å…¨å“¡ã‚’åˆ¥ã®å½¹è·ã«å¤‰æ›´ã—ã¦ãã ã•ã„ã€‚`
    }
  });
}

// 2. å‰Šé™¤å®Ÿè¡Œ
await prisma.role.delete({
  where: { id: roleId }
});
```

---

### 2. æ¨©é™ç®¡ç†API

#### `GET /api/v1/admin/permissions`

**ç›®çš„**: ã‚·ã‚¹ãƒ†ãƒ æ¨©é™ä¸€è¦§å–å¾—

**ãƒªã‚¯ã‚¨ã‚¹ãƒˆ**:
```
GET /api/v1/admin/permissions?category=hotel-pms&isActive=true
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹**:
```json
{
  "success": true,
  "data": [
    {
      "id": "perm-001",
      "code": "hotel-pms:reservation:view",
      "name": "äºˆç´„é–²è¦§",
      "description": "äºˆç´„æƒ…å ±ã‚’é–²è¦§ã™ã‚‹æ¨©é™",
      "category": "hotel-pms",
      "isActive": true
    }
  ]
}
```

---

#### `GET /api/v1/admin/permissions/grouped`

**ç›®çš„**: ã‚«ãƒ†ã‚´ãƒªåˆ¥ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã•ã‚ŒãŸæ¨©é™ä¸€è¦§å–å¾—

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹**:
```json
{
  "success": true,
  "data": {
    "hotel-pms": {
      "reservation": [
        {
          "id": "perm-001",
          "code": "hotel-pms:reservation:view",
          "name": "äºˆç´„é–²è¦§"
        },
        {
          "id": "perm-002",
          "code": "hotel-pms:reservation:create",
          "name": "äºˆç´„ä½œæˆ"
        }
      ],
      "billing": [
        {
          "id": "perm-010",
          "code": "hotel-pms:billing:view",
          "name": "ä¼šè¨ˆé–²è¦§"
        }
      ]
    },
    "hotel-saas": {
      "order": [
        {
          "id": "perm-020",
          "code": "hotel-saas:order:view",
          "name": "æ³¨æ–‡é–²è¦§"
        }
      ]
    }
  }
}
```

---

### 3. å½¹è·ã‚³ãƒ”ãƒ¼API

#### `POST /api/v1/admin/roles/copy`

**ç›®çš„**: ãƒ–ãƒ©ãƒ³ãƒ‰ï¼ˆãƒã‚§ãƒ¼ãƒ³ï¼‰å†…ã®ä»–ãƒ†ãƒŠãƒ³ãƒˆã‹ã‚‰å½¹è·ã‚’ã‚³ãƒ”ãƒ¼

**ãƒªã‚¯ã‚¨ã‚¹ãƒˆ**:
```json
{
  "sourceTenantId": "hotel-a",
  "sourceRoleId": "role-001",
  "targetTenantId": "hotel-b",
  "newRoleName": "ãƒ•ãƒ­ãƒ³ãƒˆä¸»ä»»ï¼ˆã‚³ãƒ”ãƒ¼ï¼‰"
}
```

**å‡¦ç†ãƒ•ãƒ­ãƒ¼**:
```typescript
// 1. åŒä¸€ãƒ–ãƒ©ãƒ³ãƒ‰ï¼ˆãƒã‚§ãƒ¼ãƒ³ï¼‰ç¢ºèª
const sourceOrg = await prisma.organizationHierarchy.findFirst({
  where: {
    level: 3, // HOTEL
    path: { contains: sourceTenantId }
  }
});

const targetOrg = await prisma.organizationHierarchy.findFirst({
  where: {
    level: 3, // HOTEL
    path: { contains: targetTenantId }
  }
});

// è¦ªBRANDï¼ˆãƒã‚§ãƒ¼ãƒ³ï¼‰IDãŒåŒã˜ã‹ç¢ºèª
if (sourceOrg.parentId !== targetOrg.parentId) {
  return res.status(403).json({
    success: false,
    error: {
      code: 'DIFFERENT_BRAND',
      message: 'ç•°ãªã‚‹ãƒ–ãƒ©ãƒ³ãƒ‰ï¼ˆãƒã‚§ãƒ¼ãƒ³ï¼‰ã®ãƒ›ãƒ†ãƒ«é–“ã§ã¯å½¹è·ã‚’ã‚³ãƒ”ãƒ¼ã§ãã¾ã›ã‚“'
    }
  });
}

// 2. å…ƒã®å½¹è·ã¨æ¨©é™ã‚’å–å¾—
const sourceRole = await prisma.role.findUnique({
  where: { id: sourceRoleId },
  include: { permissions: { include: { permission: true } } }
});

// 3. æ–°ã—ã„å½¹è·ã‚’ä½œæˆ
const newRole = await prisma.role.create({
  data: {
    tenantId: targetTenantId,
    name: newRoleName,
    description: `${sourceRole.description}ï¼ˆã‚³ãƒ”ãƒ¼å…ƒ: ${sourceRole.name}ï¼‰`,
    sortOrder: sourceRole.sortOrder
  }
});

// 4. æ¨©é™ã‚’ã‚³ãƒ”ãƒ¼
await prisma.rolePermission.createMany({
  data: sourceRole.permissions.map(rp => ({
    roleId: newRole.id,
    permissionId: rp.permissionId
  }))
});
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹**:
```json
{
  "success": true,
  "data": {
    "id": "role-new",
    "tenantId": "hotel-b",
    "name": "ãƒ•ãƒ­ãƒ³ãƒˆä¸»ä»»ï¼ˆã‚³ãƒ”ãƒ¼ï¼‰",
    "permissionCount": 25,
    "sourceTenantName": "ãƒ›ãƒ†ãƒ«A",
    "sourceRoleName": "ãƒ•ãƒ­ãƒ³ãƒˆä¸»ä»»"
  }
}
```

---

### 4. çµ„ç¹”ç®¡ç†API

#### `GET /api/v1/admin/organization/same-brand-tenants`

**ç›®çš„**: åŒä¸€ãƒ–ãƒ©ãƒ³ãƒ‰ï¼ˆãƒã‚§ãƒ¼ãƒ³ï¼‰å†…ã®ãƒ†ãƒŠãƒ³ãƒˆä¸€è¦§å–å¾—

**ãƒªã‚¯ã‚¨ã‚¹ãƒˆ**:
```
GET /api/v1/admin/organization/same-brand-tenants?tenantId={tenantId}
```

**å‡¦ç†ãƒ•ãƒ­ãƒ¼**:
```typescript
// 1. å¯¾è±¡ãƒ†ãƒŠãƒ³ãƒˆã®çµ„ç¹”æƒ…å ±ã‚’å–å¾—
const targetOrg = await prisma.organizationHierarchy.findFirst({
  where: {
    level: 3,  // HOTEL
    path: { contains: tenantId }
  }
});

// 2. åŒä¸€BRANDé…ä¸‹ã®å…¨HOTELã‚’å–å¾—
const sameBrandOrgs = await prisma.organizationHierarchy.findMany({
  where: {
    level: 3,  // HOTEL
    parentId: targetOrg.parentId  // åŒã˜BRAND
  },
  include: {
    parent: true  // BRANDæƒ…å ±
  }
});

// 3. ãƒ†ãƒŠãƒ³ãƒˆæƒ…å ±ã‚’å–å¾—
const tenantIds = sameBrandOrgs.map(org => 
  org.path.split('/').pop()  // pathã‹ã‚‰æœ€å¾Œã®ã‚»ã‚°ãƒ¡ãƒ³ãƒˆï¼ˆtenantIdï¼‰ã‚’å–å¾—
);

const tenants = await prisma.tenant.findMany({
  where: { id: { in: tenantIds } }
});
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹**:
```json
{
  "success": true,
  "data": [
    {
      "id": "hotel-a",
      "name": "ãƒ›ãƒ†ãƒ«A",
      "brandId": "brand-001",
      "brandName": "ã‚¢ãƒ‘ãƒ›ãƒ†ãƒ«"
    },
    {
      "id": "hotel-b",
      "name": "ãƒ›ãƒ†ãƒ«B",
      "brandId": "brand-001",
      "brandName": "ã‚¢ãƒ‘ãƒ›ãƒ†ãƒ«"
    },
    {
      "id": "hotel-c",
      "name": "ãƒ›ãƒ†ãƒ«C",
      "brandId": "brand-001",
      "brandName": "ã‚¢ãƒ‘ãƒ›ãƒ†ãƒ«"
    }
  ]
}
```

---

### 5. ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆAPI

#### `GET /api/v1/admin/role-templates`

**ç›®çš„**: æ¥­æ…‹åˆ¥ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä¸€è¦§å–å¾—

**ãƒªã‚¯ã‚¨ã‚¹ãƒˆ**:
```
GET /api/v1/admin/role-templates?businessType=hotel
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹**:
```json
{
  "success": true,
  "data": [
    {
      "id": "template-hotel",
      "businessType": "hotel",
      "name": "ãƒ“ã‚¸ãƒã‚¹ãƒ›ãƒ†ãƒ«æ¨™æº–",
      "description": "ãƒ“ã‚¸ãƒã‚¹ãƒ›ãƒ†ãƒ«å‘ã‘ã®æ¨™æº–å½¹è·ã‚»ãƒƒãƒˆ",
      "isSystem": true,
      "rolesCount": 5,
      "createdAt": "2025-01-01T00:00:00Z"
    }
  ]
}
```

---

#### `POST /api/v1/admin/roles/apply-template`

**ç›®çš„**: ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‹ã‚‰ãƒ†ãƒŠãƒ³ãƒˆã«å½¹è·ã‚’ä¸€æ‹¬ä½œæˆ

**ãƒªã‚¯ã‚¨ã‚¹ãƒˆ**:
```json
{
  "tenantId": "hotel-new",
  "templateId": "template-hotel"
}
```

**å‡¦ç†ãƒ•ãƒ­ãƒ¼**:
```typescript
// 1. ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå–å¾—
const template = await prisma.roleTemplate.findUnique({
  where: { id: templateId }
});

const rolesDefinition = template.rolesDefinition as {
  roles: Array<{
    name: string;
    description: string;
    sortOrder: number;
    permissions: string[];
  }>;
};

// 2. æ¨©é™ã‚³ãƒ¼ãƒ‰ã‹ã‚‰PermissionIDã‚’å–å¾—
const permissionCodes = rolesDefinition.roles
  .flatMap(r => r.permissions);

const permissions = await prisma.permission.findMany({
  where: { code: { in: permissionCodes } }
});

const permissionMap = new Map(permissions.map(p => [p.code, p.id]));

// 3. å½¹è·ã‚’ä¸€æ‹¬ä½œæˆ
for (const roleDef of rolesDefinition.roles) {
  const role = await prisma.role.create({
    data: {
      tenantId,
      name: roleDef.name,
      description: roleDef.description,
      sortOrder: roleDef.sortOrder,
      isDefault: roleDef.sortOrder === 80  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå½¹è·ãƒ•ãƒ©ã‚°
    }
  });

  // æ¨©é™ã‚’ä¸€æ‹¬ä½œæˆ
  const permissionIds = roleDef.permissions
    .map(code => permissionMap.get(code))
    .filter(id => id !== undefined);

  await prisma.rolePermission.createMany({
    data: permissionIds.map(permissionId => ({
      roleId: role.id,
      permissionId
    }))
  });
}
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹**:
```json
{
  "success": true,
  "data": {
    "tenantId": "hotel-new",
    "templateName": "ãƒ“ã‚¸ãƒã‚¹ãƒ›ãƒ†ãƒ«æ¨™æº–",
    "createdRoles": [
      {
        "id": "role-001",
        "name": "æ”¯é…äºº"
      },
      {
        "id": "role-002",
        "name": "ãƒ•ãƒ­ãƒ³ãƒˆä¸»ä»»"
      }
    ]
  }
}
```

---

### 6. ã‚¹ã‚¿ãƒƒãƒ•å½¹è·å‰²ã‚Šå½“ã¦API

#### `PUT /api/v1/admin/staff/:staffId/role`

**ç›®çš„**: ã‚¹ã‚¿ãƒƒãƒ•ã¸ã®å½¹è·å‰²ã‚Šå½“ã¦ï¼ˆãƒ†ãƒŠãƒ³ãƒˆåˆ¥ï¼‰

**ãƒªã‚¯ã‚¨ã‚¹ãƒˆ**:
```json
{
  "tenantId": "hotel-a",
  "roleId": "role-001"
}
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹**:
```json
{
  "success": true,
  "data": {
    "staffId": "staff-001",
    "tenantId": "hotel-a",
    "roleId": "role-001",
    "roleName": "ãƒ•ãƒ­ãƒ³ãƒˆä¸»ä»»",
    "permissions": [
      "hotel-pms:reservation:view",
      "hotel-pms:checkin:execute"
    ]
  }
}
```

---

## ğŸ¨ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å®Ÿè£…

### 1. å½¹è·ç®¡ç†ç”»é¢

**ãƒ‘ã‚¹**: `/pages/admin/settings/roles/index.vue`

**ç”»é¢æ§‹æˆ**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å½¹è·ç®¡ç†                                               â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ + æ–°ã—ã„å½¹è·ã‚’è¿½åŠ   [ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‹ã‚‰èª­ã¿è¾¼ã¿]     â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                        â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ æ”¯é…äºº                              [ç·¨é›†] [å‰Šé™¤] â”‚   â”‚
â”‚ â”‚ èª¬æ˜: ãƒ›ãƒ†ãƒ«å…¨ä½“ã®ç®¡ç†è²¬ä»»è€…                     â”‚   â”‚
â”‚ â”‚ æ¨©é™: å…¨æ¨©é™                                     â”‚   â”‚
â”‚ â”‚ ã‚¹ã‚¿ãƒƒãƒ•: 1äºº                                    â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                        â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ ãƒ•ãƒ­ãƒ³ãƒˆä¸»ä»»                        [ç·¨é›†] [å‰Šé™¤] â”‚   â”‚
â”‚ â”‚ èª¬æ˜: ãƒ•ãƒ­ãƒ³ãƒˆæ¥­å‹™å…¨èˆ¬ã®ç®¡ç†                     â”‚   â”‚
â”‚ â”‚ æ¨©é™: 25å€‹                                       â”‚   â”‚
â”‚ â”‚ ã‚¹ã‚¿ãƒƒãƒ•: 3äºº                                    â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                        â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ ãƒ•ãƒ­ãƒ³ãƒˆã‚¹ã‚¿ãƒƒãƒ•                    [ç·¨é›†] [å‰Šé™¤] â”‚   â”‚
â”‚ â”‚ èª¬æ˜: åŸºæœ¬çš„ãªãƒ•ãƒ­ãƒ³ãƒˆæ¥­å‹™                       â”‚   â”‚
â”‚ â”‚ æ¨©é™: 12å€‹                                       â”‚   â”‚
â”‚ â”‚ ã‚¹ã‚¿ãƒƒãƒ•: 8äºº                                    â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å®Ÿè£…ä¾‹**:
```vue
<template>
  <div class="roles-management">
    <div class="header">
      <h1>å½¹è·ç®¡ç†</h1>
      <div class="actions">
        <UButton 
          color="primary" 
          @click="showCreateModal = true"
        >
          + æ–°ã—ã„å½¹è·ã‚’è¿½åŠ 
        </UButton>
        <UButton 
          color="white" 
          @click="showTemplateModal = true"
        >
          ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‹ã‚‰èª­ã¿è¾¼ã¿
        </UButton>
      </div>
    </div>

    <div class="roles-list">
      <div 
        v-for="role in roles" 
        :key="role.id" 
        class="role-card"
      >
        <div class="role-header">
          <h3>{{ role.name }}</h3>
          <div class="role-actions">
            <UButton 
              size="sm" 
              color="white" 
              @click="editRole(role.id)"
            >
              ç·¨é›†
            </UButton>
            <UButton 
              size="sm" 
              color="red" 
              :disabled="role.assignedStaffCount > 0"
              @click="deleteRole(role.id)"
            >
              å‰Šé™¤
            </UButton>
          </div>
        </div>
        <p class="role-description">{{ role.description }}</p>
        <div class="role-stats">
          <span>æ¨©é™: {{ role.permissionCount }}å€‹</span>
          <span>ã‚¹ã‚¿ãƒƒãƒ•: {{ role.assignedStaffCount }}äºº</span>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
const { currentTenant } = useSessionAuth();
const toast = useToast();

const roles = ref<Role[]>([]);
const showCreateModal = ref(false);
const showTemplateModal = ref(false);

// å½¹è·ä¸€è¦§å–å¾—
const fetchRoles = async () => {
  try {
    const response = await $fetch('/api/v1/admin/roles', {
      params: { tenantId: currentTenant.value?.id }
    });
    roles.value = response.data;
  } catch (error) {
    toast.error('ã‚¨ãƒ©ãƒ¼', 'å½¹è·ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
  }
};

// å½¹è·å‰Šé™¤
const deleteRole = async (roleId: string) => {
  const role = roles.value.find(r => r.id === roleId);
  
  if (role.assignedStaffCount > 0) {
    toast.error(
      'å‰Šé™¤ã‚¨ãƒ©ãƒ¼',
      `ã“ã®å½¹è·ã«ã¯${role.assignedStaffCount}äººã®ã‚¹ã‚¿ãƒƒãƒ•ãŒå‰²ã‚Šå½“ã¦ã‚‰ã‚Œã¦ã„ã¾ã™ã€‚å‰Šé™¤ã™ã‚‹å‰ã«ã€å…¨å“¡ã‚’åˆ¥ã®å½¹è·ã«å¤‰æ›´ã—ã¦ãã ã•ã„ã€‚`
    );
    return;
  }
  
  // ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«
  const confirmed = await showConfirmModal({
    title: 'å½¹è·å‰Šé™¤ç¢ºèª',
    message: `å½¹è·ã€Œ${role.name}ã€ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`,
    confirmText: 'å‰Šé™¤',
    confirmColor: 'red'
  });
  
  if (!confirmed) return;
  
  try {
    await $fetch(`/api/v1/admin/roles/${roleId}`, {
      method: 'DELETE'
    });
    
    toast.success('å‰Šé™¤æˆåŠŸ', `å½¹è·ã€Œ${role.name}ã€ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`);
    fetchRoles();
  } catch (error) {
    toast.error('ã‚¨ãƒ©ãƒ¼', 'å½¹è·ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
  }
};

onMounted(() => {
  fetchRoles();
});
</script>
```

---

### 2. æ¨©é™ãƒãƒƒãƒ”ãƒ³ã‚°ç”»é¢

**ãƒ‘ã‚¹**: `/pages/admin/settings/roles/[id]/permissions.vue`

**ğŸ“Œ æ³¨æ„: ã“ã®ç”»é¢è¨­è¨ˆã¯hotel-saaså°‚ç”¨ã§ã™**

hotel-saasç®¡ç†ç”»é¢ã§ã¯ã€ä»¥ä¸‹ã®ã‚«ãƒ†ã‚´ãƒªã‚’ç®¡ç†ã—ã¾ã™ï¼š
- `hotel-saas`: æ³¨æ–‡ç®¡ç†ã€ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç®¡ç†ã€AIæ©Ÿèƒ½ç­‰
- `system`: ã‚¹ã‚¿ãƒƒãƒ•ç®¡ç†ã€å½¹è·ç®¡ç†ã€ãƒ­ã‚°é–²è¦§ç­‰

**hotel-pmså®Ÿè£…æ™‚ã¯ã€ã‚«ãƒ†ã‚´ãƒªã‚’ä»¥ä¸‹ã«å¤‰æ›´ã—ã¦ãã ã•ã„ï¼š**
- `hotel-pms`: äºˆç´„ç®¡ç†ã€ä¼šè¨ˆç®¡ç†ã€ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³/ã‚¢ã‚¦ãƒˆç­‰
- `system`: ã‚¹ã‚¿ãƒƒãƒ•ç®¡ç†ã€å½¹è·ç®¡ç†ã€ãƒ­ã‚°é–²è¦§ç­‰ï¼ˆå…±é€šï¼‰

**ã‚¿ãƒ–æ§‹æˆã«ã¤ã„ã¦ï¼š**
- hotel-saas: è‡ªã‚·ã‚¹ãƒ†ãƒ ã®ã‚«ãƒ†ã‚´ãƒªï¼ˆ`hotel-saas`ã€`system`ï¼‰ã®ã¿ã‚’è¡¨ç¤ºã™ã‚‹ãŸã‚ã€ã‚¿ãƒ–åˆ†ã‘ã¯ä¸è¦
- hotel-pms: è‡ªã‚·ã‚¹ãƒ†ãƒ ã®ã‚«ãƒ†ã‚´ãƒªï¼ˆ`hotel-pms`ã€`system`ï¼‰ã®ã¿ã‚’è¡¨ç¤ºã™ã‚‹ãŸã‚ã€ã‚¿ãƒ–åˆ†ã‘ã¯ä¸è¦

**ç”»é¢æ§‹æˆï¼ˆhotel-saaså®Ÿè£…ä¾‹ï¼‰**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å½¹è·: ãƒ•ãƒ­ãƒ³ãƒˆã‚¹ã‚¿ãƒƒãƒ• ã®æ¨©é™è¨­å®š                        â”‚
â”‚                                                          â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ ğŸ“¦ æ³¨æ–‡ç®¡ç†ï¼ˆhotel-saasï¼‰              [å…¨ã¦è¨±å¯]    â”‚ â”‚
â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”           â”‚ â”‚
â”‚ â”‚ â”‚ æ©Ÿèƒ½     â”‚ é–²è¦§ â”‚ ä½œæˆ â”‚ æ›´æ–° â”‚ å‰Šé™¤ â”‚           â”‚ â”‚
â”‚ â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¤           â”‚ â”‚
â”‚ â”‚ â”‚ æ³¨æ–‡     â”‚  âœ“   â”‚  âœ“   â”‚  âœ“   â”‚  âœ—   â”‚           â”‚ â”‚
â”‚ â”‚ â”‚ ã‚­ãƒ£ãƒ³ã‚»ãƒ«â”‚  âœ“   â”‚  âœ—   â”‚  âœ—   â”‚  âœ—   â”‚           â”‚ â”‚
â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”˜           â”‚ â”‚
â”‚ â”‚                                                      â”‚ â”‚
â”‚ â”‚ ğŸ½ï¸ ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç®¡ç†ï¼ˆhotel-saasï¼‰         [å…¨ã¦è¨±å¯]    â”‚ â”‚
â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”           â”‚ â”‚
â”‚ â”‚ â”‚ æ©Ÿèƒ½     â”‚ é–²è¦§ â”‚ ä½œæˆ â”‚ ç·¨é›† â”‚ å‰Šé™¤ â”‚           â”‚ â”‚
â”‚ â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¤           â”‚ â”‚
â”‚ â”‚ â”‚ ãƒ¡ãƒ‹ãƒ¥ãƒ¼ â”‚  âœ“   â”‚  âœ“   â”‚  âœ“   â”‚  âœ—   â”‚           â”‚ â”‚
â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”˜           â”‚ â”‚
â”‚ â”‚                                                      â”‚ â”‚
â”‚ â”‚ âš™ï¸ ã‚¹ã‚¿ãƒƒãƒ•ç®¡ç†ï¼ˆsystemï¼‰             [å…¨ã¦è¨±å¯]    â”‚ â”‚
â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”           â”‚ â”‚
â”‚ â”‚ â”‚ æ©Ÿèƒ½     â”‚ é–²è¦§ â”‚ ä½œæˆ â”‚ ç·¨é›† â”‚ å‰Šé™¤ â”‚           â”‚ â”‚
â”‚ â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¤           â”‚ â”‚
â”‚ â”‚ â”‚ ã‚¹ã‚¿ãƒƒãƒ• â”‚  âœ“   â”‚  âœ“   â”‚  âœ“   â”‚  âœ—   â”‚           â”‚ â”‚
â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”˜           â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                          â”‚
â”‚ [ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼] [ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‹ã‚‰èª­ã¿è¾¼ã¿] [ä¿å­˜]           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ’¡ hotel-pmså®Ÿè£…æ™‚ã®ç”»é¢æ§‹æˆä¾‹**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å½¹è·: ãƒ•ãƒ­ãƒ³ãƒˆã‚¹ã‚¿ãƒƒãƒ• ã®æ¨©é™è¨­å®š                        â”‚
â”‚                                                          â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ ğŸ“‹ äºˆç´„ç®¡ç†ï¼ˆhotel-pmsï¼‰               [å…¨ã¦è¨±å¯]    â”‚ â”‚
â”‚ â”‚ â”‚ äºˆç´„     â”‚  âœ“   â”‚  âœ“   â”‚  âœ“   â”‚  âœ—   â”‚           â”‚ â”‚
â”‚ â”‚                                                      â”‚ â”‚
â”‚ â”‚ ğŸ’° ä¼šè¨ˆç®¡ç†ï¼ˆhotel-pmsï¼‰               [å…¨ã¦è¨±å¯]    â”‚ â”‚
â”‚ â”‚ â”‚ ä¼šè¨ˆå‡¦ç† â”‚  âœ“   â”‚  âœ“   â”‚  âœ—   â”‚  âœ—   â”‚           â”‚ â”‚
â”‚ â”‚                                                      â”‚ â”‚
â”‚ â”‚ âš™ï¸ ã‚¹ã‚¿ãƒƒãƒ•ç®¡ç†ï¼ˆsystemï¼‰             [å…¨ã¦è¨±å¯]    â”‚ â”‚
â”‚ â”‚ â”‚ ã‚¹ã‚¿ãƒƒãƒ• â”‚  âœ“   â”‚  âœ“   â”‚  âœ“   â”‚  âœ—   â”‚           â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**é‡è¦ãªUIè¦ç´ **:

1. **æ¨©é™ã‚°ãƒ«ãƒ¼ãƒ—**: æ©Ÿèƒ½ã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ”ãƒ³ã‚°ï¼ˆæ³¨æ–‡ç®¡ç†ã€ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç®¡ç†ã€ã‚¹ã‚¿ãƒƒãƒ•ç®¡ç†ç­‰ï¼‰
2. **å…¨ã¦è¨±å¯ãƒœã‚¿ãƒ³**: ã‚°ãƒ«ãƒ¼ãƒ—å†…ã®å…¨æ¨©é™ã‚’ä¸€æ‹¬ã§æœ‰åŠ¹åŒ–
3. **ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ãƒãƒˆãƒªãƒƒã‚¯ã‚¹**: ç›´æ„Ÿçš„ãªæ¨©é™é¸æŠ
4. **ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ©Ÿèƒ½**: å®ŸåŠ¹æ¨©é™ã®ç¢ºèªï¼ˆãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰å±•é–‹å«ã‚€ï¼‰
5. **ä¿å­˜æ™‚ç¢ºèª**: å¤‰æ›´å†…å®¹ã®ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°

---

### 2-1. æ¨©é™ãƒãƒƒãƒ”ãƒ³ã‚°ç”»é¢ã®UXè¨­è¨ˆï¼ˆv1.3.0è¿½åŠ ï¼‰

**ğŸ“Œ ãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰ + å…¨ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹è¡¨ç¤ºæ–¹å¼**

#### **è¨­è¨ˆæ–¹é‡**

ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ã¯åŠ¹ç‡çš„ãªãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰å½¢å¼ã§ä¿å­˜ã—ã¤ã¤ã€UIä¸Šã§ã¯å…¨ã¦ã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’è¡¨ç¤ºã™ã‚‹ã“ã¨ã§ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã€Œä½•ãŒè¨±å¯ã•ã‚Œã¦ã„ã‚‹ã‹ã€ã‚’è¦–è¦šçš„ã«ç†è§£ã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

#### **ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼**

```
ã€èª­ã¿è¾¼ã¿æ™‚ã€‘
DB: ['*:*:*']
  â†“
UI: å…¨49å€‹ã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ãŒONï¼ˆè‡ªå‹•å±•é–‹ï¼‰
    å…¨é …ç›®ã®èƒŒæ™¯è‰²ãŒé’è‰²ã«å¤‰åŒ–

ã€ä¿å­˜æ™‚ã€‘
UI: 49å€‹å…¨ã¦ãƒã‚§ãƒƒã‚¯æ¸ˆã¿
  â†“
æœ€é©åŒ–å‡¦ç†: optimizePermissionsé–¢æ•°
  â†“
DB: ['*:*:*']ï¼ˆ1ãƒ¬ã‚³ãƒ¼ãƒ‰ã«åœ§ç¸®ï¼‰
```

#### **è¦–è¦šçš„ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯**

1. **é¸æŠé …ç›®ã®èƒŒæ™¯è‰²å¤‰æ›´**
   - âœ… ãƒã‚§ãƒƒã‚¯æ¸ˆã¿é …ç›®: `bg-blue-50 border-blue-300`
   - âŒ æœªé¸æŠé …ç›®: `bg-white border-gray-200`

2. **ã‚°ãƒ­ãƒ¼ãƒãƒ«å…¨æ¨©é™ã®è¡¨ç¤º**
   ```
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ âœ“ å…¨ã¦ã®æ¨©é™ã‚’è¨±å¯ ï¼ˆæ”¯é…äººãƒ»ã‚ªãƒ¼ãƒŠãƒ¼å‘ã‘ï¼‰ â”‚
   â”‚   âœ“ å…¨ã¦ã®æ©Ÿèƒ½ï¼ˆ49å€‹ï¼‰ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã™    â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   ```

3. **ã‚«ãƒ†ã‚´ãƒªåˆ¥ã®ä¸€æ‹¬é¸æŠ**
   ```
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ ğŸ“¦ æ³¨æ–‡ç®¡ç†ï¼ˆhotel-saasï¼‰    [âœ“ å…¨ã¦è¨±å¯]  â”‚
   â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
   â”‚ â”‚ âœ“ æ³¨æ–‡ã®é–²è¦§      ï¼ˆèƒŒæ™¯è‰²: é’ï¼‰      â”‚   â”‚
   â”‚ â”‚ âœ“ æ³¨æ–‡ã®ä½œæˆ      ï¼ˆèƒŒæ™¯è‰²: é’ï¼‰      â”‚   â”‚
   â”‚ â”‚ âœ“ æ³¨æ–‡ã®æ›´æ–°      ï¼ˆèƒŒæ™¯è‰²: é’ï¼‰      â”‚   â”‚
   â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   ```

4. **å®ŸåŠ¹æ¨©é™ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼**
   ```
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ å®ŸåŠ¹æ¨©é™ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼                         â”‚
   â”‚ âœ“ 49å€‹ã®æ¨©é™ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã™ï¼ˆå…¨æ¨©é™ï¼‰   â”‚
   â”‚ ğŸ’¾ ä¿å­˜æ™‚: 1ä»¶ã¨ã—ã¦ä¿å­˜ã•ã‚Œã¾ã™           â”‚
   â”‚    ï¼ˆãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰: *:*:*ï¼‰              â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   ```

#### **æœ€é©åŒ–ãƒ­ã‚¸ãƒƒã‚¯**

```typescript
/**
 * UIé¸æŠçŠ¶æ…‹ã‚’ãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰ã«æœ€é©åŒ–
 * 
 * ä¾‹:
 * - å…¨49å€‹é¸æŠ â†’ ['*:*:*']
 * - hotel-saaså…¨é¸æŠ â†’ ['hotel-saas:*:*']
 * - å€‹åˆ¥é¸æŠ â†’ ['hotel-saas:order:view', 'hotel-saas:order:create']
 */
function optimizePermissions(uiPermissions: string[]): string[] {
  // å…¨æ¨©é™é¸æŠãƒã‚§ãƒƒã‚¯
  if (allPermissions.every(p => uiPermissions.includes(p.code))) {
    return ['*:*:*'];
  }
  
  // ã‚«ãƒ†ã‚´ãƒªåˆ¥æœ€é©åŒ–
  const optimized = new Set<string>();
  
  for (const category of ['hotel-saas', 'system']) {
    const categoryPerms = allPermissions.filter(p => 
      p.code.startsWith(`${category}:`)
    );
    
    const allSelected = categoryPerms.every(p => 
      uiPermissions.includes(p.code)
    );
    
    if (allSelected) {
      optimized.add(`${category}:*:*`);
    } else {
      categoryPerms.forEach(p => {
        if (uiPermissions.includes(p.code)) {
          optimized.add(p.code);
        }
      });
    }
  }
  
  return Array.from(optimized);
}
```

#### **ãƒã‚§ãƒƒã‚¯çŠ¶æ…‹åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯**

```typescript
/**
 * ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®è¡¨ç¤ºçŠ¶æ…‹ã‚’åˆ¤å®š
 * 
 * ãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã‚‚ã€
 * è©²å½“ã™ã‚‹å…¨ã¦ã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’ONã«ã™ã‚‹
 */
function isPermissionChecked(permissionCode: string): boolean {
  // ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰
  if (selectedPermissions.includes('*:*:*')) {
    return true;
  }
  
  const [category, resource, action] = permissionCode.split(':');
  
  // ã‚«ãƒ†ã‚´ãƒªãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰
  if (selectedPermissions.includes(`${category}:*:*`)) {
    return true;
  }
  
  // ãƒªã‚½ãƒ¼ã‚¹ãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰
  if (selectedPermissions.includes(`${category}:${resource}:*`)) {
    return true;
  }
  
  // å€‹åˆ¥æ¨©é™
  return selectedPermissions.includes(permissionCode);
}
```

#### **UXä¸Šã®æ³¨æ„ç‚¹**

1. **å…¨æ¨©é™é¸æŠæ™‚ã®æŒ™å‹•**
   - ã€Œå…¨ã¦ã®æ¨©é™ã‚’è¨±å¯ã€ã‚’ãƒã‚§ãƒƒã‚¯ â†’ å…¨ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ãŒè‡ªå‹•çš„ã«ON
   - å€‹åˆ¥ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã¯`disabled`çŠ¶æ…‹ï¼ˆã‚°ãƒ¬ãƒ¼ã‚¢ã‚¦ãƒˆï¼‰
   - èƒŒæ™¯è‰²ã¯å…¨ã¦é’è‰²ã«å¤‰åŒ–

2. **ã‚«ãƒ†ã‚´ãƒªå…¨é¸æŠæ™‚ã®æŒ™å‹•**
   - ã€Œhotel-saas: å…¨ã¦è¨±å¯ã€ã‚’ãƒã‚§ãƒƒã‚¯ â†’ è©²å½“ã‚«ãƒ†ã‚´ãƒªã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ãŒå…¨ã¦ON
   - è©²å½“é …ç›®ã®ã¿èƒŒæ™¯è‰²ãŒé’è‰²ã«å¤‰åŒ–

3. **å€‹åˆ¥é¸æŠã‹ã‚‰ã®å…¨é¸æŠ**
   - ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ‰‹å‹•ã§å…¨ã¦ãƒã‚§ãƒƒã‚¯ â†’ ä¿å­˜æ™‚ã«è‡ªå‹•çš„ã«`*:*:*`ã«æœ€é©åŒ–
   - æ¬¡å›èª­ã¿è¾¼ã¿æ™‚ã‚‚å…¨ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ONã§è¡¨ç¤º

4. **éƒ¨åˆ†è§£é™¤**
   - å…¨æ¨©é™ã‹ã‚‰1ã¤è§£é™¤ â†’ ãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰ã‚’ç ´æ£„ã—ã€å€‹åˆ¥æ¨©é™ãƒªã‚¹ãƒˆã«å¤‰æ›
   - ä¾‹: `['*:*:*']` â†’ `['hotel-saas:order:view', 'hotel-saas:order:create', ...]`ï¼ˆ48å€‹ï¼‰

#### **ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—è¡¨ç¤ºï¼ˆæ··ä¹±é˜²æ­¢ï¼‰**

**å•é¡Œ**: ã€Œå…¨æ¨©é™ã€ã¨ã€Œã‚·ã‚¹ãƒ†ãƒ å…¨æ¨©é™ã€ã®é•ã„ãŒåˆ†ã‹ã‚Šã«ãã„

**è§£æ±ºç­–**: ãƒã‚¦ã‚¹ã‚ªãƒ¼ãƒãƒ¼æ™‚ã«è©³ç´°èª¬æ˜ã‚’è¡¨ç¤º

| è¡¨ç¤ºå | ãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰ | ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—å†…å®¹ |
|:------|:--------------|:----------------|
| **å…¨ã¦ã®æ¨©é™ã‚’è¨±å¯** | `*:*:*` | ğŸ’¡ **å…¨ã‚·ã‚¹ãƒ†ãƒ ã®å…¨æ©Ÿèƒ½**<br>ãƒ»hotel-saasï¼ˆæ³¨æ–‡ã€ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç­‰ï¼‰<br>ãƒ»systemï¼ˆã‚¹ã‚¿ãƒƒãƒ•ã€å½¹è·ã€ãƒ­ã‚°ç­‰ï¼‰<br>ãƒ»hotel-pmsï¼ˆäºˆç´„ã€ä¼šè¨ˆç­‰ï¼‰â€»å°†æ¥<br><br>æ”¯é…äººãƒ»ã‚ªãƒ¼ãƒŠãƒ¼å‘ã‘ |
| **æ³¨æ–‡ç®¡ç†: å…¨ã¦è¨±å¯** | `hotel-saas:*:*` | ğŸ’¡ **æ³¨æ–‡ç®¡ç†ã®å…¨æ©Ÿèƒ½**<br>ãƒ»æ³¨æ–‡ã®é–²è¦§ã€ä½œæˆã€æ›´æ–°<br>ãƒ»ã‚­ãƒ£ãƒ³ã‚»ãƒ«å‡¦ç†<br>ãƒ»ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç®¡ç†<br>ãƒ»AIæ©Ÿèƒ½<br><br>æ³¨æ–‡ç®¡ç†è²¬ä»»è€…å‘ã‘ |
| **ã‚·ã‚¹ãƒ†ãƒ è¨­å®š: å…¨ã¦è¨±å¯** | `system:*:*` | ğŸ’¡ **ã‚·ã‚¹ãƒ†ãƒ è¨­å®šã®å…¨æ©Ÿèƒ½**<br>ãƒ»ã‚¹ã‚¿ãƒƒãƒ•ç®¡ç†<br>ãƒ»å½¹è·ãƒ»æ¨©é™ç®¡ç†<br>ãƒ»ãƒ­ã‚°é–²è¦§<br>ãƒ»ç›£æŸ»ãƒ­ã‚°<br><br>ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…å‘ã‘ |

**å®Ÿè£…ä¾‹**:

```vue
<UCheckbox 
  :model-value="hasGlobalWildcard"
  @update:model-value="toggleGlobalWildcard"
>
  <template #label>
    <div class="flex items-center gap-2">
      <Icon name="heroicons:shield-check" class="w-5 h-5" />
      <span class="font-semibold">å…¨ã¦ã®æ¨©é™ã‚’è¨±å¯</span>
      <UTooltip>
        <template #default>
          <Icon name="heroicons:question-mark-circle" class="w-4 h-4 text-gray-400 cursor-help" />
        </template>
        <template #content>
          <div class="text-sm">
            <div class="font-semibold mb-1">ğŸ’¡ å…¨ã‚·ã‚¹ãƒ†ãƒ ã®å…¨æ©Ÿèƒ½</div>
            <ul class="list-disc list-inside space-y-1 text-xs">
              <li>hotel-saasï¼ˆæ³¨æ–‡ã€ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç­‰ï¼‰</li>
              <li>systemï¼ˆã‚¹ã‚¿ãƒƒãƒ•ã€å½¹è·ã€ãƒ­ã‚°ç­‰ï¼‰</li>
              <li>hotel-pmsï¼ˆäºˆç´„ã€ä¼šè¨ˆç­‰ï¼‰â€»å°†æ¥</li>
            </ul>
            <div class="mt-2 text-xs text-gray-300">
              æ”¯é…äººãƒ»ã‚ªãƒ¼ãƒŠãƒ¼å‘ã‘
            </div>
          </div>
        </template>
      </UTooltip>
    </div>
  </template>
</UCheckbox>

<!-- ã‚«ãƒ†ã‚´ãƒªåˆ¥ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ— -->
<div class="flex items-center justify-between mb-3">
  <h3 class="text-lg font-semibold flex items-center gap-2">
    <Icon name="heroicons:cog-6-tooth" class="w-5 h-5" />
    ã‚·ã‚¹ãƒ†ãƒ è¨­å®š
    <UTooltip>
      <template #default>
        <Icon name="heroicons:question-mark-circle" class="w-4 h-4 text-gray-400 cursor-help" />
      </template>
      <template #content>
        <div class="text-sm">
          <div class="font-semibold mb-1">ğŸ’¡ ã‚·ã‚¹ãƒ†ãƒ è¨­å®šã®å…¨æ©Ÿèƒ½</div>
          <ul class="list-disc list-inside space-y-1 text-xs">
            <li>ã‚¹ã‚¿ãƒƒãƒ•ç®¡ç†</li>
            <li>å½¹è·ãƒ»æ¨©é™ç®¡ç†</li>
            <li>ãƒ­ã‚°é–²è¦§</li>
            <li>ç›£æŸ»ãƒ­ã‚°</li>
          </ul>
          <div class="mt-2 text-xs text-gray-300">
            ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…å‘ã‘
          </div>
        </div>
      </template>
    </UTooltip>
  </h3>
  <UCheckbox
    :model-value="isCategoryFullySelected('system')"
    @update:model-value="toggleCategoryAll('system', $event)"
    :disabled="hasGlobalWildcard"
  >
    <template #label>
      <span class="text-sm">å…¨ã¦è¨±å¯</span>
    </template>
  </UCheckbox>
</div>
```

**ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ãƒ‡ã‚¶ã‚¤ãƒ³**:
- èƒŒæ™¯è‰²: `bg-gray-800`ï¼ˆãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ï¼‰
- æ–‡å­—è‰²: `text-white`
- ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°: `p-3`
- è§’ä¸¸: `rounded-lg`
- å½±: `shadow-xl`
- ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³: `transition-opacity duration-200`

---

### 3. æ¨©é™ã‚³ãƒ”ãƒ¼UI

**ãƒ‘ã‚¹**: `/pages/admin/settings/roles/index.vue`ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ï¼‰

**ç”»é¢æ§‹æˆ**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä»–ã®ãƒ›ãƒ†ãƒ«ã‹ã‚‰å½¹è·ã‚’ã‚³ãƒ”ãƒ¼           â”‚
â”‚                                      â”‚
â”‚ ã‚³ãƒ”ãƒ¼å…ƒãƒ›ãƒ†ãƒ«:                      â”‚
â”‚ [é¸æŠã—ã¦ãã ã•ã„           â–¼]      â”‚
â”‚                                      â”‚
â”‚ ã‚³ãƒ”ãƒ¼å…ƒå½¹è·:                        â”‚
â”‚ [é¸æŠã—ã¦ãã ã•ã„           â–¼]      â”‚
â”‚                                      â”‚
â”‚ æ–°ã—ã„å½¹è·å:                        â”‚
â”‚ [____________]                       â”‚
â”‚                                      â”‚
â”‚ âš ï¸ æ³¨æ„:                            â”‚
â”‚ - åŒã˜ãƒ–ãƒ©ãƒ³ãƒ‰ï¼ˆãƒã‚§ãƒ¼ãƒ³ï¼‰å†…ã®ãƒ›ãƒ†ãƒ« â”‚
â”‚   ã‹ã‚‰ã®ã¿ã‚³ãƒ”ãƒ¼å¯èƒ½ã§ã™             â”‚
â”‚ - æ¨©é™è¨­å®šã‚‚ã‚³ãƒ”ãƒ¼ã•ã‚Œã¾ã™           â”‚
â”‚ - ã‚³ãƒ”ãƒ¼å¾Œã«ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºå¯èƒ½ã§ã™     â”‚
â”‚                                      â”‚
â”‚ [ã‚­ãƒ£ãƒ³ã‚»ãƒ«]           [ã‚³ãƒ”ãƒ¼å®Ÿè¡Œ]  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å®Ÿè£…ä¾‹**:
```vue
<template>
  <UModal v-model="isOpen">
    <div class="copy-role-modal">
      <h2>ä»–ã®ãƒ›ãƒ†ãƒ«ã‹ã‚‰å½¹è·ã‚’ã‚³ãƒ”ãƒ¼</h2>
      
      <UFormGroup label="ã‚³ãƒ”ãƒ¼å…ƒãƒ›ãƒ†ãƒ«">
        <USelect
          v-model="sourceTenantId"
          :options="sameBrandTenants"
          placeholder="é¸æŠã—ã¦ãã ã•ã„"
          @change="fetchSourceRoles"
        />
      </UFormGroup>
      
      <UFormGroup label="ã‚³ãƒ”ãƒ¼å…ƒå½¹è·">
        <USelect
          v-model="sourceRoleId"
          :options="sourceRoles"
          placeholder="é¸æŠã—ã¦ãã ã•ã„"
          :disabled="!sourceTenantId"
        />
      </UFormGroup>
      
      <UFormGroup label="æ–°ã—ã„å½¹è·å">
        <UInput
          v-model="newRoleName"
          placeholder="ä¾‹: ãƒ•ãƒ­ãƒ³ãƒˆä¸»ä»»ï¼ˆã‚³ãƒ”ãƒ¼ï¼‰"
        />
      </UFormGroup>
      
      <div class="notice">
        <p>âš ï¸ æ³¨æ„:</p>
        <ul>
          <li>åŒã˜ãƒ–ãƒ©ãƒ³ãƒ‰ï¼ˆãƒã‚§ãƒ¼ãƒ³ï¼‰å†…ã®ãƒ›ãƒ†ãƒ«ã‹ã‚‰ã®ã¿ã‚³ãƒ”ãƒ¼å¯èƒ½ã§ã™</li>
          <li>æ¨©é™è¨­å®šã‚‚ã‚³ãƒ”ãƒ¼ã•ã‚Œã¾ã™</li>
          <li>ã‚³ãƒ”ãƒ¼å¾Œã«ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºå¯èƒ½ã§ã™</li>
        </ul>
      </div>
      
      <div class="modal-actions">
        <UButton color="white" @click="isOpen = false">
          ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        </UButton>
        <UButton 
          color="primary" 
          @click="copyRole"
          :disabled="!sourceRoleId || !newRoleName"
        >
          ã‚³ãƒ”ãƒ¼å®Ÿè¡Œ
        </UButton>
      </div>
    </div>
  </UModal>
</template>

<script setup lang="ts">
const { currentTenant } = useSessionAuth();
const toast = useToast();

const isOpen = ref(false);
const sourceTenantId = ref('');
const sourceRoleId = ref('');
const newRoleName = ref('');
const sameBrandTenants = ref<Tenant[]>([]);
const sourceRoles = ref<Role[]>([]);

// åŒä¸€ãƒ–ãƒ©ãƒ³ãƒ‰ã®ãƒ†ãƒŠãƒ³ãƒˆå–å¾—
const fetchSameBrandTenants = async () => {
  try {
    const response = await $fetch('/api/v1/admin/organization/same-brand-tenants', {
      params: { tenantId: currentTenant.value?.id }
    });
    sameBrandTenants.value = response.data;
  } catch (error) {
    toast.error('ã‚¨ãƒ©ãƒ¼', 'ãƒ†ãƒŠãƒ³ãƒˆä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
  }
};

// ã‚³ãƒ”ãƒ¼å…ƒå½¹è·å–å¾—
const fetchSourceRoles = async () => {
  if (!sourceTenantId.value) return;
  
  try {
    const response = await $fetch('/api/v1/admin/roles', {
      params: { tenantId: sourceTenantId.value }
    });
    sourceRoles.value = response.data;
  } catch (error) {
    toast.error('ã‚¨ãƒ©ãƒ¼', 'å½¹è·ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
  }
};

// å½¹è·ã‚³ãƒ”ãƒ¼å®Ÿè¡Œ
const copyRole = async () => {
  try {
    const response = await $fetch('/api/v1/admin/roles/copy', {
      method: 'POST',
      body: {
        sourceTenantId: sourceTenantId.value,
        sourceRoleId: sourceRoleId.value,
        targetTenantId: currentTenant.value?.id,
        newRoleName: newRoleName.value
      }
    });
    
    toast.success('ã‚³ãƒ”ãƒ¼æˆåŠŸ', `å½¹è·ã€Œ${newRoleName.value}ã€ã‚’ä½œæˆã—ã¾ã—ãŸ`);
    isOpen.value = false;
    emit('copied');
  } catch (error) {
    if (error.statusCode === 403) {
      toast.error('ã‚¨ãƒ©ãƒ¼', 'ç•°ãªã‚‹ãƒ–ãƒ©ãƒ³ãƒ‰ï¼ˆãƒã‚§ãƒ¼ãƒ³ï¼‰ã®ãƒ›ãƒ†ãƒ«é–“ã§ã¯ã‚³ãƒ”ãƒ¼ã§ãã¾ã›ã‚“');
    } else {
      toast.error('ã‚¨ãƒ©ãƒ¼', 'å½¹è·ã®ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ');
    }
  }
};

onMounted(() => {
  fetchSameBrandTenants();
});
</script>
```

---

## ğŸ›¡ï¸ æ¨©é™ãƒã‚§ãƒƒã‚¯å®Ÿè£…

### 1. ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰æ¨©é™ãƒã‚§ãƒƒã‚¯

**ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢**: `/server/middleware/permission-check.ts`

```typescript
export default defineEventHandler(async (event) => {
  // èªè¨¼ãƒã‚§ãƒƒã‚¯
  const session = event.context.session;
  if (!session) {
    throw createError({
      statusCode: 401,
      message: 'èªè¨¼ãŒå¿…è¦ã§ã™'
    });
  }
  
  // æ¨©é™å–å¾—ï¼ˆRedisã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼‰
  const cacheKey = `permissions:${session.userId}:${session.tenantId}`;
  let permissions = await redis.get(cacheKey);
  
  if (!permissions) {
    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒãªã‘ã‚Œã°DBã‹ã‚‰å–å¾—
    permissions = await fetchUserPermissions(session.userId, session.tenantId);
    
    // 5åˆ†é–“ã‚­ãƒ£ãƒƒã‚·ãƒ¥
    await redis.setex(cacheKey, 300, JSON.stringify(permissions));
  } else {
    permissions = JSON.parse(permissions);
  }
  
  // ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã«æ¨©é™ã‚’è¨­å®š
  event.context.permissions = permissions;
});

// æ¨©é™å–å¾—é–¢æ•°
async function fetchUserPermissions(userId: string, tenantId: string) {
  const membership = await prisma.staffTenantMembership.findUnique({
    where: {
      staffId_tenantId: {
        staffId: userId,
        tenantId
      }
    },
    include: {
      role: {
        include: {
          permissions: {
            include: {
              permission: true
            }
          }
        }
      }
    }
  });
  
  // å½¹è·ã®æ¨©é™
  const rolePermissions = membership.role.permissions.map(rp => rp.permission.code);
  
  // ã‚«ã‚¹ã‚¿ãƒ æ¨©é™ï¼ˆã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ï¼‰
  const customPermissions = membership.customPermissions as string[];
  
  // çµ±åˆ
  return [...new Set([...rolePermissions, ...customPermissions])];
}
```

---

### 2. APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆæ¨©é™ãƒã‚§ãƒƒã‚¯

**å®Ÿè£…ä¾‹**: `/server/api/v1/admin/billing/refunds.post.ts`

```typescript
export default defineEventHandler(async (event) => {
  // æ¨©é™ãƒã‚§ãƒƒã‚¯
  const hasPermission = await checkPermission(event, 'hotel-pms:billing:refund');
  
  if (!hasPermission) {
    throw createError({
      statusCode: 403,
      message: 'ã“ã®æ“ä½œã‚’å®Ÿè¡Œã™ã‚‹æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“'
    });
  }
  
  // å‡¦ç†å®Ÿè¡Œ
  // ...
});

// æ¨©é™ãƒã‚§ãƒƒã‚¯ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
async function checkPermission(event: H3Event, requiredPermission: string): Promise<boolean> {
  const permissions = event.context.permissions as string[];
  
  // ãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰å±•é–‹
  for (const permission of permissions) {
    if (permission === '*:*:*') {
      // å…¨æ¨©é™
      return true;
    }
    
    const [system, resource, action] = permission.split(':');
    const [reqSystem, reqResource, reqAction] = requiredPermission.split(':');
    
    // ã‚·ã‚¹ãƒ†ãƒ ãƒ¬ãƒ™ãƒ«ãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰
    if (system === reqSystem && resource === '*' && action === '*') {
      return true;
    }
    
    // ãƒªã‚½ãƒ¼ã‚¹ãƒ¬ãƒ™ãƒ«ãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰
    if (system === reqSystem && resource === reqResource && action === '*') {
      return true;
    }
    
    // å®Œå…¨ä¸€è‡´
    if (permission === requiredPermission) {
      return true;
    }
  }
  
  return false;
}
```

---

### 3. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰æ¨©é™ãƒã‚§ãƒƒã‚¯

**Composable**: `/composables/usePermissions.ts`

```typescript
export const usePermissions = () => {
  const { user } = useSessionAuth();
  
  // æ¨©é™ä¸€è¦§ï¼ˆSessionã‹ã‚‰å–å¾—ï¼‰
  const permissions = computed(() => user.value?.permissions || []);
  
  // æ¨©é™ãƒã‚§ãƒƒã‚¯é–¢æ•°
  const hasPermission = (requiredPermission: string): boolean => {
    for (const permission of permissions.value) {
      if (permission === '*:*:*') {
        return true;
      }
      
      const [system, resource, action] = permission.split(':');
      const [reqSystem, reqResource, reqAction] = requiredPermission.split(':');
      
      // ãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰å±•é–‹
      if (system === reqSystem && resource === '*' && action === '*') {
        return true;
      }
      
      if (system === reqSystem && resource === reqResource && action === '*') {
        return true;
      }
      
      // å®Œå…¨ä¸€è‡´
      if (permission === requiredPermission) {
        return true;
      }
    }
    
    return false;
  };
  
  // è¤‡æ•°æ¨©é™ãƒã‚§ãƒƒã‚¯ï¼ˆORæ¡ä»¶ï¼‰
  const hasAnyPermission = (requiredPermissions: string[]): boolean => {
    return requiredPermissions.some(perm => hasPermission(perm));
  };
  
  // è¤‡æ•°æ¨©é™ãƒã‚§ãƒƒã‚¯ï¼ˆANDæ¡ä»¶ï¼‰
  const hasAllPermissions = (requiredPermissions: string[]): boolean => {
    return requiredPermissions.every(perm => hasPermission(perm));
  };
  
  return {
    permissions,
    hasPermission,
    hasAnyPermission,
    hasAllPermissions
  };
};
```

**ä½¿ç”¨ä¾‹**:
```vue
<template>
  <div>
    <!-- è¿”é‡‘ãƒœã‚¿ãƒ³: æ¨©é™ãŒã‚ã‚Œã°è¡¨ç¤º -->
    <UButton 
      v-if="hasPermission('hotel-pms:billing:refund')"
      @click="refundBilling"
    >
      è¿”é‡‘å‡¦ç†
    </UButton>
    
    <!-- è¨­å®šã‚¿ãƒ–: è¤‡æ•°æ¨©é™ã®ã„ãšã‚Œã‹ãŒã‚ã‚Œã°è¡¨ç¤º -->
    <UTabs v-if="hasAnyPermission(['system:settings:view', 'system:staff:manage'])">
      <UTab name="settings">è¨­å®š</UTab>
    </UTabs>
  </div>
</template>

<script setup lang="ts">
const { hasPermission, hasAnyPermission } = usePermissions();
</script>
```

---

## ğŸ¨ æ¥­æ…‹åˆ¥ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ

### 1. ãƒ›ãƒ†ãƒ«ï¼ˆãƒ“ã‚¸ãƒã‚¹ãƒ›ãƒ†ãƒ«ï¼‰

**ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆID**: `template-hotel`

**roles_definition**:
```json
{
  "roles": [
    {
      "name": "æ”¯é…äºº",
      "description": "ãƒ›ãƒ†ãƒ«å…¨ä½“ã®ç®¡ç†è²¬ä»»è€…",
      "sortOrder": 100,
      "permissions": [
        "hotel-saas:order:view",
        "hotel-saas:order:create",
        "hotel-saas:order:update",
        "hotel-saas:order:delete",
        "hotel-saas:menu:view",
        "hotel-saas:menu:create",
        "hotel-saas:menu:update",
        "hotel-saas:menu:delete",
        "hotel-saas:ai:use",
        "system:staff:view",
        "system:staff:create",
        "system:staff:update",
        "system:staff:delete",
        "system:roles:view",
        "system:roles:create",
        "system:roles:update",
        "system:roles:delete",
        "system:settings:view",
        "system:settings:update",
        "system:logs:view"
      ]
    },
    {
      "name": "ãƒ•ãƒ­ãƒ³ãƒˆä¸»ä»»",
      "description": "ãƒ•ãƒ­ãƒ³ãƒˆæ¥­å‹™å…¨èˆ¬ã®ç®¡ç†",
      "sortOrder": 90,
      "permissions": [
        "hotel-pms:reservation:*",
        "hotel-pms:checkin:*",
        "hotel-pms:checkout:*",
        "hotel-pms:billing:view",
        "hotel-pms:billing:create",
        "hotel-saas:order:view",
        "hotel-saas:menu:view",
        "system:staff:view"
      ]
    },
    {
      "name": "ãƒ•ãƒ­ãƒ³ãƒˆã‚¹ã‚¿ãƒƒãƒ•",
      "description": "åŸºæœ¬çš„ãªãƒ•ãƒ­ãƒ³ãƒˆæ¥­å‹™",
      "sortOrder": 80,
      "permissions": [
        "hotel-pms:reservation:view",
        "hotel-pms:reservation:create",
        "hotel-pms:checkin:execute",
        "hotel-pms:checkout:execute",
        "hotel-pms:billing:view",
        "hotel-saas:order:view"
      ]
    },
    {
      "name": "æ¸…æƒã‚¹ã‚¿ãƒƒãƒ•",
      "description": "å®¢å®¤æ¸…æƒæ¥­å‹™",
      "sortOrder": 70,
      "permissions": [
        "hotel-pms:room:view",
        "hotel-pms:room:status-update"
      ]
    },
    {
      "name": "ã‚­ãƒƒãƒãƒ³ã‚¹ã‚¿ãƒƒãƒ•",
      "description": "å¨æˆ¿æ¥­å‹™",
      "sortOrder": 60,
      "permissions": [
        "hotel-saas:order:view",
        "hotel-saas:order:update-status"
      ]
    }
  ]
}
```

---

### 2. æ—…é¤¨

**ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆID**: `template-ryokan`

**roles_definition**:
```json
{
  "roles": [
    {
      "name": "å¥³å°†",
      "description": "æ—…é¤¨å…¨ä½“ã®ç®¡ç†è²¬ä»»è€…",
      "sortOrder": 100,
      "permissions": [
        "hotel-saas:order:view",
        "hotel-saas:order:create",
        "hotel-saas:order:update",
        "hotel-saas:order:delete",
        "hotel-saas:menu:view",
        "hotel-saas:menu:create",
        "hotel-saas:menu:update",
        "hotel-saas:menu:delete",
        "hotel-saas:ai:use",
        "system:staff:view",
        "system:staff:create",
        "system:staff:update",
        "system:staff:delete",
        "system:roles:view",
        "system:roles:create",
        "system:roles:update",
        "system:roles:delete",
        "system:settings:view",
        "system:settings:update",
        "system:logs:view"
      ]
    },
    {
      "name": "ç•ªé ­",
      "description": "ãƒ•ãƒ­ãƒ³ãƒˆãƒ»äºˆç´„æ¥­å‹™ã®ç®¡ç†",
      "sortOrder": 90,
      "permissions": [
        "hotel-pms:reservation:*",
        "hotel-pms:checkin:*",
        "hotel-pms:checkout:*",
        "hotel-pms:billing:*",
        "hotel-saas:order:view",
        "system:staff:view"
      ]
    },
    {
      "name": "ä»²å±…",
      "description": "å®¢å®¤ã‚µãƒ¼ãƒ“ã‚¹æ¥­å‹™",
      "sortOrder": 80,
      "permissions": [
        "hotel-pms:reservation:view",
        "hotel-pms:room:view",
        "hotel-saas:order:view",
        "hotel-saas:order:create"
      ]
    },
    {
      "name": "æ¿å‰",
      "description": "æ–™ç†æ¥­å‹™",
      "sortOrder": 70,
      "permissions": [
        "hotel-saas:menu:view",
        "hotel-saas:order:view",
        "hotel-saas:order:update-status"
      ]
    },
    {
      "name": "æ¸…æƒä¿‚",
      "description": "å®¢å®¤æ¸…æƒæ¥­å‹™",
      "sortOrder": 60,
      "permissions": [
        "hotel-pms:room:view",
        "hotel-pms:room:status-update"
      ]
    }
  ]
}
```

---

### 3. ã‚¹ãƒ¼ãƒ‘ãƒ¼ã‚¢ãƒ‰ãƒŸãƒ³ã«ã‚ˆã‚‹ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç®¡ç†

**ãƒ‘ã‚¹**: `/pages/super-admin/role-templates/index.vue`

**æ©Ÿèƒ½**:
- âœ… æ—¢å­˜ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®ç·¨é›†
- âœ… æ–°è¦ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®ä½œæˆ
- âœ… ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
- âœ… ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®æœ‰åŠ¹åŒ–/ç„¡åŠ¹åŒ–

**API**:
- `GET /api/v1/super-admin/role-templates`
- `GET /api/v1/super-admin/role-templates/:id`
- `POST /api/v1/super-admin/role-templates`
- `PUT /api/v1/super-admin/role-templates/:id`
- `DELETE /api/v1/super-admin/role-templates/:id`

---

## ğŸ¢ ã‚°ãƒ«ãƒ¼ãƒ—ãƒ»ãƒ–ãƒ©ãƒ³ãƒ‰é€£æº

### 1. éšå±¤æ§‹é€ 

**å‚ç…§**: [SSOT_SAAS_MULTITENANT.md](../00_foundation/SSOT_SAAS_MULTITENANT.md)

```
Level 1: GROUPï¼ˆã‚°ãƒ«ãƒ¼ãƒ—ä¼æ¥­å…¨ä½“ï¼‰
         â†“
Level 2: BRANDï¼ˆãƒ–ãƒ©ãƒ³ãƒ‰ãƒ»äº‹æ¥­ãƒ©ã‚¤ãƒ³ï¼‰  â† ãƒã‚§ãƒ¼ãƒ³
         â†“
Level 3: HOTELï¼ˆå€‹åˆ¥åº—èˆ—ï¼‰
         â†“
Level 4: DEPARTMENTï¼ˆéƒ¨é–€ï¼‰
```

---

### 2. ãƒ–ãƒ©ãƒ³ãƒ‰ï¼ˆãƒã‚§ãƒ¼ãƒ³ï¼‰å†…ã§ã®å½¹è·ã‚³ãƒ”ãƒ¼

**åˆ¶ç´„**:
- âœ… åŒã˜BRANDï¼ˆLevel 2ï¼‰é…ä¸‹ã®HOTELé–“ã§ã®ã¿ã‚³ãƒ”ãƒ¼å¯èƒ½
- âŒ ç•°ãªã‚‹BRANDé–“ã§ã¯ã‚³ãƒ”ãƒ¼ä¸å¯

**æ¤œè¨¼ãƒ­ã‚¸ãƒƒã‚¯**:
```typescript
// åŒä¸€ãƒ–ãƒ©ãƒ³ãƒ‰ï¼ˆãƒã‚§ãƒ¼ãƒ³ï¼‰ç¢ºèª
async function isSameBrand(tenantId1: string, tenantId2: string): Promise<boolean> {
  const org1 = await prisma.organizationHierarchy.findFirst({
    where: {
      level: 3,  // HOTEL
      path: { contains: tenantId1 }
    }
  });
  
  const org2 = await prisma.organizationHierarchy.findFirst({
    where: {
      level: 3,  // HOTEL
      path: { contains: tenantId2 }
    }
  });
  
  // è¦ªBRAND IDãŒåŒã˜ã‹ç¢ºèª
  return org1.parentId === org2.parentId;
}
```

---

## ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

### 1. æ¨©é™ãƒã‚§ãƒƒã‚¯ã®å®Ÿè£…å¿…é ˆç®‡æ‰€

**ã™ã¹ã¦ã®APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**:
- âœ… ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã§ã®èªè¨¼ãƒã‚§ãƒƒã‚¯
- âœ… ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã”ã¨ã®æ¨©é™ãƒã‚§ãƒƒã‚¯
- âœ… ãƒ†ãƒŠãƒ³ãƒˆåˆ†é›¢ï¼ˆ`tenant_id`ãƒ•ã‚£ãƒ«ã‚¿ï¼‰

**UIãƒ¬ãƒ™ãƒ«**:
- âœ… ãƒœã‚¿ãƒ³ãƒ»ãƒªãƒ³ã‚¯ã®è¡¨ç¤º/éè¡¨ç¤º
- âœ… ã‚¿ãƒ–ãƒ»ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®è¡¨ç¤º/éè¡¨ç¤º
- âœ… ç·¨é›†ä¸å¯ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ç„¡åŠ¹åŒ–

---

### 2. æ¨©é™ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥

**Redisã‚­ãƒ£ãƒƒã‚·ãƒ¥**:
- **ã‚­ãƒ¼**: `permissions:{userId}:{tenantId}`
- **TTL**: 300ç§’ï¼ˆ5åˆ†ï¼‰
- **æ›´æ–°ã‚¿ã‚¤ãƒŸãƒ³ã‚°**: å½¹è·å¤‰æ›´æ™‚ã€æ¨©é™å¤‰æ›´æ™‚

**ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç„¡åŠ¹åŒ–**:
```typescript
// å½¹è·æ›´æ–°æ™‚
async function updateRole(roleId: string, data: UpdateRoleData) {
  // 1. å½¹è·æ›´æ–°
  await prisma.role.update({ ... });
  
  // 2. ã“ã®å½¹è·ã‚’æŒã¤å…¨ã‚¹ã‚¿ãƒƒãƒ•ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢
  const memberships = await prisma.staffTenantMembership.findMany({
    where: { roleId }
  });
  
  for (const membership of memberships) {
    await redis.del(`permissions:${membership.staffId}:${membership.tenantId}`);
  }
}
```

---

### 3. ç›£æŸ»ãƒ­ã‚°

**è¨˜éŒ²å¯¾è±¡**:
- âœ… å½¹è·ã®ä½œæˆãƒ»ç·¨é›†ãƒ»å‰Šé™¤
- âœ… æ¨©é™ã®å¤‰æ›´
- âœ… ã‚¹ã‚¿ãƒƒãƒ•ã¸ã®å½¹è·å‰²ã‚Šå½“ã¦å¤‰æ›´
- âœ… å½¹è·ã‚³ãƒ”ãƒ¼

**ãƒ­ã‚°ãƒ†ãƒ¼ãƒ–ãƒ«**: `audit_logs`ï¼ˆæ—¢å­˜ï¼‰

**å®Ÿè£…ä¾‹**:
```typescript
await prisma.auditLog.create({
  data: {
    tenantId,
    userId: session.userId,
    action: 'ROLE_UPDATED',
    resource: 'roles',
    resourceId: roleId,
    details: {
      roleName: role.name,
      changes: {
        permissions: {
          added: ['hotel-pms:billing:refund'],
          removed: ['hotel-pms:billing:delete']
        }
      }
    },
    ipAddress: req.ip,
    userAgent: req.headers['user-agent']
  }
});
```

---

## ğŸ”„ ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ‰‹é †

### æ¦‚è¦

æ—¢å­˜ã®`staff_tenant_memberships`ãƒ†ãƒ¼ãƒ–ãƒ«ã®`role`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆæ–‡å­—åˆ—ï¼‰ã‚’ã€æ–°ã—ã„`roles`ãƒ†ãƒ¼ãƒ–ãƒ«ã¸ã®å¤–éƒ¨ã‚­ãƒ¼`role_id`ã«ç§»è¡Œã—ã¾ã™ã€‚

**é‡è¦**: ã“ã®ç§»è¡Œã¯**ãƒ‡ãƒ¼ã‚¿ãƒ­ã‚¹ç„¡ã—**ã§å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚

---

### Phase 1: æ–°è¦ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ

**å®Ÿè¡Œé †åº**: `permissions` â†’ `roles` â†’ `role_permissions` â†’ `role_templates`

```sql
-- 1. permissionsãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
CREATE TABLE permissions (
  id              TEXT PRIMARY KEY,
  code            TEXT NOT NULL UNIQUE,
  name            TEXT NOT NULL,
  description     TEXT,
  category        TEXT NOT NULL,
  is_active       BOOLEAN DEFAULT true,
  created_at      TIMESTAMP DEFAULT NOW(),
  updated_at      TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_permissions_code ON permissions(code);
CREATE INDEX idx_permissions_category ON permissions(category);
CREATE INDEX idx_permissions_is_active ON permissions(is_active);

-- 2. rolesãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
CREATE TABLE roles (
  id              TEXT PRIMARY KEY,
  tenant_id       TEXT NOT NULL,
  name            TEXT NOT NULL,
  description     TEXT,
  sort_order      INTEGER DEFAULT 0,
  is_active       BOOLEAN DEFAULT true,
  is_default      BOOLEAN DEFAULT false,
  created_at      TIMESTAMP DEFAULT NOW(),
  updated_at      TIMESTAMP DEFAULT NOW(),
  created_by      TEXT,
  updated_by      TEXT,
  CONSTRAINT fk_roles_tenant FOREIGN KEY (tenant_id) REFERENCES tenants(id) ON DELETE CASCADE,
  CONSTRAINT unq_roles_tenant_id_name UNIQUE (tenant_id, name)
);

CREATE INDEX idx_roles_tenant_id ON roles(tenant_id);
CREATE INDEX idx_roles_is_active ON roles(is_active);
CREATE INDEX idx_roles_is_default ON roles(is_default);
CREATE INDEX idx_roles_sort_order ON roles(sort_order DESC);

-- 3. role_permissionsãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
CREATE TABLE role_permissions (
  id              TEXT PRIMARY KEY,
  role_id         TEXT NOT NULL,
  permission_id   TEXT NOT NULL,
  created_at      TIMESTAMP DEFAULT NOW(),
  created_by      TEXT,
  CONSTRAINT fk_role_permissions_role FOREIGN KEY (role_id) REFERENCES roles(id) ON DELETE CASCADE,
  CONSTRAINT fk_role_permissions_permission FOREIGN KEY (permission_id) REFERENCES permissions(id) ON DELETE CASCADE,
  CONSTRAINT unq_role_permissions UNIQUE (role_id, permission_id)
);

CREATE INDEX idx_role_permissions_role_id ON role_permissions(role_id);
CREATE INDEX idx_role_permissions_permission_id ON role_permissions(permission_id);

-- 4. role_templatesãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
CREATE TABLE role_templates (
  id              TEXT PRIMARY KEY,
  business_type   TEXT NOT NULL,
  name            TEXT NOT NULL,
  description     TEXT,
  roles_definition JSONB NOT NULL,
  is_active       BOOLEAN DEFAULT true,
  is_system       BOOLEAN DEFAULT false,
  created_at      TIMESTAMP DEFAULT NOW(),
  updated_at      TIMESTAMP DEFAULT NOW(),
  created_by      TEXT,
  updated_by      TEXT,
  CONSTRAINT unq_role_templates_business_type_name UNIQUE (business_type, name)
);

CREATE INDEX idx_role_templates_business_type ON role_templates(business_type);
CREATE INDEX idx_role_templates_is_active ON role_templates(is_active);
CREATE INDEX idx_role_templates_is_system ON role_templates(is_system);
```

---

### Phase 2: ã‚·ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿æŠ•å…¥

**å®Ÿè¡Œ**: `/Users/kaneko/hotel-common/prisma/seeds/`

```bash
# 1. æ¨©é™ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’æŠ•å…¥
npx prisma db seed -- --only permissions

# 2. ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’æŠ•å…¥
npx prisma db seed -- --only role-templates
```

**ã‚·ãƒ¼ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ**:
- `permissions.seed.ts`: ã‚·ã‚¹ãƒ†ãƒ æ¨©é™ä¸€è¦§ï¼ˆç´„100ä»¶ï¼‰
- `role-templates.seed.ts`: æ¥­æ…‹åˆ¥ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼ˆãƒ›ãƒ†ãƒ«ã€æ—…é¤¨ï¼‰

---

### Phase 3: æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ç§»è¡Œ

#### ã‚¹ãƒ†ãƒƒãƒ—1: æ—¢å­˜roleã‹ã‚‰rolesãƒ†ãƒ¼ãƒ–ãƒ«ã¸ã®ç§»è¡Œ

```sql
-- æ—¢å­˜ã®roleæ–‡å­—åˆ—ã‚’æŠ½å‡ºã—ã€rolesãƒ†ãƒ¼ãƒ–ãƒ«ã«ç™»éŒ²
INSERT INTO roles (id, tenant_id, name, description, sort_order, is_active, created_at)
SELECT 
  gen_random_uuid() AS id,
  tenant_id,
  role AS name,
  CASE role
    WHEN 'OWNER' THEN 'ã‚ªãƒ¼ãƒŠãƒ¼'
    WHEN 'ADMIN' THEN 'ç®¡ç†è€…'
    WHEN 'MANAGER' THEN 'ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼'
    WHEN 'STAFF' THEN 'ã‚¹ã‚¿ãƒƒãƒ•'
    WHEN 'READONLY' THEN 'é–²è¦§ã®ã¿'
    ELSE role
  END AS description,
  CASE role
    WHEN 'OWNER' THEN 100
    WHEN 'ADMIN' THEN 90
    WHEN 'MANAGER' THEN 80
    WHEN 'STAFF' THEN 70
    WHEN 'READONLY' THEN 60
    ELSE 50
  END AS sort_order,
  true AS is_active,
  NOW() AS created_at
FROM (
  SELECT DISTINCT tenant_id, role
  FROM staff_tenant_memberships
  WHERE role IS NOT NULL AND role != ''
) AS distinct_roles
ON CONFLICT (tenant_id, name) DO NOTHING;
```

**ç¢ºèª**:
```sql
-- rolesãƒ†ãƒ¼ãƒ–ãƒ«ã®ãƒ¬ã‚³ãƒ¼ãƒ‰æ•°ã‚’ç¢ºèª
SELECT COUNT(*) FROM roles;

-- ãƒ†ãƒŠãƒ³ãƒˆåˆ¥å½¹è·æ•°ã‚’ç¢ºèª
SELECT tenant_id, COUNT(*) AS role_count
FROM roles
GROUP BY tenant_id
ORDER BY role_count DESC;
```

---

#### ã‚¹ãƒ†ãƒƒãƒ—2: staff_tenant_membershipsã«role_idã‚«ãƒ©ãƒ è¿½åŠ 

```sql
-- 1. role_idã‚«ãƒ©ãƒ ã‚’è¿½åŠ ï¼ˆNULLè¨±å¯ï¼‰
ALTER TABLE staff_tenant_memberships 
ADD COLUMN role_id TEXT;

-- 2. role_idã‚’è¨­å®š
UPDATE staff_tenant_memberships m
SET role_id = r.id
FROM roles r
WHERE m.tenant_id = r.tenant_id 
  AND m.role = r.name;

-- 3. ç¢ºèª: role_idãŒè¨­å®šã•ã‚Œã¦ã„ãªã„ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯
SELECT id, staff_id, tenant_id, role
FROM staff_tenant_memberships
WHERE role_id IS NULL;

-- æœŸå¾…: 0ä»¶ï¼ˆå…¨ã¦ã®roleãŒrolesãƒ†ãƒ¼ãƒ–ãƒ«ã«å­˜åœ¨ã™ã‚‹ã¯ãšï¼‰
```

**ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°**:
```sql
-- ã‚‚ã—role_idæœªè¨­å®šã®ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒã‚ã‚‹å ´åˆã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå½¹è·ã‚’ä½œæˆã—ã¦å‰²ã‚Šå½“ã¦
INSERT INTO roles (id, tenant_id, name, description, sort_order, is_active)
SELECT 
  gen_random_uuid(),
  m.tenant_id,
  m.role,
  'ãƒ‡ãƒ¼ã‚¿ç§»è¡Œæ™‚ã«ä½œæˆ',
  50,
  true
FROM staff_tenant_memberships m
WHERE m.role_id IS NULL
GROUP BY m.tenant_id, m.role
ON CONFLICT (tenant_id, name) DO NOTHING;

-- å†åº¦role_idã‚’è¨­å®š
UPDATE staff_tenant_memberships m
SET role_id = r.id
FROM roles r
WHERE m.tenant_id = r.tenant_id 
  AND m.role = r.name
  AND m.role_id IS NULL;
```

---

#### ã‚¹ãƒ†ãƒƒãƒ—3: custom_permissionsã‚«ãƒ©ãƒ è¿½åŠ 

```sql
-- æ—¢å­˜ã®permissionsã‚’custom_permissionsã«ç§»è¡Œ
ALTER TABLE staff_tenant_memberships 
ADD COLUMN custom_permissions JSONB DEFAULT '[]';

-- æ—¢å­˜ã®permissionsï¼ˆJSONBï¼‰ã‚’custom_permissionsã«ã‚³ãƒ”ãƒ¼
UPDATE staff_tenant_memberships
SET custom_permissions = COALESCE(permissions, '[]'::jsonb)
WHERE permissions IS NOT NULL;

-- ç¢ºèª
SELECT 
  id, 
  staff_id, 
  tenant_id, 
  role_id, 
  custom_permissions
FROM staff_tenant_memberships
LIMIT 10;
```

---

### Phase 4: åˆ¶ç´„è¿½åŠ ãƒ»æ—§ã‚«ãƒ©ãƒ å‰Šé™¤

```sql
-- 1. role_idã‚’NOT NULLã«å¤‰æ›´
ALTER TABLE staff_tenant_memberships 
ALTER COLUMN role_id SET NOT NULL;

-- 2. å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„ã‚’è¿½åŠ 
ALTER TABLE staff_tenant_memberships
ADD CONSTRAINT fk_membership_role 
FOREIGN KEY (role_id) REFERENCES roles(id) ON DELETE RESTRICT;

-- 3. ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¿½åŠ 
CREATE INDEX idx_memberships_role_id ON staff_tenant_memberships(role_id);

-- 4. æ—§ã‚«ãƒ©ãƒ ã‚’å‰Šé™¤ï¼ˆãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å¾Œï¼‰
-- âš ï¸ æœ¬ç•ªç’°å¢ƒã§ã¯ã€ã¾ãšãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’å–å¾—ã—ã¦ã‹ã‚‰å®Ÿè¡Œ
ALTER TABLE staff_tenant_memberships DROP COLUMN role;
ALTER TABLE staff_tenant_memberships DROP COLUMN permissions;
ALTER TABLE staff_tenant_memberships DROP COLUMN level;
```

**æ³¨æ„**: æ—§ã‚«ãƒ©ãƒ å‰Šé™¤å‰ã«ã€å¿…ãšãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’å–å¾—ã—ã¦ãã ã•ã„:
```bash
pg_dump -h localhost -U postgres -d hotel_unified_db \
  -t staff_tenant_memberships \
  > backup_staff_tenant_memberships_$(date +%Y%m%d_%H%M%S).sql
```

---

### Phase 5: Prismaã‚¹ã‚­ãƒ¼ãƒæ›´æ–°ãƒ»ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

```bash
# 1. Prismaã‚¹ã‚­ãƒ¼ãƒã‚’æ›´æ–°
# /Users/kaneko/hotel-common/prisma/schema.prisma

# 2. ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ä½œæˆ
npx prisma migrate dev --name add_permission_system

# 3. Prisma Clientã‚’å†ç”Ÿæˆ
npx prisma generate
```

---

### Phase 6: å‹•ä½œç¢ºèª

#### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹1: ãƒ­ã‚°ã‚¤ãƒ³èªè¨¼

```bash
# ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦æ¨©é™ãŒæ­£ã—ãå–å¾—ã•ã‚Œã‚‹ã‹ç¢ºèª
curl -X POST http://localhost:3400/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"test@example.com","password":"password"}' \
  -c cookies.txt

# ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã‚’ç¢ºèª
curl http://localhost:3400/api/v1/auth/me \
  -b cookies.txt | jq '.data.permissions'
```

**æœŸå¾…çµæœ**: æ¨©é™ã‚³ãƒ¼ãƒ‰é…åˆ—ãŒè¿”å´ã•ã‚Œã‚‹

---

#### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹2: å½¹è·ä¸€è¦§å–å¾—

```sql
-- ãƒ†ãƒŠãƒ³ãƒˆåˆ¥å½¹è·ä¸€è¦§
SELECT 
  r.id,
  r.tenant_id,
  r.name,
  r.sort_order,
  COUNT(DISTINCT rp.permission_id) AS permission_count,
  COUNT(DISTINCT stm.staff_id) AS assigned_staff_count
FROM roles r
LEFT JOIN role_permissions rp ON r.id = rp.role_id
LEFT JOIN staff_tenant_memberships stm ON r.id = stm.role_id
WHERE r.tenant_id = 'hotel-a'
GROUP BY r.id
ORDER BY r.sort_order DESC;
```

---

#### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹3: æ¨©é™ãƒã‚§ãƒƒã‚¯

```typescript
// ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰æ¨©é™ãƒã‚§ãƒƒã‚¯
const hasPermission = await checkPermission(event, 'hotel-pms:billing:refund');
console.log('Has refund permission:', hasPermission);

// æœŸå¾…: å½¹è·ã®æ¨©é™ã«åŸºã¥ã„ã¦true/falseãŒè¿”ã‚‹
```

---

### ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ‰‹é †

ä¸‡ãŒä¸€å•é¡ŒãŒç™ºç”Ÿã—ãŸå ´åˆã®ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯:

```sql
-- 1. å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„ã‚’å‰Šé™¤
ALTER TABLE staff_tenant_memberships DROP CONSTRAINT IF EXISTS fk_membership_role;

-- 2. role_idã‚«ãƒ©ãƒ ã‚’å‰Šé™¤
ALTER TABLE staff_tenant_memberships DROP COLUMN IF EXISTS role_id;
ALTER TABLE staff_tenant_memberships DROP COLUMN IF EXISTS custom_permissions;

-- 3. æ–°è¦ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å‰Šé™¤ï¼ˆCASCADEï¼‰
DROP TABLE IF EXISTS role_permissions CASCADE;
DROP TABLE IF EXISTS roles CASCADE;
DROP TABLE IF EXISTS role_templates CASCADE;
DROP TABLE IF EXISTS permissions CASCADE;

-- 4. ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰å¾©å…ƒ
psql -h localhost -U postgres -d hotel_unified_db \
  < backup_staff_tenant_memberships_YYYYMMDD_HHMMSS.sql
```

---

### ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

#### äº‹å‰æº–å‚™
- [ ] ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ãƒ•ãƒ«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å–å¾—
- [ ] `staff_tenant_memberships`ãƒ†ãƒ¼ãƒ–ãƒ«ã®å€‹åˆ¥ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å–å¾—
- [ ] ãƒ†ã‚¹ãƒˆç’°å¢ƒã§å®Œå…¨ãªãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆå®Œäº†
- [ ] ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ‰‹é †ã®ç¢ºèªãƒ»æ¤œè¨¼

#### Phase 1: æ–°è¦ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
- [ ] `permissions`ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
- [ ] `roles`ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
- [ ] `role_permissions`ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
- [ ] `role_templates`ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
- [ ] ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½œæˆç¢ºèª

#### Phase 2: ã‚·ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿æŠ•å…¥
- [ ] æ¨©é™ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿æŠ•å…¥
- [ ] ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæŠ•å…¥
- [ ] ã‚·ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ç¢ºèªï¼ˆä»¶æ•°ãƒã‚§ãƒƒã‚¯ï¼‰

#### Phase 3: æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ç§»è¡Œ
- [ ] æ—¢å­˜roleã‹ã‚‰rolesãƒ†ãƒ¼ãƒ–ãƒ«ã¸ã®ç§»è¡Œ
- [ ] role_idã‚«ãƒ©ãƒ è¿½åŠ 
- [ ] role_idè¨­å®š
- [ ] role_idæœªè¨­å®šãƒ¬ã‚³ãƒ¼ãƒ‰ã®ç¢ºèªï¼ˆ0ä»¶ï¼‰
- [ ] custom_permissionsã‚«ãƒ©ãƒ è¿½åŠ 
- [ ] æ—¢å­˜permissionsç§»è¡Œ

#### Phase 4: åˆ¶ç´„è¿½åŠ 
- [ ] role_id NOT NULLåˆ¶ç´„è¿½åŠ 
- [ ] å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„è¿½åŠ 
- [ ] ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¿½åŠ 
- [ ] æ—§ã‚«ãƒ©ãƒ å‰Šé™¤ï¼ˆrole, permissions, levelï¼‰

#### Phase 5: Prismaæ›´æ–°
- [ ] Prismaã‚¹ã‚­ãƒ¼ãƒæ›´æ–°
- [ ] ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ä½œæˆ
- [ ] Prisma Clientå†ç”Ÿæˆ

#### Phase 6: å‹•ä½œç¢ºèª
- [ ] ãƒ­ã‚°ã‚¤ãƒ³èªè¨¼ãƒ†ã‚¹ãƒˆ
- [ ] å½¹è·ä¸€è¦§å–å¾—ãƒ†ã‚¹ãƒˆ
- [ ] æ¨©é™ãƒã‚§ãƒƒã‚¯ãƒ†ã‚¹ãƒˆ
- [ ] å…¨ã‚·ã‚¹ãƒ†ãƒ ã®å‹•ä½œç¢ºèª

#### æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤
- [ ] ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ãƒ¢ãƒ¼ãƒ‰è¨­å®š
- [ ] ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
- [ ] å‹•ä½œç¢ºèª
- [ ] ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ãƒ¢ãƒ¼ãƒ‰è§£é™¤
- [ ] ç›£è¦–é–‹å§‹

---

## âœ… å®Ÿè£…ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹

- [ ] `roles`ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
- [ ] `permissions`ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
- [ ] `role_permissions`ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
- [ ] `role_templates`ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
- [ ] `staff_tenant_memberships`ãƒ†ãƒ¼ãƒ–ãƒ«æ›´æ–°ï¼ˆ`role_id`è¿½åŠ ï¼‰
- [ ] ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½œæˆ
- [ ] å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„ä½œæˆ
- [ ] ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
- [ ] ã‚·ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿æŠ•å…¥

---

### APIå®Ÿè£…ï¼ˆhotel-commonï¼‰

- [ ] `GET /api/v1/admin/roles`
- [ ] `GET /api/v1/admin/roles/:id`
- [ ] `POST /api/v1/admin/roles`
- [ ] `PUT /api/v1/admin/roles/:id`
- [ ] `DELETE /api/v1/admin/roles/:id`
- [ ] `GET /api/v1/admin/permissions`
- [ ] `GET /api/v1/admin/permissions/grouped`
- [ ] `POST /api/v1/admin/roles/copy`
- [ ] `GET /api/v1/admin/role-templates`
- [ ] `POST /api/v1/admin/roles/apply-template`
- [ ] `PUT /api/v1/admin/staff/:staffId/role`
- [ ] `GET /api/v1/admin/organization/same-brand-tenants`

---

### APIå®Ÿè£…ï¼ˆhotel-saasï¼‰

- [ ] å…¨hotel-commonã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¸ã®ãƒ—ãƒ­ã‚­ã‚·APIä½œæˆ
- [ ] Sessionèªè¨¼é€£æºï¼ˆCookieè»¢é€ï¼‰

---

### ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å®Ÿè£…

- [ ] `/pages/admin/settings/roles/index.vue`ï¼ˆå½¹è·ä¸€è¦§ï¼‰
- [ ] `/pages/admin/settings/roles/[id]/permissions.vue`ï¼ˆæ¨©é™ãƒãƒƒãƒ”ãƒ³ã‚°ï¼‰
- [ ] `/pages/admin/settings/roles/create.vue`ï¼ˆå½¹è·ä½œæˆï¼‰
- [ ] `/components/RolePermissionMatrix.vue`ï¼ˆæ¨©é™ãƒãƒˆãƒªãƒƒã‚¯ã‚¹ï¼‰
- [ ] `/components/RoleCopyModal.vue`ï¼ˆå½¹è·ã‚³ãƒ”ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼‰
- [ ] `/composables/usePermissions.ts`ï¼ˆæ¨©é™ãƒã‚§ãƒƒã‚¯ï¼‰

---

### ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ãƒ»ãƒ˜ãƒ«ãƒ‘ãƒ¼

- [ ] `/server/middleware/permission-check.ts`ï¼ˆæ¨©é™ãƒã‚§ãƒƒã‚¯ï¼‰
- [ ] `/server/utils/permission-helpers.ts`ï¼ˆãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ï¼‰
- [ ] Redisã‚­ãƒ£ãƒƒã‚·ãƒ¥å®Ÿè£…

---

### ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‡ãƒ¼ã‚¿

- [ ] ã‚·ã‚¹ãƒ†ãƒ æ¨©é™ä¸€è¦§ï¼ˆ`permissions`ãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰ã®ã‚·ãƒ¼ãƒ‰
- [ ] ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼ˆ`role_templates`ãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰ã®ã‚·ãƒ¼ãƒ‰
  - [ ] ãƒ›ãƒ†ãƒ«ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
  - [ ] æ—…é¤¨ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ

---

### ãƒ†ã‚¹ãƒˆ

- [ ] å½¹è·CRUD APIãƒ†ã‚¹ãƒˆ
- [ ] æ¨©é™ãƒã‚§ãƒƒã‚¯ãƒ­ã‚¸ãƒƒã‚¯ãƒ†ã‚¹ãƒˆ
- [ ] ãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰å±•é–‹ãƒ†ã‚¹ãƒˆ
- [ ] ãƒ–ãƒ©ãƒ³ãƒ‰ï¼ˆãƒã‚§ãƒ¼ãƒ³ï¼‰å†…ã‚³ãƒ”ãƒ¼åˆ¶ç´„ãƒ†ã‚¹ãƒˆ
- [ ] ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç„¡åŠ¹åŒ–ãƒ†ã‚¹ãƒˆ

---

## ğŸ“ å¤‰æ›´å±¥æ­´

| ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | æ—¥ä»˜ | å¤‰æ›´å†…å®¹ | æ‹…å½“è€… |
|-----------|------|---------|--------|
| 1.0.0 | 2025-10-08 | åˆç‰ˆä½œæˆ<br>- ãƒ¬ãƒ™ãƒ«æ¦‚å¿µã®å»ƒæ­¢<br>- å½¹è·ãƒ™ãƒ¼ã‚¹æ¨©é™ç®¡ç†<br>- æ¥­æ…‹åˆ¥ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼ˆãƒ›ãƒ†ãƒ«ã€æ—…é¤¨ï¼‰<br>- ãƒ–ãƒ©ãƒ³ãƒ‰ï¼ˆãƒã‚§ãƒ¼ãƒ³ï¼‰é–“å½¹è·ã‚³ãƒ”ãƒ¼<br>- ã‚¹ãƒ¼ãƒ‘ãƒ¼ã‚¢ãƒ‰ãƒŸãƒ³ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç®¡ç†<br>- æŸ”è»Ÿãªæ¨©é™ãƒãƒƒãƒ”ãƒ³ã‚°UI | Sun |
| 1.1.0 | 2025-10-08 | 120ç‚¹æ”¹å–„å¯¾å¿œ<br>- åŒä¸€ãƒ–ãƒ©ãƒ³ãƒ‰ãƒ†ãƒŠãƒ³ãƒˆå–å¾—APIä»•æ§˜è¿½åŠ <br>- æ¨©é™ã‚³ãƒ¼ãƒ‰å®Œå…¨ä¸€è¦§è¿½åŠ ï¼ˆç´„100ä»¶ã®è©³ç´°å®šç¾©ï¼‰<br>- è©³ç´°ãªãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ‰‹é †è¿½åŠ ï¼ˆ6ãƒ•ã‚§ãƒ¼ã‚ºã€å®Œå…¨ãªSQLã€ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ‰‹é †ï¼‰ | Sun |
| 1.2.0 | 2025-10-15 | è¨­è¨ˆæ–¹é‡æ˜ç¢ºåŒ–<br>- å„ã‚·ã‚¹ãƒ†ãƒ ã®è²¬å‹™ã‚’æ˜è¨˜ï¼ˆhotel-saas: `hotel-saas`+`system`ã‚«ãƒ†ã‚´ãƒªç®¡ç†ï¼‰<br>- hotel-pmså®Ÿè£…æ™‚ã®æ³¨æ„äº‹é …è¿½åŠ <br>- ã‚¿ãƒ–æ§‹æˆã‚’ä¸è¦ã«å¤‰æ›´ï¼ˆå„ã‚·ã‚¹ãƒ†ãƒ ãŒè‡ªã‚«ãƒ†ã‚´ãƒªã®ã¿è¡¨ç¤ºï¼‰<br>- æ¨©é™ãƒãƒƒãƒ”ãƒ³ã‚°ç”»é¢ã®å…·ä½“ä¾‹è¿½åŠ ï¼ˆhotel-saas/hotel-pmsåˆ¥ï¼‰ | Common |
| 1.3.0 | 2025-10-16 | **UXæ”¹å–„: ãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰ + å…¨ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹è¡¨ç¤ºæ–¹å¼**<br>- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¯ãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰æ–¹å¼ã§åŠ¹ç‡åŒ–ï¼ˆ`*:*:*`ï¼‰<br>- UIä¸Šã¯å…¨ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹è¡¨ç¤ºã§è¦–è¦šçš„ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯<br>- é¸æŠé …ç›®ã®èƒŒæ™¯è‰²å¤‰æ›´ï¼ˆ`bg-blue-50`ï¼‰<br>- æœ€é©åŒ–ãƒ­ã‚¸ãƒƒã‚¯è¿½åŠ ï¼ˆ`optimizePermissions`é–¢æ•°ï¼‰<br>- ãƒã‚§ãƒƒã‚¯çŠ¶æ…‹åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯è¿½åŠ ï¼ˆ`isPermissionChecked`é–¢æ•°ï¼‰<br>- å®ŸåŠ¹æ¨©é™ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º<br>- ä¿å­˜æ™‚ã®è‡ªå‹•åœ§ç¸®ï¼ˆå…¨é¸æŠæ™‚â†’`*:*:*`ã€ã‚«ãƒ†ã‚´ãƒªå…¨é¸æŠæ™‚â†’`hotel-saas:*:*`ï¼‰ | Iza |
| 1.3.1 | 2025-10-16 | **ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—è¿½åŠ : æ··ä¹±é˜²æ­¢UXæ”¹å–„**<br>- ã€Œå…¨ã¦ã®æ¨©é™ã€ã¨ã€Œã‚·ã‚¹ãƒ†ãƒ å…¨æ¨©é™ã€ã®é•ã„ã‚’ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã§èª¬æ˜<br>- `*:*:*`ï¼ˆå…¨ã‚·ã‚¹ãƒ†ãƒ ï¼‰vs `system:*:*`ï¼ˆsystemã‚«ãƒ†ã‚´ãƒªã®ã¿ï¼‰ã‚’æ˜ç¢ºåŒ–<br>- å„ã‚«ãƒ†ã‚´ãƒªãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰ã®ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—å®Ÿè£…ä¾‹è¿½åŠ <br>- ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ãƒ‡ã‚¶ã‚¤ãƒ³ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³è¿½åŠ  | Iza |
| **2.0.0** | **2025-10-20** | **è¦ä»¶IDä½“ç³»é©ç”¨: å®Ÿè¡Œå¯èƒ½ãªå¥‘ç´„åŒ–** ğŸ‰<br>- è¦ä»¶IDä¸€è¦§è¿½åŠ ï¼ˆPERM-001ã€œPERM-UI-005ï¼‰<br>- **PERM-002: ãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰å…¨æ¨©é™** å®Œå…¨ä»•æ§˜åŒ–<br>  - Acceptï¼ˆåˆæ ¼æ¡ä»¶ï¼‰æ˜è¨˜<br>  - Test Casesè¿½åŠ ï¼ˆ4ã‚±ãƒ¼ã‚¹ï¼‰<br>  - Typeå®šç¾©è¿½åŠ ï¼ˆZod Schemaï¼‰<br>  - Implementationä¾‹è¿½åŠ <br>- **PERM-003: ãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰ã‚«ãƒ†ã‚´ãƒª** ä»•æ§˜åŒ–<br>- **PERM-004: ãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰ãƒªã‚½ãƒ¼ã‚¹** ä»•æ§˜åŒ–<br>- å…¨æ©Ÿèƒ½ã®è¦ä»¶IDä»˜ä¸<br>- ãƒ†ã‚¹ãƒˆã«ã‚ˆã‚‹å¥‘ç´„ã®å¼·åˆ¶<br>- å‹ã«ã‚ˆã‚‹å¥‘ç´„ã®å¼·åˆ¶ | Iza |
| **2.1.0** | **2025-10-20** | **ãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰å…¨å»ƒæ­¢: å€‹åˆ¥æ¨©é™ã®ã¿ã«çµ±ä¸€** âš ï¸<br>- **PERM-002, PERM-003, PERM-004 å»ƒæ­¢**<br>- ãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰ï¼ˆ`*:*:*`, `hotel-saas:*:*` ç­‰ï¼‰ä½¿ç”¨ä¸å¯<br>- å®Ÿè£…ãŒè¤‡é›‘ã§ãƒã‚°å¤šç™ºã®ãŸã‚å€‹åˆ¥æ¨©é™ã®ã¿ã«çµ±ä¸€<br>- æ¨©é™ãƒã‚§ãƒƒã‚¯ã‚’å˜ç´”åŒ–ï¼ˆé…åˆ—æ¤œç´¢ã®ã¿ï¼‰<br>- Zodãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã§ãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰ã‚’ç¦æ­¢<br>- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ›´æ–°ï¼ˆæ”¯é…äººãƒ»å¥³å°†ã¯å…¨å€‹åˆ¥æ¨©é™ã‚’åˆ—æŒ™ï¼‰<br>- ã‚·ãƒ³ãƒ—ãƒ«ã§ä¿å®ˆã—ã‚„ã™ã„å®Ÿè£…ã«å¤‰æ›´ | Iza |

---

**ğŸ”– ã“ã®SSOTã¯ã€æ—¢å­˜ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã€ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼è¦ä»¶ã‚’åŸºã«ä½œæˆã•ã‚Œã¦ã„ã¾ã™ã€‚**  
**æƒ³åƒã‚„æ¨æ¸¬ã«ã‚ˆã‚‹è¨˜è¼‰ã¯ä¸€åˆ‡å«ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚**

