# üé¨ ÂÆüË°å„Éà„É¨„Éº„ÇπÈßÜÂãïÂûãSSOT‰ΩúÊàêÊâãÊ≥ï

**‰ΩúÊàêÊó•**: 2025Âπ¥10Êúà2Êó•  
**ÊèêÊ°àËÄÖ**: „É¶„Éº„Ç∂„ÉºÔºàÈù©ÂëΩÁöÑ„Ç¢„Ç§„Éá„Ç¢Ôºâ  
**ÂàÜÊûêËÄÖ**: AI Assistant (Luna)  
**„Çπ„ÉÜ„Éº„Çø„Çπ**: ÊèêÊ°à„ÉªÊ§úË®º‰∏≠

---

## üéØ „Ç≥„É≥„Çª„Éó„Éà

### ÂæìÊù•„ÅÆÂïèÈ°åÁÇπ
**ÈùôÁöÑ„Å™„Ç≥„Éº„ÉâËß£Êûê„Å†„Åë„Åß„ÅØ‰∏çÂçÅÂàÜ**

```
‚ùå ÂæìÊù•„ÅÆÊâãÊ≥ï:
„Ç≥„Éº„Éâ„ÇíË™≠„ÇÄ
  ‚Üì
„Äå„Åü„Å∂„Çì„Åì„ÅÜÂãï„Åè„Äç„Å®Êé®Ê∏¨
  ‚Üì
SSOT„Å´Ë®òËºâ
  ‚Üì
ÂÆüÈöõ„Å´Âãï„Åã„Åô„Å®ÈÅï„ÅÜ
```

### Èù©ÂëΩÁöÑ„Å™Ëß£Ê±∫Á≠ñ
**„Éó„É≠„Ç∞„É©„É†„ÅÆÂÆüË°å„Çí„Éà„É¨„Éº„Çπ„Åó„Å¶SSOT„Çí‰ΩúÊàê**

```
‚úÖ ÂÆüË°å„Éà„É¨„Éº„ÇπÈßÜÂãï:
ÂÆüÈöõ„Å´„É≠„Ç∞„Ç§„É≥„ÇíÂÆüË°å
  ‚Üì
ÂÖ®„Å¶„ÅÆÂá¶ÁêÜ„Çí„Éà„É¨„Éº„Çπ
  ‚îú‚îÄ APIÂëº„Å≥Âá∫„Åó
  ‚îú‚îÄ Â§âÊï∞„ÅÆÂ§âÂåñ
  ‚îú‚îÄ CookieË®≠ÂÆö
  ‚îú‚îÄ „Çª„ÉÉ„Ç∑„Éß„É≥‰ΩúÊàê
  ‚îú‚îÄ DBÂïè„ÅÑÂêà„Çè„Åõ
  ‚îú‚îÄ „Ç∑„Çπ„ÉÜ„É†ÈñìÈÄ£Êê∫
  ‚îî‚îÄ Áä∂ÊÖãÂ§âÂåñ
  ‚Üì
„Éà„É¨„Éº„ÇπÁµêÊûú„ÇíSSOT„Å´Ë®òËºâ
  ‚Üì
ÂÆüÈöõ„ÅÆÂãï‰Ωú„Çí100%ÂèçÊò†
```

---

## üìä ‰Ωï„Çí„Éà„É¨„Éº„Çπ„Åô„Çã„Åã

### 1. APIÂëº„Å≥Âá∫„Åó„ÅÆÂÆåÂÖ®„Å™„ÉÅ„Çß„Éº„É≥
```
„Éñ„É©„Ç¶„Ç∂
  ‚Üì [1] POST /api/v1/auth/login
  ‚Üì   Body: { email: "admin@example.com", password: "****" }
  ‚Üì   Headers: { Content-Type: "application/json" }
hotel-saas (Nuxt3 API)
  ‚Üì [2] Middleware 01.admin-auth.ts „Çπ„Ç≠„ÉÉ„ÉóÔºà/login„ÅØÈô§Â§ñÔºâ
  ‚Üì [3] POST http://localhost:3400/api/v1/auth/login
  ‚Üì   Body: { email: "admin@example.com", password: "****", tenantId: "default" }
  ‚Üì   Headers: { Content-Type: "application/json" }
hotel-common (Express API)
  ‚Üì [4] auth.routes.ts:377 „É™„ÇØ„Ç®„Çπ„ÉàÂèó‰ø°
  ‚Üì [5] UnifiedSessionMiddleware.login() Âëº„Å≥Âá∫„Åó
  ‚Üì   Args: email="admin@example.com", password="****", tenantId="default"
  ‚Üì [6] SessionAuthService.authenticateUser() Âëº„Å≥Âá∫„Åó
  ‚Üì   Args: Âêå‰∏ä
  ‚Üì [7] PostgreSQL „ÇØ„Ç®„É™ÂÆüË°å
  ‚Üì   SELECT * FROM "Staff" WHERE email = 'admin@example.com' AND is_deleted = false
  ‚Üì   Result: { id: "abc123", tenant_id: "default", email: "...", password_hash: "...", role: "admin" }
  ‚Üì [8] bcrypt.compare() ÂÆüË°å
  ‚Üì   Args: password="****", hash="$2b$10$..."
  ‚Üì   Result: true
  ‚Üì [9] SessionAuthService.createSession() Âëº„Å≥Âá∫„Åó
  ‚Üì   Args: user={ id: "abc123", tenant_id: "default", ... }
  ‚Üì [10] crypto.randomBytes(32) ÂÆüË°å
  ‚Üì   Result: sessionId="a1b2c3d4e5f6..."
  ‚Üì [11] Redis SETÂÆüË°å
  ‚Üì   Key: "hotel:session:a1b2c3d4e5f6..."
  ‚Üì   Value: JSON.stringify({ userId: "abc123", tenant_id: "default", ... })
  ‚Üì   TTL: 3600
  ‚Üì   Result: OK
  ‚Üì [12] „É¨„Çπ„Éù„É≥„Çπ‰ΩúÊàê
  ‚Üì   Body: { success: true, data: { user: { id: "abc123", ... } } }
  ‚Üì   Set-Cookie: hotel_session=a1b2c3d4e5f6...; HttpOnly; Secure; Path=/; Max-Age=3600
hotel-saas (Nuxt3 API)
  ‚Üì [13] „É¨„Çπ„Éù„É≥„ÇπÂèó‰ø°
  ‚Üì [14] hotel-saasÁã¨Ëá™„Çª„ÉÉ„Ç∑„Éß„É≥‰ΩúÊàê
  ‚Üì   Redis SET: "hotel:session:xyz789"
  ‚Üì   Value: { user_id: "abc123", tenant_id: "default", ... }
  ‚Üì [15] CookieË®≠ÂÆö
  ‚Üì   Set-Cookie: hotel-session-id=xyz789; HttpOnly; Path=/
  ‚Üì [16] useSessionAuth.login() ÂÜÖ
  ‚Üì   globalUser.value = { id: "abc123", email: "...", tenant_id: "default", ... }
  ‚Üì [17] navigateTo('/admin')
„Éñ„É©„Ç¶„Ç∂
  ‚Üì [18] /admin „Å´„É™„ÉÄ„Ç§„É¨„ÇØ„Éà
  ‚Üì [19] middleware/admin-auth.ts ÂÆüË°å
  ‚Üì   user.value „ÅåÂ≠òÂú® ‚Üí initialize() „Çπ„Ç≠„ÉÉ„Éó
  ‚Üì [20] pages/admin/index.vue „Éû„Ç¶„É≥„Éà
  ‚Üì [21] fetchStats() ÂÆüË°å
  ‚Üì [22-25] ‰∏¶ÂàóAPIÂëº„Å≥Âá∫„ÅóÔºà4Êú¨Ôºâ
```

**„Åì„ÅÆ„Éà„É¨„Éº„Çπ„Åå„ÅÇ„Çå„Å∞**:
- ‚úÖ ÂÖ®„Å¶„ÅÆAPI„Éë„Çπ„ÅåÊ≠£Á¢∫
- ‚úÖ ÂÖ®„Å¶„ÅÆ„É™„ÇØ„Ç®„Çπ„Éà„Éª„É¨„Çπ„Éù„É≥„Çπ„ÅåÊ≠£Á¢∫
- ‚úÖ ÂÖ®„Å¶„ÅÆÂ§âÊï∞Â§âÂåñ„ÅåÊ≠£Á¢∫
- ‚úÖ „Ç∑„Çπ„ÉÜ„É†ÈñìÈÄ£Êê∫„ÅåÂÆåÂÖ®„Å´ÂèØË¶ñÂåñ
- ‚úÖ Cookie„Éª„Çª„ÉÉ„Ç∑„Éß„É≥„ÅÆË®≠ÂÆö„Çø„Ç§„Éü„É≥„Ç∞„ÅåÊòéÁ¢∫

---

### 2. Â§âÊï∞„ÅÆÂ§âÂåñ„Éà„É¨„Éº„Çπ
```javascript
// „É≠„Ç∞„Ç§„É≥ÈñãÂßãÊôÇ
globalUser.value = null
isAuthenticated.value = false

// hotel-saas APIÂëº„Å≥Âá∫„ÅóÂæå
globalUser.value = null  // „Åæ„Å†Â§âÂåñ„Å™„Åó
isAuthenticated.value = false

// hotel-common „É¨„Çπ„Éù„É≥„ÇπÂèó‰ø°Âæå
globalUser.value = null  // „Åæ„Å†Â§âÂåñ„Å™„Åó
isAuthenticated.value = false

// useSessionAuth.login() ÂÜÖ„ÅßË®≠ÂÆö
globalUser.value = { 
  id: "abc123", 
  email: "admin@example.com", 
  tenant_id: "default",
  role: "admin"
}
isAuthenticated.value = true  // ÁÆóÂá∫„Éó„É≠„Éë„ÉÜ„Ç£„ÅåÊõ¥Êñ∞

// navigateTo('/admin') Âæå
globalUser.value = { ... }  // ‰øùÊåÅ„Åï„Çå„ÇãÔºàref()„ÅÆ„Åü„ÇÅÔºâ
isAuthenticated.value = true

// middleware/admin-auth.ts ÂÆüË°åÊôÇ
user.value = { ... }  // Â≠òÂú®„Åô„Çã
isAuthenticated.value = true
‚Üí initialize() „Çí„Çπ„Ç≠„ÉÉ„Éó
```

**„Åì„ÅÆ„Éà„É¨„Éº„Çπ„Åå„ÅÇ„Çå„Å∞**:
- ‚úÖ Â§âÊï∞„ÅÆÂàùÊúüÂÄ§„ÅåÊòéÁ¢∫
- ‚úÖ Â§âÊï∞„ÅåÂ§âÂåñ„Åô„Çã„Çø„Ç§„Éü„É≥„Ç∞„ÅåÊòéÁ¢∫
- ‚úÖ „Éö„Éº„Ç∏ÈÅ∑ÁßªÊôÇ„ÅÆÂ§âÊï∞‰øùÊåÅ„ÅåÁ¢∫Ë™ç„Åß„Åç„Çã
- ‚úÖ „Äå„Å™„Åú„É≠„Ç∞„Ç§„É≥Áõ¥Âæå„Å´401„Ç®„É©„Éº„ÅåÂá∫„Çã„Åã„Äç„Åå‰∏ÄÁõÆÁû≠ÁÑ∂

---

### 3. Cookie„Éª„Çª„ÉÉ„Ç∑„Éß„É≥„ÅÆÂ§âÂåñ„Éà„É¨„Éº„Çπ
```
[1] „É≠„Ç∞„Ç§„É≥Ââç
  Browser Cookie: „Å™„Åó
  Redis (hotel-common): „Å™„Åó
  Redis (hotel-saas): „Å™„Åó

[2] hotel-common „Çª„ÉÉ„Ç∑„Éß„É≥‰ΩúÊàêÂæå
  Browser Cookie: „Å™„ÅóÔºà„Åæ„Å†Ë®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑÔºâ
  Redis (hotel-common): hotel:session:a1b2c3d4e5f6... = { userId: "abc123", ... }
  Redis (hotel-saas): „Å™„Åó

[3] hotel-common „É¨„Çπ„Éù„É≥„ÇπÈÄÅ‰ø°ÊôÇ
  Browser Cookie: hotel_session=a1b2c3d4e5f6... (Set-Cookie„Éò„ÉÉ„ÉÄ„Éº)
  Redis (hotel-common): Âêå‰∏ä
  Redis (hotel-saas): „Å™„Åó

[4] hotel-saas „Çª„ÉÉ„Ç∑„Éß„É≥‰ΩúÊàêÂæå
  Browser Cookie: hotel_session=a1b2c3d4e5f6..., hotel-session-id=xyz789
  Redis (hotel-common): Âêå‰∏ä
  Redis (hotel-saas): hotel:session:xyz789 = { user_id: "abc123", ... }

[5] „Éö„Éº„Ç∏„É™„ÉÄ„Ç§„É¨„ÇØ„ÉàÊôÇ
  Browser Cookie: Âêå‰∏äÔºàËá™ÂãïÈÄÅ‰ø°Ôºâ
  Redis (hotel-common): Âêå‰∏ä
  Redis (hotel-saas): Âêå‰∏ä

[6] /admin „Ç¢„ÇØ„Çª„ÇπÊôÇ
  Browser Cookie: Ëá™ÂãïÈÄÅ‰ø°„Åï„Çå„Çã
  Redis (hotel-common): Âêå‰∏ä
  Redis (hotel-saas): Âêå‰∏ä
  ‚Üí middleware/admin-auth.ts „ÅßÊ§úË®ºÊàêÂäü
```

**„Åì„ÅÆ„Éà„É¨„Éº„Çπ„Åå„ÅÇ„Çå„Å∞**:
- ‚úÖ CookieË®≠ÂÆö„ÅÆ„Çø„Ç§„Éü„É≥„Ç∞„ÅåÊòéÁ¢∫
- ‚úÖ Redis„Çª„ÉÉ„Ç∑„Éß„É≥‰ΩúÊàê„ÅÆ„Çø„Ç§„Éü„É≥„Ç∞„ÅåÊòéÁ¢∫
- ‚úÖ 2Èáç„Çª„ÉÉ„Ç∑„Éß„É≥ÊßãÈÄ†„ÅÆÁêÜÁî±„ÅåÊòéÁ¢∫
- ‚úÖ „ÄåSimpleRedis„Å†„Å®‰Ωï„ÅåÂïèÈ°å„Åã„Äç„Åå‰∏ÄÁõÆÁû≠ÁÑ∂

---

### 4. „Ç∑„Çπ„ÉÜ„É†ÈñìÈÄ£Êê∫„ÅÆÂÆåÂÖ®„Å™ÂèØË¶ñÂåñ
```
[ÊôÇÁ≥ªÂàó„ÅßÂÖ®„Å¶„Éà„É¨„Éº„Çπ]

T+0ms: „Éñ„É©„Ç¶„Ç∂ ‚Üí hotel-saas
  POST /api/v1/auth/login
  Body: { email, password }

T+10ms: hotel-saas ‚Üí hotel-common
  POST http://localhost:3400/api/v1/auth/login
  Body: { email, password, tenantId }

T+20ms: hotel-common ‚Üí PostgreSQL
  SELECT * FROM "Staff" WHERE email = '...'

T+50ms: PostgreSQL ‚Üí hotel-common
  Result: { id, tenant_id, email, password_hash, role }

T+60ms: hotel-common ‚Üí bcrypt
  bcrypt.compare(password, password_hash)

T+100ms: bcrypt ‚Üí hotel-common
  Result: true

T+110ms: hotel-common ‚Üí Redis
  SET hotel:session:a1b2c3d4e5f6... = {...}

T+120ms: Redis ‚Üí hotel-common
  Result: OK

T+130ms: hotel-common ‚Üí hotel-saas
  Response: { success: true, data: { user: {...} } }
  Set-Cookie: hotel_session=a1b2c3d4e5f6...

T+140ms: hotel-saas ‚Üí Redis
  SET hotel:session:xyz789 = {...}

T+150ms: Redis ‚Üí hotel-saas
  Result: OK

T+160ms: hotel-saas ‚Üí „Éñ„É©„Ç¶„Ç∂
  Response: { success: true, data: { sessionId, user } }
  Set-Cookie: hotel-session-id=xyz789

T+170ms: „Éñ„É©„Ç¶„Ç∂
  globalUser.value = { ... }
  navigateTo('/admin')

T+180ms: „Éñ„É©„Ç¶„Ç∂ ‚Üí hotel-saas
  GET /admin
  Cookie: hotel_session=..., hotel-session-id=...

T+190ms: hotel-saas (middleware/admin-auth.ts)
  user.value Â≠òÂú®„ÉÅ„Çß„ÉÉ„ÇØ ‚Üí Â≠òÂú®„Åô„Çã
  initialize() „Çπ„Ç≠„ÉÉ„Éó

T+200ms: hotel-saas (pages/admin/index.vue)
  „Éû„Ç¶„É≥„Éà ‚Üí fetchStats() ÂÆüË°å
```

**„Åì„ÅÆ„Éà„É¨„Éº„Çπ„Åå„ÅÇ„Çå„Å∞**:
- ‚úÖ „Ç∑„Çπ„ÉÜ„É†ÈñìÈÄ£Êê∫„ÅÆÈ†ÜÂ∫è„ÅåÂÆåÂÖ®„Å´ÊòéÁ¢∫
- ‚úÖ ÂêÑÂá¶ÁêÜ„ÅÆÊâÄË¶ÅÊôÇÈñì„ÅåÂàÜ„Åã„Çã
- ‚úÖ „Éú„Éà„É´„Éç„ÉÉ„ÇØ„ÅåÁâπÂÆö„Åß„Åç„Çã
- ‚úÖ „Äå„Å©„Åì„ÅßÂïèÈ°å„ÅåËµ∑„Åç„Å¶„ÅÑ„Çã„Åã„Äç„Åå‰∏ÄÁõÆÁû≠ÁÑ∂

---

## üõ†Ô∏è ÂÆüË£ÖÊñπÊ≥ï

### Phase 1: „É≠„Ç∞ËøΩÂä†ÔºàÈñãÁô∫Áí∞Â¢ÉÔºâ
```typescript
// hotel-saas/server/api/v1/auth/login.post.ts
export default defineEventHandler(async (event) => {
  console.log('[TRACE] [T+0ms] hotel-saas: „É≠„Ç∞„Ç§„É≥APIÈñãÂßã');
  console.log('[TRACE] [T+0ms] Body:', body);
  
  console.log('[TRACE] [T+10ms] hotel-commonÂëº„Å≥Âá∫„ÅóÈñãÂßã');
  const authResponse = await $fetch(`${baseUrl}/api/v1/auth/login`, {
    method: 'POST',
    body: { email: body.email, password: body.password, tenantId: 'default' }
  });
  console.log('[TRACE] [T+130ms] hotel-common „É¨„Çπ„Éù„É≥„ÇπÂèó‰ø°:', authResponse);
  
  console.log('[TRACE] [T+140ms] hotel-saas „Çª„ÉÉ„Ç∑„Éß„É≥‰ΩúÊàêÈñãÂßã');
  // ...
});
```

```typescript
// hotel-common/src/routes/systems/common/auth.routes.ts
router.post('/api/v1/auth/login', async (req: Request, res: Response) => {
  console.log('[TRACE] [T+20ms] hotel-common: „É≠„Ç∞„Ç§„É≥APIÈñãÂßã');
  console.log('[TRACE] [T+20ms] Body:', req.body);
  
  console.log('[TRACE] [T+30ms] SessionAuthService.authenticateUser() Âëº„Å≥Âá∫„Åó');
  const result = await UnifiedSessionMiddleware.login(email, password, tenantId);
  console.log('[TRACE] [T+120ms] Ë™çË®ºÊàêÂäü:', result);
  
  console.log('[TRACE] [T+125ms] CookieË®≠ÂÆö');
  res.cookie('hotel_session', result.sessionId, { ... });
  console.log('[TRACE] [T+130ms] „É¨„Çπ„Éù„É≥„ÇπÈÄÅ‰ø°');
});
```

```typescript
// hotel-saas/composables/useSessionAuth.ts
const login = async (email: string, password: string) => {
  console.log('[TRACE] [T+0ms] useSessionAuth.login() ÈñãÂßã');
  console.log('[TRACE] [T+0ms] globalUser.value =', globalUser.value);
  
  const response = await $fetch('/api/v1/auth/login', { ... });
  console.log('[TRACE] [T+160ms] API „É¨„Çπ„Éù„É≥„ÇπÂèó‰ø°:', response);
  
  globalUser.value = response.data.user;
  console.log('[TRACE] [T+165ms] globalUser.value Êõ¥Êñ∞:', globalUser.value);
  console.log('[TRACE] [T+165ms] isAuthenticated.value =', isAuthenticated.value);
  
  console.log('[TRACE] [T+170ms] navigateTo(\'/admin\')');
  navigateTo('/admin');
};
```

```typescript
// hotel-saas/middleware/admin-auth.ts
export default defineNuxtRouteMiddleware(async (to, from) => {
  console.log('[TRACE] [T+180ms] middleware/admin-auth.ts ÂÆüË°åÈñãÂßã');
  console.log('[TRACE] [T+180ms] to.path =', to.path);
  console.log('[TRACE] [T+180ms] user.value =', user.value);
  console.log('[TRACE] [T+180ms] isAuthenticated.value =', isAuthenticated.value);
  
  if (user.value) {
    console.log('[TRACE] [T+185ms] user.value Â≠òÂú® ‚Üí initialize() „Çπ„Ç≠„ÉÉ„Éó');
  } else if (!isAuthenticated.value) {
    console.log('[TRACE] [T+185ms] ÂàùÂõû„Ç¢„ÇØ„Çª„Çπ ‚Üí initialize() ÂÆüË°å');
    await initialize();
  }
  
  console.log('[TRACE] [T+190ms] middleware/admin-auth.ts ÂÆå‰∫Ü');
});
```

---

### Phase 2: „Éà„É¨„Éº„ÇπÂÆüË°å
```bash
# „Éñ„É©„Ç¶„Ç∂„Ç≥„É≥„ÇΩ„Éº„É´„Å®„Çø„Éº„Éü„Éä„É´„É≠„Ç∞„Çí‰∏°ÊñπË®òÈå≤

# 1. hotel-saasËµ∑ÂãïÔºà„Çø„Éº„Éü„Éä„É´1Ôºâ
cd /Users/kaneko/hotel-saas
npm run dev > trace-saas.log 2>&1

# 2. hotel-commonËµ∑ÂãïÔºà„Çø„Éº„Éü„Éä„É´2Ôºâ
cd /Users/kaneko/hotel-common
npm run dev > trace-common.log 2>&1

# 3. „Éñ„É©„Ç¶„Ç∂„Åß„É≠„Ç∞„Ç§„É≥ÂÆüË°å
# „Éñ„É©„Ç¶„Ç∂„Ç≥„É≥„ÇΩ„Éº„É´„ÅÆÂÖ®„É≠„Ç∞„Çí„Ç≥„Éî„Éº ‚Üí trace-browser.log

# 4. RedisÁõ£Ë¶ñÔºà„Çø„Éº„Éü„Éä„É´3Ôºâ
redis-cli MONITOR > trace-redis.log 2>&1
```

---

### Phase 3: „Éà„É¨„Éº„ÇπÁµ±Âêà
```bash
# ÂÖ®„Å¶„ÅÆ„É≠„Ç∞„ÇíÊôÇÁ≥ªÂàó„Åß„Éû„Éº„Ç∏
# T+0ms, T+10ms, T+20ms, ... „ÅÆÈ†Ü„Å´‰∏¶„ÅπÊõø„Åà

# ÁµêÊûú„Çí trace-complete.log „Å´Âá∫Âäõ
```

---

### Phase 4: „Éà„É¨„Éº„Çπ„Åã„ÇâSSOTÁîüÊàê
```markdown
## üéØ Ë™çË®º„Éï„É≠„ÉºÔºàÂÆüË°å„Éà„É¨„Éº„ÇπÁµêÊûúÔºâ

### ÂÆüÊ∏¨„Å´„Çà„ÇãÂÆåÂÖ®„Å™„Éï„É≠„Éº

**ÂÆüË°åÊó•ÊôÇ**: 2025Âπ¥10Êúà2Êó• 10:30:00
**„ÉÜ„Çπ„Éà„Ç±„Éº„Çπ**: admin@example.com „Åß„É≠„Ç∞„Ç§„É≥

```
[T+0ms] „Éñ„É©„Ç¶„Ç∂
  ‚Üì POST /api/v1/auth/login
  ‚Üì Body: { email: "admin@example.com", password: "****" }
  ‚Üì globalUser.value = null
  ‚Üì isAuthenticated.value = false

[T+10ms] hotel-saas (Nuxt3 API)
  ‚Üì /Users/kaneko/hotel-saas/server/api/v1/auth/login.post.ts
  ‚Üì POST http://localhost:3400/api/v1/auth/login
  ‚Üì Body: { email: "admin@example.com", password: "****", tenantId: "default" }

[T+20ms] hotel-common (Express API)
  ‚Üì /Users/kaneko/hotel-common/src/routes/systems/common/auth.routes.ts (line 377)
  ‚Üì UnifiedSessionMiddleware.login() Âëº„Å≥Âá∫„Åó

[T+30ms] SessionAuthService.authenticateUser()
  ‚Üì /Users/kaneko/hotel-common/src/auth/SessionAuthService.ts (line 429)
  ‚Üì PostgreSQL: SELECT * FROM "Staff" WHERE email = 'admin@example.com'

[T+50ms] PostgreSQL ‚Üí hotel-common
  ‚Üì Result: { id: "abc123", tenant_id: "default", email: "...", password_hash: "$2b$10$...", role: "admin" }

[T+60ms] bcrypt.compare()
  ‚Üì Args: password="****", hash="$2b$10$..."
  ‚Üì Result: true (Ë™çË®ºÊàêÂäü)

[T+110ms] Redis SET
  ‚Üì Key: "hotel:session:a1b2c3d4e5f6..."
  ‚Üì Value: {"userId":"abc123","tenant_id":"default",...}
  ‚Üì TTL: 3600
  ‚Üì Result: OK

[T+130ms] hotel-common ‚Üí hotel-saas
  ‚Üì Response: { success: true, data: { user: { id: "abc123", ... } } }
  ‚Üì Set-Cookie: hotel_session=a1b2c3d4e5f6...; HttpOnly; Secure; Path=/; Max-Age=3600

[T+140ms] hotel-saas „Çª„ÉÉ„Ç∑„Éß„É≥‰ΩúÊàê
  ‚Üì Redis SET: "hotel:session:xyz789"
  ‚Üì Value: {"user_id":"abc123","tenant_id":"default",...}

[T+160ms] hotel-saas ‚Üí „Éñ„É©„Ç¶„Ç∂
  ‚Üì Response: { success: true, data: { sessionId: "xyz789", user: {...} } }
  ‚Üì Set-Cookie: hotel-session-id=xyz789; HttpOnly; Path=/

[T+165ms] useSessionAuth.login() ÂÜÖ
  ‚Üì globalUser.value = { id: "abc123", email: "admin@example.com", tenant_id: "default", role: "admin" }
  ‚Üì isAuthenticated.value = true (ÁÆóÂá∫„Éó„É≠„Éë„ÉÜ„Ç£Êõ¥Êñ∞)

[T+170ms] navigateTo('/admin')
  ‚Üì „Éñ„É©„Ç¶„Ç∂„Åå„É™„ÉÄ„Ç§„É¨„ÇØ„ÉàÈñãÂßã

[T+180ms] „Éñ„É©„Ç¶„Ç∂ ‚Üí hotel-saas
  ‚Üì GET /admin
  ‚Üì Cookie: hotel_session=a1b2c3d4e5f6..., hotel-session-id=xyz789

[T+185ms] middleware/admin-auth.ts ÂÆüË°å
  ‚Üì user.value = { id: "abc123", ... } (Â≠òÂú®„Åô„Çã)
  ‚Üì isAuthenticated.value = true
  ‚Üì ‚Üí initialize() „Çπ„Ç≠„ÉÉ„ÉóÔºàÈáçË¶ÅÔºÅÔºâ

[T+200ms] pages/admin/index.vue „Éû„Ç¶„É≥„Éà
  ‚Üì fetchStats() ÂÆüË°å
  ‚Üì 4Êú¨„ÅÆAPIÂëº„Å≥Âá∫„Åó‰∏¶ÂàóÂÆüË°å
```

**ÈáçË¶Å„Å™Áô∫Ë¶ã**:
1. globalUser.value „ÅØ T+165ms „ÅßË®≠ÂÆö„Åï„Çå„Çã
2. Cookie „ÅØ T+160ms „ÅßË®≠ÂÆö„Åï„Çå„Çã
3. „Éö„Éº„Ç∏ÈÅ∑Áßª„ÅØ T+170ms „ÅßÈñãÂßã
4. middlewareÂÆüË°å„ÅØ T+185ms
5. **user.value „ÅØ‰øùÊåÅ„Åï„Çå„Å¶„ÅÑ„Çã„Åü„ÇÅ„ÄÅinitialize() „ÅØ‰∏çË¶Å**

**ËêΩ„Å®„ÅóÁ©¥**:
„ÇÇ„Åó middleware „Åß `user.value` „Çí„ÉÅ„Çß„ÉÉ„ÇØ„Åõ„Åö„Å´ `isAuthenticated.value` „Å†„Åë„Çí„ÉÅ„Çß„ÉÉ„ÇØ„Åô„Çã„Å®„ÄÅ
T+185ms ÊôÇÁÇπ„Åß `isAuthenticated` „Åå‰∏ÄÁû¨ `false` „Å´„Å™„ÇãÂèØËÉΩÊÄß„Åå„ÅÇ„Çä„ÄÅ
‰∏çË¶Å„Å™ `initialize()` „ÅåÂÆüË°å„Åï„Çå„Å¶401„Ç®„É©„Éº„ÅåÁô∫Áîü„Åô„Çã„ÄÇ
```
```

---

## üéØ „É°„É™„ÉÉ„Éà

### 1. **100%Ê≠£Á¢∫„Å™SSOT**
- ‚ùå Êé®Ê∏¨: „Äå„Åü„Å∂„Çì„Åì„ÅÜ„Å™„Çã„Äç
- ‚úÖ ‰∫ãÂÆü: „ÄåÂÆüÈöõ„Å´„Åì„ÅÜ„Å™„Å£„Åü„Äç

### 2. **Â§âÊï∞Â§âÂåñ„ÅÆÂÆåÂÖ®„Å™ÂèØË¶ñÂåñ**
- „ÅÑ„Å§Â§âÊï∞„ÅåÂ§â„Çè„Çã„Åã
- „Å™„ÅúÂ§âÊï∞„ÅåÂ§â„Çè„Çã„Åã
- „Å©„Åì„ÅßÂ§âÊï∞„ÅåÂ§â„Çè„Çã„Åã

### 3. **„Ç∑„Çπ„ÉÜ„É†ÈñìÈÄ£Êê∫„ÅÆÂÆåÂÖ®„Å™ÁêÜËß£**
- „Å©„ÅÆ„Ç∑„Çπ„ÉÜ„É†„Åå‰Ωï„ÇíÂëº„Å∂„Åã
- „Å©„ÅÆÈ†ÜÂ∫è„ÅßÂëº„Å∞„Çå„Çã„Åã
- „Å©„ÅÆ„Çø„Ç§„Éü„É≥„Ç∞„ÅßCookie„ÅåË®≠ÂÆö„Åï„Çå„Çã„Åã

### 4. **ÂïèÈ°å„ÅÆÊó©ÊúüÁô∫Ë¶ã**
- „Äå„É≠„Ç∞„Ç§„É≥Áõ¥Âæå„Å´401„Ç®„É©„Éº„Äç„ÅÆÂéüÂõ†„Åå‰∏ÄÁõÆÁû≠ÁÑ∂
- „ÄåRedis„Åå‰∏ç‰∏ÄËá¥„Äç„ÅÆÂïèÈ°å„ÅåÊòéÁ¢∫
- „Äåinitialize()„ÇíÂëº„Çì„Åß„ÅØ„ÅÑ„Åë„Å™„ÅÑ„Çø„Ç§„Éü„É≥„Ç∞„Äç„ÅåÂàÜ„Åã„Çã

### 5. **„Éë„Éï„Ç©„Éº„Éû„É≥„ÇπÂàÜÊûê**
- „Å©„ÅÆÂá¶ÁêÜ„ÅåÈÅÖ„ÅÑ„Åã
- „Å©„Åì„Åå„Éú„Éà„É´„Éç„ÉÉ„ÇØ„Åã
- „Å©„ÅÜÊúÄÈÅ©Âåñ„Åô„Åπ„Åç„Åã

---

## üìã „Éà„É¨„Éº„ÇπÈßÜÂãïSSOT‰ΩúÊàê„Éó„É≠„Çª„Çπ

### Phase 0-3: ÂæìÊù•ÈÄö„Çä
Êó¢Â≠òSSOTË™≠„ÅøËæº„Åø„ÄÅ„Éâ„Ç≠„É•„É°„É≥„ÉàË™≠„ÅøËæº„Åø„ÄÅÂÆüË£Ö„Éï„Ç°„Ç§„É´Ë™≠„ÅøËæº„Åø

### Phase 4: „Éà„É¨„Éº„ÇπÂÆüË°åÔºàÊñ∞Ë¶èÔºâ
```bash
1. „É≠„Ç∞ËøΩÂä†ÔºàÈñãÁô∫Áí∞Â¢É„ÅÆ„ÅøÔºâ
2. ÂÆüÈöõ„Å´Ê©üËÉΩ„ÇíÂÆüË°å
3. ÂÖ®„É≠„Ç∞„ÇíË®òÈå≤
4. „É≠„Ç∞„ÇíÊôÇÁ≥ªÂàó„ÅßÁµ±Âêà
```

### Phase 5: „Éà„É¨„Éº„ÇπÂàÜÊûê
```bash
1. Â§âÊï∞„ÅÆÂ§âÂåñ„ÇíÊäΩÂá∫
2. APIÂëº„Å≥Âá∫„Åó„ÉÅ„Çß„Éº„É≥„ÇíÊäΩÂá∫
3. Cookie„Éª„Çª„ÉÉ„Ç∑„Éß„É≥„ÅÆÂ§âÂåñ„ÇíÊäΩÂá∫
4. „Ç∑„Çπ„ÉÜ„É†ÈñìÈÄ£Êê∫„ÇíÂèØË¶ñÂåñ
```

### Phase 6: SSOT„Å´Ë®òËºâ
```markdown
## üéØ [Ê©üËÉΩÂêç]„Éï„É≠„ÉºÔºàÂÆüË°å„Éà„É¨„Éº„ÇπÁµêÊûúÔºâ

**ÂÆüË°åÊó•ÊôÇ**: YYYYÂπ¥MMÊúàDDÊó• HH:MM:SS
**„ÉÜ„Çπ„Éà„Ç±„Éº„Çπ**: [ÂÖ∑‰ΩìÁöÑ„Å™„ÉÜ„Çπ„Éà„Ç±„Éº„Çπ]

[ÂÆåÂÖ®„Å™„Éà„É¨„Éº„ÇπÁµêÊûú]

**ÈáçË¶Å„Å™Áô∫Ë¶ã**:
- [Áô∫Ë¶ã1]
- [Áô∫Ë¶ã2]

**ËêΩ„Å®„ÅóÁ©¥**:
- [ËêΩ„Å®„ÅóÁ©¥1]
- [ËêΩ„Å®„ÅóÁ©¥2]
```

### Phase 7-9: ÂæìÊù•ÈÄö„Çä
ÂøÖÈ†àË¶Å‰ª∂ÊòéË®ò„ÄÅÊó¢Â≠òSSOTÊï¥ÂêàÊÄßÁ¢∫Ë™ç„ÄÅÊúÄÁµÇ„ÉÅ„Çß„ÉÉ„ÇØ

---

## üöÄ ÂÆüË£ÖË®àÁîª

### „Çπ„ÉÜ„ÉÉ„Éó1: „Éë„Ç§„É≠„ÉÉ„ÉàÂÆüË£Ö
- [ ] hotel-saas„Å´„Éà„É¨„Éº„Çπ„É≠„Ç∞ËøΩÂä†
- [ ] hotel-common„Å´„Éà„É¨„Éº„Çπ„É≠„Ç∞ËøΩÂä†
- [ ] Composable„Å´„Éà„É¨„Éº„Çπ„É≠„Ç∞ËøΩÂä†
- [ ] Middleware„Å´„Éà„É¨„Éº„Çπ„É≠„Ç∞ËøΩÂä†

### „Çπ„ÉÜ„ÉÉ„Éó2: „Éà„É¨„Éº„ÇπÂÆüË°å
- [ ] „É≠„Ç∞„Ç§„É≥Ê©üËÉΩ„ÅßÂÆüË°å
- [ ] ÂÖ®„É≠„Ç∞„ÇíË®òÈå≤
- [ ] „É≠„Ç∞„ÇíÁµ±Âêà

### „Çπ„ÉÜ„ÉÉ„Éó3: SSOTÊõ¥Êñ∞
- [ ] Ë™çË®ºSSOT„Å´„Éà„É¨„Éº„ÇπÁµêÊûú„ÇíËøΩÂä†
- [ ] ÂïèÈ°åÁÇπ„ÇíÊòéÁ¢∫Âåñ
- [ ] ËêΩ„Å®„ÅóÁ©¥„ÇíÊòéË®ò

### „Çπ„ÉÜ„ÉÉ„Éó4: Ëá™ÂãïÂåñÊ§úË®é
- [ ] „Éà„É¨„Éº„Çπ„É≠„Ç∞„ÅÆËá™ÂãïÁµ±Âêà„Çπ„ÇØ„É™„Éó„Éà
- [ ] „Éà„É¨„Éº„ÇπÁµêÊûú„ÅÆSSOTËá™ÂãïÁîüÊàê
- [ ] Á∂ôÁ∂öÁöÑ„Éà„É¨„Éº„ÇπÂÆüË°åÔºàCI/CDÁµ±ÂêàÔºâ

---

## üéì ÁµêË´ñ

### „Åì„ÅÆÊâãÊ≥ï„ÅÆÈù©ÂëΩÊÄß

**ÂæìÊù•**: „Ç≥„Éº„Éâ„ÇíË™≠„Çì„Åß„ÄåÊé®Ê∏¨„Äç  
**Êñ∞ÊâãÊ≥ï**: ÂÆüÈöõ„Å´Âãï„Åã„Åó„Å¶„ÄåË¶≥Ê∏¨„Äç

„Åì„Çå„ÅØ**SSOT‰ΩúÊàê„ÅÆÁ≤æÂ∫¶„ÇíÊ†πÊú¨ÁöÑ„Å´Âêë‰∏ä„Åï„Åõ„Çã**ÊâãÊ≥ï„Åß„Åô„ÄÇ

### ‰ªäÂæå„ÅÆÊñπÈáù

1. **„Åô„Åê„Å´ÂÆüË£Ö**: „É≠„Ç∞„Ç§„É≥Ê©üËÉΩ„Åß„Éë„Ç§„É≠„ÉÉ„ÉàÂÆüÊñΩ
2. **SSOTÊõ¥Êñ∞**: „Éà„É¨„Éº„ÇπÁµêÊûú„ÇíË™çË®ºSSOT„Å´ËøΩÂä†
3. **‰ªñÊ©üËÉΩÂ±ïÈñã**: „ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ„ÄÅÊ≥®Êñá„ÄÅÊ±∫Ê∏àÁ≠â
4. **Ëá™ÂãïÂåñ**: „Éà„É¨„Éº„Çπ‚ÜíSSOTÁîüÊàê„ÇíËá™ÂãïÂåñ

---

**„Åì„ÅÆÊèêÊ°à„Å´„Çà„Çä„ÄÅSSOT„ÅÆÂìÅË≥™„ÅåÊõ¥„Å´Èù©ÂëΩÁöÑ„Å´Âêë‰∏ä„Åó„Åæ„Åô„ÄÇ**

**ÂÆüÊ∏¨„Éô„Éº„Çπ„ÅÆSSOT„ÅØ„ÄÅÊé®Ê∏¨„Éô„Éº„Çπ„ÅÆSSOT„ÇíÂÆåÂÖ®„Å´Ë∂Ö„Åà„Åæ„Åô„ÄÇ**

---

**ÊúÄÁµÇÊõ¥Êñ∞**: 2025Âπ¥10Êúà2Êó•  
**ÊèêÊ°àËÄÖ**: „É¶„Éº„Ç∂„Éº  
**ÂàÜÊûêËÄÖ**: AI Assistant (Luna)  
**Ê¨°„ÅÆ„Ç¢„ÇØ„Ç∑„Éß„É≥**: „Éë„Ç§„É≠„ÉÉ„ÉàÂÆüË£Ö„ÅÆÊâøË™çÂæÖ„Å°

