# 緊急時の例外プロセス

**日付**: 2023年8月17日
**作成者**: hotel-kanri

## 概要

このドキュメントは、通常のデプロイフローでは対応できない緊急事態が発生した場合の例外的なプロセスを定義します。このプロセスは最後の手段として使用され、厳格な条件と事後処理が必須です。

## 緊急事態の定義

以下の条件をすべて満たす場合のみ、緊急事態と認定します：

1. 本番環境またはデモ環境で重大な障害が発生している
2. 通常のデプロイフロー（GitHub Actions経由）では解決できない技術的な問題がある
3. 問題の解決が24時間以上待てない業務上の緊急性がある
4. CTO/開発責任者が緊急事態と判断している

## 例外プロセスの実行手順

### 1. 事前承認

1. **承認申請**：
   - Slackチャンネル「#emergency-deploy」で緊急事態の詳細を報告
   - 必要な対応と例外プロセスを適用する理由を明記
   - 「@cto」と「@dev-lead」をメンションして承認を依頼

2. **承認条件**：
   - CTO/開発責任者の明示的な承認が必要
   - 承認はSlackチャンネルで公開され、記録が残る
   - 承認は特定の対応に対してのみ有効（包括的な承認は不可）

### 2. 実行条件

1. **立会人**：
   - 最低2名の開発者が立ち会うこと
   - うち1名は承認者以外のシニア開発者であること

2. **記録**：
   - すべての操作をスクリーン共有で記録
   - 共有セッションはSlackチャンネル「#emergency-deploy」で通知
   - 操作の開始時間と終了時間を記録

3. **実行ログ**：
   - すべてのコマンドとその結果をログに記録
   - 変更したファイルとその内容を記録
   - 実行者と立会人の名前を記録

### 3. 実行手順

1. **バックアップ**：
   - 変更前に必ずバックアップを作成
   ```bash
   cp -r /path/to/directory /path/to/backup/directory_$(date +%Y%m%d_%H%M%S)
   ```

2. **最小限の変更**：
   - 問題解決に必要な最小限の変更のみを行う
   - 変更内容を明確に文書化

3. **検証**：
   - 変更後、問題が解決したことを確認
   - 他の機能に影響がないことを確認

### 4. 事後処理（必須）

1. **GitHub反映**：
   - 24時間以内に同じ変更をGitHubリポジトリに反映
   - プルリクエストには「Emergency Fix」ラベルを付与
   - 緊急対応の詳細と承認者を明記

2. **報告書作成**：
   - 緊急対応レポートを作成（`docs/emergency/2025-09-12-incident.md`）
   - 以下の内容を含める：
     - 発生した問題の詳細
     - 原因分析
     - 実施した対応
     - 通常のデプロイフローを使用できなかった理由
     - 再発防止策

3. **振り返りミーティング**：
   - 緊急対応から48時間以内に振り返りミーティングを実施
   - 再発防止策を議論し、実施計画を立案

## 緊急対応レポートのテンプレート

```markdown
# 緊急対応レポート

## 基本情報

- **日時**: 2025-09-12 HH:MM
- **対象システム**: [システム名]
- **影響範囲**: [影響を受けた機能/ユーザー]
- **実行者**: [名前]
- **立会人**: [名前1], [名前2]
- **承認者**: [名前]

## 問題詳細

[発生した問題の詳細な説明]

## 原因分析

[問題の根本原因の分析]

## 実施した対応

[実施した変更の詳細]

## 通常フローを使用できなかった理由

[GitHub Actions経由のデプロイができなかった具体的な理由]

## 再発防止策

[同様の問題が再発しないための対策]

## GitHubへの反映状況

- **プルリクエスト**: [PR番号またはURL]
- **反映日時**: 2025-09-12 HH:MM
```

## 監査と違反対応

1. すべての緊急対応は月次の開発会議で報告
2. 四半期ごとに緊急対応の傾向分析を実施
3. 例外プロセスの乱用が発覚した場合は、即座に是正措置を実施

## 注意事項

- このプロセスは最後の手段として使用すること
- 可能な限り通常のデプロイフローを使用すること
- 例外プロセスの適用回数を最小限に抑えることが目標
- 事後処理を怠った場合、今後の例外プロセスの承認が困難になる可能性あり
