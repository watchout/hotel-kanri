=== 全システム統合ログ管理 粒度・レベル統一基準 ===

**ドキュメントID**: LOG-STANDARDS-2025-09-24-001  
**対象システム**: hotel-saas, hotel-pms, hotel-member, hotel-common  
**バージョン**: v1.0  
**作成日**: 2025年9月24日  
**ステータス**: 策定中  

---

【必読ドキュメント】
★★★ 本仕様書（全システム共通基準）
★★☆ 各システム個別実装ガイド（後日作成予定）
★☆☆ hotel-common統合ログ管理仕様（後日作成予定）

---

【実装順序】
Phase 1: ログレベル・粒度基準策定（本ドキュメント）
Phase 2: 全システム統合アーキテクチャ設計
Phase 3: 各システム個別実装仕様
Phase 4: hotel-common統合管理機能
Phase 5: 運用監視・分析機能

---

【重要な実装方針】

❌ 禁止事項:
- システムごとに異なるログレベル定義の使用
- 個人情報の平文ログ出力
- パスワード・トークン等の機密情報のログ出力
- 過度に詳細なログによるパフォーマンス劣化

✅ 必須事項:
- 統一されたログフォーマットの使用
- 適切なログレベルの設定
- セキュリティ・監査要件の遵守
- システム間での時刻同期

---

## 🎯 ログレベル統一定義

### Level 1: CRITICAL（緊急）
**対象**: システム停止、データ損失、セキュリティ侵害
**粒度**: 最小限の必要情報のみ
**保存期間**: 永続保存
**通知**: 即座にアラート

**記録対象**:
- システムクラッシュ、DB接続不可
- 不正アクセス、認証回避の試行
- データ整合性エラー、重要データ消失
- 外部サービス完全停止

### Level 2: ERROR（エラー）
**対象**: 機能停止、処理失敗、予期しない例外
**粒度**: エラー特定に必要な情報
**保存期間**: 1年
**通知**: 1時間以内にアラート

**記録対象**:
- API呼び出し失敗、タイムアウト
- データベース操作エラー
- 外部サービス連携エラー
- ビジネスロジック例外

### Level 3: WARN（警告）
**対象**: 異常だが処理継続可能、パフォーマンス劣化
**粒度**: 問題特定に必要な情報
**保存期間**: 6ヶ月
**通知**: 日次サマリー

**記録対象**:
- リトライ処理の実行
- 設定値の異常、デフォルト値使用
- パフォーマンス閾値超過
- 非推奨機能の使用

### Level 4: INFO（情報）
**対象**: 重要な業務処理、状態変更
**粒度**: 業務分析に必要な情報
**保存期間**: 3ヶ月
**通知**: なし

**記録対象**:
- ユーザーログイン/ログアウト
- 重要データの作成/更新/削除
- システム設定変更
- バッチ処理の開始/終了

### Level 5: DEBUG（デバッグ）
**対象**: 開発・トラブルシューティング用詳細情報
**粒度**: 詳細な処理フロー
**保存期間**: 1週間
**通知**: なし

**記録対象**:
- 関数の入出力パラメータ
- 条件分岐の詳細
- 中間処理結果
- パフォーマンス測定値

---

## 📊 システム別ログ粒度基準

### hotel-saas
**重点領域**: ゲストサービス、注文処理、課金処理、**管理画面操作**

□ Level 1-2: 注文処理失敗、決済エラー、ゲストデータ異常、**不正アクセス・権限昇格試行**
□ Level 3: サービス応答遅延、在庫不足警告、**異常な操作パターン**
□ Level 4: 注文作成/更新、ゲストログイン、**全ての管理者操作**、**全ての業務操作**
□ Level 5: API呼び出し詳細、UI操作フロー

**業務操作ログ（Level 4必須）**:
□ メニュー管理: メニュー追加/変更/削除/価格変更/在庫変更
□ 注文処理: 注文受付/変更/キャンセル/配達完了/返金処理
□ 決済処理: 決済実行/失敗/返金/手数料調整
□ ゲスト対応: 問い合わせ対応/苦情処理/特別対応/サービス提供
□ 在庫管理: 在庫追加/削除/調整/棚卸し/発注処理
□ プロモーション: クーポン発行/キャンペーン設定/割引適用

**管理画面操作ログ（Level 4必須）**:
□ スタッフ管理: 追加/削除/権限変更/パスワードリセット
□ 料金設定: メニュー価格変更/税率変更/割引設定
□ システム設定: 営業時間変更/サービス設定/通知設定
□ データ操作: 注文履歴修正/顧客情報変更/売上データ修正
□ レポート閲覧: 売上レポート/顧客データエクスポート
□ 緊急操作: システム停止/データベース直接操作

### hotel-pms
**重点領域**: 客室管理、チェックイン/アウト、清掃管理、**管理画面操作**

□ Level 1-2: 客室データ不整合、同期失敗、システム間連携エラー、**不正な客室操作**
□ Level 3: オフライン状態、清掃遅延警告、**権限外操作の試行**
□ Level 4: 客室状態変更、予約操作、**全てのスタッフ・管理者操作**、**全ての業務操作**
□ Level 5: 同期処理詳細、UI操作フロー

**業務操作ログ（Level 4必須）**:
□ チェックイン/アウト: チェックイン実行/早期チェックイン/レイトチェックアウト/ノーショー処理
□ 客室状態変更: 清掃中→利用可能/故障→修理中/ブロック設定/解除
□ 予約管理: 予約作成/変更/キャンセル/延泊/料金調整/特別料金適用
□ 清掃管理: 清掃開始/完了/点検/不合格/再清掃指示
□ メンテナンス: 故障報告/修理依頼/修理完了/定期点検/設備交換
□ 料金処理: 宿泊料金計算/追加料金/割引適用/返金処理
□ ゲスト対応: 部屋変更/アップグレード/苦情対応/特別サービス

**管理画面操作ログ（Level 4必須）**:
□ スタッフ管理: フロント・清掃スタッフの追加/削除/シフト変更
□ 客室管理: 客室設定変更/料金設定/ブロック設定
□ 予約管理: 予約変更/キャンセル/料金調整/特別対応
□ 清掃管理: 清掃スケジュール変更/清掃完了の手動変更
□ レポート操作: 稼働率レポート/清掃レポート/売上データ
□ システム設定: PMS設定変更/連携設定/バックアップ操作

### hotel-member
**重点領域**: 会員管理、認証、ポイント管理、**管理画面操作**

□ Level 1-2: 認証システム障害、会員データ不整合、**不正アクセス・ポイント操作**
□ Level 3: ログイン試行回数超過、ポイント計算異常、**異常な会員データ操作**
□ Level 4: 会員登録/更新、ポイント付与/使用、**全ての管理者操作**、**全ての業務操作**
□ Level 5: 認証フロー詳細、API呼び出し詳細

**業務操作ログ（Level 4必須）**:
□ 会員登録: 新規会員登録/会員情報更新/退会処理/再入会
□ ポイント処理: ポイント付与/使用/失効/調整/移行
□ 特典利用: 特典交換/クーポン利用/会員限定サービス利用
□ 認証処理: ログイン/ログアウト/パスワード変更/二段階認証
□ ランク変更: 会員ランクアップ/ダウン/手動調整
□ キャンペーン: キャンペーン参加/特別オファー適用/ボーナスポイント

**管理画面操作ログ（Level 4必須）**:
□ 会員管理: 会員情報変更/削除/ステータス変更/強制退会
□ ポイント管理: ポイント手動付与/削除/有効期限変更
□ 特典管理: 特典設定変更/クーポン発行/キャンペーン設定
□ 認証管理: パスワードリセット/アカウントロック解除
□ データ管理: 会員データエクスポート/一括更新/データ削除
□ システム設定: 会員ランク設定/ポイント計算ルール変更

### hotel-common
**重点領域**: システム間連携、統合データ管理、API管理、**管理画面操作**

□ Level 1-2: システム間通信断絶、データ同期失敗、API認証エラー、**システム全体への不正アクセス**
□ Level 3: 負荷分散異常、キャッシュ異常、**権限外のシステム操作**
□ Level 4: システム間データ同期、API呼び出し、**全ての統合管理操作**
□ Level 5: 内部処理詳細、パフォーマンス測定

**管理画面操作ログ（Level 4必須）**:
□ システム統合管理: 各システムの接続設定/API設定/同期設定
□ 全体データ管理: 統合データベース操作/マスタデータ変更
□ セキュリティ管理: 認証設定/API キー管理/アクセス制御
□ 監視・運用: ログ設定変更/アラート設定/バックアップ設定
□ 緊急対応: システム停止/データ復旧/緊急メンテナンス
□ レポート・分析: 全システム統合レポート/データ分析

---

## 🔧 統一ログフォーマット

### 基本構造
```json
{
  "timestamp": "2025-09-24T10:30:00.000Z",
  "level": "INFO",
  "system": "hotel-saas",
  "component": "order-service",
  "trace_id": "trace-12345",
  "user_id": "user-789",
  "session_id": "session-456",
  "action": "ORDER_CREATE",
  "message": "注文が正常に作成されました",
  "details": {
    "order_id": "order-123",
    "room_number": "101",
    "amount": 1500
  },
  "metadata": {
    "ip_address": "192.168.1.100",
    "user_agent": "Mozilla/5.0...",
    "request_id": "req-abc123"
  }
}
```

### 必須フィールド
- timestamp: ISO 8601形式
- level: CRITICAL/ERROR/WARN/INFO/DEBUG
- system: hotel-saas/hotel-pms/hotel-member/hotel-common
- component: サービス/モジュール名
- action: 操作種別
- message: 人間が読める説明

### 推奨フィールド
- trace_id: 分散トレーシング用
- user_id: 操作者識別
- session_id: セッション識別
- details: 構造化された詳細情報

---

## 🔍 管理画面操作ログ特別要件

### 従業員不正・ミス調査対応

**必須記録項目**:
□ 操作者情報: user_id, 氏名, 部署, 権限レベル
□ 操作詳細: 変更前後の値, 操作理由（入力必須）
□ 環境情報: IPアドレス, 端末情報, ブラウザ情報
□ 時刻情報: 操作開始時刻, 操作完了時刻, セッション時間
□ 承認情報: 承認者, 承認時刻（重要操作の場合）

**特別監視対象操作**:
```json
{
  "high_risk_operations": [
    "STAFF_DELETE",           // スタッフ削除
    "PERMISSION_ESCALATION",  // 権限昇格
    "DATA_EXPORT",           // データエクスポート
    "PRICE_CHANGE",          // 料金変更
    "REFUND_PROCESS",        // 返金処理
    "SYSTEM_CONFIG_CHANGE",  // システム設定変更
    "DATABASE_DIRECT_ACCESS", // DB直接操作
    "EMERGENCY_OVERRIDE"     // 緊急時オーバーライド
  ]
}
```

**異常パターン検知**:
□ 営業時間外の操作
□ 短時間での大量操作
□ 権限外操作の試行
□ 異常な金額変更
□ 複数システムでの同時操作
□ 通常と異なるアクセス元

**調査用ログフォーマット拡張**:
```json
{
  "timestamp": "2025-09-24T10:30:00.000Z",
  "level": "INFO",
  "system": "hotel-saas",
  "component": "admin-panel",
  "trace_id": "trace-12345",
  "user_id": "staff-789",
  "session_id": "session-456",
  "action": "PRICE_CHANGE",
  "message": "メニュー価格を変更しました",
  "details": {
    "target_entity": "menu_item",
    "entity_id": "menu-123",
    "old_values": {
      "price": 1000,
      "tax_rate": 0.10
    },
    "new_values": {
      "price": 1200,
      "tax_rate": 0.10
    },
    "change_reason": "季節メニューの価格調整",
    "approval_required": true,
    "approved_by": "manager-456",
    "approved_at": "2025-09-24T10:25:00.000Z"
  },
  "metadata": {
    "ip_address": "192.168.1.100",
    "user_agent": "Mozilla/5.0...",
    "request_id": "req-abc123",
    "session_duration": 1800,
    "previous_action": "MENU_VIEW",
    "risk_level": "HIGH"
  },
  "investigation": {
    "flagged": false,
    "auto_review": true,
    "retention_period": "7_years"  // 重要操作は長期保存
  }
}
```

**保存期間（管理画面操作）**:
- 高リスク操作: 7年間
- 一般管理操作: 3年間
- 設定変更: 5年間
- データエクスポート: 永続保存

---

## 🚨 セキュリティ・プライバシー要件

### 機密情報の取り扱い
❌ ログ出力禁止:
- パスワード、トークン、API キー
- クレジットカード番号、CVV
- 個人識別情報（氏名、住所、電話番号）

✅ マスキング必須:
- メールアドレス: u***@example.com
- 電話番号: 090-****-1234
- 客室番号: 部分マスキング可

### アクセス制御
- Level 1-3: システム管理者のみ
- Level 4: 各システム管理者
- Level 5: 開発者のみ

---

## 📈 パフォーマンス要件

### ログ出力パフォーマンス
- 同期ログ出力: 5ms以内
- 非同期ログ出力: 推奨
- バッファリング: 1000件または10秒間隔

### ストレージ要件
- 圧縮率: 70%以上
- インデックス: timestamp, level, system, user_id
- パーティション: 日別

---

## 🔄 運用要件

### ログローテーション
- 日次ローテーション
- 圧縮保存
- 自動削除（保存期間経過後）

### 監視・アラート
- エラー率閾値: 5%/時間
- 応答時間閾値: 3秒
- ディスク使用率: 80%

---

【実装チェックリスト】

□ 統一ログフォーマットの実装
□ ログレベル設定の統一
□ 機密情報マスキング機能
□ ログローテーション設定
□ パフォーマンス測定・最適化
□ セキュリティ要件の確認
□ 運用監視設定

---

【デプロイメント手順】

1. 各システムでのログライブラリ統一
2. 設定ファイルでのログレベル調整
3. hotel-commonでの統合ログ収集設定
4. 監視・アラート設定
5. 運用手順書の作成・共有

---

**承認者**: hotel-kanri統合管理  
**承認日**: 2025年9月24日（予定）  
**次回見直し予定**: 2025年12月24日
