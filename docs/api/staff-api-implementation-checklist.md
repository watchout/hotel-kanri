# スタッフ管理API実装チェックリスト

**作成日**: 2025年9月16日  
**対象**: `/api/v1/admin/staff` エンドポイント実装  
**システム**: hotel-common

## 📋 概要

`/api/v1/admin/staff` エンドポイントの実装に必要な技術仕様確認項目をまとめています。

## 🚨 **重要な実装方針**

### **❌ 禁止事項（厳守）**

**フォールバック・モック・一時対応の全面禁止**
- ❌ フォールバック処理（エラー時の代替処理）
- ❌ モックデータの使用
- ❌ 一時的な回避実装
- ❌ try-catch での例外隠蔽
- ❌ デフォルト値での問題回避
- ❌ 「とりあえず動く」実装

**理由**:
- エラーの隠蔽により問題発見が困難
- 一時対応の恒久化による技術的負債
- システム整合性の破綻
- デバッグ困難化

### **✅ 必須事項**

**正面からの問題解決**
- ✅ エラーは必ず表面化させる
- ✅ 問題の根本原因を特定・解決
- ✅ 適切なエラーハンドリング（隠蔽ではない）
- ✅ 実装前の依存関係確認
- ✅ 段階的だが確実な実装

## 🔍 技術仕様チェックが必要な項目

### 1. **データベーススキーマ確認** 🏗️
**チェック担当**: hotel-pms開発者 + hotel-common開発者

- [ ] `staff` テーブルの最新スキーマ確認
- [ ] インデックス設定の最適化
- [ ] 外部キー制約の確認
- [ ] ソフト削除（`deleted_at`）の実装確認
- [ ] テナント分離（`tenant_id`）の実装確認

**確認ファイル**:
- `docs/01_systems/pms/staff-table-detailed-design.md`
- `docs/db/schema.prisma`

### 2. **権限管理システム統合** 🔐
**チェック担当**: hotel-common開発者

- [ ] `baseLevel` による権限チェック実装
- [ ] 管理者権限（level 3以上）の確認ロジック
- [ ] 自分より上位レベルスタッフの操作制限
- [ ] システムユーザー（`is_system_user`）の削除制限
- [ ] JWT トークンからの権限情報取得

**確認ファイル**:
- `docs/01_systems/common/pms-permission-management-spec.md`
- `docs/01_systems/common/staff-login-guide.md`

### 3. **検索・フィルタリング機能** 🔍
**チェック担当**: hotel-common開発者

- [ ] 全文検索（名前、メール、スタッフコード）の実装方法
- [ ] 部門コードフィルタリング
- [ ] 雇用ステータスフィルタリング
- [ ] 権限レベルフィルタリング
- [ ] ソート機能（複数項目対応）
- [ ] ページネーション実装

### 4. **バリデーション仕様** ✅
**チェック担当**: hotel-common開発者

- [ ] スタッフコードの重複チェック
- [ ] メールアドレスの重複チェック
- [ ] 従業員IDの重複チェック（テナント内）
- [ ] 必須フィールドのバリデーション
- [ ] 権限レベル（1-5）の範囲チェック
- [ ] 日付フィールドの形式チェック

### 5. **レスポンス形式統一** 📄
**チェック担当**: hotel-common開発者

- [ ] 一覧取得時のページネーション形式
- [ ] サマリー情報（統計データ）の実装
- [ ] エラーレスポンスの統一
- [ ] 日時フィールドのISO 8601形式統一
- [ ] null値の適切な処理

### 6. **セキュリティ要件** 🛡️
**チェック担当**: hotel-common開発者 + セキュリティ担当者

- [ ] JWT認証の実装確認
- [ ] CORS設定の確認
- [ ] レート制限の実装
- [ ] ログ出力（操作履歴）の実装
- [ ] 機密情報（パスワードハッシュ等）の除外
- [ ] SQL インジェクション対策

### 7. **パフォーマンス最適化** ⚡
**チェック担当**: hotel-common開発者

- [ ] データベースクエリの最適化
- [ ] インデックス使用の確認
- [ ] N+1問題の回避
- [ ] キャッシュ戦略の検討
- [ ] 大量データ処理時の対応

### 8. **既存システムとの統合** 🔗
**チェック担当**: 全システム開発者

- [ ] hotel-pmsとのデータ連携確認
- [ ] hotel-saasでの認証連携確認
- [ ] hotel-memberでの顧客情報連携確認
- [ ] 既存の `GET /api/v1/staff/:id` との整合性確認

### 9. **テスト要件** 🧪
**チェック担当**: hotel-common開発者

- [ ] 単体テストの実装
- [ ] 統合テストの実装
- [ ] 権限テストの実装
- [ ] エラーハンドリングテスト
- [ ] パフォーマンステスト

### 10. **ドキュメント更新** 📚
**チェック担当**: kanri（統合管理）

- [ ] API仕様書の更新確認
- [ ] 実装ガイドの作成
- [ ] 運用マニュアルの更新
- [ ] 変更履歴の記録

## 🚨 重要な注意事項

### システム間制約
- [[memory:6412434]] hotel-saasやhotel-pmsが直接hotel-commonのファイルを編集することは禁止
- 各システムは自システム内でのみファイル操作を行う
- データベースの直接操作も同様に制限

### 実装優先度
1. **高優先度**: 認証・権限管理、基本CRUD操作
2. **中優先度**: 検索・フィルタリング、バリデーション
3. **低優先度**: パフォーマンス最適化、高度な統計機能

## 📞 技術仕様確認のタイミング

以下の段階で各担当者の確認が必要です：

### Phase 1: 設計確認
- **タイミング**: 実装開始前
- **担当者**: hotel-common開発者 + hotel-pms開発者
- **内容**: データベーススキーマ、権限管理仕様の確認

### Phase 2: 実装確認
- **タイミング**: 基本機能実装後
- **担当者**: hotel-common開発者
- **内容**: API動作、バリデーション、セキュリティの確認

### Phase 3: 統合確認
- **タイミング**: 他システム連携前
- **担当者**: 全システム開発者
- **内容**: システム間連携、データ整合性の確認

### Phase 4: 本番確認
- **タイミング**: デプロイ前
- **担当者**: 全担当者
- **内容**: パフォーマンス、セキュリティ、運用面の最終確認

## 📝 確認完了の記録

各項目の確認完了時は、以下の形式で記録してください：

```
- [x] 項目名 (確認者: 名前, 確認日: YYYY-MM-DD, 備考: 詳細)
```

## 🔄 更新履歴

| 日付 | 更新者 | 更新内容 |
|------|--------|----------|
| 2025-09-16 | kanri | 初版作成 |

---

**注意**: このチェックリストは実装進行に合わせて更新してください。新たな技術要件が判明した場合は、適宜項目を追加してください。
