# ネットワーク構成

## 概要

本ドキュメントでは、omotenasuai.comプロジェクトのネットワーク構成について記載します。開発環境、テスト環境、本番環境それぞれのネットワーク設定、セキュリティ対策、監視体制について定義します。

## ネットワークアーキテクチャ

### 全体構成図

```
                                    +----------------+
                                    |                |
                                    |  CDN           |
                                    |  (Cloudflare)  |
                                    |                |
                                    +--------+-------+
                                             |
                                             v
+----------------+              +------------+-------------+
|                |              |                          |
|  DNS           +------------->+  ロードバランサー         |
|  (Cloudflare)  |              |  (AWS ALB/Nginx)        |
|                |              |                          |
+----------------+              +------------+-------------+
                                             |
                 +-----------------------------+-----------------------------+
                 |                             |                             |
                 v                             v                             v
        +----------------+            +----------------+            +----------------+
        |                |            |                |            |                |
        |  Webサーバー    |            |  APIサーバー    |            |  認証サーバー   |
        |  (Nginx)       |            |  (Node.js)     |            |  (Node.js)     |
        |                |            |                |            |                |
        +-------+--------+            +-------+--------+            +-------+--------+
                |                             |                             |
                +-----------------------------+-----------------------------+
                                             |
                                             v
                                    +----------------+
                                    |                |
                                    |  データベース    |
                                    |  (PostgreSQL)  |
                                    |                |
                                    +----------------+
```

## 環境別ネットワーク構成

### 開発環境

- **ネットワーク**: プライベートVPC
- **サブネット**:
  - Web層: 10.0.1.0/24
  - アプリケーション層: 10.0.2.0/24
  - データベース層: 10.0.3.0/24
- **アクセス制限**: 開発チームIPからのみアクセス可能
- **ドメイン**: dev.omotenasuai.com

### テスト環境

- **ネットワーク**: プライベートVPC
- **サブネット**:
  - Web層: 10.1.1.0/24
  - アプリケーション層: 10.1.2.0/24
  - データベース層: 10.1.3.0/24
- **アクセス制限**: 社内IPおよびVPN経由でのみアクセス可能
- **ドメイン**: test.omotenasuai.com

### 本番環境

- **ネットワーク**: プライベートVPC
- **サブネット**:
  - Web層: 10.2.1.0/24 (AZ-a), 10.2.2.0/24 (AZ-b)
  - アプリケーション層: 10.2.3.0/24 (AZ-a), 10.2.4.0/24 (AZ-b)
  - データベース層: 10.2.5.0/24 (AZ-a), 10.2.6.0/24 (AZ-b)
- **アクセス制限**: 公開Webサービスのみ外部アクセス可能
- **ドメイン**: www.omotenasuai.com

## セキュリティ設定

### ファイアウォールルール

#### 開発環境

| 送信元 | 宛先 | ポート | プロトコル | 説明 |
|-------|-----|-------|----------|------|
| 開発チームIP | Web層 | 80, 443 | TCP | HTTP/HTTPS |
| 開発チームIP | アプリケーション層 | 3100-3400 | TCP | 各サービスポート |
| Web層 | アプリケーション層 | 3100-3400 | TCP | 内部通信 |
| アプリケーション層 | データベース層 | 5432 | TCP | PostgreSQL |

#### 本番環境

| 送信元 | 宛先 | ポート | プロトコル | 説明 |
|-------|-----|-------|----------|------|
| 任意 | ロードバランサー | 80, 443 | TCP | HTTP/HTTPS |
| ロードバランサー | Web層 | 80, 443 | TCP | HTTP/HTTPS |
| Web層 | アプリケーション層 | 3100-3400 | TCP | 内部通信 |
| アプリケーション層 | データベース層 | 5432 | TCP | PostgreSQL |
| 運用チームIP | 全レイヤー | 22 | TCP | SSH（緊急時のみ） |

### WAF設定

- **プロバイダー**: AWS WAF / Cloudflare WAF
- **保護対象**:
  - SQLインジェクション
  - クロスサイトスクリプティング（XSS）
  - DDoS攻撃
  - 不正ボットアクセス
- **カスタムルール**:
  - 特定地域からのアクセス制限
  - レート制限（APIエンドポイント別）
  - 特定のUser-Agent制限

## ロードバランシング

### 構成

- **プロバイダー**: AWS Application Load Balancer / Nginx
- **アルゴリズム**: ラウンドロビン（デフォルト）
- **ヘルスチェック**:
  - パス: /health
  - 間隔: 30秒
  - タイムアウト: 5秒
  - 成功コード: 200
  - 失敗しきい値: 2回
  - 成功しきい値: 2回

### SSL終端

- SSL証明書はロードバランサーで終端
- バックエンドへの通信はHTTPSで暗号化（内部CA証明書使用）

## ネットワーク監視

### 監視項目

- **トラフィック**: インバウンド/アウトバウンドトラフィック量
- **レイテンシ**: リクエスト応答時間
- **エラーレート**: HTTP 4xx/5xxレスポンス率
- **接続数**: アクティブ接続数
- **帯域使用率**: ネットワーク帯域使用率

### アラート設定

| 監視項目 | しきい値 | アクション |
|---------|---------|----------|
| HTTP 5xxエラー | 5%以上/5分間 | メール通知 + Slack通知 |
| レイテンシ | 1000ms以上/5分間 | メール通知 |
| CPU使用率 | 80%以上/15分間 | メール通知 |
| メモリ使用率 | 85%以上/15分間 | メール通知 |
| ディスク使用率 | 90%以上 | メール通知 + Slack通知 |

## 障害対応

### フェイルオーバー設定

- **Webサーバー**: 複数インスタンスでの冗長化、自動スケーリング
- **APIサーバー**: 複数インスタンスでの冗長化、自動スケーリング
- **データベース**: マスター/スレーブ構成、自動フェイルオーバー

### 障害時の通信経路

1. プライマリデータセンター障害時:
   - DNSフェイルオーバーによるセカンダリデータセンターへの切り替え
   - 推定復旧時間: 5分以内

2. ロードバランサー障害時:
   - セカンダリロードバランサーへの自動切り替え
   - 推定復旧時間: 1分以内

## ネットワークパフォーマンス最適化

### CDN設定

- **プロバイダー**: Cloudflare / AWS CloudFront
- **キャッシュ対象**:
  - 静的アセット（JS, CSS, 画像）
  - APIレスポンス（GET, キャッシュ可能なもの）
- **キャッシュ期間**:
  - 静的アセット: 7日間
  - API応答: 設定による（最大1時間）

### 接続最適化

- HTTP/2の有効化
- ブラウザキャッシュヘッダーの最適化
- TLSセッションの再利用
- TCPコネクションプーリング

## 責任者

- **ネットワーク設計責任者**: [役職名]
- **セキュリティ責任者**: [役職名]
- **監視責任者**: [役職名]

## 定期メンテナンス

- **頻度**: 月1回
- **時間帯**: 深夜（1:00-5:00）
- **作業内容**:
  - セキュリティパッチの適用
  - ファイアウォールルールの見直し
  - パフォーマンス指標の確認
  - 監視設定の見直し

---

本ドキュメントは定期的にレビューし、必要に応じて更新してください。最終更新日: 2025-09-12