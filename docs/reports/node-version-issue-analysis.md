# Node.jsバージョン不一致問題の分析報告

**日付**: 2023年8月17日
**作成者**: hotel-kanri

## 1. 問題の概要

hotel-saasのデプロイが継続的に失敗しており、エラーログから以下の問題が特定されました：

```
[nuxi] ERROR Nuxt Build Error: [vite:css] [postcss] Cannot use 'import.meta' outside a module
file: /opt/omotenasuai/hotel-saas/layouts/fullscreen.vue?vue&type=style&index=0&lang.css:undefined:NaN
```

このエラーの根本的な原因は、サーバー上のNode.jsバージョン（v18.20.8）と、hotel-saasのpackage.jsonで指定されているNode.js要件（v20以上）の不一致です。

## 2. 詳細な調査結果

### 2.1. 環境の現状

1. **サーバー環境**:
   - 開発サーバー上のNode.jsバージョン: v18.20.8
   - npm バージョン: v10.8.2

2. **アプリケーション要件**:
   - hotel-saasのpackage.json: `"engines": { "node": ">=20.0.0" }`
   - hotel-commonのDockerfile: `FROM node:18-slim`（バージョン18を指定）

3. **依存パッケージの要件**:
   - `@sidebase/nuxt-auth@1.0.0`: Node.js v20以上が必要
   - `lru-cache@11.1.0`: Node.js v20以上が必要

### 2.2. デプロイフローの分析

1. **GitHub Actionsのワークフロー**:
   - `.github/workflows/deploy-dev.yml`では、サーバー上で直接ビルドを実行
   - Dockerを使用せず、ホストマシン上のNode.jsに依存

2. **Docker設定**:
   - `config/docker/docker-compose.yml.template`にはDockerの設定が存在
   - 各サービス（hotel-saas, hotel-common等）のDockerfile参照あり
   - しかし、実際のデプロイではDockerが使用されていない

3. **サーバー設定**:
   - `docs/infrastructure/servers/server-configuration.md`では、Node.js v18をインストールする設定が記載
   - 実際の開発サーバーもこれに従ってv18.20.8がインストールされている

## 3. 矛盾点と問題の原因

1. **設計と実装の乖離**:
   - 設計上はDockerを使用して環境の一貫性を確保する予定だった
   - `docker-compose.yml.template`の存在はこれを示唆
   - しかし、実際のデプロイフローではDockerが使用されていない

2. **バージョン要件の不整合**:
   - hotel-saasはNode.js v20以上を要求
   - hotel-commonのDockerfileはNode.js v18を指定
   - サーバー設定ドキュメントもNode.js v18をインストールするよう指示

3. **依存パッケージのアップデート**:
   - 最近の依存パッケージのアップデート（特に`@sidebase/nuxt-auth`を1.0.0にアップデート）により、Node.js v20要件が追加された
   - しかし、サーバー環境のNode.jsバージョンは更新されていない

## 4. 問題解決のための選択肢

1. **サーバー上のNode.jsをアップグレード**:
   - Node.js v20以上にアップグレードする
   - 最も直接的な解決策だが、他のサービスへの影響を考慮する必要がある

2. **Dockerベースのデプロイフローへの移行**:
   - Docker Composeを使用して、各サービスを独立したコンテナで実行
   - 環境の一貫性を確保し、バージョン要件の衝突を回避

3. **依存パッケージのバージョンダウングレード**:
   - Node.js v18と互換性のある古いバージョンの依存パッケージを使用
   - 一時的な対応策だが、機能制限や将来的な問題の可能性あり

## 5. 根本的な問題

この問題の根本には、以下の課題があります：

1. **環境の一貫性の欠如**:
   - 開発環境、CI/CD環境、本番環境でのNode.jsバージョンの不一致
   - Dockerが設計されていたが実際には使用されていない

2. **バージョン管理の不足**:
   - 依存パッケージのアップデートに伴うNode.js要件の変更が追跡されていない
   - サーバー環境の更新が適切に計画・実行されていない

3. **デプロイフローの不明確さ**:
   - Docker使用の有無が明確に定義されていない
   - サーバー環境の管理責任が不明確

## 6. 推奨される対応

短期的には、サーバー上のNode.jsをv20にアップグレードすることで、現在のデプロイ問題を解決することを推奨します。

長期的には、以下の対応を検討すべきです：

1. **Dockerベースのデプロイフローの完全実装**:
   - 各サービスをDockerコンテナとして実行
   - バージョン要件をDockerfile内で明示的に定義

2. **環境管理の標準化**:
   - すべての環境（開発、CI/CD、本番）での一貫した設定
   - バージョン要件の変更時の更新プロセスの明確化

3. **自動化されたバージョン検証**:
   - CI/CDパイプラインでのバージョン要件の自動チェック
   - 不一致があれば早期に警告

## 7. 結論

現在のデプロイ問題は、サーバー上のNode.jsバージョン（v18.20.8）と、アプリケーションが要求するバージョン（v20以上）の不一致によるものです。この問題を解決するためには、サーバー上のNode.jsをアップグレードするか、依存パッケージのバージョンを下げる必要があります。

長期的には、Dockerを使用した環境の一貫性確保と、バージョン管理の改善が必要です。これにより、同様の問題の再発を防ぎ、より安定したデプロイプロセスを実現できます。
