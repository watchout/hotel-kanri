# hotel-saasデプロイ問題 最終分析報告書

**日付**: 2023年8月17日
**作成者**: hotel-kanri

## 1. 概要

本報告書は、hotel-saasのデプロイ失敗問題に関する調査、分析、対応策をまとめたものです。一連の問題解決プロセスを通じて、複数の問題が特定され、段階的に解決されました。また、根本的な原因と長期的な対策についても分析しました。

## 2. 問題の経緯

hotel-saasのデプロイが継続的に失敗し、GitHub Actionsのログから以下のようなエラーが確認されました：

```
[nuxi] ERROR Nuxt Build Error: [vite:css] [postcss] Cannot use 'import.meta' outside a module
```

このエラーを解決するために、複数の問題を段階的に特定し、対応しました。

## 3. 特定された問題と対応

### 3.1. ファイル末尾の不要な`%`記号

#### 問題
複数のファイル（`billing-fix.css`, `tsconfig.json`, `layouts/operation.vue`など）の末尾に不要な`%`記号が存在し、ビルドプロセスを妨げていました。

#### 対応
- `billing-fix.css`から末尾の`%`記号を削除
- `nuxt.config.ts`から`billing-fix.css`の参照を削除
- `tsconfig.json`から末尾の`%`記号を削除
- `layouts/operation.vue`から末尾の`%`記号を削除

### 3.2. tsconfig.jsonの不適切な参照

#### 問題
`tsconfig.json`ファイルが`"extends": "/Users/kaneko/hotel-common/configs/tsconfig.base.json"`を参照していましたが、サーバー環境ではこのパスが解決できませんでした。

#### 対応
- `tsconfig.json`から`extends`設定を削除

### 3.3. Node.jsバージョンの不一致

#### 問題
サーバー上のNode.jsバージョン（v18.20.8）と、hotel-saasのpackage.jsonで指定されているNode.js要件（v20以上）に不一致がありました。

#### 対応
- サーバー上のNode.jsをv20にアップグレードするスクリプト（`upgrade-nodejs.sh`）を作成
- アップグレード手順を文書化（`node-version-update-procedure.md`）

## 4. 根本的な原因分析

### 4.1. 環境の一貫性の欠如

1. **設計と実装の乖離**:
   - 設計上はDockerを使用して環境の一貫性を確保する予定だった
   - `docker-compose.yml.template`の存在はこれを示唆
   - しかし、実際のデプロイフローではDockerが使用されていない

2. **バージョン要件の不整合**:
   - hotel-saasはNode.js v20以上を要求
   - hotel-commonのDockerfileはNode.js v18を指定
   - サーバー設定ドキュメントもNode.js v18をインストールするよう指示

3. **依存パッケージのアップデート管理の不足**:
   - 最近の依存パッケージのアップデート（特に`@sidebase/nuxt-auth`を1.0.0にアップデート）により、Node.js v20要件が追加された
   - しかし、サーバー環境のNode.jsバージョンは更新されていない

### 4.2. デプロイフローの不明確さ

1. **責任範囲の不明確さ**:
   - サーバー環境の管理とアプリケーションデプロイの責任境界が不明確
   - 環境依存の問題が発生した際の対応フローが確立されていない

2. **ドキュメントの不足**:
   - 環境要件（Node.jsバージョンなど）の明示的なドキュメントの不足
   - デプロイフローの詳細な手順と検証方法の不足

## 5. 短期的な対応策

### 5.1. ファイル修正

- `billing-fix.css`, `tsconfig.json`, `layouts/operation.vue`などの問題のあるファイルを修正
- 修正内容をGitHubリポジトリにコミットしてプッシュ
- hotel-saasチームに修正内容と対応手順を通知

### 5.2. Node.jsアップグレード

- サーバー上のNode.jsをv20にアップグレードするスクリプト（`upgrade-nodejs.sh`）を作成
- アップグレード手順を文書化（`node-version-update-procedure.md`）
- 環境変数とバージョン要件の一貫性を確保

## 6. 長期的な対応策

### 6.1. Dockerベースデプロイフローの提案

Dockerを使用した一貫性のあるデプロイフローへの移行を提案しました。主な内容は以下の通りです：

1. **コンテナ化**:
   - 各サービスを個別のDockerコンテナとして実行
   - 各サービスのDockerfileで必要なNode.jsバージョンを明示的に指定

2. **Docker Composeによる環境管理**:
   - `docker-compose.yml`で複数サービスの連携を定義
   - 環境変数、ネットワーク設定、ボリューム設定の一元管理

3. **CI/CDパイプラインの更新**:
   - GitHub Actionsでコンテナのビルドとプッシュを実行
   - サーバー上ではコンテナのプル、起動のみを行う

詳細は`docs/proposals/docker-deployment-proposal.md`を参照してください。

### 6.2. デプロイフロー強制ルールの作成

デプロイフローの厳格な遵守を確保するため、以下のルールを作成しました：

1. **デプロイの絶対原則**:
   - すべてのデプロイはGitHub ActionsのCI/CDパイプラインを通じてのみ実行
   - サーバー上での直接編集を禁止

2. **短絡的解決の禁止**:
   - 問題発生時は根本的な原因を特定し、GitHub Actionsのフローを通じて解決
   - サーバー上での直接修正を避ける

3. **監視と検証**:
   - サーバー上のファイル変更を監視するスクリプト（`file-change-monitor.sh`）を実装
   - 定期的な監査と違反報告のプロセスを確立

詳細は`docs/rules/deployment-workflow-rules.md`と`docs/rules/deployment-enforcement-rules.md`を参照してください。

## 7. 学んだ教訓

### 7.1. 環境の一貫性の重要性

- 開発、CI/CD、本番環境での一貫した環境設定の重要性
- バージョン要件の明示的な管理と更新プロセスの必要性

### 7.2. デプロイフローの明確化

- デプロイフローの明確な定義と文書化の重要性
- 責任範囲の明確化と対応フローの確立

### 7.3. 問題解決アプローチ

- 表面的な問題だけでなく、根本的な原因を特定することの重要性
- 段階的な問題解決と検証のプロセスの有効性

## 8. 今後の推奨事項

### 8.1. 短期的な推奨事項

1. **Node.jsアップグレードの実施**:
   - 作成したスクリプト（`upgrade-nodejs.sh`）を使用してサーバー上のNode.jsをv20にアップグレード
   - アップグレード後の動作確認とテスト

2. **デプロイフロー強制ルールの導入**:
   - 作成したルールとチェックリストの導入
   - チーム全体への周知と教育

### 8.2. 中長期的な推奨事項

1. **Dockerベースデプロイフローへの移行**:
   - 提案書に基づいたパイロットプロジェクトの実施
   - 段階的な移行と検証

2. **環境管理の自動化**:
   - 環境要件の自動チェックと通知の仕組みの導入
   - バージョン管理の自動化と可視化

3. **ドキュメントの充実**:
   - 環境要件とデプロイフローの詳細なドキュメント作成
   - トラブルシューティングガイドの整備

## 9. 結論

hotel-saasのデプロイ問題は、ファイル形式の問題とNode.jsバージョンの不一致という複数の要因が重なって発生していました。短期的な対応としてファイルの修正とNode.jsのアップグレードを行い、長期的な対策としてDockerベースのデプロイフローへの移行とデプロイフロー強制ルールの導入を提案しました。

これらの対応と提案が、今後のデプロイプロセスの安定性と効率性の向上につながることを期待します。また、今回の経験から得られた教訓を活かし、環境の一貫性確保とデプロイフローの明確化に取り組むことが重要です。
