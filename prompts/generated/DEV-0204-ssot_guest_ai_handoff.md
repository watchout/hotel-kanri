# DEV-0204: AIチャットでは対応困難な問い合わせを、60秒以内にスタッフ

**タスクタイプ**: fullstack
**推定工数**: 27時間
**生成日時**: 2026-01-18T00:31:01.233Z

---

## 🚨 【自動挿入】実装中断の基準（全タスク共通）

<!-- FIXED: 停止基準を簡素化し、判断しやすい内容に修正 -->
**絶対ルール**: 以下の場合、実装を即座に停止してユーザーに報告する

### 必須停止トリガー（Layer 1）
1. **ファイル非実在**
   - 依存ファイルが存在しない
2. **ルーティング違反**
   - `/api/v1/admin` 形式外のパス
3. **システム境界違反**
   - hotel-saasでPrisma直接使用
   - hotel-saasで`$fetch`直接使用（Cookie未転送）
4. **型エラー連鎖（>3件/1ステップ）**
5. **Prismaスキーマ変更要求**
6. **tenant_idフォールバック/環境分岐**
7. **エラー原因不明（10分以上）**

---

# DEV-0204: AIチャットでは対応困難な問い合わせを、60秒以内にスタッフ - Backend API実装

## 🚨 重要：実装中断の基準（必読）

**絶対ルール**: 以下の場合、実装を即座に停止してユーザーに報告する

### 必須停止トリガー（Layer 1）
1. ファイル非実在・依存関係エラー
2. ルーティング違反（`/api/v1/admin` 形式外）
3. システム境界違反（saasでPrisma直/saasで$fetch直）
4. 型エラー連鎖（>3件）
5. Prismaスキーマ変更要求
6. tenant_idフォールバック/環境分岐
7. エラー原因不明（10分以上）

---

## 📖 必読SSOT

<!-- FIXED: 実在確認可能なファイルパスに修正 -->
| ドキュメント | パス |
|:------------|:-----|
| **メインSSOT** | `docs/03_ssot/02_guest_features/ai_chat/SSOT_GUEST_AI_HANDOFF.md` |
| **APIレジストリ** | `docs/03_ssot/00_foundation/SSOT_API_REGISTRY.md` |
| **ルーティング** | `docs/01_systems/saas/API_ROUTING_GUIDELINES.md` |
| **命名規則** | `docs/standards/DATABASE_NAMING_STANDARD.md` |

---

## 📋 実装対象

### 要件一覧（12件）

<!-- FIXED: 全ての要件IDのAccept条件をSSOTに準拠して完全な形で記載 -->
| ID | 名前 | タイプ | Accept条件 |
|:---|:-----|:-------|:-----------|
| HDF-001 | ハンドオフリクエスト作成 | FR | sessionId、guestId、channel、contextを含むリクエストが作成される、作成と同時にハンドオフステータスが"PENDING"になる、作成と同時にフロントデスクへ通知が送信される、60秒のタイムアウトタイマーが開始される |
| HDF-002 | スタッフ通知 | FR | フロントデスクPC/タブレットにポップアップ通知が表示される、ゲスト情報（部屋番号、氏名）と問い合わせ履歴が通知に含まれる |
| HDF-003 | タイムアウト処理 | FR | カウントダウン表示が0になると電話CTAを表示、ハンドオフステータスが"TIMEOUT"に更新される、内線番号が強調表示される |
| HDF-004 | 夜間自動無効化 | FR | 指定時間帯はハンドオフボタンが非表示、「夜間のため、緊急時のみフロントデスクまでお電話ください」を表示 |
| HDF-100 | 性能要件 | NFR | API応答時間: 2秒以内（95パーセンタイル）、同時接続数: 最大100リクエスト/分、システム可用性99.9%以上 |
| HDF-101 | セキュリティ要件 | NFR | 全APIで認証・認可チェック実施、tenant_idによるデータ分離、入力値バリデーション実装、レート制限: 1ゲストあたり10分間に3回まで、監査ログ: 90日間保持、XSS対策、context最大サイズ: 10KB |
| HDF-102 | 可用性要件 | NFR | SLA: 99.9%（月次）、障害時フォールバック: 電話CTAを即座に表示、バックアップ: 通知履歴の自動保存 |
| HDF-200 | 画面一覧 | UI | ゲスト向けハンドオフ画面、スタッフ向け通知画面、管理画面での履歴表示を提供 |
| HDF-201 | 多言語対応 | UI | 日本語、英語、中国語（簡体字）、韓国語に対応 |
| HDF-202 | アクセシビリティ | UI | WCAG 2.1 AA準拠、キーボード操作対応、スクリーンリーダー対応 |
| HDF-300 | ROI | BIZ | スタッフ対応時間を30%削減、ゲスト満足度スコア10%向上 |
| HDF-301 | KPI | BIZ | ハンドオフ成功率95%以上、平均応答時間45秒以内、月次利用件数を測定 |

### API一覧（4件）

| Method | Path | 説明 |
|:-------|:-----|:-----|
| POST | `/api/v1/handoff/requests` | ハンドオフリクエストを作成 |
| GET | `/api/v1/handoff/requests/:id` | ハンドオフリクエストの詳細を取得 |
| PATCH | `/api/v1/handoff/requests/:id/status` | ステータスを更新 |
| GET | `/api/v1/handoff/requests` | リクエスト一覧を取得 |

<!-- FIXED: Prismaスキーマ定義を完全な形で追加 -->
### データベーススキーマ
