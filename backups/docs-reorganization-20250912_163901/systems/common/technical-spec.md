# hotel-common 技術仕様

## システム構成

### バックエンド
- **フレームワーク**: Node.js + TypeScript + NestJS
- **API設計**: RESTful + GraphQL Gateway
- **データベース**: PostgreSQL
- **ORM**: Prisma
- **イベント連携**: RabbitMQ/Kafka
- **認証**: JWT
- **キャッシュ**: Redis

### フロントエンド共通
- **コンポーネントライブラリ**: 共通UIコンポーネント
- **状態管理**: Pinia
- **API連携**: Axios/Fetch統一クライアント
- **バリデーション**: 共通バリデーションルール
- **ユーティリティ**: 共通関数ライブラリ

### インフラ
- **コンテナ化**: Docker
- **オーケストレーション**: Kubernetes
- **CI/CD**: GitHub Actions
- **環境**: 開発・ステージング・本番

## アーキテクチャ

### 認証アーキテクチャ
```
+----------------+      +----------------+      +----------------+
|  hotel-saas    |      |   hotel-pms    |      | hotel-member   |
+----------------+      +----------------+      +----------------+
         |                      |                      |
         v                      v                      v
+-------------------------------------------------------+
|                  統一JWT認証基盤                        |
+-------------------------------------------------------+
         |                      |                      |
         v                      v                      v
+----------------+      +----------------+      +----------------+
|   ユーザーDB     |      |  セッション管理   |      | アクセス制御    |
+----------------+      +----------------+      +----------------+
```

### データベースアーキテクチャ
```
+----------------+      +----------------+      +----------------+
|  hotel-saas    |      |   hotel-pms    |      | hotel-member   |
+----------------+      +----------------+      +----------------+
         |                      |                      |
         v                      v                      v
+-------------------------------------------------------+
|              UnifiedPrismaClient                      |
+-------------------------------------------------------+
                           |
                           v
+-------------------------------------------------------+
|             PostgreSQL (マルチテナント)                 |
+-------------------------------------------------------+
```

### イベント連携アーキテクチャ
```
+----------------+      +----------------+      +----------------+
|  hotel-saas    |      |   hotel-pms    |      | hotel-member   |
|  Publisher     |      |  Publisher     |      |  Publisher     |
|  Subscriber    |      |  Subscriber    |      |  Subscriber    |
+----------------+      +----------------+      +----------------+
         |                      |                      |
         v                      v                      v
+-------------------------------------------------------+
|                    EventBus                           |
+-------------------------------------------------------+
                           |
                           v
+-------------------------------------------------------+
|                RabbitMQ/Kafka                         |
+-------------------------------------------------------+
```

## 認証システム詳細

### JWT構造
```json
{
  "header": {
    "alg": "RS256",
    "typ": "JWT"
  },
  "payload": {
    "sub": "user_uuid",
    "name": "ユーザー名",
    "email": "user@example.com",
    "tenant_id": "tenant_uuid",
    "roles": ["admin", "manager"],
    "permissions": ["read:customers", "write:reservations"],
    "iat": 1516239022,
    "exp": 1516242622
  }
}
```

### 認証フロー
1. ユーザーがログイン情報を送信
2. 認証サービスが認証情報を検証
3. JWTトークン生成
4. クライアントにトークン返却
5. 以降のリクエストにトークンを付与
6. 各サービスでトークン検証・権限チェック

### 権限管理
- ロールベースアクセス制御
- 細粒度のパーミッション
- テナント単位のアクセス制限
- リソースベースの権限チェック

## データベース詳細

### マルチテナント設計
- テナントIDによる分離
- すべてのテーブルにtenant_idカラム
- テナント単位のクエリフィルタリング
- クロステナントクエリの制限

### UnifiedPrismaClient
- 共通のPrismaクライアント
- テナントコンテキスト自動適用
- トランザクション管理
- コネクションプール最適化
- クエリログ・モニタリング

### マイグレーション管理
- バージョン管理されたマイグレーション
- ロールバック機能
- テナント別適用オプション
- データシード機能
- スキーマ検証

## イベント連携詳細

### イベントスキーマ
- JSON Schema定義
- バージョニング
- 互換性チェック
- ドキュメント自動生成

### イベント処理
- 冪等性保証
- 順序保証（必要に応じて）
- デッドレターキュー
- 再試行ポリシー
- バックプレッシャー処理

### モニタリング
- イベント処理ステータス追跡
- 処理時間測定
- エラー率監視
- キュー長モニタリング
- アラート設定

## ガードレールシステム詳細

### データ整合性チェック
- 定期的な整合性検証ジョブ
- クロスシステムデータ比較
- 不整合検出・通知
- 自動修復（可能な場合）

### アクセス制御検証
- 権限設定の検証
- 不正アクセス検出
- 異常パターン検出
- セキュリティ監査

### イベント連携監視
- イベント配信確認
- 未処理イベント検出
- イベント処理タイムアウト検出
- イベントスキーマ検証

## 共通コンポーネント

### UIコンポーネント
- フォーム要素
- テーブル・リスト
- モーダル・ダイアログ
- ナビゲーション
- カード・パネル

### APIクライアント
- 認証トークン自動管理
- リクエスト/レスポンス変換
- エラーハンドリング
- 再試行ロジック
- キャッシュ管理

### ユーティリティ
- 日付・時刻処理
- 通貨・金額計算
- バリデーション
- フォーマット変換
- ロギング

## テスト要件
- 単体テスト: Jest/Vitest
- 統合テスト: Supertest
- E2Eテスト: Playwright
- カバレッジ目標: 90%以上（基盤システム）

## パフォーマンス要件
- API応答: 100ms以内
- イベント処理: 500ms以内
- バッチ処理: 5分以内
- 同時接続: 最大1000ユーザー

## 関連ドキュメント
- [システム概要](./overview.md)
- [アーキテクチャ設計](./architecture.md)
- [開発ガイドライン](../../development/guidelines/common-guidelines.md)
- [ディレクトリ構造](./directory-structure.md)