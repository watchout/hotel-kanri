# hotel-common アーキテクチャ設計

## 概要
hotel-commonは、3つのシステム（hotel-saas、hotel-pms、hotel-member）を統合するための共通基盤システムです。このドキュメントでは、hotel-commonのアーキテクチャ設計について詳細に説明します。

## アーキテクチャ原則

### 1. マイクロサービスアーキテクチャ
- 各システムは独立して開発・デプロイ可能
- 明確に定義されたAPIを通じて通信
- サービス間の疎結合を維持
- 必要に応じたスケーリング

### 2. イベント駆動アーキテクチャ
- 非同期通信による疎結合
- イベントソーシング
- コマンド・クエリ責務分離（CQRS）
- 発行-購読パターン

### 3. マルチテナントアーキテクチャ
- テナント分離
- リソース共有
- テナント固有のカスタマイズ
- テナント間のセキュリティ境界

### 4. レイヤードアーキテクチャ
- プレゼンテーション層
- ビジネスロジック層
- データアクセス層
- インフラストラクチャ層

## システム構成図

### 全体アーキテクチャ
```
                        +-------------------+
                        |   クライアント     |
                        +--------+----------+
                                 |
                                 v
+------------------------------------------------------------------+
|                          API Gateway                             |
+------------------------------------------------------------------+
          |                   |                   |
          v                   v                   v
+------------------+  +------------------+  +------------------+
|   hotel-saas     |  |   hotel-pms      |  |   hotel-member   |
+--------+---------+  +--------+---------+  +--------+---------+
          |                   |                   |
          v                   v                   v
+------------------------------------------------------------------+
|                        hotel-common                              |
|                                                                  |
|  +---------------+  +----------------+  +--------------------+   |
|  | 認証サービス   |  | データベース基盤 |  | イベント連携基盤    |   |
|  +---------------+  +----------------+  +--------------------+   |
|                                                                  |
|  +---------------+  +----------------+  +--------------------+   |
|  |ガードレール基盤 |  | 共通コンポーネント|  | 監視・ロギング    |   |
|  +---------------+  +----------------+  +--------------------+   |
+------------------------------------------------------------------+
```

### 認証サービスアーキテクチャ
```
+-------------------+     +-------------------+
|   クライアント     |     |    管理画面       |
+--------+----------+     +--------+----------+
         |                         |
         v                         v
+------------------------------------------+
|              認証API Gateway             |
+------------------------------------------+
         |                  |
         v                  v
+----------------+  +------------------+
| 認証サービス    |  | ユーザー管理サービス|
+-------+--------+  +--------+---------+
        |                    |
        v                    v
+------------------------------------------+
|            認証データベース              |
+------------------------------------------+
```

### データベース基盤アーキテクチャ
```
+----------------+     +----------------+     +----------------+
|  hotel-saas    |     |   hotel-pms    |     | hotel-member   |
+-------+--------+     +-------+--------+     +-------+--------+
        |                      |                      |
        v                      v                      v
+------------------------------------------------------------------+
|                     UnifiedPrismaClient                          |
+------------------------------------------------------------------+
                              |
                              v
+------------------------------------------------------------------+
|                   Connection Pool Manager                         |
+------------------------------------------------------------------+
                              |
                              v
+------------------------------------------------------------------+
|                PostgreSQL (マルチテナント)                        |
+------------------------------------------------------------------+
```

### イベント連携基盤アーキテクチャ
```
+----------------+     +----------------+     +----------------+
|  hotel-saas    |     |   hotel-pms    |     | hotel-member   |
|  Publisher     |     |  Publisher     |     |  Publisher     |
|  Subscriber    |     |  Subscriber    |     |  Subscriber    |
+-------+--------+     +-------+--------+     +-------+--------+
        |                      |                      |
        v                      v                      v
+------------------------------------------------------------------+
|                         EventBus                                 |
+------------------------------------------------------------------+
        |                      |                      |
        v                      v                      v
+----------------+     +----------------+     +----------------+
|  イベントログ    |     |  再試行メカニズム |     | デッドレターキュー |
+----------------+     +----------------+     +----------------+
                              |
                              v
+------------------------------------------------------------------+
|                     RabbitMQ / Kafka                             |
+------------------------------------------------------------------+
```

## モジュール構成

### 認証モジュール
- ユーザー認証
- トークン管理
- セッション管理
- 権限管理
- 多要素認証

### データベースモジュール
- スキーマ管理
- マイグレーション
- クエリビルダー
- トランザクション管理
- データアクセスコントロール

### イベントモジュール
- イベントパブリッシャー
- イベントサブスクライバー
- イベントストア
- イベントスキーマ管理
- 再試行管理

### ガードレールモジュール
- データ整合性チェッカー
- アクセス制御検証
- イベント連携監視
- エラー検出・通知
- 自動修復エンジン

### 共通コンポーネントモジュール
- UIコンポーネントライブラリ
- APIクライアント
- ユーティリティ関数
- バリデーションライブラリ
- ログ・モニタリング

## データフロー

### 認証フロー
1. ユーザーがログイン情報を送信
2. 認証サービスが認証情報を検証
3. JWTトークン生成
4. クライアントにトークン返却
5. 以降のリクエストにトークンを付与
6. 各サービスでトークン検証・権限チェック

### イベント処理フロー
1. サービスがイベントを発行
2. イベントバスがイベントを受け取る
3. イベントスキーマ検証
4. 購読サービスにイベント配信
5. イベント処理結果の記録
6. 必要に応じて再試行・デッドレターキュー処理

### データアクセスフロー
1. サービスがUnifiedPrismaClientを通じてクエリを発行
2. テナントコンテキストの自動適用
3. コネクションプールからの接続取得
4. クエリの実行とモニタリング
5. 結果の変換と返却
6. トランザクション完了・ロールバック

## セキュリティアーキテクチャ

### 認証・認可
- JWTベースの認証
- ロールベースアクセス制御
- リソースベース権限
- テナント分離

### データ保護
- 転送時の暗号化（TLS 1.3）
- 保存時の暗号化
- 機密データのマスキング
- 監査ログ

### インフラストラクチャセキュリティ
- ネットワークセグメンテーション
- ファイアウォール
- 侵入検知・防止
- 脆弱性スキャン

## 可用性・復元力

### 高可用性設計
- 冗長構成
- 負荷分散
- フェイルオーバー
- ヘルスチェック

### 障害復旧
- バックアップ・リストア
- 災害復旧計画
- データ同期メカニズム
- 自動復旧手順

### 監視・アラート
- システムメトリクス
- アプリケーションメトリクス
- ビジネスメトリクス
- アラートポリシー

## スケーラビリティ

### 水平スケーリング
- ステートレスサービス
- シャーディング
- レプリケーション
- オートスケーリング

### 垂直スケーリング
- リソース最適化
- パフォーマンスチューニング
- キャッシュ戦略
- 非同期処理

## 関連ドキュメント
- [システム概要](./overview.md)
- [技術仕様](./technical-spec.md)
- [イベント連携](../../integration/events/common-events.md)
- [データベース設計](../../db/schema.md)