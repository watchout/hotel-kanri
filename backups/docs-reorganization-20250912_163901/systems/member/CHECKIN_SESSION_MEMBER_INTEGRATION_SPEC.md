# ğŸŒ¸ hotel-member ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¼šå“¡çµ±åˆä»•æ§˜æ›¸

**å¯¾è±¡ã‚·ã‚¹ãƒ†ãƒ **: hotel-member  
**æ‹…å½“AI**: Sakuraï¼ˆæ¡œ - Cherry Blossomï¼‰  
**ä½œæˆæ—¥**: 2025å¹´1æœˆ19æ—¥  
**å„ªå…ˆåº¦**: ğŸ”´ **ç·Šæ€¥ãƒ»é«˜å„ªå…ˆåº¦**  
**å®Ÿè£…æœŸé™**: 2025å¹´2æœˆ1æ—¥

---

## ğŸ“‹ **çµ±åˆæ¦‚è¦**

hotel-memberã‚·ã‚¹ãƒ†ãƒ ã«ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†æ©Ÿèƒ½ã‚’çµ±åˆã—ã€ä¼šå“¡æƒ…å ±ç®¡ç†ã€ãƒã‚¤ãƒ³ãƒˆç®¡ç†ã€ä¼šå“¡ç‰¹å…¸ã‚’ã‚»ãƒƒã‚·ãƒ§ãƒ³å˜ä½ã§æ­£ç¢ºã«é©ç”¨ã§ãã‚‹ã‚·ã‚¹ãƒ†ãƒ ã‚’å®Ÿç¾ã—ã¾ã™ã€‚

### **Sakuraï¼ˆæ¡œï¼‰ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¨ã—ã¦ã®è²¬å‹™**
- **é¡§å®¢ç¬¬ä¸€**: ä¼šå“¡æ§˜ã®ä½“é¨“å‘ä¸Šã‚’æœ€å„ªå…ˆ
- **ãŠã‚‚ã¦ãªã—ç²¾ç¥**: ç´°ã‚„ã‹ãªé…æ…®ã¨ãƒ‘ãƒ¼ã‚½ãƒŠãƒ©ã‚¤ã‚º
- **æˆé•·å¿—å‘**: ä¼šå“¡ä¾¡å€¤ã®ç¶™ç¶šçš„å‘ä¸Š

---

## ğŸ¯ **çµ±åˆç›®æ¨™**

### **è§£æ±ºã™ã¹ãå•é¡Œ**
1. **ãƒã‚¤ãƒ³ãƒˆä»˜ä¸ã®æ›–æ˜§æ€§**: äºˆç´„å˜ä½ã®ãƒã‚¤ãƒ³ãƒˆç®¡ç†ã«ã‚ˆã‚‹ä¸æ­£ç¢ºæ€§
2. **ä¼šå“¡ç‰¹å…¸ã®é©ç”¨æ¼ã‚Œ**: ã‚»ãƒƒã‚·ãƒ§ãƒ³æœŸé–“ä¸­ã®ç‰¹å…¸é©ç”¨ã®ä¸å‚™
3. **ä¼šå“¡å±¥æ­´ã®åˆ†æ•£**: è¤‡æ•°ã®å®¿æ³Šã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ã¾ãŸãŒã‚‹å±¥æ­´ç®¡ç†ã®è¤‡é›‘æ€§

### **é”æˆã™ã¹ãåŠ¹æœ**
1. **æ­£ç¢ºãªãƒã‚¤ãƒ³ãƒˆç®¡ç†**: ã‚»ãƒƒã‚·ãƒ§ãƒ³å˜ä½ã§ã®ç²¾å¯†ãªãƒã‚¤ãƒ³ãƒˆè¨ˆç®—ãƒ»ä»˜ä¸
2. **é©åˆ‡ãªç‰¹å…¸é©ç”¨**: ã‚»ãƒƒã‚·ãƒ§ãƒ³æœŸé–“ä¸­ã®ä¼šå“¡ç‰¹å…¸ã®ç¢ºå®Ÿãªé©ç”¨
3. **çµ±åˆã•ã‚ŒãŸä¼šå“¡ä½“é¨“**: ã‚»ãƒƒã‚·ãƒ§ãƒ³æ¨ªæ–­ã§ã®ä¸€è²«ã—ãŸä¼šå“¡ã‚µãƒ¼ãƒ“ã‚¹

---

## ğŸ”„ **ä¼šå“¡ã‚·ã‚¹ãƒ†ãƒ çµ±åˆè¨­è¨ˆ**

### **1. ã‚»ãƒƒã‚·ãƒ§ãƒ³å˜ä½ãƒã‚¤ãƒ³ãƒˆç®¡ç†**

#### **å¾“æ¥ã®ãƒã‚¤ãƒ³ãƒˆä»˜ä¸ãƒ•ãƒ­ãƒ¼**
```
1. billing.paidã‚¤ãƒ™ãƒ³ãƒˆå—ä¿¡
2. äºˆç´„å˜ä½ã§ã®ãƒã‚¤ãƒ³ãƒˆè¨ˆç®—
3. ä¼šå“¡ãƒ©ãƒ³ã‚¯ã«åŸºã¥ãå€ç‡é©ç”¨
4. ãƒã‚¤ãƒ³ãƒˆä»˜ä¸ãƒ»å±¥æ­´è¨˜éŒ²
```

#### **æ–°ã—ã„ãƒã‚¤ãƒ³ãƒˆä»˜ä¸ãƒ•ãƒ­ãƒ¼**
```
1. ğŸ†• session.checked_outã‚¤ãƒ™ãƒ³ãƒˆå—ä¿¡
2. ğŸ†• ã‚»ãƒƒã‚·ãƒ§ãƒ³å˜ä½ã§ã®ãƒã‚¤ãƒ³ãƒˆè¨ˆç®—
3. ğŸ†• ã‚»ãƒƒã‚·ãƒ§ãƒ³æœŸé–“ä¸­ã®ç‰¹å…¸é©ç”¨ç¢ºèª
4. ä¼šå“¡ãƒ©ãƒ³ã‚¯ã«åŸºã¥ãå€ç‡é©ç”¨
5. ğŸ†• ã‚»ãƒƒã‚·ãƒ§ãƒ³å˜ä½ãƒã‚¤ãƒ³ãƒˆä»˜ä¸ãƒ»å±¥æ­´è¨˜éŒ²
6. ğŸ†• session.points_awardedã‚¤ãƒ™ãƒ³ãƒˆç™ºè¡Œ
```

#### **ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒã‚¤ãƒ³ãƒˆè¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯**
```typescript
interface SessionPointCalculation {
  sessionId: string;
  customerId: string;
  membershipId: string;
  
  // ã‚»ãƒƒã‚·ãƒ§ãƒ³è©³ç´°
  sessionDuration: number; // å®¿æ³Šæ—¥æ•°
  roomCharges: number;     // å®¿æ³Šæ–™é‡‘
  serviceCharges: number;  // ã‚µãƒ¼ãƒ“ã‚¹æ–™é‡‘
  totalAmount: number;     // ç·é¡
  
  // ä¼šå“¡æƒ…å ±
  membershipRank: MembershipRank;
  currentPoints: number;
  
  // ç‰¹å…¸ãƒ»ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³
  applicablePromotions: Promotion[];
  seasonalBonuses: SeasonalBonus[];
}

async function calculateSessionPoints(
  calculation: SessionPointCalculation
): Promise<{
  basePoints: number;
  bonusPoints: number;
  totalPoints: number;
  appliedPromotions: string[];
  nextRankThreshold?: number;
}> {
  // 1. åŸºæœ¬ãƒã‚¤ãƒ³ãƒˆè¨ˆç®—ï¼ˆå®¿æ³Šæ–™é‡‘ãƒ™ãƒ¼ã‚¹ï¼‰
  const baseRoomPoints = Math.floor(
    calculation.roomCharges * calculation.membershipRank.pointMultiplier / 100
  );
  
  // 2. ã‚µãƒ¼ãƒ“ã‚¹åˆ©ç”¨ãƒã‚¤ãƒ³ãƒˆè¨ˆç®—
  const baseServicePoints = Math.floor(
    calculation.serviceCharges * calculation.membershipRank.servicePointMultiplier / 100
  );
  
  const basePoints = baseRoomPoints + baseServicePoints;
  
  // 3. å®¿æ³Šæ—¥æ•°ãƒœãƒ¼ãƒŠã‚¹
  const durationBonus = calculation.sessionDuration >= 3 
    ? Math.floor(basePoints * 0.1) // 3æ³Šä»¥ä¸Šã§10%ãƒœãƒ¼ãƒŠã‚¹
    : 0;
  
  // 4. å­£ç¯€ãƒ»ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ãƒœãƒ¼ãƒŠã‚¹
  let campaignBonus = 0;
  const appliedPromotions: string[] = [];
  
  for (const promotion of calculation.applicablePromotions) {
    if (isPromotionApplicable(promotion, calculation)) {
      campaignBonus += calculatePromotionBonus(promotion, basePoints);
      appliedPromotions.push(promotion.name);
    }
  }
  
  // 5. ä¼šå“¡ãƒ©ãƒ³ã‚¯ãƒœãƒ¼ãƒŠã‚¹
  const rankBonus = calculation.membershipRank.level >= 3 
    ? Math.floor(basePoints * 0.05) // ã‚´ãƒ¼ãƒ«ãƒ‰ä»¥ä¸Šã§5%ãƒœãƒ¼ãƒŠã‚¹
    : 0;
  
  const bonusPoints = durationBonus + campaignBonus + rankBonus;
  const totalPoints = basePoints + bonusPoints;
  
  // 6. æ¬¡ã®ãƒ©ãƒ³ã‚¯ã¾ã§ã®å¿…è¦ãƒã‚¤ãƒ³ãƒˆè¨ˆç®—
  const nextRankThreshold = calculateNextRankThreshold(
    calculation.membershipId,
    calculation.currentPoints + totalPoints
  );
  
  return {
    basePoints,
    bonusPoints,
    totalPoints,
    appliedPromotions,
    nextRankThreshold
  };
}
```

### **2. ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¼šå“¡ç‰¹å…¸ç®¡ç†**

#### **ã‚»ãƒƒã‚·ãƒ§ãƒ³æœŸé–“ä¸­ã®ç‰¹å…¸é©ç”¨**
```typescript
interface SessionMemberBenefits {
  sessionId: string;
  membershipId: string;
  membershipRank: MembershipRank;
  
  // é©ç”¨å¯èƒ½ç‰¹å…¸
  availableBenefits: MemberBenefit[];
  appliedBenefits: AppliedBenefit[];
  
  // ç‰¹å…¸é©ç”¨å±¥æ­´
  benefitHistory: BenefitApplication[];
}

interface MemberBenefit {
  id: string;
  name: string;
  type: BenefitType; // 'room_upgrade' | 'late_checkout' | 'service_discount' | 'amenity'
  description: string;
  conditions: BenefitCondition[];
  value: BenefitValue;
  validFrom: Date;
  validTo: Date;
  usageLimit?: number; // åˆ©ç”¨å›æ•°åˆ¶é™
  rankRequirement: number; // å¿…è¦ãƒ©ãƒ³ã‚¯ãƒ¬ãƒ™ãƒ«
}

interface AppliedBenefit {
  benefitId: string;
  sessionId: string;
  appliedAt: Date;
  appliedBy: string; // 'system' | 'staff' | 'member'
  value: number; // é©ç”¨ã•ã‚ŒãŸå€¤ï¼ˆå‰²å¼•é¡ã€ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ä¾¡å€¤ç­‰ï¼‰
  status: 'active' | 'used' | 'expired';
}

async function applySessionBenefits(
  sessionId: string,
  membershipId: string
): Promise<SessionMemberBenefits> {
  // 1. ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±å–å¾—
  const session = await sessionApi.getSession(sessionId);
  const membership = await getMembership(membershipId);
  
  // 2. é©ç”¨å¯èƒ½ç‰¹å…¸ã®åˆ¤å®š
  const availableBenefits = await getAvailableBenefits(
    membership.rankId,
    session.checkInAt,
    session.plannedCheckOut
  );
  
  // 3. è‡ªå‹•é©ç”¨ç‰¹å…¸ã®å‡¦ç†
  const autoAppliedBenefits: AppliedBenefit[] = [];
  
  for (const benefit of availableBenefits) {
    if (benefit.autoApply && isBenefitApplicable(benefit, session, membership)) {
      const applied = await applyBenefit(sessionId, benefit);
      autoAppliedBenefits.push(applied);
      
      // ç‰¹å…¸é©ç”¨ã‚¤ãƒ™ãƒ³ãƒˆç™ºè¡Œ
      await eventPublisher.publish('member.benefit_applied', {
        sessionId,
        membershipId,
        benefitId: benefit.id,
        benefitName: benefit.name,
        value: applied.value,
        appliedAt: applied.appliedAt.toISOString()
      });
    }
  }
  
  return {
    sessionId,
    membershipId,
    membershipRank: membership.rank,
    availableBenefits,
    appliedBenefits: autoAppliedBenefits,
    benefitHistory: []
  };
}
```

#### **ç‰¹å…¸ç¨®åˆ¥ã¨é©ç”¨ãƒ­ã‚¸ãƒƒã‚¯**

##### **éƒ¨å±‹ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ç‰¹å…¸**
```typescript
async function applyRoomUpgradeBenefit(
  sessionId: string,
  benefit: MemberBenefit
): Promise<AppliedBenefit> {
  const session = await sessionApi.getSession(sessionId);
  const availableUpgrades = await roomApi.getAvailableUpgrades(
    session.roomId,
    session.checkInAt,
    session.plannedCheckOut
  );
  
  if (availableUpgrades.length > 0) {
    const upgrade = availableUpgrades[0]; // æœ€è‰¯ã®ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰é¸æŠ
    
    // éƒ¨å±‹å¤‰æ›´å‡¦ç†
    await sessionApi.updateSession(sessionId, {
      roomId: upgrade.roomId,
      notes: `ä¼šå“¡ç‰¹å…¸ã«ã‚ˆã‚‹éƒ¨å±‹ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰: ${upgrade.roomType} â†’ ${upgrade.upgradedRoomType}`
    });
    
    // è«‹æ±‚èª¿æ•´ï¼ˆã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰æ–™é‡‘ã®å…é™¤ï¼‰
    await sessionBillingApi.addDiscount(sessionId, {
      type: 'member_benefit',
      name: benefit.name,
      amount: upgrade.additionalCost,
      appliedTo: 'room'
    });
    
    return {
      benefitId: benefit.id,
      sessionId,
      appliedAt: new Date(),
      appliedBy: 'system',
      value: upgrade.additionalCost,
      status: 'active'
    };
  }
  
  throw new Error('No available room upgrades');
}
```

##### **ãƒ¬ã‚¤ãƒˆãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆç‰¹å…¸**
```typescript
async function applyLateCheckoutBenefit(
  sessionId: string,
  benefit: MemberBenefit
): Promise<AppliedBenefit> {
  const session = await sessionApi.getSession(sessionId);
  const extendedCheckout = new Date(session.plannedCheckOut);
  extendedCheckout.setHours(extendedCheckout.getHours() + benefit.value.hours);
  
  // ã‚»ãƒƒã‚·ãƒ§ãƒ³æ›´æ–°
  await sessionApi.updateSession(sessionId, {
    plannedCheckOut: extendedCheckout,
    notes: `ä¼šå“¡ç‰¹å…¸ã«ã‚ˆã‚‹ãƒ¬ã‚¤ãƒˆãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ: ${benefit.value.hours}æ™‚é–“å»¶é•·`
  });
  
  return {
    benefitId: benefit.id,
    sessionId,
    appliedAt: new Date(),
    appliedBy: 'system',
    value: benefit.value.hours,
    status: 'active'
  };
}
```

##### **ã‚µãƒ¼ãƒ“ã‚¹å‰²å¼•ç‰¹å…¸**
```typescript
async function applyServiceDiscountBenefit(
  sessionId: string,
  benefit: MemberBenefit,
  serviceOrderId: string
): Promise<AppliedBenefit> {
  const order = await serviceOrderApi.getOrder(serviceOrderId);
  const discountAmount = Math.floor(order.amount * benefit.value.discountRate);
  
  // ã‚»ãƒƒã‚·ãƒ§ãƒ³è«‹æ±‚ã«å‰²å¼•è¿½åŠ 
  await sessionBillingApi.addDiscount(sessionId, {
    type: 'member_benefit',
    name: benefit.name,
    amount: discountAmount,
    appliedTo: 'service',
    relatedOrderId: serviceOrderId
  });
  
  return {
    benefitId: benefit.id,
    sessionId,
    appliedAt: new Date(),
    appliedBy: 'system',
    value: discountAmount,
    status: 'used'
  };
}
```

### **3. ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¼šå“¡å±¥æ­´ç®¡ç†**

#### **çµ±åˆä¼šå“¡å±¥æ­´ãƒ¢ãƒ‡ãƒ«**
```typescript
interface MemberSessionHistory {
  id: string;
  membershipId: string;
  sessionId: string;
  sessionNumber: string;
  
  // ã‚»ãƒƒã‚·ãƒ§ãƒ³åŸºæœ¬æƒ…å ±
  roomNumber: string;
  roomType: string;
  checkInAt: Date;
  checkOutAt: Date;
  duration: number;
  
  // åˆ©ç”¨è©³ç´°
  totalAmount: number;
  roomCharges: number;
  serviceCharges: number;
  discounts: number;
  
  // ãƒã‚¤ãƒ³ãƒˆæƒ…å ±
  pointsEarned: number;
  pointsUsed: number;
  pointBalance: number;
  
  // ç‰¹å…¸é©ç”¨
  appliedBenefits: AppliedBenefit[];
  benefitValue: number;
  
  // è©•ä¾¡ãƒ»ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
  rating?: number;
  feedback?: string;
  
  // ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿
  createdAt: Date;
  updatedAt: Date;
}

async function createSessionHistory(
  sessionId: string
): Promise<MemberSessionHistory> {
  const session = await sessionApi.getSessionWithDetails(sessionId);
  const membership = await getMembershipByCustomerId(session.customerId);
  
  if (!membership) {
    throw new Error('No membership found for customer');
  }
  
  const sessionBilling = session.billings[0];
  const appliedBenefits = await getSessionBenefits(sessionId);
  const pointsData = await getSessionPoints(sessionId);
  
  const history: MemberSessionHistory = {
    id: generateId(),
    membershipId: membership.id,
    sessionId: session.id,
    sessionNumber: session.sessionNumber,
    
    roomNumber: session.room.roomNumber,
    roomType: session.room.roomType.name,
    checkInAt: session.checkInAt,
    checkOutAt: session.checkOutAt!,
    duration: calculateSessionDuration(session),
    
    totalAmount: sessionBilling.totalAmount,
    roomCharges: sessionBilling.roomCharges.reduce((sum, charge) => sum + charge.amount, 0),
    serviceCharges: sessionBilling.serviceCharges.reduce((sum, charge) => sum + charge.amount, 0),
    discounts: sessionBilling.discounts.reduce((sum, discount) => sum + discount.amount, 0),
    
    pointsEarned: pointsData.earned,
    pointsUsed: pointsData.used,
    pointBalance: pointsData.balance,
    
    appliedBenefits,
    benefitValue: appliedBenefits.reduce((sum, benefit) => sum + benefit.value, 0),
    
    createdAt: new Date(),
    updatedAt: new Date()
  };
  
  await memberHistoryRepository.save(history);
  
  // ä¼šå“¡çµ±è¨ˆæ›´æ–°
  await updateMembershipStats(membership.id, history);
  
  return history;
}
```

---

## ğŸ—„ï¸ **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹çµ±åˆ**

### **1. ä¼šå“¡é–¢é€£ãƒ†ãƒ¼ãƒ–ãƒ«æ‹¡å¼µ**

#### **membershipsãƒ†ãƒ¼ãƒ–ãƒ«æ‹¡å¼µ**
```sql
-- ã‚»ãƒƒã‚·ãƒ§ãƒ³é–¢é€£çµ±è¨ˆã‚«ãƒ©ãƒ è¿½åŠ 
ALTER TABLE memberships 
ADD COLUMN total_sessions INTEGER DEFAULT 0,
ADD COLUMN total_nights INTEGER DEFAULT 0,
ADD COLUMN total_spent DECIMAL(10,2) DEFAULT 0,
ADD COLUMN average_session_value DECIMAL(10,2) DEFAULT 0,
ADD COLUMN last_session_id UUID REFERENCES checkin_sessions(id),
ADD COLUMN last_session_date TIMESTAMP WITH TIME ZONE,
ADD COLUMN preferred_room_type VARCHAR(50),
ADD COLUMN preferred_services JSONB DEFAULT '[]';

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¿½åŠ 
CREATE INDEX idx_memberships_last_session ON memberships(last_session_id);
CREATE INDEX idx_memberships_last_session_date ON memberships(last_session_date);
```

#### **member_session_historyãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ**
```sql
CREATE TABLE member_session_history (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    membership_id UUID NOT NULL REFERENCES memberships(id),
    session_id UUID NOT NULL REFERENCES checkin_sessions(id),
    session_number VARCHAR(50) NOT NULL,
    
    -- ã‚»ãƒƒã‚·ãƒ§ãƒ³åŸºæœ¬æƒ…å ±
    room_number VARCHAR(10) NOT NULL,
    room_type VARCHAR(50) NOT NULL,
    check_in_at TIMESTAMP WITH TIME ZONE NOT NULL,
    check_out_at TIMESTAMP WITH TIME ZONE NOT NULL,
    duration INTEGER NOT NULL, -- å®¿æ³Šæ—¥æ•°
    
    -- åˆ©ç”¨è©³ç´°
    total_amount DECIMAL(10,2) NOT NULL,
    room_charges DECIMAL(10,2) NOT NULL,
    service_charges DECIMAL(10,2) NOT NULL,
    discounts DECIMAL(10,2) NOT NULL DEFAULT 0,
    
    -- ãƒã‚¤ãƒ³ãƒˆæƒ…å ±
    points_earned INTEGER NOT NULL DEFAULT 0,
    points_used INTEGER NOT NULL DEFAULT 0,
    point_balance INTEGER NOT NULL,
    
    -- ç‰¹å…¸é©ç”¨
    applied_benefits JSONB DEFAULT '[]',
    benefit_value DECIMAL(10,2) DEFAULT 0,
    
    -- è©•ä¾¡ãƒ»ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
    rating INTEGER CHECK (rating >= 1 AND rating <= 5),
    feedback TEXT,
    
    -- ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    
    -- åˆ¶ç´„
    UNIQUE(membership_id, session_id),
    INDEX(membership_id),
    INDEX(session_id),
    INDEX(check_in_at),
    INDEX(total_amount)
);
```

#### **member_session_benefitsãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ**
```sql
CREATE TABLE member_session_benefits (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    session_id UUID NOT NULL REFERENCES checkin_sessions(id),
    membership_id UUID NOT NULL REFERENCES memberships(id),
    benefit_id UUID NOT NULL REFERENCES member_benefits(id),
    
    -- é©ç”¨è©³ç´°
    applied_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    applied_by VARCHAR(20) NOT NULL, -- 'system', 'staff', 'member'
    value DECIMAL(10,2) NOT NULL, -- é©ç”¨ã•ã‚ŒãŸå€¤
    status VARCHAR(20) NOT NULL DEFAULT 'active', -- 'active', 'used', 'expired'
    
    -- ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿
    notes TEXT,
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    
    -- åˆ¶ç´„
    INDEX(session_id),
    INDEX(membership_id),
    INDEX(benefit_id),
    INDEX(applied_at)
);
```

### **2. ãƒ“ãƒ¥ãƒ¼ä½œæˆ**

#### **ä¼šå“¡ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ±åˆãƒ“ãƒ¥ãƒ¼**
```sql
CREATE VIEW member_session_overview AS
SELECT 
    msh.id as history_id,
    msh.session_number,
    msh.check_in_at,
    msh.check_out_at,
    msh.duration,
    msh.total_amount,
    msh.points_earned,
    
    -- ä¼šå“¡æƒ…å ±
    m.id as membership_id,
    c.first_name,
    c.last_name,
    c.email,
    mr.name as membership_rank,
    mr.level as rank_level,
    
    -- ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±
    cs.status as session_status,
    r.room_number,
    rt.name as room_type,
    
    -- ç‰¹å…¸æƒ…å ±
    (SELECT COUNT(*) FROM member_session_benefits msb WHERE msb.session_id = msh.session_id) as benefit_count,
    msh.benefit_value,
    
    -- è©•ä¾¡æƒ…å ±
    msh.rating,
    msh.feedback

FROM member_session_history msh
LEFT JOIN memberships m ON msh.membership_id = m.id
LEFT JOIN customers c ON m.customer_id = c.id
LEFT JOIN membership_ranks mr ON m.rank_id = mr.id
LEFT JOIN checkin_sessions cs ON msh.session_id = cs.id
LEFT JOIN rooms r ON cs.room_id = r.id
LEFT JOIN room_types rt ON r.room_type_id = rt.id;
```

---

## ğŸ”§ **APIçµ±åˆ**

### **1. Member APIæ‹¡å¼µ**

```typescript
// /api/members/* ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆç¾¤ã®æ‹¡å¼µ

interface MemberApiExtension {
  // ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¼šå“¡æƒ…å ±å–å¾—
  'GET /api/members/session/:sessionId': {
    response: {
      membership: Membership;
      availableBenefits: MemberBenefit[];
      appliedBenefits: AppliedBenefit[];
      pointsPreview: {
        estimatedEarning: number;
        currentBalance: number;
        nextRankThreshold?: number;
      };
    };
  };
  
  // ã‚»ãƒƒã‚·ãƒ§ãƒ³ç‰¹å…¸é©ç”¨
  'POST /api/members/session/:sessionId/benefits': {
    body: {
      benefitId: string;
      notes?: string;
    };
    response: AppliedBenefit;
  };
  
  // ã‚»ãƒƒã‚·ãƒ§ãƒ³å±¥æ­´å–å¾—
  'GET /api/members/:membershipId/sessions': {
    query: {
      limit?: number;
      offset?: number;
      dateFrom?: string;
      dateTo?: string;
    };
    response: MemberSessionHistory[];
  };
  
  // ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒã‚¤ãƒ³ãƒˆè¨ˆç®—
  'POST /api/members/session/:sessionId/calculate-points': {
    response: {
      basePoints: number;
      bonusPoints: number;
      totalPoints: number;
      appliedPromotions: string[];
      breakdown: PointCalculationBreakdown;
    };
  };
  
  // ä¼šå“¡çµ±è¨ˆå–å¾—
  'GET /api/members/:membershipId/stats': {
    query: {
      period?: 'month' | 'quarter' | 'year';
    };
    response: MembershipStats;
  };
}
```

### **2. ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†æ‹¡å¼µ**

```typescript
// ã‚»ãƒƒã‚·ãƒ§ãƒ³é–¢é€£ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼
class SessionMemberEventHandler {
  // ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆæ™‚ã®ä¼šå“¡å‡¦ç†
  async handleSessionCreated(event: SessionCreatedEvent) {
    const { sessionId, customerId } = event.data;
    
    // 1. ä¼šå“¡æƒ…å ±ç¢ºèª
    const membership = await getMembershipByCustomerId(customerId);
    if (!membership) return; // éä¼šå“¡ã®å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
    
    // 2. ã‚»ãƒƒã‚·ãƒ§ãƒ³ç‰¹å…¸ã®è‡ªå‹•é©ç”¨
    await applySessionBenefits(sessionId, membership.id);
    
    // 3. ä¼šå“¡ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹ã‚¤ãƒ™ãƒ³ãƒˆç™ºè¡Œ
    await eventPublisher.publish('member.session_started', {
      sessionId,
      membershipId: membership.id,
      rankLevel: membership.rank.level,
      availableBenefits: await getAvailableBenefits(membership.rankId)
    });
  }
  
  // ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆæ™‚ã®ä¼šå“¡å‡¦ç†
  async handleSessionCheckedOut(event: SessionCheckedOutEvent) {
    const { sessionId, totalAmount } = event.data;
    
    const session = await sessionApi.getSession(sessionId);
    const membership = await getMembershipByCustomerId(session.customerId);
    if (!membership) return;
    
    // 1. ãƒã‚¤ãƒ³ãƒˆè¨ˆç®—ãƒ»ä»˜ä¸
    const pointsResult = await calculateAndAwardSessionPoints(sessionId, membership.id);
    
    // 2. ã‚»ãƒƒã‚·ãƒ§ãƒ³å±¥æ­´ä½œæˆ
    const history = await createSessionHistory(sessionId);
    
    // 3. ä¼šå“¡çµ±è¨ˆæ›´æ–°
    await updateMembershipStats(membership.id, history);
    
    // 4. ãƒ©ãƒ³ã‚¯è©•ä¾¡
    await evaluateMembershipRank(membership.id);
    
    // 5. ä¼šå“¡ã‚»ãƒƒã‚·ãƒ§ãƒ³å®Œäº†ã‚¤ãƒ™ãƒ³ãƒˆç™ºè¡Œ
    await eventPublisher.publish('member.session_completed', {
      sessionId,
      membershipId: membership.id,
      pointsEarned: pointsResult.totalPoints,
      totalSpent: totalAmount,
      newRank: await getCurrentRank(membership.id)
    });
  }
  
  // ã‚µãƒ¼ãƒ“ã‚¹æ³¨æ–‡æ™‚ã®ä¼šå“¡å‡¦ç†
  async handleServiceOrdered(event: ServiceOrderedEvent) {
    const { sessionId, serviceId, amount } = event.data;
    
    const session = await sessionApi.getSession(sessionId);
    const membership = await getMembershipByCustomerId(session.customerId);
    if (!membership) return;
    
    // 1. ã‚µãƒ¼ãƒ“ã‚¹å‰²å¼•ç‰¹å…¸ã®ç¢ºèªãƒ»é©ç”¨
    const serviceBenefits = await getApplicableServiceBenefits(
      membership.id,
      serviceId
    );
    
    for (const benefit of serviceBenefits) {
      await applyServiceDiscountBenefit(sessionId, benefit, event.data.orderId);
    }
    
    // 2. ã‚µãƒ¼ãƒ“ã‚¹åˆ©ç”¨å±¥æ­´æ›´æ–°
    await updateServiceUsageHistory(membership.id, serviceId, amount);
  }
}
```

---

## ğŸ“Š **ä¼šå“¡åˆ†ææ©Ÿèƒ½çµ±åˆ**

### **1. ã‚»ãƒƒã‚·ãƒ§ãƒ³å˜ä½ä¼šå“¡åˆ†æ**

```typescript
interface MemberSessionAnalytics {
  // ä¼šå“¡ã‚»ãƒƒã‚·ãƒ§ãƒ³åˆ†æ
  analyzeSessionPatterns(membershipId: string): Promise<{
    averageSessionValue: number;
    averageStayDuration: number;
    preferredRoomTypes: Array<{ type: string; frequency: number }>;
    preferredServices: Array<{ service: string; frequency: number }>;
    seasonalPatterns: Array<{ month: number; sessions: number; value: number }>;
    loyaltyTrend: Array<{ period: string; sessions: number; growth: number }>;
  }>;
  
  // ä¼šå“¡ä¾¡å€¤åˆ†æ
  calculateMemberValue(membershipId: string): Promise<{
    lifetimeValue: number;
    averageSessionValue: number;
    pointsEarnedTotal: number;
    benefitsReceivedValue: number;
    predictedFutureValue: number;
    valueSegment: 'high' | 'medium' | 'low';
  }>;
  
  // ä¼šå“¡æº€è¶³åº¦åˆ†æ
  analyzeMemberSatisfaction(membershipId: string): Promise<{
    averageRating: number;
    ratingTrend: Array<{ period: string; rating: number }>;
    feedbackSentiment: 'positive' | 'neutral' | 'negative';
    issueCategories: Array<{ category: string; frequency: number }>;
    improvementSuggestions: string[];
  }>;
}
```

### **2. ä¼šå“¡ãƒ¬ã‚³ãƒ¡ãƒ³ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³**

```typescript
interface MemberRecommendationService {
  // ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸­ã®ãƒ¬ã‚³ãƒ¡ãƒ³ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
  getSessionRecommendations(sessionId: string): Promise<{
    services: Array<{
      serviceId: string;
      serviceName: string;
      reason: string;
      confidence: number;
      estimatedValue: number;
    }>;
    upgrades: Array<{
      upgradeType: string;
      description: string;
      additionalCost: number;
      memberDiscount?: number;
    }>;
    experiences: Array<{
      experienceId: string;
      title: string;
      description: string;
      personalizedReason: string;
    }>;
  }>;
  
  // æ¬¡å›æ»åœ¨ãƒ¬ã‚³ãƒ¡ãƒ³ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
  getNextStayRecommendations(membershipId: string): Promise<{
    recommendedDates: Array<{
      checkIn: Date;
      checkOut: Date;
      reason: string;
      specialOffers?: string[];
    }>;
    recommendedRooms: Array<{
      roomType: string;
      reason: string;
      memberBenefits: string[];
    }>;
    personalizedOffers: Array<{
      offerId: string;
      title: string;
      description: string;
      validUntil: Date;
      value: number;
    }>;
  }>;
}
```

---

## ğŸ§ª **ãƒ†ã‚¹ãƒˆæˆ¦ç•¥**

### **1. ä¼šå“¡çµ±åˆãƒ†ã‚¹ãƒˆ**

```typescript
describe('Member Session Integration', () => {
  test('should apply member benefits on session creation', async () => {
    const session = await createTestSession({
      customerId: 'premium-member-123',
      roomId: 'standard-room-456'
    });
    
    const benefits = await getSessionBenefits(session.id);
    expect(benefits).toContainEqual(
      expect.objectContaining({
        type: 'room_upgrade',
        status: 'active'
      })
    );
  });
  
  test('should calculate points correctly for session', async () => {
    const sessionId = 'test-session-123';
    const membershipId = 'gold-member-456';
    
    const pointsResult = await calculateSessionPoints({
      sessionId,
      membershipId,
      totalAmount: 50000,
      sessionDuration: 2
    });
    
    expect(pointsResult.totalPoints).toBeGreaterThan(0);
    expect(pointsResult.bonusPoints).toBeGreaterThan(0);
  });
  
  test('should create session history on checkout', async () => {
    const sessionId = 'test-session-789';
    
    await processSessionCheckout(sessionId);
    
    const history = await getSessionHistory(sessionId);
    expect(history).toBeDefined();
    expect(history.pointsEarned).toBeGreaterThan(0);
  });
});
```

---

## ğŸ“… **å®Ÿè£…ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«**

### **Week 1 (1/20-1/26)**
- [ ] ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒæ‹¡å¼µ
- [ ] ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒã‚¤ãƒ³ãƒˆè¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯å®Ÿè£…
- [ ] åŸºæœ¬ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼å®Ÿè£…

### **Week 2 (1/27-2/2)**
- [ ] ä¼šå“¡ç‰¹å…¸é©ç”¨ã‚·ã‚¹ãƒ†ãƒ å®Ÿè£…
- [ ] ã‚»ãƒƒã‚·ãƒ§ãƒ³å±¥æ­´ç®¡ç†å®Ÿè£…
- [ ] APIæ‹¡å¼µå®Ÿè£…

### **Week 3 (2/3-2/9)**
- [ ] ä¼šå“¡åˆ†ææ©Ÿèƒ½å®Ÿè£…
- [ ] ãƒ¬ã‚³ãƒ¡ãƒ³ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³æ©Ÿèƒ½å®Ÿè£…
- [ ] ãƒ†ã‚¹ãƒˆå®Ÿè£…ãƒ»å®Ÿè¡Œ

---

## ğŸ¯ **æˆåŠŸæŒ‡æ¨™**

### **æŠ€è¡“æŒ‡æ¨™**
- [ ] ãƒã‚¤ãƒ³ãƒˆè¨ˆç®—ç²¾åº¦: 100%
- [ ] ç‰¹å…¸é©ç”¨æˆåŠŸç‡: 99.9%ä»¥ä¸Š
- [ ] ä¼šå“¡ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§: ã‚¨ãƒ©ãƒ¼0ä»¶

### **æ¥­å‹™æŒ‡æ¨™**
- [ ] ä¼šå“¡æº€è¶³åº¦: 10%å‘ä¸Š
- [ ] ç‰¹å…¸åˆ©ç”¨ç‡: 30%å‘ä¸Š
- [ ] ä¼šå“¡ç¶™ç¶šç‡: 15%å‘ä¸Š

---

**Sakuraï¼ˆæ¡œï¼‰ã¨ã—ã¦ã€ãŠã‚‚ã¦ãªã—ã®å¿ƒã‚’æŒã£ã¦ä¼šå“¡æ§˜ä¸€äººã²ã¨ã‚Šã«æœ€é©åŒ–ã•ã‚ŒãŸã‚µãƒ¼ãƒ“ã‚¹ã‚’æä¾›ã—ã€ç¶™ç¶šçš„ãªä¾¡å€¤å‘ä¸Šã‚’å®Ÿç¾ã—ã¾ã™ã€‚**

---

**ä½œæˆè€…**: Sakuraï¼ˆæ¡œ - Cherry Blossomï¼‰  
**æ‰¿èªè€…**: hotel-memberãƒãƒ¼ãƒ è²¬ä»»è€…  
**é…å¸ƒå…ˆ**: hotel-memberãƒãƒ¼ãƒ ã€é–¢é€£ã‚·ã‚¹ãƒ†ãƒ ãƒãƒ¼ãƒ 




