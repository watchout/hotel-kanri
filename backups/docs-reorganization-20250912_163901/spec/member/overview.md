# hotel-member システム仕様書

> **注意**: このドキュメントは詳細仕様書です。概要情報は [docs/systems/member/overview.md](../../systems/member/overview.md) を参照してください。

## 概要
hotel-memberはホテル顧客管理システム（CRM）であり、会員情報管理、ポイント管理、顧客分析を担当するシステムです。顧客データの正本として機能し、パーソナライズされたサービス提供の基盤となります。

## 目的
- 顧客情報の一元管理
- 会員プログラムの運営
- 顧客ロイヤリティの向上
- データ分析による顧客理解
- マーケティング施策の最適化

## 主要機能

### 1. 顧客情報管理
- 顧客プロフィール管理
- 顧客検索・フィルタリング
- 顧客履歴追跡
- 顧客セグメント管理
- データクレンジング

### 2. 会員プログラム
- 会員登録・管理
- 会員ランク設定
- 特典管理
- 会員カード発行
- 会員向けキャンペーン

### 3. ポイント管理
- ポイント付与・使用・失効
- ポイント履歴管理
- ポイント交換
- ボーナスポイントキャンペーン
- ポイント分析

### 4. 顧客分析
- 顧客セグメント分析
- 購買行動分析
- ライフタイムバリュー計算
- 離反予測
- 顧客満足度分析

### 5. マーケティング支援
- ターゲットセグメント抽出
- キャンペーン管理
- メール配信連携
- パーソナライズ推奨
- 効果測定

## システム構成

### フロントエンド
- Vue 3 + TypeScript
- Nuxt.js（管理画面）
- Responsive Design

### バックエンド
- Node.js + TypeScript
- Express
- RESTful API + GraphQL

### データベース
- PostgreSQL
- Redis（キャッシュ）

### 外部連携
- メール配信サービス
- SMS配信サービス
- 分析ツール連携
- hotel-pms API（予約・宿泊履歴）
- hotel-saas API（サービス利用履歴）

## 画面構成

### 1. ダッシュボード
- 会員数サマリー
- 最近の活動
- キャンペーン状況
- 重要指標グラフ
- タスク通知

### 2. 顧客管理
- 顧客一覧
- 顧客詳細プロフィール
- 顧客編集
- 顧客検索・フィルタリング
- 顧客インポート/エクスポート

### 3. 会員管理
- 会員一覧
- 会員詳細
- 会員ランク管理
- 特典設定
- 会員カード管理

### 4. ポイント管理
- ポイント付与
- ポイント使用
- ポイント履歴
- ポイント設定
- ポイントキャンペーン

### 5. セグメント管理
- セグメント定義
- セグメント一覧
- セグメント分析
- ターゲティング設定

### 6. キャンペーン管理
- キャンペーン作成
- キャンペーン一覧
- キャンペーン分析
- A/Bテスト

### 7. レポート
- 会員動向レポート
- ポイント利用分析
- セグメント分析
- キャンペーン効果測定

## データフロー

### 1. 顧客登録フロー
1. 顧客情報の受け取り（直接入力またはAPI経由）
2. データバリデーション
3. 重複チェック
4. 顧客データの保存
5. customer.createdイベント発行

### 2. 会員登録フロー
1. 顧客IDの確認
2. 会員情報の登録
3. 初期ポイント付与
4. 会員カード発行（必要に応じて）
5. member.registeredイベント発行

### 3. ポイント付与フロー
1. ポイント付与トリガー（予約、支払い、キャンペーン等）
2. ポイント計算
3. ポイント残高更新
4. ポイント履歴記録
5. points.addedイベント発行
6. 会員ランク確認・更新（必要に応じて）

### 4. ポイント使用フロー
1. ポイント使用リクエスト
2. 残高確認
3. ポイント差し引き
4. ポイント履歴記録
5. points.usedイベント発行

## イベント連携

### 発行イベント
- customer.created: 顧客作成時
- customer.updated: 顧客情報更新時
- member.registered: 会員登録時
- member.status_changed: 会員ステータス変更時
- points.added: ポイント追加時
- points.used: ポイント使用時

### 購読イベント
- reservation.created: 予約作成時
- reservation.canceled: 予約キャンセル時
- checkin_checkout.checked_in: チェックイン時
- checkin_checkout.checked_out: チェックアウト時
- billing.paid: 請求支払完了時
- feedback.submitted: フィードバック送信時

## セキュリティ要件
- JWT認証による保護
- ロールベースアクセス制御
- 個人情報の暗号化
- GDPR/個人情報保護法対応
- アクセスログ記録

## パフォーマンス要件
- API応答: 500ms以内
- バッチ処理: 15分以内
- 検索応答: 3秒以内
- 同時接続: 最大50ユーザー

## 制約事項
- 全クエリにtenant_id必須
- 顧客情報更新時はcustomer.updatedイベント必須発行
- hotel-pms更新権限はname/phone/addressのみ
- ポイント操作は履歴テーブル記録必須
- Prisma ORM専用・直接SQL禁止
- 他システムDBアクセス禁止

## 開発ガイドライン
- コンポーネントベース設計
- 状態管理はPinia
- APIクライアントは共通モジュール化
- エラーハンドリングの統一
- ログ出力の標準化

## テスト要件
- 単体テスト: Vitest
- 統合テスト: Jest
- E2Eテスト: Cypress
- カバレッジ目標: 80%以上

## デプロイメント
- Docker + Kubernetes
- CI/CD: GitHub Actions
- 環境: 開発、ステージング、本番
- ブルー/グリーンデプロイメント

## 監視・ロギング
- エラーログ
- パフォーマンスメトリクス
- ユーザー操作ログ
- システムヘルスチェック

## データ保護・コンプライアンス
- データバックアップ（日次）
- データ保持ポリシー
- 個人情報保護法対応
- GDPR対応（必要に応じて）
- 情報セキュリティポリシー