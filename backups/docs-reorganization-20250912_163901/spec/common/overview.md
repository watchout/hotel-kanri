# hotel-common システム仕様書

> **注意**: このドキュメントは詳細仕様書です。概要情報は [docs/systems/common/overview.md](../../systems/common/overview.md) を参照してください。

## 概要
hotel-commonは3つのシステム（hotel-saas、hotel-pms、hotel-member）を統合するための共通基盤システムです。認証、データベース、イベント連携などの共通機能を提供し、システム間の一貫性と連携を実現します。

## 目的
- システム間の一貫性確保
- 共通機能の集約による重複排除
- 開発効率の向上
- 保守性の向上
- スケーラビリティの確保

## 主要機能

### 1. 統一JWT認証基盤
- シングルサインオン
- ロールベースアクセス制御
- トークン管理
- セッション管理
- 多要素認証

### 2. マルチテナント統一データベース
- スキーマ管理
- マイグレーション管理
- クエリ最適化
- コネクションプール管理
- データアクセス制御

### 3. Event-driven設計基盤
- イベントブローカー
- イベントスキーマ管理
- イベントログ
- 再試行メカニズム
- デッドレターキュー

### 4. ガードレールシステム
- データ整合性チェック
- アクセス権限検証
- イベント連携監視
- エラー検出・通知
- 自動修復

### 5. 共通コンポーネント
- UIコンポーネントライブラリ
- APIクライアント
- ユーティリティ関数
- バリデーションライブラリ
- ログ・モニタリング

## システム構成

### バックエンド
- Node.js + TypeScript
- Express
- GraphQL Gateway

### データベース
- PostgreSQL
- Redis（キャッシュ、セッション）

### イベント連携
- RabbitMQ/Kafka
- Redis Pub/Sub

### インフラ
- Kubernetes
- Docker
- CI/CD Pipeline

## アーキテクチャ

### 認証アーキテクチャ
```
+----------------+      +----------------+      +----------------+
|  hotel-saas    |      |   hotel-pms    |      | hotel-member   |
+----------------+      +----------------+      +----------------+
         |                      |                      |
         v                      v                      v
+-------------------------------------------------------+
|                  統一JWT認証基盤                        |
+-------------------------------------------------------+
         |                      |                      |
         v                      v                      v
+----------------+      +----------------+      +----------------+
|   ユーザーDB     |      |  セッション管理   |      | アクセス制御    |
+----------------+      +----------------+      +----------------+
```

### データベースアーキテクチャ
```
+----------------+      +----------------+      +----------------+
|  hotel-saas    |      |   hotel-pms    |      | hotel-member   |
+----------------+      +----------------+      +----------------+
         |                      |                      |
         v                      v                      v
+-------------------------------------------------------+
|              UnifiedPrismaClient                      |
+-------------------------------------------------------+
                           |
                           v
+-------------------------------------------------------+
|             PostgreSQL (マルチテナント)                 |
+-------------------------------------------------------+
```

### イベント連携アーキテクチャ
```
+----------------+      +----------------+      +----------------+
|  hotel-saas    |      |   hotel-pms    |      | hotel-member   |
|  Publisher     |      |  Publisher     |      |  Publisher     |
|  Subscriber    |      |  Subscriber    |      |  Subscriber    |
+----------------+      +----------------+      +----------------+
         |                      |                      |
         v                      v                      v
+-------------------------------------------------------+
|                    EventBus                           |
+-------------------------------------------------------+
                           |
                           v
+-------------------------------------------------------+
|                RabbitMQ/Kafka                         |
+-------------------------------------------------------+
```

## 認証システム詳細

### JWT構造
```json
{
  "header": {
    "alg": "RS256",
    "typ": "JWT"
  },
  "payload": {
    "sub": "user_uuid",
    "name": "ユーザー名",
    "email": "user@example.com",
    "tenant_id": "tenant_uuid",
    "roles": ["admin", "manager"],
    "permissions": ["read:customers", "write:reservations"],
    "iat": 1516239022,
    "exp": 1516242622
  }
}
```

### 認証フロー
1. ユーザーがログイン情報を送信
2. 認証サービスが認証情報を検証
3. JWTトークン生成
4. クライアントにトークン返却
5. 以降のリクエストにトークンを付与
6. 各サービスでトークン検証・権限チェック

### 権限管理
- ロールベースアクセス制御
- 細粒度のパーミッション
- テナント単位のアクセス制限
- リソースベースの権限チェック

## データベース詳細

### マルチテナント設計
- テナントIDによる分離
- すべてのテーブルにtenant_idカラム
- テナント単位のクエリフィルタリング
- クロステナントクエリの制限

### UnifiedPrismaClient
- 共通のPrismaクライアント
- テナントコンテキスト自動適用
- トランザクション管理
- コネクションプール最適化
- クエリログ・モニタリング

### マイグレーション管理
- バージョン管理されたマイグレーション
- ロールバック機能
- テナント別適用オプション
- データシード機能
- スキーマ検証

## イベント連携詳細

### イベントスキーマ
- JSON Schema定義
- バージョニング
- 互換性チェック
- ドキュメント自動生成

### イベント処理
- 冪等性保証
- 順序保証（必要に応じて）
- デッドレターキュー
- 再試行ポリシー
- バックプレッシャー処理

### モニタリング
- イベント処理ステータス追跡
- 処理時間測定
- エラー率監視
- キュー長モニタリング
- アラート設定

## ガードレールシステム詳細

### データ整合性チェック
- 定期的な整合性検証ジョブ
- クロスシステムデータ比較
- 不整合検出・通知
- 自動修復（可能な場合）

### アクセス制御検証
- 権限設定の検証
- 不正アクセス検出
- 異常パターン検出
- セキュリティ監査

### イベント連携監視
- イベント配信確認
- 未処理イベント検出
- イベント処理タイムアウト検出
- イベントスキーマ検証

## 共通コンポーネント

### UIコンポーネント
- フォーム要素
- テーブル・リスト
- モーダル・ダイアログ
- ナビゲーション
- カード・パネル

### APIクライアント
- 認証トークン自動管理
- リクエスト/レスポンス変換
- エラーハンドリング
- 再試行ロジック
- キャッシュ管理

### ユーティリティ
- 日付・時刻処理
- 通貨・金額計算
- バリデーション
- フォーマット変換
- ロギング

## デプロイメント

### CI/CD
- 自動ビルド
- 自動テスト
- 静的解析
- 脆弱性スキャン
- 自動デプロイ

### 環境
- 開発環境
- テスト環境
- ステージング環境
- 本番環境

### スケーリング
- 水平スケーリング
- 負荷分散
- オートスケーリング
- リソース最適化

## 監視・運用

### モニタリング
- システムメトリクス
- アプリケーションメトリクス
- ユーザーエクスペリエンスメトリクス
- ビジネスメトリクス

### アラート
- 異常検知
- エスカレーションポリシー
- オンコール管理
- インシデント対応

### バックアップ・リカバリ
- 定期バックアップ
- ポイントインタイムリカバリ
- 災害復旧計画
- フェイルオーバー戦略

## 移行戦略

### 段階的移行
1. 共通認証基盤の構築
2. イベント連携基盤の構築
3. 段階的データベース統合
4. システム間APIの標準化
5. UI/UX統一

### 移行技術
- Adapter Pattern
- dual-write方式
- フィーチャーフラグ
- シャドウモード
- カナリアリリース

## 開発ガイドライン
- モジュール化設計
- インターフェース駆動開発
- テスト駆動開発
- コードレビュープロセス
- ドキュメント駆動開発