# hotel-pms システム仕様書

> **注意**: このドキュメントは詳細仕様書です。概要情報は [docs/systems/pms/overview.md](../../systems/pms/overview.md) を参照してください。

## 概要
hotel-pmsはホテルマネジメントシステム（Property Management System）であり、予約管理、フロント業務、オペレーション効率化を担当するシステムです。ホテル運営の中核となるシステムとして、予約から請求までの一連のプロセスを管理します。

## 目的
- 予約・在庫の一元管理
- フロント業務の効率化
- 売上・稼働率の最適化
- 顧客サービスの向上
- バックオフィス業務の効率化

## 主要機能

### 1. 予約管理
- 予約の作成・変更・キャンセル
- 複数チャネルからの予約統合（OTA、直販、電話等）
- 部屋タイプ・料金プラン管理
- 予約カレンダー表示
- 予約検索・フィルタリング

### 2. フロント業務
- チェックイン・チェックアウト処理
- 宿泊者情報管理
- ルームアサイン
- キーカード発行
- ゲスト対応記録

### 3. 請求・決済
- 料金計算
- 追加料金・割引管理
- 複数決済方法対応
- 請求書・領収書発行
- 売掛金管理

### 4. 在庫管理
- リアルタイム部屋在庫管理
- 料金・在庫の一括更新
- 閑散期・繁忙期設定
- 販売制限・条件設定

### 5. ハウスキーピング
- 清掃状況管理
- 客室状態追跡
- 作業指示・報告
- メンテナンス管理

### 6. レポーティング
- 売上レポート
- 稼働率分析
- チャネル別実績
- 予測・傾向分析

## システム構成

### フロントエンド
- Vue 3 + TypeScript
- Electron（フロントデスク用デスクトップアプリ）
- ブラウザ版（管理画面用）

### バックエンド
- Node.js + TypeScript
- Express
- GraphQL API

### データベース
- PostgreSQL
- Redis（キャッシュ、セッション管理）

### 外部連携
- OTA API連携（Booking.com, Expedia等）
- 決済ゲートウェイ連携
- hotel-member API（顧客情報）
- hotel-saas API（サービス連携）

## 画面構成

### 1. ダッシュボード
- 本日の予約概要
- チェックイン/アウト予定
- 部屋稼働状況
- 売上サマリー
- タスク通知

### 2. 予約管理
- 予約カレンダー
- 予約一覧
- 予約詳細・編集
- 予約検索
- グループ予約

### 3. フロント業務
- チェックイン処理
- 宿泊者情報
- 部屋割り当て
- チェックアウト処理
- ゲスト対応記録

### 4. 請求管理
- 請求書作成
- 決済処理
- 請求履歴
- 入金管理
- 売掛金管理

### 5. 在庫・料金管理
- カレンダー表示
- 一括更新
- レート戦略設定
- 販売条件設定

### 6. ハウスキーピング
- 清掃状況一覧
- 作業指示
- 報告確認
- メンテナンス管理

### 7. レポート
- 期間別売上
- 稼働率分析
- チャネル分析
- 顧客分析

## データフロー

### 1. 予約処理フロー
1. 予約情報の受け取り（直接入力またはAPI経由）
2. 在庫・料金の確認
3. 予約データの保存
4. reservation.createdイベント発行
5. 予約確認の送信

### 2. チェックインフロー
1. 予約情報の検索・確認
2. 顧客情報の確認・更新
3. 部屋割り当て・鍵発行
4. チェックイン処理実行
5. checkin_checkout.checked_inイベント発行

### 3. チェックアウトフロー
1. 宿泊料金・追加料金の計算
2. 請求書作成
3. 決済処理
4. チェックアウト処理実行
5. checkin_checkout.checked_outイベント発行
6. billing.paidイベント発行

### 4. サービス注文処理フロー
1. service.orderedイベント受信
2. 請求項目への追加
3. サービス提供指示

## イベント連携

### 発行イベント
- reservation.created: 予約作成時
- reservation.updated: 予約更新時
- reservation.canceled: 予約キャンセル時
- checkin_checkout.checked_in: チェックイン時
- checkin_checkout.checked_out: チェックアウト時
- billing.created: 請求作成時
- billing.paid: 請求支払完了時

### 購読イベント
- service.ordered: サービス注文時
- service.canceled: サービスキャンセル時
- customer.updated: 顧客情報更新時
- member.status_changed: 会員ステータス変更時

## セキュリティ要件
- JWT認証による保護
- ロールベースアクセス制御
- 個人情報の暗号化
- 監査ログの記録
- セッション管理

## パフォーマンス要件
- 画面表示: 1秒以内
- API応答: 500ms以内
- バッチ処理: 10分以内
- 同時接続: 最大100ユーザー

## 制約事項
- 予約作成・更新時はreservation.updatedイベント必須発行
- チェックイン/アウト時はcheckin_checkout.checked_inイベント必須発行
- 顧客情報更新は制限項目(name/phone/address)のみ許可
- 部屋ダブルブッキング自動検知・拒否必須
- 全予約にorigin(MEMBER/OTA/FRONT/PHONE/WALK_IN)必須
- 他システムDBアクセス禁止

## 開発ガイドライン
- コンポーネントベース設計
- 状態管理はPinia
- APIクライアントは共通モジュール化
- エラーハンドリングの統一
- ログ出力の標準化

## テスト要件
- 単体テスト: Vitest
- E2Eテスト: Playwright
- カバレッジ目標: 80%以上

## デプロイメント
- Docker + Kubernetes
- CI/CD: GitHub Actions
- 環境: 開発、ステージング、本番
- ブルー/グリーンデプロイメント

## 監視・ロギング
- エラーログ
- パフォーマンスメトリクス
- ユーザー操作ログ
- システムヘルスチェック

## 特記事項
- オフライン対応（ネットワーク障害時の業務継続）
- データバックアップ（1時間ごと）
- 災害復旧計画
- 24時間稼働体制