# 正しいデプロイ手順

## 概要

このドキュメントでは、hotel-kanriプロジェクトにおける正しいデプロイ手順を定義します。この手順に従うことで、一貫性のあるデプロイと環境間の整合性を確保します。

## 前提条件

- Gitがインストールされていること
- 適切なリポジトリアクセス権限があること
- CI/CDパイプラインへのアクセス権限があること

## 基本的なデプロイフロー

### 1. ローカル開発環境での変更

```
ローカル開発 → コミット → プッシュ → CI/CD → 開発環境
```

1. **ローカル環境のセットアップ**
   ```bash
   # リポジトリのクローン
   git clone https://github.com/watchout/[リポジトリ名].git
   cd [リポジトリ名]
   
   # 依存関係のインストール
   npm install
   ```

2. **ローカルでの開発と検証**
   ```bash
   # 開発サーバーの起動
   npm run dev
   
   # ビルドテスト
   npm run build
   ```

3. **変更のコミットとプッシュ**
   ```bash
   git add .
   git commit -m "明確な変更内容の説明"
   git push origin [ブランチ名]
   ```

### 2. CI/CDパイプラインによるデプロイ

1. **GitHub Actionsワークフローの確認**
   - `.github/workflows/deploy-dev.yml`の内容を確認
   - デプロイ対象のサービスとバージョンを確認

2. **ワークフローの手動実行（必要な場合）**
   - GitHubリポジトリの「Actions」タブを開く
   - 「開発環境デプロイ」ワークフローを選択
   - 「Run workflow」ボタンをクリック
   - デプロイするサービスとバージョンを選択して実行

3. **デプロイ結果の確認**
   - ワークフローの実行ログを確認
   - デプロイが成功したことを確認
   - 開発環境でのアプリケーション動作を確認

## 問題発生時の対応手順

### 1. デプロイ失敗時の対応

1. **エラーの特定**
   - CI/CDパイプラインのログを確認
   - エラーメッセージと発生箇所を特定

2. **ローカルでの再現と修正**
   ```bash
   # ローカル環境でのビルド再現
   npm run build
   
   # 問題の修正
   [エディタで修正]
   
   # 修正のテスト
   npm run build
   ```

3. **修正のコミットとデプロイ再試行**
   ```bash
   git add .
   git commit -m "Fix: デプロイエラーの修正"
   git push origin [ブランチ名]
   ```

### 2. 環境依存の問題への対応

1. **環境差異の特定**
   - ローカル環境と開発環境の違いを確認
   - Node.jsバージョン、依存パッケージ、環境変数などを比較

2. **package.jsonの調整**
   - エンジンの要件を明示
   ```json
   "engines": {
     "node": ">=18.0.0"
   }
   ```
   - 依存パッケージのバージョン固定
   ```json
   "dependencies": {
     "critical-package": "3.3.0"
   }
   ```

3. **環境設定の文書化**
   - 必要な環境設定を`docs/environment-requirements.md`に記録
   - CI/CD設定との整合性を確保

## サーバー環境の更新手順

サーバー環境の更新が必要な場合（Node.jsバージョンアップなど）は、以下の手順で行います：

1. **更新計画の作成**
   - 更新内容、影響範囲、スケジュールを明確化
   - チームへの通知と承認取得

2. **更新スクリプトの作成**
   ```bash
   # hotel-kanri/scripts/server/update-nodejs.sh
   #!/bin/bash
   
   # Node.jsのアップデートスクリプト
   curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
   sudo apt-get install -y nodejs
   node -v
   npm -v
   ```

3. **CI/CDパイプラインへの統合**
   - 更新スクリプトをCI/CDパイプラインに組み込む
   - 更新後の検証ステップを追加

4. **更新の実施と検証**
   - 更新スクリプトの実行
   - 環境の正常性確認
   - アプリケーションの動作確認

## ベストプラクティス

1. **小さな変更を頻繁にデプロイする**
   - 大きな変更を一度にデプロイするのではなく、小さな変更を頻繁にデプロイする
   - 問題が発生した場合の切り分けが容易になる

2. **デプロイ前の十分なテスト**
   - 単体テスト、統合テストを実行
   - ローカルでのビルド検証

3. **変更の明確な文書化**
   - コミットメッセージの質を高める
   - 重要な変更はプルリクエストで詳細に説明

4. **デプロイ後の検証**
   - デプロイ後のアプリケーション動作確認
   - ログの監視
   - パフォーマンスの確認
