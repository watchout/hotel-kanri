# 通常のデプロイフローへの復旧手順

**日付**: 2023年8月17日
**作成者**: hotel-kanri

## 概要

このドキュメントは、サーバー上での直接編集などの緊急対応後に、通常のGitHub Actions経由のデプロイフローに復旧するための手順を提供します。

## 問題の背景

緊急対応としてサーバー上でファイルを直接編集した場合、以下の問題が発生します：

1. サーバー上のGitリポジトリにコミットされていないローカルな変更が残る
2. これらの変更がGitHub Actionsによるデプロイを妨げる
3. 通常のデプロイフローが機能しなくなる

## 復旧手順

### 1. サーバー上の変更をリセットする

サーバー上のローカルな変更を破棄し、GitHubからの最新の変更を適用します。

```bash
# SSHでサーバーに接続
ssh omotenasu-dev

# リポジトリディレクトリに移動
cd /opt/omotenasuai/hotel-saas

# 変更をリセット
git reset --hard HEAD
git clean -fd

# 最新の変更を取得
git fetch origin
git checkout main
git pull origin main
```

または、提供されたスクリプトを使用します：

```bash
# ローカルから実行
ssh omotenasu-dev 'bash -s' < /Users/kaneko/hotel-kanri/scripts/deploy/reset-server-changes.sh hotel-saas main
```

### 2. GitHub Actionsのワークフローを手動で実行

1. GitHubのリポジトリページで「Actions」タブを開く
2. 「開発環境デプロイ」ワークフローを選択
3. 「Run workflow」ボタンをクリック
4. 必要なパラメータを設定（デフォルト値でよい場合が多い）
5. 「Run workflow」ボタンをクリックして実行

### 3. デプロイの成功を確認

1. GitHub Actionsのワークフロー実行ログを確認
2. サーバー上でアプリケーションの状態を確認：

```bash
# SSHでサーバーに接続
ssh omotenasu-dev

# PM2の状態を確認
pm2 status

# アプリケーションのヘルスチェック
curl -f http://localhost:3100/health
```

## 再発防止策

### 1. サーバー上での直接編集の禁止

サーバー上でファイルを直接編集することは避けてください。すべての変更は以下のフローに従って行います：

1. ローカル環境で変更を行う
2. 変更をコミットしてGitHubにプッシュする
3. GitHub Actionsを通じてデプロイする

### 2. 緊急時の対応手順

どうしても緊急対応が必要な場合は、以下の手順に従います：

1. 変更の内容と理由を文書化する
2. サーバー上で変更を行う
3. 変更後、同じ変更をローカル環境で再現する
4. 変更をコミットしてGitHubにプッシュする
5. GitHub Actionsを通じてデプロイする
6. サーバー上の変更が不要になったことを確認する

### 3. デプロイスクリプトの改善

デプロイスクリプトを改善し、以下の機能を追加することを検討します：

1. デプロイ前にローカルな変更を検出する
2. 検出した場合は警告を表示し、対応方法を提案する
3. 必要に応じて自動的に変更をバックアップする

## 結論

通常のデプロイフローを維持することは、安定した開発環境を確保するために非常に重要です。緊急対応が必要な場合でも、できるだけ早く通常のフローに戻すことを心がけてください。
