# デプロイフロー強制ルール

**日付**: 2023年8月17日
**作成者**: hotel-kanri

## 1. 基本原則

デプロイは常にGitHub Actions経由で行い、サーバー上での直接編集は絶対に禁止します。この原則を徹底するための具体的なルールと対策を以下に定めます。

## 2. 技術的強制対策

### 2.1 サーバーアクセス制限

- **デプロイユーザー権限制限**:
  - `deploy`ユーザーはGitHub Actionsからのデプロイ専用とし、手動SSH接続を禁止
  - `~/.ssh/authorized_keys`にGitHub Actionsの公開鍵のみを登録
  - 手動接続が必要な場合は、別の管理用ユーザー（`admin`）を使用し、ログを残す

- **ファイル変更監視**:
  - ファイル変更監視スクリプト（`file-change-monitor.sh`）をサーバー上に設置
  - 変更があった場合、Slack通知と監査ログへの記録を行う
  - 定期的（1時間ごと）にチェックサムを検証し、不正な変更を検出

### 2.2 GitHub Actions強化

- **必須ステータスチェック**:
  - `main`ブランチと`develop`ブランチに必須ステータスチェックを設定
  - デプロイワークフローが成功しない限り、マージを禁止

- **自動レビュー**:
  - デプロイ関連ファイルの変更に対して、自動レビューを実施
  - デプロイスクリプトの変更には必ず2名以上のレビュアーを要求

- **バージョン管理の厳格化**:
  - すべてのデプロイはバージョンタグを付与
  - デプロイ履歴とバージョンの対応を明確に記録

## 3. プロセスの強制対策

### 3.1 変更管理プロセス

- **変更依頼フロー**:
  - システム間の変更依頼は必ず文書化（`docs/requests/`ディレクトリに保存）
  - 変更依頼には必ず以下の情報を含める：
    - 変更理由
    - 変更内容の詳細
    - 期限
    - 担当者
    - 確認方法

- **コードレビュー必須化**:
  - すべてのプルリクエストに対してコードレビューを必須化
  - デプロイ関連の変更には特に厳格なレビューを実施

### 3.2 デプロイ前チェックリスト

デプロイ前に以下のチェックリストを必ず確認し、すべての項目がクリアされていることを確認：

1. コードレビューが完了しているか
2. 自動テストがパスしているか
3. 依存関係に問題がないか
4. 環境変数の設定は正しいか
5. デプロイ先環境の状態は正常か
6. ロールバック計画が準備されているか

### 3.3 デプロイ実行権限

- デプロイの実行権限は限定されたチームメンバーのみに付与
- デプロイ実行者は必ず実行前にチェックリストを確認
- デプロイ実行後は必ず結果を報告

## 4. 緊急時の例外プロセス

緊急時のみ、以下の厳格な条件下でサーバー上の直接編集を許可：

1. **事前承認**:
   - CTO/開発責任者の明示的な承認が必要
   - 承認はSlackチャンネルで公開し、記録を残す

2. **実行条件**:
   - 2名以上の開発者が立ち会うこと
   - すべての操作をスクリーン共有で記録
   - すべての変更をログに記録

3. **事後処理**（必須）:
   - 24時間以内に同じ変更をGitHubリポジトリに反映
   - 緊急対応レポートを作成（`docs/emergency/`ディレクトリに保存）
   - 再発防止策を立案し実施

## 5. 監査と違反対応

### 5.1 定期監査

- 週次でデプロイログとサーバー変更ログを照合
- 月次でデプロイプロセスの遵守状況を評価
- 四半期ごとにルール自体の見直しを実施

### 5.2 違反発生時の対応

1. 違反の詳細を調査し文書化
2. 原因分析と再発防止策の立案
3. 必要に応じてプロセスやツールの改善
4. チーム全体への共有と教育

### 5.3 違反の報告義務

- ルール違反を発見した場合、即座に報告する義務あり
- 報告者は保護され、不利益を受けないことを保証

## 6. 教育と啓発

- 新メンバー向けオンボーディングでデプロイルールを必ず説明
- 四半期ごとにデプロイルールの復習セッションを実施
- 優れた実践例を共有し、表彰

## 7. ツールとスクリプト

以下のツールとスクリプトを用意し、ルールの遵守を技術的に支援：

1. **デプロイ検証スクリプト**: デプロイ前の検証を自動化
2. **変更監視スクリプト**: サーバー上のファイル変更を監視
3. **監査ログ生成ツール**: デプロイと変更の履歴を自動記録
4. **チェックリスト自動化ツール**: デプロイ前チェックリストの確認を支援

## 8. 責任者

- デプロイルール遵守の最終責任者: 統合管理者（Iza）
- 監査責任者: CTO/開発責任者
- 教育責任者: 各システム担当リーダー

## 9. 定期レビュー

このルールは3ヶ月ごとにレビューし、必要に応じて更新します。更新履歴は`CHANGELOG.md`に記録します。
