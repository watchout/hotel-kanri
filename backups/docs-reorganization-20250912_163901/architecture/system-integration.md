# システム統合アーキテクチャ

## 概要
このドキュメントでは、hotel-saas（AIコンシェルジュ）、hotel-pms（PMS）、hotel-member（CRM）、hotel-common（統合基盤）の4つのシステム間の統合アーキテクチャについて定義します。

## システム構成

### hotel-common（統合基盤）
- **役割**: 共通基盤・認証・イベント連携・データベース統合
- **担当AI**: Iza（伊邪那岐）- 創造神・基盤構築・調和秩序
- **主要機能**: 
  - 統一JWT認証基盤
  - マルチテナント統一データベース
  - Event-driven連携基盤
  - 共通UIコンポーネント
  - ガードレールシステム

### hotel-saas（AIコンシェルジュ）
- **役割**: 顧客向けサービス・UI/UX・客室内サービス
- **担当AI**: Sun（天照）- 明るく温かい・希望を与える
- **主要機能**:
  - AIコンシェルジュ
  - 注文管理
  - 顧客体験向上
  - パーソナライズサービス

### hotel-pms（PMS）
- **役割**: フロント業務・予約管理・運用効率化
- **担当AI**: Luna（月読）- 冷静沈着・確実遂行・24時間運用
- **主要機能**:
  - 予約管理
  - チェックイン/アウト
  - 請求処理
  - 在庫管理

### hotel-member（CRM）
- **役割**: 顧客管理・会員制度・プライバシー保護
- **担当AI**: Suno（須佐之男）- 力強い・顧客守護・正義感
- **主要機能**:
  - 顧客マスタ管理
  - ポイントシステム
  - 会員ランク管理
  - プライバシー保護

## 統合アーキテクチャ

### データ統合
```
┌──────────────┐     ┌──────────────┐     ┌──────────────┐
│  hotel-saas  │     │  hotel-pms   │     │ hotel-member │
│   (読取専用)  │     │ (予約/在庫管理) │     │ (顧客マスタ)  │
└──────┬───────┘     └──────┬───────┘     └──────┬───────┘
       │                    │                    │
       └────────────┬───────┴────────────┬───────┘
                    │                    │
          ┌─────────▼──────────┐ ┌───────▼─────────┐
          │ UnifiedPrismaClient│ │  EventBus基盤   │
          └─────────┬──────────┘ └───────┬─────────┘
                    │                    │
                    └────────────────────┘
                              │
                    ┌─────────▼──────────┐
                    │    hotel-common    │
                    │    (統合基盤)      │
                    └────────────────────┘
```

### 認証統合
- **JWT統一認証基盤**（hotel-common）
  - 全システム共通のトークン形式
  - ロールベースアクセス制御
  - マルチテナント対応

### イベント連携
```
┌─────────────────────┐
│    EventBus基盤     │
└─────────┬───────────┘
          │
┌─────────▼───────────┬─────────────────────┬─────────────────────┐
│                     │                     │                     │
▼                     ▼                     ▼                     ▼
┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐
│   hotel-saas    │  │   hotel-pms     │  │  hotel-member   │  │  hotel-common   │
│                 │  │                 │  │                 │  │                 │
│ 発行:            │  │ 発行:            │  │ 発行:            │  │ 発行:            │
│ - service.ordered │  │ - reservation.* │  │ - customer.*   │  │ - system.*     │
│ - feedback.*    │  │ - checkin_*     │  │ - member.*     │  │ - auth.*       │
│                 │  │ - billing.*     │  │ - points.*     │  │                 │
│                 │  │                 │  │                 │  │                 │
│ 購読:            │  │ 購読:            │  │ 購読:            │  │ 購読:            │
│ - reservation.* │  │ - service.*     │  │ - reservation.* │  │ - すべてのイベント  │
│ - checkin_*     │  │ - customer.*    │  │ - checkin_*    │  │                 │
│ - customer.*    │  │ - member.*      │  │ - billing.*    │  │                 │
└─────────────────┘  └─────────────────┘  └─────────────────┘  └─────────────────┘
```

## データ所有権

### マスタデータ所有権
- **顧客情報**: hotel-member
- **予約情報**: hotel-pms
- **サービス注文**: hotel-saas
- **請求情報**: hotel-pms
- **共通マスタ**: hotel-common

### 更新権限マトリックス

| データ | hotel-saas | hotel-pms | hotel-member | hotel-common |
|-------|------------|-----------|--------------|--------------|
| 顧客情報 | 参照のみ | 限定項目のみ更新可 | 完全な更新権限 | 参照のみ |
| 予約情報 | 参照のみ | 完全な更新権限 | 参照のみ | 参照のみ |
| サービス注文 | 完全な更新権限 | 参照のみ | 参照のみ | 参照のみ |
| 請求情報 | 参照のみ | 完全な更新権限 | 参照のみ | 参照のみ |
| 会員ポイント | 参照のみ | 参照のみ | 完全な更新権限 | 参照のみ |

## イベント連携詳細

### 主要イベント一覧

#### hotel-saas発行イベント
- `service.ordered`: サービス注文発生
- `service.canceled`: サービス注文キャンセル
- `feedback.submitted`: フィードバック送信

#### hotel-pms発行イベント
- `reservation.created`: 予約作成
- `reservation.updated`: 予約更新
- `reservation.canceled`: 予約キャンセル
- `checkin_checkout.checked_in`: チェックイン
- `checkin_checkout.checked_out`: チェックアウト
- `billing.created`: 請求作成
- `billing.paid`: 請求支払完了

#### hotel-member発行イベント
- `customer.created`: 顧客作成
- `customer.updated`: 顧客情報更新
- `member.registered`: 会員登録
- `member.status_changed`: 会員ステータス変更
- `points.added`: ポイント追加
- `points.used`: ポイント使用

### イベントスキーマ例

```json
// service.ordered
{
  "eventType": "service.ordered",
  "version": "1.0",
  "timestamp": "2023-01-01T12:00:00Z",
  "data": {
    "orderId": "ord_12345",
    "roomId": "room_789",
    "serviceId": "svc_456",
    "quantity": 2,
    "customerId": "cust_123",
    "price": 1500
  },
  "metadata": {
    "tenantId": "tenant_001",
    "source": "hotel-saas",
    "correlationId": "corr_abc123"
  }
}
```

## API連携

### API連携パターン

#### REST API
- 基本的なCRUD操作
- リソース指向設計
- OpenAPI仕様準拠

#### GraphQL
- 複雑なデータ取得
- フロントエンド最適化クエリ
- スキーマ駆動開発

### 認証・認可

- **Bearer Token認証**: JWT統一認証基盤
- **スコープベース認可**: 各APIエンドポイントに必要なスコープを定義
- **テナント分離**: すべてのAPIリクエストでテナントIDを検証

## 障害対策

### オフライン対応
- **ローカルキャッシュ**: 重要データのローカルキャッシュ
- **キュー機構**: 通信障害時のイベント蓄積
- **再同期機能**: 復旧後の差分同期

### 障害検知・復旧
- **ヘルスチェック**: 各システムの定期的な状態確認
- **サーキットブレーカー**: 障害時の連鎖防止
- **自動復旧**: 一時的障害からの自動回復

## 監視・運用

### 監視指標
- **システム健全性**: CPU、メモリ、ディスク使用率
- **アプリケーション指標**: レスポンス時間、エラー率
- **ビジネス指標**: 予約数、注文数、会員登録数

### アラート
- **重大度レベル**: 緊急、警告、情報
- **通知チャネル**: メール、Slack、SMS
- **エスカレーションポリシー**: 対応時間に応じた段階的エスカレーション

## デプロイメント

### 環境構成
- **開発環境**: 各開発者用
- **テスト環境**: 統合テスト用
- **ステージング環境**: 本番相当
- **本番環境**: 実サービス提供

### デプロイメントパイプライン
- **CI/CD**: GitHub Actions
- **コンテナ化**: Docker
- **オーケストレーション**: Kubernetes（大規模環境）

## セキュリティ

### データ保護
- **保存時暗号化**: 機密データの暗号化
- **転送時暗号化**: TLS 1.3
- **データマスキング**: 個人情報の表示制限

### アクセス制御
- **最小権限の原則**: 必要最小限の権限のみ付与
- **多要素認証**: 重要操作時
- **アクセスログ**: すべての重要操作を記録

## 将来の拡張性

### スケーリング戦略
- **水平スケーリング**: 負荷に応じたインスタンス追加
- **垂直スケーリング**: リソース増強
- **データベースシャーディング**: テナント別データ分割

### 新機能追加
- **プラグインアーキテクチャ**: 拡張ポイントの提供
- **機能フラグ**: 段階的な機能リリース
- **A/Bテスト**: 新機能の効果測定