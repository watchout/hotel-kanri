# マイグレーション: ページ管理モデルの追加

**マイグレーション日時**: 2025年8月10日  
**マイグレーションID**: 20250810000000_add_page_models  
**作成者**: システム管理者  
**関連チケット**: TOP Page Editor 開発チーム変更申請  

## 概要

hotel-saasのTOPページUI編集機能のために、ページ管理用のデータベーステーブルを追加します。これにより、コーディングスキルを持たないスタッフでも、16:9のTV画面に最適化されたTOPページを視覚的に編集・管理できるようになります。

## 変更内容

### 新規テーブル

1. `pages` - ページ本体を管理するテーブル
2. `page_histories` - ページの変更履歴を管理するテーブル

### テーブル構造

#### pages テーブル

| フィールド名 | 型 | 説明 | 制約 |
|------------|-----|------|------|
| Id | TEXT | 一意識別子 | PRIMARY KEY |
| TenantId | TEXT | テナントID | FOREIGN KEY |
| Slug | TEXT | ページ識別子 | - |
| Title | TEXT | ページタイトル | NOT NULL |
| Html | TEXT | HTML形式のコンテンツ | NULL許容 |
| Css | TEXT | CSSスタイル | NULL許容 |
| Content | TEXT | BlockNoteのJSONコンテンツ | NULL許容 |
| Template | TEXT | テンプレート識別子 | NULL許容 |
| IsPublished | BOOLEAN | 公開状態 | DEFAULT false |
| PublishedAt | TIMESTAMP | 公開日時 | NULL許容 |
| Version | INTEGER | バージョン番号 | DEFAULT 1 |
| CreatedAt | TIMESTAMP | 作成日時 | DEFAULT CURRENT_TIMESTAMP |
| UpdatedAt | TIMESTAMP | 更新日時 | - |

**インデックス**:
- UNIQUE [TenantId, Slug]
- INDEX [TenantId]
- INDEX [Slug]
- INDEX [IsPublished]

#### page_histories テーブル

| フィールド名 | 型 | 説明 | 制約 |
|------------|-----|------|------|
| Id | TEXT | 一意識別子 | PRIMARY KEY |
| PageId | TEXT | 親ページID | FOREIGN KEY |
| Html | TEXT | HTML形式のコンテンツ | NULL許容 |
| Css | TEXT | CSSスタイル | NULL許容 |
| Content | TEXT | BlockNoteのJSONコンテンツ | NULL許容 |
| Template | TEXT | テンプレート識別子 | NULL許容 |
| Version | INTEGER | バージョン番号 | NOT NULL |
| CreatedAt | TIMESTAMP | 作成日時 | DEFAULT CURRENT_TIMESTAMP |
| CreatedBy | TEXT | 作成者ID | NULL許容 |

**インデックス**:
- INDEX [PageId]
- INDEX [Version]

## 外部キー制約

1. `pages.TenantId` → `Tenant.id`
2. `page_histories.PageId` → `pages.Id` (ON DELETE CASCADE)

## 影響範囲

- **影響を受けるシステム**: hotel-saas (ページ編集機能)
- **影響を受けないシステム**: hotel-member, hotel-pms

## 注意事項

- テナントIDによるデータ分離を実装
- バージョン管理と履歴追跡が可能
- 公開/非公開の状態管理をサポート
- 複数のコンテンツ形式（HTML, CSS, JSON）を保存可能

## ロールバック手順

問題が発生した場合は以下のSQLを実行してロールバックします：

```sql
DROP TABLE IF EXISTS "page_histories";
DROP TABLE IF EXISTS "pages";
```
