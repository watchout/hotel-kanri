# Prisma移行テスト計画

## 概要

この文書では、Prismaスキーマの命名規則統一とPrismaアダプター導入後のテスト計画について説明します。テストは段階的に行い、各機能が正しく動作することを確認します。

## テスト環境

- **開発環境**: ローカル開発環境
- **テスト環境**: 開発用テスト環境（必要に応じて）
- **本番環境**: 最終確認後にのみデプロイ

## テストの種類

1. **単体テスト**: 個々のコンポーネントやモジュールのテスト
2. **統合テスト**: 複数のコンポーネントを組み合わせたテスト
3. **エンドツーエンドテスト**: ユーザーの視点からのテスト
4. **回帰テスト**: 既存機能が正しく動作することを確認するテスト

## テスト計画

### フェーズ1: 基本機能テスト

#### 1.1 Prismaアダプターの動作確認

- **目的**: Prismaアダプターが正しく動作することを確認する
- **テスト項目**:
  - 各モデルの基本的なCRUD操作
  - トランザクション処理
  - リレーションの取得
- **テストデータ**: テスト用データセット
- **期待される結果**: すべての操作が正常に完了し、データが期待通りに取得・更新される

```typescript
// テストコード例
import { hotelDb } from '../database/prisma';

async function testPrismaAdapter() {
  // 読み取りテスト
  const devices = await hotelDb.getAdapter().deviceRoom.findMany({
    where: { isActive: true }
  });
  console.log(`デバイス数: ${devices.length}`);
  
  // 作成テスト
  const newDevice = await hotelDb.getAdapter().deviceRoom.create({
    data: {
      tenantId: 'test-tenant',
      roomId: 'test-room',
      roomName: 'テストルーム',
      deviceType: 'test',
      status: 'active',
      createdAt: new Date(),
      updatedAt: new Date(),
      isActive: true
    }
  });
  console.log(`作成されたデバイス: ${newDevice.id}`);
  
  // 更新テスト
  const updatedDevice = await hotelDb.getAdapter().deviceRoom.update({
    where: { id: newDevice.id },
    data: {
      status: 'inactive',
      updatedAt: new Date()
    }
  });
  console.log(`更新されたデバイス: ${updatedDevice.status}`);
  
  // 削除テスト
  await hotelDb.getAdapter().deviceRoom.delete({
    where: { id: newDevice.id }
  });
  console.log('デバイスが削除されました');
}
```

#### 1.2 リポジトリレイヤーのテスト

- **目的**: 修正されたリポジトリが正しく動作することを確認する
- **テスト項目**:
  - DeviceRoomRepository
  - ResponseTreeRepository
  - その他の重要なリポジトリ
- **期待される結果**: リポジトリメソッドが正しく動作し、データの取得・更新が行われる

### フェーズ2: API機能テスト

#### 2.1 RESTful APIテスト

- **目的**: APIエンドポイントが正しく動作することを確認する
- **テスト項目**:
  - デバイス管理API
  - レスポンスツリーAPI
  - その他の重要なAPI
- **テストツール**: Postman, curl, またはAPIテスト用スクリプト
- **期待される結果**: APIが正常にレスポンスを返し、データが期待通りに処理される

#### 2.2 WebSocketテスト

- **目的**: WebSocket接続が正しく動作することを確認する
- **テスト項目**:
  - 接続確立
  - メッセージ送受信
  - 接続切断
- **期待される結果**: WebSocket接続が安定し、メッセージが正しく送受信される

### フェーズ3: 統合テスト

#### 3.1 フロントエンドとの統合テスト

- **目的**: バックエンドとフロントエンドの統合が正しく機能することを確認する
- **テスト項目**:
  - 管理画面の各機能
  - ユーザー向け機能
- **期待される結果**: UIが正しく表示され、データの取得・更新が正しく行われる

#### 3.2 外部システムとの統合テスト

- **目的**: 外部システムとの連携が正しく機能することを確認する
- **テスト項目**:
  - hotel-saas連携
  - hotel-member連携
  - その他の外部システム連携
- **期待される結果**: 外部システムとのデータ連携が正しく行われる

### フェーズ4: 回帰テスト

#### 4.1 既存機能の回帰テスト

- **目的**: 既存機能が引き続き正しく動作することを確認する
- **テスト項目**:
  - すべての主要機能
  - エッジケース
- **テスト方法**: 自動化テストとマニュアルテストの組み合わせ
- **期待される結果**: すべての既存機能が正しく動作する

## テスト実行計画

### テストの優先順位

1. **高優先度**: 認証、データ取得・更新の基本操作
2. **中優先度**: 複雑なビジネスロジック、外部システム連携
3. **低優先度**: エッジケース、非頻繁に使用される機能

### テストスケジュール

1. **フェーズ1**: 1-2日
2. **フェーズ2**: 2-3日
3. **フェーズ3**: 2-3日
4. **フェーズ4**: 1-2日

合計: 6-10日

## テスト結果の記録

テスト結果は以下の形式で記録します：

```
テスト項目: [項目名]
テスト日時: [日時]
テスト担当者: [担当者名]
テスト環境: [環境]
テスト結果: [成功/失敗]
詳細: [詳細な結果や問題点]
```

## 問題発生時の対応

1. 問題を特定し、再現手順を文書化
2. 問題の重要度を評価（クリティカル、高、中、低）
3. 修正を実施
4. 修正後に再テスト
5. テスト結果を記録

## 本番環境への移行基準

以下の条件をすべて満たした場合に本番環境への移行を検討します：

1. すべての高優先度テストが成功
2. クリティカルな問題が存在しない
3. 中優先度テストの90%以上が成功
4. 低優先度テストの80%以上が成功
5. パフォーマンステストで許容範囲内の結果

## ロールバック計画

問題が発生した場合のロールバック手順：

1. 現在のスキーマとコードをバックアップ
2. 以前のバージョンに戻す
3. データベースの整合性を確認
4. アプリケーションの動作確認
5. ユーザーに通知

## まとめ

このテスト計画に従って段階的にテストを実施し、Prismaスキーマの命名規則統一とPrismaアダプター導入による変更が正しく機能することを確認します。テスト結果に基づいて必要な修正を行い、安定した状態で本番環境への移行を目指します。
