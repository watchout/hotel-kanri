# スキーマとデータベース同期化計画

**作成日**: 2025年8月18日  
**バージョン**: 1.0  
**ステータス**: 実装中

## 1. 現状の問題

現在、Prismaスキーマ（`schema.prisma`）と実際のデータベース構造に不一致が存在しています。主な問題点は以下の通りです：

1. **service_usage_statistics テーブルの問題**:
   - マイグレーション20250731020156でテーブルが削除され、マイグレーション20250731123000で再作成されている
   - この削除と再作成のパターンがシャドウデータベースとの不整合を引き起こしている

2. **Staff テーブルの不一致**:
   - スキーマでは`password_hash`などのフィールドが定義されているが、実際のデータベースには存在しない可能性がある
   - マイグレーション20250728005730では`password_hash`フィールドを含むテーブル定義があるが、適用されていない可能性がある

3. **命名規則の不一致**:
   - スキーマではPascalCase（例：`Staff`）が使用されているが、データベースではsnake_case（例：`staff`）が使用されている
   - この不一致がマッピングの問題を引き起こす可能性がある

## 2. 同期化計画

### 2.1 準備作業

1. **データベースのバックアップ**:
   ```bash
   pg_dump -U [ユーザー名] -d [データベース名] -f backup_$(date +%Y%m%d_%H%M%S).sql
   ```

2. **現在のスキーマのバックアップ**:
   ```bash
   cp prisma/schema.prisma prisma/schema.prisma.bak_$(date +%Y%m%d_%H%M%S)
   ```

### 2.2 スキーマとデータベースの同期

#### 方法1: データベースからスキーマを再生成する

この方法は、実際のデータベース構造を「正」とし、スキーマをそれに合わせて更新します。

1. **データベースからスキーマを生成**:
   ```bash
   npx prisma db pull --schema=prisma/schema.pulled.prisma
   ```

2. **生成されたスキーマの確認**:
   ```bash
   diff prisma/schema.prisma prisma/schema.pulled.prisma > schema.diff.txt
   ```

3. **スキーマの更新**:
   - `schema.pulled.prisma`の内容を確認し、必要な修正を加えた上で`schema.prisma`を更新
   - 特に`Staff`モデルと`service_usage_statistics`モデルに注意

4. **クライアントの再生成**:
   ```bash
   npx prisma generate
   ```

#### 方法2: スキーマをデータベースに適用する

この方法は、現在のスキーマを「正」とし、データベースをそれに合わせて更新します。

1. **マイグレーションの作成**:
   ```bash
   npx prisma migrate dev --name sync_schema_with_database
   ```

2. **生成されたマイグレーションファイルの確認**:
   - `prisma/migrations/[timestamp]_sync_schema_with_database/migration.sql`を確認
   - 特に`Staff`テーブルと`service_usage_statistics`テーブルの変更に注意

3. **マイグレーションの適用**:
   ```bash
   npx prisma migrate deploy
   ```

### 2.3 推奨アプローチ

現状の分析に基づき、以下のアプローチを推奨します：

1. **マイグレーションの問題を解決**:
   - `scripts/merge-conflicting-migrations.js`を使用して競合するマイグレーションを統合
   - シャドウデータベースをリセット: `npx prisma migrate reset --skip-seed`

2. **スキーマとデータベースを同期**:
   - 実際のデータベース構造を確認: `npx prisma db pull`
   - 差分に基づいて`schema.prisma`を更新
   - 新しいマイグレーションを作成: `npx prisma migrate dev --name fix_schema_sync`

3. **検証**:
   - 更新されたスキーマでアプリケーションが正常に動作することを確認
   - 特に認証機能とStaffモデルを使用する機能を重点的にテスト

## 3. 実装手順

### 3.1 Day 1: 準備と分析

- [x] 問題の根本原因を特定
- [x] 競合するマイグレーションを分析
- [x] 解決策の計画を作成

### 3.2 Day 2: マイグレーションの修正

- [x] データベースのバックアップを作成
- [ ] 競合するマイグレーションを統合
- [ ] シャドウデータベースをリセット
- [ ] マイグレーションの適用をテスト

### 3.3 Day 3: スキーマとデータベースの同期

- [ ] 実際のデータベース構造を確認
- [ ] スキーマを更新
- [ ] 新しいマイグレーションを作成
- [ ] 同期を検証

### 3.4 Day 4: テストと文書化

- [ ] 更新されたスキーマでアプリケーションをテスト
- [ ] CI/CDパイプラインでのスキーマ検証を設定
- [ ] 変更内容を文書化
- [ ] チームメンバーに変更を通知

## 4. リスクと対策

### 4.1 データ損失のリスク

**リスク**: マイグレーションの適用中にデータが失われる可能性がある  
**対策**: 
- 本番環境への適用前に必ずバックアップを作成
- ステージング環境で事前にテスト
- 重要なデータを含むテーブルの変更は特に慎重に行う

### 4.2 アプリケーションの互換性

**リスク**: スキーマの変更がアプリケーションコードと互換性がない可能性がある  
**対策**:
- 変更後のスキーマでアプリケーションを十分にテスト
- 必要に応じてアプリケーションコードも更新
- 段階的にデプロイし、問題があればすぐにロールバックできるようにする

### 4.3 マイグレーションの失敗

**リスク**: マイグレーションが途中で失敗し、データベースが不整合な状態になる可能性がある  
**対策**:
- トランザクションを使用してマイグレーションを実行
- ロールバック手順を事前に準備
- 小さな変更に分割して段階的に適用

## 5. 今後の防止策

1. **マイグレーション管理の改善**:
   - マイグレーションの命名規則を厳格化
   - マイグレーションファイルのレビュープロセスを導入
   - 同じ日に同じ名前のマイグレーションを作成しない

2. **CI/CDでのスキーマ検証**:
   - プルリクエスト時にスキーマとマイグレーションを自動検証
   - 問題のあるマイグレーションをマージ前に検出

3. **データベース安全規則の遵守**:
   - 直接のSQL操作を禁止し、すべての変更をPrismaを通じて行う
   - スキーマの変更は必ずマイグレーションを通じて行う
   - 定期的にスキーマとデータベースの同期状態を確認

4. **開発者トレーニング**:
   - マイグレーションのベストプラクティスに関するトレーニングを実施
   - 新しいデータベース変更ガイドラインを共有

## 6. 結論

スキーマとデータベースの同期は、アプリケーションの安定性と信頼性を確保するために不可欠です。本計画を実施することで、現在の不一致を解消し、今後同様の問題が発生するリスクを最小限に抑えることができます。

マイグレーションの問題は、一見単純なエラーから始まることがありますが、適切に対処しないと技術的負債として蓄積されていきます。今回の取り組みを通じて、より堅牢なデータベース管理プロセスを確立し、長期的なプロジェクトの健全性を維持していきます。
