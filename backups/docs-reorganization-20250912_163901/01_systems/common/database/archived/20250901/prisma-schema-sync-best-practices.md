# Prismaスキーマ同期のベストプラクティス

## 概要

このドキュメントでは、Prismaスキーマとデータベースの間で一貫性を維持するためのベストプラクティスを説明します。スキーマドリフト（不一致）を防ぎ、安全かつ効率的にデータベース変更を管理するためのガイドラインを提供します。

## 基本原則

1. **単一の信頼できる情報源**：
   - schema.prismaファイルをデータベース構造の唯一の信頼できる情報源として扱う
   - すべてのデータベース変更はPrismaマイグレーションを通じて行う

2. **直接SQLの禁止**：
   - 直接SQLを使用してデータベーススキーマを変更しない
   - 緊急時の例外的な直接変更は、必ずschema.prismaの更新と同期を行う

3. **環境間の一貫性**：
   - 開発、テスト、本番環境で同じマイグレーション履歴を維持する
   - 環境固有の設定は.envファイルで管理し、schema.prismaは共通にする

## マイグレーションワークフロー

### 1. 新しいマイグレーションの作成

```bash
# 1. schema.prismaを編集
# 2. マイグレーションを作成
npx prisma migrate dev --name descriptive_name

# 3. 生成されたマイグレーションファイルをレビュー
# 4. 必要に応じてマイグレーションファイルを調整
```

### 2. 既存データベースからのスキーマ更新

```bash
# データベース構造をschema.prismaに反映
npx prisma db pull

# 生成されたスキーマを確認し、必要に応じて調整
# Prismaクライアントを再生成
npx prisma generate
```

### 3. マイグレーションの適用

```bash
# 開発環境
npx prisma migrate dev

# テスト/本番環境
npx prisma migrate deploy
```

### 4. マイグレーション後の検証

```bash
# データベース構造を確認
npx prisma db pull --print

# マイグレーション履歴を確認
npx prisma migrate status
```

## スキーマドリフト防止のためのベストプラクティス

### 1. 開発プロセス

- **チームでの変更の共有**：
  - スキーマ変更とマイグレーションファイルを迅速にコミットし共有する
  - マイグレーションファイルの競合を慎重に解決する

- **レビュープロセス**：
  - データベース変更のためのコードレビュープロセスを確立する
  - マイグレーションファイルを慎重にレビューする

- **テスト**：
  - マイグレーションのテストを自動化する
  - マイグレーション適用後のアプリケーションテストを実行する

### 2. 運用プロセス

- **バックアップ**：
  - マイグレーション前にデータベースをバックアップする
  - 重要なマイグレーションは本番環境適用前に複数回テストする

- **ロールバック計画**：
  - 各マイグレーションのロールバック手順を文書化する
  - 可能な限り、ロールバックマイグレーションを準備する

- **監視**：
  - マイグレーション適用後のデータベースパフォーマンスを監視する
  - スキーマ変更の影響を評価する

### 3. 自動化とツール

- **CI/CD統合**：
  - CI/CDパイプラインにマイグレーション検証を組み込む
  - 環境間のスキーマ差異を自動的に検出する

- **スキーマ検証**：
  - 定期的にschema.prismaとデータベース構造の整合性をチェックする
  - 不一致を検出するスクリプトを実行する

```javascript
// schema-validation.js
const { execSync } = require('child_process');
const fs = require('fs');

// データベース構造をテンポラリファイルに出力
execSync('npx prisma db pull --schema=./temp-schema.prisma');

// 現在のスキーマとの差分を確認
const diff = execSync('diff ./prisma/schema.prisma ./temp-schema.prisma').toString();

if (diff) {
  console.error('スキーマドリフトが検出されました:');
  console.error(diff);
  process.exit(1);
} else {
  console.log('スキーマは同期しています');
  // テンポラリファイルを削除
  fs.unlinkSync('./temp-schema.prisma');
}
```

## 共通の問題と解決策

### 1. マイグレーション競合

**問題**：複数の開発者が同時にスキーマを変更し、マイグレーションファイルが競合する

**解決策**：
- 変更を小さく保ち、頻繁に統合する
- マージ前にマイグレーション履歴を確認する
- 競合が発生した場合は、マイグレーションをリセットして再作成する

```bash
# マイグレーションのリセット（開発環境のみ）
npx prisma migrate reset

# 新しいマイグレーションの作成
npx prisma migrate dev --name resolved_conflicts
```

### 2. シャドウデータベースの問題

**問題**：シャドウデータベースの作成に失敗し、マイグレーションの検証ができない

**解決策**：
- シャドウデータベースの接続設定を確認する
- 必要に応じて手動でシャドウデータベースを作成する
- `--skip-generate` フラグを使用して問題を切り分ける

```bash
# シャドウデータベースの問題をバイパス（緊急時のみ）
npx prisma migrate dev --name emergency_fix --skip-generate --skip-seed
```

### 3. 本番環境での不一致

**問題**：本番環境のデータベース構造がschema.prismaと一致しない

**解決策**：
- 本番環境のデータベース構造をエクスポートして分析
- 差異を特定し、修正マイグレーションを作成
- 修正マイグレーションを慎重にテストしてから適用

```bash
# 本番環境のスキーマをエクスポート（安全な方法で）
npx prisma db pull --schema=./prod-schema.prisma

# 差異を確認
diff ./prisma/schema.prisma ./prod-schema.prisma

# 修正マイグレーションを作成
npx prisma migrate dev --name fix_production_schema
```

## マイグレーション適用のチェックリスト

### 開発環境

1. 最新のコードをプル
2. 依存関係をインストール
3. マイグレーションを適用: `npx prisma migrate dev`
4. Prismaクライアントを生成: `npx prisma generate`
5. アプリケーションをテスト

### テスト/ステージング環境

1. マイグレーション前にデータベースをバックアップ
2. マイグレーションを適用: `npx prisma migrate deploy`
3. マイグレーション状態を確認: `npx prisma migrate status`
4. アプリケーションの統合テストを実行
5. パフォーマンスへの影響を評価

### 本番環境

1. 計画されたメンテナンス時間を確保
2. マイグレーション前にデータベースをバックアップ
3. マイグレーションを適用: `npx prisma migrate deploy`
4. マイグレーション状態を確認: `npx prisma migrate status`
5. アプリケーションの動作を検証
6. 監視を強化して問題を早期に検出

## 結論

Prismaスキーマとデータベースの間の一貫性を維持することは、安定したアプリケーション開発と運用の鍵です。このドキュメントで説明したベストプラクティスに従うことで、スキーマドリフトを防ぎ、データベース変更を安全かつ効率的に管理できます。

定期的なスキーマ検証、厳格なマイグレーションプロセス、そして適切な自動化を通じて、データベーススキーマの整合性を維持し、アプリケーションの信頼性を確保しましょう。
