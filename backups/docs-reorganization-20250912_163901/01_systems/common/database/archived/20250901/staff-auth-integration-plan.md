# スタッフ認証統合計画

**作成日**: 2025年8月18日  
**バージョン**: 1.0  
**ステータス**: 提案

## 1. 現状分析

### 1.1 スタッフテーブルの現状

現在、`staff`テーブルには以下の問題が確認されています：

1. **スキーマとデータベースの不一致**:
   - Prismaスキーマでは`password_hash`などの認証関連フィールドが定義されている
   - 実際のデータベースには、これらのフィールドが存在しない

2. **マイグレーションの状況**:
   - マイグレーション20250728005730_add_staff_management_systemでは`password_hash`を含む定義がある
   - マイグレーション20250815000000_add_password_fields_to_staffで再度追加を試みている
   - マイグレーション20250817000000_sync_schema_with_databaseでも同様の追加を試みている

3. **認証機能への影響**:
   - 現在の認証システムは、存在しないフィールドに依存している可能性がある
   - JWTベースの認証は正常に機能しているが、パスワード検証に問題がある可能性がある

### 1.2 関連システムの状況

- **hotel-saas**チームからの報告によると、`users`テーブルが存在しないとの指摘がある
- 実際には`users`テーブルは存在せず、認証は`staff`テーブルと`admin`テーブルに基づいている
- `hotel-common`は認証の中央サービスとして機能している

## 2. 統合計画

### 2.1 短期的解決策

1. **スキーマとデータベースの同期**:
   - `staff`テーブルに必要な認証フィールドを追加するマイグレーションを適用
   - マイグレーションが失敗する場合は、手動でSQLを実行

   ```sql
   ALTER TABLE "staff" ADD COLUMN IF NOT EXISTS "password_hash" TEXT;
   ALTER TABLE "staff" ADD COLUMN IF NOT EXISTS "failed_login_count" INTEGER NOT NULL DEFAULT 0;
   ALTER TABLE "staff" ADD COLUMN IF NOT EXISTS "last_login_at" TIMESTAMP(3);
   ALTER TABLE "staff" ADD COLUMN IF NOT EXISTS "locked_until" TIMESTAMP(3);
   CREATE INDEX IF NOT EXISTS "Staff_email_idx" ON "staff"("email");
   ```

2. **認証ロジックの確認**:
   - `src/auth/middleware.ts`と`src/auth/jwt.ts`の認証ロジックを確認
   - パスワード検証が正しく行われているか確認
   - 必要に応じてロジックを修正

3. **テスト**:
   - スタッフログインのテストを実施
   - JWTトークン生成と検証のテストを実施
   - 権限チェックのテストを実施

### 2.2 中期的解決策

1. **認証システムの統一**:
   - `staff`と`admin`の認証ロジックを統一
   - 共通の認証インターフェースを作成

2. **認証ドキュメントの更新**:
   - 正確な認証フローを文書化
   - 各テーブルの役割と関連を明確に説明

3. **マイグレーション整理**:
   - 重複するマイグレーションを整理
   - 一貫性のあるマイグレーション履歴を確立

### 2.3 長期的解決策

1. **認証サービスの分離**:
   - 認証ロジックを専用のサービスに分離
   - マイクロサービスアーキテクチャに適した設計に移行

2. **多要素認証の導入**:
   - TOTPベースの2要素認証を導入
   - バックアップコードシステムの実装

3. **セキュリティ強化**:
   - パスワードポリシーの強化
   - アカウントロックアウトポリシーの改善
   - セキュリティ監査ログの強化

## 3. 実装計画

### 3.1 フェーズ1: 緊急対応（1-2日）

- [x] 問題の根本原因を特定
- [x] スキーマとデータベースの不一致を文書化
- [ ] 必要なフィールドを`staff`テーブルに追加
- [ ] 基本的な認証機能をテスト

### 3.2 フェーズ2: 安定化（1週間）

- [ ] 認証ロジックの包括的なレビュー
- [ ] テストカバレッジの向上
- [ ] 認証関連のバグ修正
- [ ] 更新されたドキュメントの作成

### 3.3 フェーズ3: 最適化（2-3週間）

- [ ] 認証システムのリファクタリング
- [ ] パフォーマンス最適化
- [ ] セキュリティ強化
- [ ] 開発者向けドキュメントの充実

## 4. チーム間連携

### 4.1 hotel-saas チームとの連携

- 認証システムの正確な情報を共有
- `users`テーブルが存在しない理由と代替手段を説明
- 統合テストを共同で実施

### 4.2 hotel-member チームとの連携

- 認証システムの変更点を共有
- APIの互換性を確保
- 統合テストを共同で実施

### 4.3 hotel-pms チームとの連携

- 認証システムの変更点を共有
- 権限システムへの影響を確認
- 統合テストを共同で実施

## 5. リスクと対策

### 5.1 データ整合性のリスク

**リスク**: スキーマ変更により既存データが影響を受ける可能性  
**対策**: 
- バックアップの作成
- 読み取り専用の移行期間を設ける
- データ検証ツールの開発

### 5.2 認証障害のリスク

**リスク**: 認証システムの変更により、ユーザーがログインできなくなる可能性  
**対策**:
- 段階的なロールアウト
- フォールバック認証メカニズムの準備
- 24時間のサポート体制

### 5.3 パフォーマンスのリスク

**リスク**: 認証システムの変更によりパフォーマンスが低下する可能性  
**対策**:
- 負荷テストの実施
- パフォーマンスモニタリングの強化
- 段階的な最適化

## 6. 結論

スタッフ認証システムの問題は、スキーマとデータベースの不一致に起因しています。この計画を実施することで、短期的には現在の問題を解決し、長期的には堅牢で拡張性のある認証システムを構築することができます。

各チームとの緊密な連携と段階的なアプローチにより、リスクを最小限に抑えながら、システム全体の安定性と信頼性を向上させることが可能です。