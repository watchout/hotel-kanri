# データベースマイグレーションガイドライン

**作成日**: 2025年8月18日  
**バージョン**: 1.0  
**対象**: 開発者、データベース管理者

## 1. はじめに

このガイドラインは、Prismaを使用したデータベースマイグレーションの計画、実行、管理に関するベストプラクティスを提供します。適切なマイグレーション管理は、データの整合性を維持し、アプリケーションの安定性を確保するために不可欠です。

## 2. マイグレーションの基本原則

### 2.1 計画と設計

- **スキーマ変更の事前計画**: すべてのスキーマ変更は事前に計画し、文書化する
- **影響分析**: 変更がアプリケーションの他の部分に与える影響を評価する
- **段階的な変更**: 大規模な変更は小さな段階に分割する

### 2.2 命名規則

- **マイグレーション名**: 日付_時間_簡潔な説明（例: `20250818120000_add_user_preferences`）
- **一意性の確保**: 同じ日に複数のマイグレーションを作成する場合は、説明部分を明確に区別する
- **命名の一貫性**: 同様の変更には同様の命名パターンを使用する

### 2.3 コンテンツのガイドライン

- **自己完結性**: 各マイグレーションは独立して機能すべき
- **冪等性**: 可能な限り、マイグレーションは複数回実行しても同じ結果になるようにする
- **ロールバック対応**: すべてのマイグレーションにはロールバック手順を含める

## 3. マイグレーションのライフサイクル

### 3.1 開発段階

1. スキーマの変更（`schema.prisma`の編集）
2. マイグレーションの生成: `npx prisma migrate dev --name 変更内容を表す名前`
3. 生成されたマイグレーションファイルのレビュー
4. 必要に応じてマイグレーションファイルの手動調整
5. ローカル環境でのテスト

### 3.2 レビュー段階

1. コードレビュープロセスの一部としてマイグレーションをレビュー
2. 以下の点を確認:
   - 命名規則の遵守
   - データ損失のリスク
   - パフォーマンスへの影響
   - ロールバック手順の適切さ

### 3.3 デプロイメント段階

1. ステージング環境でのテスト: `npx prisma migrate deploy`
2. 本番環境へのデプロイ前の最終確認
3. 本番環境へのデプロイ: `npx prisma migrate deploy`
4. デプロイ後の検証

## 4. 特別なケースの処理

### 4.1 データマイグレーション

データ構造の変更に加えてデータ自体の移行が必要な場合:

```sql
-- データ移行の例
INSERT INTO new_table (id, name, value)
SELECT id, name, value FROM old_table;
```

### 4.2 破壊的変更

テーブルやカラムの削除など、破壊的変更を行う場合:

- 段階的アプローチを採用（例: 最初にカラムを非推奨にし、後のマイグレーションで削除）
- 十分な警告と文書化を提供
- データのバックアップを確保

### 4.3 大規模なテーブルの変更

大規模なテーブルを変更する場合:

- ダウンタイムの最小化戦略を計画
- バッチ処理の検討
- 非ピーク時間帯での実行

## 5. トラブルシューティング

### 5.1 一般的な問題と解決策

| 問題 | 解決策 |
|------|--------|
| マイグレーションの競合 | 競合するマイグレーションを手動で統合 |
| シャドウDBエラー | `npx prisma migrate reset --skip-seed` でシャドウDBをリセット |
| 実行時間の長いマイグレーション | インデックス作成などの長時間操作は別のマイグレーションに分離 |

### 5.2 マイグレーションのリセットとロールバック

- **開発環境でのリセット**: `npx prisma migrate reset`
- **本番環境でのロールバック**: 事前に計画されたロールバック手順に従う

## 6. ベストプラクティス

1. **小さく頻繁なマイグレーション**: 大きな変更を小さなマイグレーションに分割
2. **テスト環境での検証**: 本番環境に適用する前に必ずテスト環境で検証
3. **バックアップ**: マイグレーション実行前に必ずデータベースをバックアップ
4. **ドキュメント化**: 複雑なマイグレーションはコメントで説明
5. **監視**: マイグレーション実行中と実行後のデータベースパフォーマンスを監視

## 7. 避けるべき実践

1. **直接のデータベース変更**: すべての変更はマイグレーションを通じて行う
2. **テーブルの削除と再作成**: 可能な限り、`ALTER TABLE`を使用する
3. **複数の大きな変更を1つのマイグレーションに含める**: 変更は論理的に分割する
4. **適切なテストなしでのデプロイ**: 常に事前にテスト環境で検証する

## 8. チェックリスト

### マイグレーション作成前:
- [ ] スキーマ変更は十分に計画されているか
- [ ] 命名規則に従っているか
- [ ] 変更の影響範囲を理解しているか

### マイグレーション作成後:
- [ ] 生成されたSQLをレビューしたか
- [ ] 必要に応じて手動調整を行ったか
- [ ] ローカル環境でテストしたか

### デプロイ前:
- [ ] コードレビューを受けたか
- [ ] ステージング環境でテストしたか
- [ ] バックアップ戦略があるか

## 9. 参考資料

- [Prisma Migration Documentation](https://www.prisma.io/docs/concepts/components/prisma-migrate)
- [Database Migration Best Practices](https://www.prisma.io/dataguide/types/relational/migration-strategies)
- [SQL Performance Best Practices](https://use-the-index-luke.com/)

---

このガイドラインは、プロジェクトの成長に合わせて定期的に更新されます。最新バージョンを参照してください。
