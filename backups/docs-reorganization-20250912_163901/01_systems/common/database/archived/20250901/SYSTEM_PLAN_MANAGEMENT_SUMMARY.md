# システム別プラン管理 - 実装サマリー

## 変更概要

ホテル統合システムにおいて、各サブシステム（AIコンシェルジュ、PMS、CRM）ごとに独立したプラン管理を実現するためのデータベース設計変更を実施しました。

## 主な変更点

1. **新規テーブルの追加**
   - `SystemPlanRestrictions`: システム別のプラン制限を管理
   - `TenantSystemPlan`: テナントとシステムプランの関連付けを管理
   - `DatabaseChangeLog`: データベース変更履歴を記録

2. **既存テーブルの変更**
   - `Tenant`: システム別プランへの関連付けを追加
   - `PlanRestrictions`: 下位互換性のために残しつつ、コメントを追加

## システム別プラン体系

新しいプラン体系では、以下の組み合わせでプランを管理できます：

- **システム種別**: saas, pms, member
- **業態種別**: general, leisure, overseas
- **プラン種別**: economy, professional, enterprise, ultimate

これにより、例えば「AIコンシェルジュはレジャー向けプロフェッショナル、PMSは一般ホテル向けエコノミー」といった柔軟な組み合わせが可能になります。

## 実装ファイル

1. **スキーマ変更**
   - `prisma/schema.prisma`

2. **マイグレーションファイル**
   - `prisma/migrations/20250731163216_add_system_plan_management/migration.sql`

3. **設計ドキュメント**
   - `docs/database/design/SYSTEM_PLAN_MANAGEMENT.md`
   - `docs/database/design/SYSTEM_PLAN_STRUCTURE.md`

## 注意点

1. **既存データとの互換性**
   - 既存のテナントデータはそのまま維持されます
   - 新しいシステム別プランへの移行は別途実施する必要があります

2. **ユニーク制約**
   - テナントごとに各システム種別で1つのプランのみ関連付け可能
   - 同一テナントで同一システムに複数のプランを設定することはできません

3. **データベース変更履歴**
   - すべてのスキーマ変更は`DatabaseChangeLog`テーブルに記録されます
   - 変更履歴は自動的に記録され、監査証跡として利用可能です

## 今後の対応

1. **既存データの移行**
   - 既存テナントのプラン情報を新しいシステム別プランに移行するスクリプトの作成

2. **管理画面の対応**
   - システム別プラン管理のための管理画面の実装

3. **請求システムとの連携**
   - 複数システム利用時の料金計算ロジックの実装

## まとめ

この変更により、テナントごとに各サブシステムの異なるプランを柔軟に管理できるようになりました。また、データベース変更履歴の記録機能により、スキーマ変更の追跡が容易になります。