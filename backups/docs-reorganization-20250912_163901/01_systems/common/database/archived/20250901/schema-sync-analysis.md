# スキーマ同期問題の分析レポート

**作成日**: 2025年8月20日  
**作成者**: データベース管理チーム

## 概要

Prismaスキーマとデータベース構造の同期問題について調査を行いました。`prisma db pull`コマンドを実行した結果、スキーマが正常に更新され、現在はデータベースとの整合性が取れています。本レポートでは、以前の不一致の原因と、今後の対策について説明します。

## 調査結果

### 1. 同期の現状

`npx prisma db pull --force`を実行した結果：
- 34個のモデルが正常にインポートされました
- 以前検出されていた不一致は解消されました
- `npx prisma generate`でクライアントコードも正常に生成されました

検証スクリプト`scripts/check-schema-db.js`の実行結果：
```
=== スキーマ検証レポート ===
モデル定義の不一致はありません。
```

### 2. 以前の不一致の原因

以前のスキーマとデータベースの不一致は、以下の原因によるものと考えられます：

#### 2.1 マッピング定義の欠如

以前のスキーマでは、モデル名とテーブル名のマッピングが明示的に定義されていませんでした。現在のスキーマを確認したところ、`@@map`ディレクティブが存在しないことが確認されました：

```bash
grep -n "@@map" prisma/schema.prisma
# 結果なし
```

これは、Prismaが自動的にデータベースのテーブル名をそのままモデル名として使用していることを示しています。

#### 2.2 命名規則の不一致

以前のスキーマでは、モデル名にPascalCase（例：`Order`）を使用し、テーブル名にsnake_case（例：`order`）を使用していました。しかし、マッピング定義がなかったため、Prismaはモデル名をそのままテーブル名として解釈していました。

#### 2.3 直接的なSQL操作

データベースに対する直接的なSQL操作が行われた可能性があります。特に、Orderテーブルの欠落は、マイグレーションファイルには存在するものの、実際のデータベースには適用されていなかった、または後に削除された可能性を示唆しています。

#### 2.4 マイグレーションの適用不備

マイグレーションファイルが正しく適用されなかった可能性があります。例えば、マイグレーションコマンドの実行エラーや、マイグレーション履歴の不整合などが考えられます。

## 現在のスキーマの特徴

1. **テーブル名とモデル名の一致**：
   - 現在のスキーマでは、モデル名がデータベースのテーブル名と完全に一致しています
   - 例：`model Order { ... }` → テーブル名も`Order`

2. **マッピング定義の欠如**：
   - `@@map`ディレクティブが使用されていないため、モデル名=テーブル名となっています
   - PostgreSQLでは通常、引用符なしのテーブル名は小文字に変換されますが、現在は引用符付きで定義されている可能性があります

3. **一貫性のある命名規則**：
   - すべてのモデル/テーブルが一貫した命名規則に従っています
   - ただし、この命名規則がベストプラクティス（モデル名:PascalCase、テーブル名:snake_case）に従っているわけではありません

## 今後の対策

### 1. 命名規則の明確化と統一

```prisma
// 推奨される命名規則
model User {
  // フィールド定義...
  
  @@map("users") // テーブル名はsnake_case
}
```

### 2. マイグレーションプロセスの改善

- マイグレーション前後での検証プロセスの導入
- マイグレーション履歴と実際のデータベース構造の定期的な整合性チェック
- マイグレーション適用の自動化とログ記録

### 3. SQL直接操作の禁止

- 既に作成済みの`docs/database/SQL_DIRECT_OPERATION_PREVENTION.md`ポリシーの徹底
- データベースユーザー権限の制限
- 変更管理プロセスの導入

### 4. CI/CDパイプラインでの検証

- デプロイ前にスキーマとデータベースの整合性を自動検証
- 不一致が検出された場合はデプロイをブロック

## 結論

スキーマとデータベースの不一致は、`prisma db pull --force`コマンドによって解消されました。この不一致の主な原因は、マッピング定義の欠如、命名規則の不一致、直接的なSQL操作、およびマイグレーションの適用不備と考えられます。

今後は、明確な命名規則の統一、マイグレーションプロセスの改善、SQL直接操作の禁止、およびCI/CDパイプラインでの検証を通じて、同様の問題の再発を防止することが重要です。

特に、モデル名とテーブル名の関係を明示的に定義するために`@@map`ディレクティブの使用を推奨します。これにより、命名規則の一貫性を保ちながら、Prismaとデータベースの間の整合性を確保することができます。
