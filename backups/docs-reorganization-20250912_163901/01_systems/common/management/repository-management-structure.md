# リポジトリ管理体制

このドキュメントでは、omotenasuai.comプロジェクトにおけるリポジトリ管理体制と開発フローを定義します。

## 1. リポジトリ構成

### 1.1 管理リポジトリ

**hotel-kanri**

- **目的**: プロジェクト全体の管理、設定、ドキュメント
- **内容**:
  - インフラ設定ファイル
  - デプロイスクリプト
  - 開発・運用ドキュメント
  - 環境設定テンプレート
  - 監視・ロギング設定
- **アクセス権**: 管理者のみ

### 1.2 機能リポジトリ

**hotel-common**
- **目的**: 共通基盤機能
- **内容**: 共通ライブラリ、ユーティリティ、API

**hotel-saas**
- **目的**: AIコンシェルジュアプリケーション
- **内容**: AIコンシェルジュ機能の実装

**hotel-pms**
- **目的**: プロパティマネジメントシステム
- **内容**: ホテル管理機能の実装

**hotel-member**
- **目的**: 会員管理システム
- **内容**: CRM機能の実装

## 2. 環境構成

### 2.1 環境の種類

**ローカル環境**
- 開発者の個人マシン
- Docker/Docker Composeで構築
- `.env.local`で設定

**開発サーバー環境**
- 共有開発サーバー (163.44.117.60)
- `dev-*.omotenasuai.com`サブドメイン
- `.env.development`で設定

**本番環境**
- 本番サーバー (将来的にさくらクラウド)
- `*.omotenasuai.com`サブドメイン（プレフィックスなし）
- `.env.production`で設定

### 2.2 環境間の移行

**ローカル → 開発サーバー**
1. ローカルでの変更をGitにコミット・プッシュ
2. 開発サーバーでプル
3. 開発サーバーでビルド・デプロイ

**開発サーバー → 本番環境**
1. 開発サーバーでのテスト完了後、リリースブランチ作成
2. リリースブランチをレビュー・承認
3. 本番環境にデプロイ

## 3. 管理フロー

### 3.1 コード管理フロー

```
ローカル開発 → Gitプッシュ → 開発サーバーデプロイ → テスト → リリースブランチ作成 → レビュー → 本番デプロイ
```

### 3.2 設定管理フロー

```
hotel-kanriで設定変更 → Gitプッシュ → 開発サーバーで設定適用 → テスト → 本番環境で設定適用
```

### 3.3 ドキュメント管理フロー

```
hotel-kanriでドキュメント作成/更新 → Gitプッシュ → レビュー → マージ → チーム共有
```

## 4. リポジトリ間の関係

### 4.1 依存関係

```
hotel-kanri
  ↑
  ├── hotel-common
  │     ↑
  ├────┼── hotel-saas
  ├────┼── hotel-pms
  └────┴── hotel-member
```

### 4.2 変更の伝播

1. **hotel-kanri**の変更
   - インフラ設定、デプロイスクリプトの変更
   - 全リポジトリに影響する可能性

2. **hotel-common**の変更
   - 共通機能の変更
   - 他の機能リポジトリに影響する可能性

3. **機能リポジトリ**の変更
   - 特定機能の変更
   - 基本的に他のリポジトリには影響しない

## 5. 権限管理

### 5.1 リポジトリ権限

| リポジトリ | 管理者 | 開発者 | 閲覧者 |
|------------|--------|--------|--------|
| hotel-kanri | 書込・マージ | 読取のみ | 読取のみ |
| hotel-common | 書込・マージ | PR作成 | 読取のみ |
| 機能リポジトリ | 書込・マージ | PR作成 | 読取のみ |

### 5.2 環境アクセス権限

| 環境 | 管理者 | 開発者 | 閲覧者 |
|------|--------|--------|--------|
| ローカル | - | 完全アクセス | - |
| 開発サーバー | 完全アクセス | SSH読取・実行 | - |
| 本番環境 | 完全アクセス | なし | なし |

## 6. デプロイプロセス

### 6.1 開発サーバーへのデプロイ

```bash
# 開発サーバーにSSH接続
ssh admin@163.44.117.60

# 対象リポジトリに移動
cd ~/projects/[repository-name]

# 最新コードを取得
git pull origin main

# 依存関係のインストール
npm ci

# ビルド
npm run build

# アプリケーション再起動
pm2 reload [app-name]
```

### 6.2 本番環境へのデプロイ

```bash
# リリースブランチの作成（ローカルで）
git checkout -b release/vX.Y.Z
git tag vX.Y.Z
git push origin release/vX.Y.Z --tags

# 本番サーバーでのデプロイ（管理者のみ）
ssh admin@[production-server]
cd ~/projects/[repository-name]
git fetch
git checkout vX.Y.Z
npm ci --production
npm run build
pm2 reload [app-name]
```

## 7. 継続的インテグレーション/デリバリー

### 7.1 現在の手動プロセス

1. 開発者がコードをプッシュ
2. 管理者が開発サーバーにデプロイ
3. テスト実施
4. 管理者が本番環境にデプロイ

### 7.2 将来的なCI/CD計画

1. GitHub Actionsによる自動テスト
2. 開発サーバーへの自動デプロイ
3. 本番環境への承認ベースデプロイ

## 8. 監視と通知

### 8.1 現在の監視体制

- サーバーリソース監視: `htop`, `df -h`
- アプリケーションログ: `pm2 logs`
- エラー通知: 手動確認

### 8.2 将来的な監視計画

- Prometheusによるメトリクス収集
- Grafanaによる可視化
- アラート自動通知

## 9. バックアップ戦略

### 9.1 コードバックアップ

- Gitリポジトリによるバージョン管理
- GitHub/GitLabによるリモートバックアップ

### 9.2 データバックアップ

- データベース: 日次バックアップ
- 設定ファイル: Gitで管理
- ユーザーデータ: 定期バックアップ

## 10. 障害復旧計画

### 10.1 軽微な障害

1. 問題の特定
2. 修正コミット
3. 緊急デプロイ

### 10.2 重大な障害

1. 問題の特定
2. 最終安定バージョンへのロールバック
3. 根本原因の分析
4. 修正と再デプロイ

---

このドキュメントは、プロジェクトの進行に合わせて定期的に更新されます。
最終更新: [YYYY-MM-DD]