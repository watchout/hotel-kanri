# âš¡ ã€å³æ™‚ç§»è¡Œã€‘ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  å®Ÿè£…è¨ˆç”»æ›¸

**ä½œæˆæ—¥**: 2025å¹´1æœˆ19æ—¥  
**ç§»è¡Œæ–¹å¼**: **å³æ™‚ç§»è¡Œï¼ˆé–‹ç™ºæ®µéšå¯¾å¿œï¼‰**  
**å®Ÿè£…æœŸé–“**: 2025å¹´1æœˆ20æ—¥ ã€œ 2025å¹´2æœˆ9æ—¥ï¼ˆ3é€±é–“ï¼‰  
**å„ªå…ˆåº¦**: ğŸ”´ **æœ€é«˜å„ªå…ˆåº¦**

---

## ğŸ¯ **å³æ™‚ç§»è¡Œã®å®Ÿè£…æˆ¦ç•¥**

### **ç§»è¡Œæ–¹å¼å¤‰æ›´ã®ç†ç”±**
- âœ… **é–‹ç™ºæ®µéšã®åˆ©ç‚¹æ´»ç”¨**: è¤‡é›‘ãªä¸¦è¡Œé‹ç”¨ãƒ­ã‚¸ãƒƒã‚¯ä¸è¦
- âœ… **å®Ÿè£…åŠ¹ç‡æœ€å¤§åŒ–**: å˜ä¸€ã‚·ã‚¹ãƒ†ãƒ ã§ã®é›†ä¸­é–‹ç™º
- âœ… **ãƒ†ã‚¹ãƒˆç°¡ç´ åŒ–**: ç§»è¡ŒæœŸé–“ä¸­ã®è¤‡é›‘ãªçŠ¶æ…‹ç®¡ç†ãŒä¸è¦
- âœ… **æ—©æœŸå•é¡Œè§£æ±º**: æ³¨æ–‡æ··åœ¨å•é¡Œã®å³åº§è§£æ±º

### **å³æ™‚ç§»è¡Œã®å‰ææ¡ä»¶**
- ğŸ”§ **é–‹ç™ºç’°å¢ƒ**: æœ¬ç•ªãƒ‡ãƒ¼ã‚¿ã¸ã®å½±éŸ¿ãªã—
- ğŸ”§ **ãƒ†ã‚¹ãƒˆç’°å¢ƒ**: å®Œå…¨ãªæ¤œè¨¼ç’°å¢ƒ
- ğŸ”§ **ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—**: å®Œå…¨ãªãƒ‡ãƒ¼ã‚¿ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
- ğŸ”§ **ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯**: å³åº§å¾©æ—§å¯èƒ½ãªä½“åˆ¶

---

## ğŸ“… **3é€±é–“å®Ÿè£…ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«**

### **Week 1: åŸºç›¤å®Ÿè£…é€±ï¼ˆ1/20-1/26ï¼‰**

#### **Day 1-2 (1/20-1/21): ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åŸºç›¤**
```yaml
Monday 1/20:
  AM: 
    - [ ] ã‚¹ã‚­ãƒ¼ãƒè¨­è¨ˆæœ€çµ‚ç¢ºèª
    - [ ] é–‹ç™ºç’°å¢ƒãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æº–å‚™
    - [ ] æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
  PM:
    - [ ] CheckinSessionãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
    - [ ] SessionBillingãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
    - [ ] ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãƒ»åˆ¶ç´„è¨­å®š

Tuesday 1/21:
  AM:
    - [ ] æ—¢å­˜ãƒ†ãƒ¼ãƒ–ãƒ«æ‹¡å¼µï¼ˆservice_orders.session_idè¿½åŠ ï¼‰
    - [ ] ç›£æŸ»ãƒ­ã‚°ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
    - [ ] ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§åˆ¶ç´„è¨­å®š
  PM:
    - [ ] åŸºæœ¬CRUDæ“ä½œãƒ†ã‚¹ãƒˆ
    - [ ] ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ€§èƒ½ãƒ†ã‚¹ãƒˆ
    - [ ] åˆ¶ç´„ãƒ»ãƒˆãƒªã‚¬ãƒ¼å‹•ä½œç¢ºèª
```

#### **Day 3-4 (1/22-1/23): APIå®Ÿè£…**
```yaml
Wednesday 1/22:
  AM:
    - [ ] ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†APIå®Ÿè£…
      - POST /api/sessions (ä½œæˆ)
      - GET /api/sessions/:id (å–å¾—)
      - PATCH /api/sessions/:id (æ›´æ–°)
  PM:
    - [ ] ã‚»ãƒƒã‚·ãƒ§ãƒ³æ¤œç´¢APIå®Ÿè£…
      - GET /api/sessions/by-number/:number
      - GET /api/sessions/active-by-room/:roomId
      - GET /api/sessions/search

Thursday 1/23:
  AM:
    - [ ] ã‚»ãƒƒã‚·ãƒ§ãƒ³è«‹æ±‚APIå®Ÿè£…
      - POST /api/session-billings
      - GET /api/session-billings/:id
      - PATCH /api/session-billings/:id
  PM:
    - [ ] ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†å®Ÿè£…
      - session.created
      - session.checked_out
      - session.billing_updated
```

#### **Day 5-7 (1/24-1/26): ãƒ‡ãƒ¼ã‚¿ç§»è¡Œãƒ»æ¤œè¨¼**
```yaml
Friday 1/24:
  AM:
    - [ ] æ—¢å­˜äºˆç´„ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ã‚»ãƒƒã‚·ãƒ§ãƒ³ç”Ÿæˆã‚¹ã‚¯ãƒªãƒ—ãƒˆ
    - [ ] æ—¢å­˜æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ç´ä»˜ã‘ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
    - [ ] ãƒ‡ãƒ¼ã‚¿ç§»è¡Œãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
  PM:
    - [ ] ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§æ¤œè¨¼
    - [ ] ç§»è¡Œãƒ‡ãƒ¼ã‚¿å“è³ªç¢ºèª
    - [ ] ç§»è¡Œãƒ­ã‚°åˆ†æ

Weekend 1/25-1/26:
  - [ ] é€±æœ«é›†ä¸­ãƒ†ã‚¹ãƒˆ
  - [ ] æ€§èƒ½ãƒ†ã‚¹ãƒˆãƒ»è² è·ãƒ†ã‚¹ãƒˆ
  - [ ] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆ
  - [ ] Week 1å®Œäº†ç¢ºèª
```

### **Week 2: ã‚·ã‚¹ãƒ†ãƒ çµ±åˆé€±ï¼ˆ1/27-2/2ï¼‰**

#### **Day 1-2 (1/27-1/28): hotel-pmsçµ±åˆ**
```yaml
Monday 1/27:
  AM:
    - [ ] ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³å‡¦ç†ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³å¯¾å¿œ
    - [ ] ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆãƒ­ã‚¸ãƒƒã‚¯çµ±åˆ
    - [ ] éƒ¨å±‹çŠ¶æ…‹ç®¡ç†é€£æº
  PM:
    - [ ] ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆå‡¦ç†ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³å¯¾å¿œ
    - [ ] æœ€çµ‚è«‹æ±‚è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯
    - [ ] ã‚»ãƒƒã‚·ãƒ§ãƒ³å®Œäº†å‡¦ç†

Tuesday 1/28:
  AM:
    - [ ] ãƒ•ãƒ­ãƒ³ãƒˆç”»é¢ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³è¡¨ç¤º
    - [ ] ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†UIå®Ÿè£…
    - [ ] ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å¼·åŒ–
  PM:
    - [ ] hotel-pmsçµ±åˆãƒ†ã‚¹ãƒˆ
    - [ ] ãƒ•ãƒ­ãƒ³ãƒˆæ¥­å‹™ãƒ•ãƒ­ãƒ¼ç¢ºèª
    - [ ] Lunaï¼ˆæœˆèª­ï¼‰ä»•æ§˜é©åˆç¢ºèª
```

#### **Day 3-4 (1/29-1/30): hotel-saasçµ±åˆ**
```yaml
Wednesday 1/29:
  AM:
    - [ ] ã‚»ãƒƒã‚·ãƒ§ãƒ³ç•ªå·ã«ã‚ˆã‚‹æ³¨æ–‡ç®¡ç†å®Ÿè£…
    - [ ] éƒ¨å±‹ç•ªå·â†’ã‚»ãƒƒã‚·ãƒ§ãƒ³ç•ªå·ãƒãƒƒãƒ”ãƒ³ã‚°
    - [ ] æ—¢å­˜æ³¨æ–‡å‡¦ç†ã®ç§»è¡Œ
  PM:
    - [ ] ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰UIèª¿æ•´
    - [ ] ã‚»ãƒƒã‚·ãƒ§ãƒ³å¯¾å¿œã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå®Ÿè£…
    - [ ] æ³¨æ–‡å±¥æ­´è¡¨ç¤ºã®æ”¹è‰¯

Thursday 1/30:
  AM:
    - [ ] useSessionApiçµ±åˆãƒ†ã‚¹ãƒˆ
    - [ ] å‹å®šç¾©ã®å®Ÿè£…ç¢ºèª
    - [ ] ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å®Ÿè£…
  PM:
    - [ ] hotel-saasçµ±åˆãƒ†ã‚¹ãƒˆ
    - [ ] æ³¨æ–‡ãƒ•ãƒ­ãƒ¼ç¢ºèª
    - [ ] UI/UXå‹•ä½œç¢ºèª
```

#### **Day 5-7 (1/31-2/2): hotel-memberçµ±åˆ**
```yaml
Friday 1/31:
  AM:
    - [ ] ã‚»ãƒƒã‚·ãƒ§ãƒ³å˜ä½ãƒã‚¤ãƒ³ãƒˆç®¡ç†å®Ÿè£…
    - [ ] ãƒã‚¤ãƒ³ãƒˆè¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯çµ±åˆ
    - [ ] ä¼šå“¡ç‰¹å…¸ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³é©ç”¨
  PM:
    - [ ] ã‚»ãƒƒã‚·ãƒ§ãƒ³å±¥æ­´ç®¡ç†å®Ÿè£…
    - [ ] ä¼šå“¡åˆ†ææ©Ÿèƒ½æ‹¡å¼µ
    - [ ] ç‰¹å…¸é©ç”¨ãƒ­ã‚¸ãƒƒã‚¯ç¢ºèª

Weekend 2/1-2/2:
  - [ ] hotel-memberçµ±åˆãƒ†ã‚¹ãƒˆ
  - [ ] Sakuraï¼ˆæ¡œï¼‰ä»•æ§˜é©åˆç¢ºèª
  - [ ] å…¨ã‚·ã‚¹ãƒ†ãƒ çµ±åˆãƒ†ã‚¹ãƒˆ
  - [ ] Week 2å®Œäº†ç¢ºèª
```

### **Week 3: æœ€çµ‚èª¿æ•´ãƒ»ãƒ‡ãƒ—ãƒ­ã‚¤é€±ï¼ˆ2/3-2/9ï¼‰**

#### **Day 1-3 (2/3-2/5): çµ±åˆãƒ†ã‚¹ãƒˆãƒ»æœ€é©åŒ–**
```yaml
Monday 2/3:
  - [ ] å…¨ã‚·ã‚¹ãƒ†ãƒ çµ±åˆãƒ†ã‚¹ãƒˆ
  - [ ] ã‚¨ãƒ³ãƒ‰ãƒ„ãƒ¼ã‚¨ãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆ
  - [ ] æ€§èƒ½ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯

Tuesday 2/4:
  - [ ] è² è·ãƒ†ã‚¹ãƒˆãƒ»ã‚¹ãƒˆãƒ¬ã‚¹ãƒ†ã‚¹ãƒˆ
  - [ ] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆ
  - [ ] ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§æœ€çµ‚ç¢ºèª

Wednesday 2/5:
  - [ ] æ€§èƒ½æœ€é©åŒ–å®Ÿè£…
  - [ ] ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡æœ€é©åŒ–
  - [ ] ã‚¯ã‚¨ãƒªæœ€é©åŒ–
```

#### **Day 4-5 (2/6-2/7): æœ¬ç•ªç’°å¢ƒæº–å‚™**
```yaml
Thursday 2/6:
  AM:
    - [ ] æœ¬ç•ªç’°å¢ƒãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æº–å‚™
    - [ ] æœ¬ç•ªç’°å¢ƒè¨­å®šç¢ºèª
    - [ ] ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¹ã‚¯ãƒªãƒ—ãƒˆæº–å‚™
  PM:
    - [ ] æœ¬ç•ªãƒ‡ãƒ¼ã‚¿ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
    - [ ] ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ‰‹é †ç¢ºèª
    - [ ] ç·Šæ€¥é€£çµ¡ä½“åˆ¶ç¢ºèª

Friday 2/7:
  AM:
    - [ ] ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒæœ€çµ‚ãƒ†ã‚¹ãƒˆ
    - [ ] æœ¬ç•ªç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤ãƒªãƒãƒ¼ã‚µãƒ«
    - [ ] ç›£è¦–ã‚·ã‚¹ãƒ†ãƒ è¨­å®š
  PM:
    - [ ] ãƒ‡ãƒ—ãƒ­ã‚¤å‰æœ€çµ‚ç¢ºèª
    - [ ] ãƒãƒ¼ãƒ ä½“åˆ¶ç¢ºèª
    - [ ] ç·Šæ€¥æ™‚å¯¾å¿œæº–å‚™
```

#### **Day 6-7 (2/8-2/9): æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤ãƒ»é‹ç”¨é–‹å§‹**
```yaml
Saturday 2/8:
  - [ ] æœ¬ç•ªç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤å®Ÿè¡Œ
  - [ ] ã‚·ã‚¹ãƒ†ãƒ å‹•ä½œç¢ºèª
  - [ ] ãƒ‡ãƒ¼ã‚¿ç§»è¡Œå®Ÿè¡Œãƒ»ç¢ºèª
  - [ ] å…¨æ©Ÿèƒ½å‹•ä½œãƒ†ã‚¹ãƒˆ

Sunday 2/9:
  - [ ] é‹ç”¨ç›£è¦–é–‹å§‹
  - [ ] æ€§èƒ½ç›£è¦–ç¢ºèª
  - [ ] ãƒ¦ãƒ¼ã‚¶ãƒ¼å—ã‘å…¥ã‚Œãƒ†ã‚¹ãƒˆ
  - [ ] ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå®Œäº†ç¢ºèª
```

---

## ğŸ› ï¸ **å®Ÿè£…è©³ç´°**

### **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç§»è¡Œã‚¹ã‚¯ãƒªãƒ—ãƒˆ**

#### **1. ã‚»ãƒƒã‚·ãƒ§ãƒ³ç”Ÿæˆã‚¹ã‚¯ãƒªãƒ—ãƒˆ**
```sql
-- æ—¢å­˜äºˆç´„ã‹ã‚‰ã‚»ãƒƒã‚·ãƒ§ãƒ³ç”Ÿæˆ
WITH session_data AS (
  SELECT 
    r.id as reservation_id,
    r.tenant_id,
    r.room_id,
    r.customer_id,
    r.check_in_date,
    r.check_out_date,
    r.status,
    rm.room_number,
    c.first_name,
    c.last_name,
    c.email,
    c.phone,
    ROW_NUMBER() OVER (
      PARTITION BY rm.room_number, DATE(r.check_in_date) 
      ORDER BY r.created_at
    ) as sequence_num
  FROM reservations r
  JOIN rooms rm ON r.room_id = rm.id
  JOIN customers c ON r.customer_id = c.id
  WHERE r.check_in_date >= '2024-01-01'
)
INSERT INTO checkin_sessions (
  id,
  tenant_id,
  session_number,
  reservation_id,
  room_id,
  customer_id,
  guest_info,
  check_in_at,
  check_out_at,
  planned_check_out,
  status,
  created_at,
  updated_at
)
SELECT 
  gen_random_uuid(),
  sd.tenant_id,
  CONCAT(
    'R', REGEXP_REPLACE(sd.room_number, '[^0-9]', '', 'g'),
    '-', TO_CHAR(sd.check_in_date, 'YYYYMMDD'),
    '-', LPAD(sd.sequence_num::text, 3, '0')
  ),
  sd.reservation_id,
  sd.room_id,
  sd.customer_id,
  jsonb_build_object(
    'primaryGuest', jsonb_build_object(
      'firstName', sd.first_name,
      'lastName', sd.last_name,
      'email', sd.email,
      'phone', sd.phone
    ),
    'additionalGuests', '[]'::jsonb,
    'specialNeeds', '[]'::jsonb,
    'preferences', '{}'::jsonb
  ),
  sd.check_in_date,
  CASE 
    WHEN sd.status = 'CHECKED_OUT' THEN sd.check_out_date
    ELSE NULL 
  END,
  sd.check_out_date,
  CASE 
    WHEN sd.status = 'CHECKED_IN' THEN 'ACTIVE'
    WHEN sd.status = 'CHECKED_OUT' THEN 'CHECKED_OUT'
    ELSE 'CANCELED'
  END,
  NOW(),
  NOW()
FROM session_data sd;
```

#### **2. æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ç§»è¡Œã‚¹ã‚¯ãƒªãƒ—ãƒˆ**
```sql
-- æ—¢å­˜æ³¨æ–‡ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ç´ä»˜ã‘
UPDATE service_orders so
SET session_id = (
  SELECT cs.id 
  FROM checkin_sessions cs
  JOIN reservations r ON cs.reservation_id = r.id
  WHERE r.room_id = so.room_id
    AND so.requested_at BETWEEN cs.check_in_at AND 
        COALESCE(cs.check_out_at, cs.planned_check_out)
  ORDER BY cs.check_in_at DESC
  LIMIT 1
)
WHERE so.session_id IS NULL 
  AND so.room_id IS NOT NULL
  AND so.requested_at >= '2024-01-01';

-- ç§»è¡Œçµæœç¢ºèª
SELECT 
  COUNT(*) as total_orders,
  COUNT(session_id) as mapped_orders,
  COUNT(*) - COUNT(session_id) as unmapped_orders,
  ROUND(COUNT(session_id)::numeric / COUNT(*) * 100, 2) as mapping_rate
FROM service_orders
WHERE requested_at >= '2024-01-01';
```

#### **3. ã‚»ãƒƒã‚·ãƒ§ãƒ³è«‹æ±‚ç”Ÿæˆã‚¹ã‚¯ãƒªãƒ—ãƒˆ**
```sql
-- ã‚»ãƒƒã‚·ãƒ§ãƒ³è«‹æ±‚ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ
INSERT INTO session_billings (
  id,
  tenant_id,
  session_id,
  billing_number,
  room_charges,
  service_charges,
  taxes,
  discounts,
  subtotal_amount,
  tax_amount,
  total_amount,
  paid_amount,
  status,
  payment_method,
  payment_date,
  created_at,
  updated_at
)
SELECT 
  gen_random_uuid(),
  cs.tenant_id,
  cs.id,
  CONCAT('SB-', cs.session_number),
  
  -- å®¿æ³Šæ–™é‡‘è©³ç´°
  jsonb_build_array(
    jsonb_build_object(
      'date', TO_CHAR(cs.check_in_at, 'YYYY-MM-DD'),
      'nights', COALESCE(
        EXTRACT(DAY FROM (cs.check_out_at - cs.check_in_at)),
        EXTRACT(DAY FROM (cs.planned_check_out - cs.check_in_at))
      ),
      'baseRate', COALESCE(b.total_amount, 0) / GREATEST(
        COALESCE(
          EXTRACT(DAY FROM (cs.check_out_at - cs.check_in_at)),
          EXTRACT(DAY FROM (cs.planned_check_out - cs.check_in_at))
        ), 1
      ),
      'amount', COALESCE(b.total_amount, 0)
    )
  ),
  
  -- ã‚µãƒ¼ãƒ“ã‚¹æ–™é‡‘è©³ç´°
  COALESCE(
    (SELECT jsonb_agg(
      jsonb_build_object(
        'orderId', so.id,
        'serviceName', s.name,
        'category', s.category,
        'quantity', so.quantity,
        'unitPrice', so.amount / GREATEST(so.quantity, 1),
        'amount', so.amount,
        'orderedAt', so.requested_at
      )
    )
    FROM service_orders so
    JOIN services s ON so.service_id = s.id
    WHERE so.session_id = cs.id),
    '[]'::jsonb
  ),
  
  -- ç¨é‡‘è©³ç´°
  jsonb_build_array(
    jsonb_build_object(
      'type', 'consumption_tax',
      'rate', 0.1,
      'baseAmount', COALESCE(b.total_amount, 0) / 1.1,
      'taxAmount', COALESCE(b.total_amount, 0) - (COALESCE(b.total_amount, 0) / 1.1)
    )
  ),
  
  -- å‰²å¼•è©³ç´°ï¼ˆåˆæœŸå€¤ã¯ç©ºï¼‰
  '[]'::jsonb,
  
  -- é‡‘é¡è¨ˆç®—
  COALESCE(b.total_amount, 0) + COALESCE(service_total.amount, 0),
  (COALESCE(b.total_amount, 0) + COALESCE(service_total.amount, 0)) - 
    ((COALESCE(b.total_amount, 0) + COALESCE(service_total.amount, 0)) / 1.1),
  COALESCE(b.total_amount, 0) + COALESCE(service_total.amount, 0),
  COALESCE(b.paid_amount, 0),
  
  COALESCE(b.status, 'PENDING'),
  b.payment_method,
  b.payment_date,
  COALESCE(b.created_at, NOW()),
  NOW()
  
FROM checkin_sessions cs
LEFT JOIN billings b ON b.reservation_id = cs.reservation_id
LEFT JOIN (
  SELECT 
    session_id,
    SUM(amount) as amount
  FROM service_orders
  WHERE session_id IS NOT NULL
  GROUP BY session_id
) service_total ON service_total.session_id = cs.id;
```

### **APIå®Ÿè£…ä¾‹**

#### **ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆAPI**
```typescript
// POST /api/sessions
export async function createSession(
  request: CreateSessionRequest
): Promise<CheckinSession> {
  const transactionId = generateTransactionId();
  
  try {
    return await prisma.$transaction(async (tx) => {
      // 1. ã‚»ãƒƒã‚·ãƒ§ãƒ³ç•ªå·ç”Ÿæˆ
      const sessionNumber = await generateSessionNumber(
        request.roomId,
        request.checkInAt
      );
      
      // 2. ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆ
      const session = await tx.checkinSession.create({
        data: {
          tenantId: request.tenantId,
          sessionNumber,
          reservationId: request.reservationId,
          roomId: request.roomId,
          customerId: request.customerId,
          guestInfo: request.guestInfo,
          checkInAt: request.checkInAt,
          plannedCheckOut: request.plannedCheckOut,
          status: 'ACTIVE',
          specialRequests: request.specialRequests,
          notes: request.notes
        },
        include: {
          reservation: true,
          room: true,
          customer: true
        }
      });
      
      // 3. åˆæœŸè«‹æ±‚ä½œæˆ
      await tx.sessionBilling.create({
        data: {
          tenantId: session.tenantId,
          sessionId: session.id,
          billingNumber: `SB-${sessionNumber}`,
          roomCharges: [],
          serviceCharges: [],
          taxes: [],
          discounts: [],
          subtotalAmount: 0,
          taxAmount: 0,
          totalAmount: 0,
          paidAmount: 0,
          status: 'PENDING'
        }
      });
      
      // 4. éƒ¨å±‹çŠ¶æ…‹æ›´æ–°
      await tx.room.update({
        where: { id: request.roomId },
        data: { status: 'OCCUPIED' }
      });
      
      // 5. ã‚¤ãƒ™ãƒ³ãƒˆç™ºè¡Œ
      await publishEvent('session.created', {
        sessionId: session.id,
        sessionNumber: session.sessionNumber,
        roomId: session.roomId,
        customerId: session.customerId,
        checkInAt: session.checkInAt.toISOString(),
        guestInfo: session.guestInfo
      });
      
      return session;
    });
    
  } catch (error) {
    await logError(transactionId, 'SESSION_CREATION_FAILED', error);
    throw new SessionCreationError(
      `Failed to create session: ${error.message}`,
      { transactionId, originalError: error }
    );
  }
}
```

---

## ğŸ§ª **ãƒ†ã‚¹ãƒˆæˆ¦ç•¥**

### **å˜ä½“ãƒ†ã‚¹ãƒˆ**
```typescript
describe('Session Management', () => {
  describe('Session Creation', () => {
    test('should create session with valid data', async () => {
      const request: CreateSessionRequest = {
        tenantId: 'tenant-123',
        reservationId: 'res-456',
        roomId: 'room-789',
        customerId: 'cust-101',
        guestInfo: mockGuestInfo,
        checkInAt: new Date(),
        plannedCheckOut: addDays(new Date(), 2)
      };
      
      const session = await createSession(request);
      
      expect(session).toBeDefined();
      expect(session.sessionNumber).toMatch(/^R\d+-\d{8}-\d{3}$/);
      expect(session.status).toBe('ACTIVE');
    });
    
    test('should handle duplicate session number', async () => {
      // é‡è¤‡ã‚»ãƒƒã‚·ãƒ§ãƒ³ç•ªå·ã®ãƒ†ã‚¹ãƒˆ
      const request = createMockRequest();
      
      await createSession(request);
      
      await expect(createSession(request))
        .rejects.toThrow('Session number already exists');
    });
  });
  
  describe('Data Migration', () => {
    test('should migrate existing orders to sessions', async () => {
      const orders = await createMockOrders();
      const session = await createMockSession();
      
      await migrateOrdersToSession(orders[0].roomId, session.id);
      
      const migratedOrders = await getOrdersBySession(session.id);
      expect(migratedOrders).toHaveLength(orders.length);
    });
  });
});
```

### **çµ±åˆãƒ†ã‚¹ãƒˆ**
```typescript
describe('System Integration', () => {
  test('should handle complete checkin flow', async () => {
    // 1. ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆ
    const session = await createSession(mockRequest);
    
    // 2. ã‚µãƒ¼ãƒ“ã‚¹æ³¨æ–‡
    const order = await createServiceOrder(session.id, mockOrderData);
    
    // 3. è«‹æ±‚æ›´æ–°ç¢ºèª
    const billing = await getSessionBilling(session.id);
    expect(billing.serviceCharges).toHaveLength(1);
    
    // 4. ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
    const finalBilling = await checkoutSession(session.id, mockCheckoutData);
    expect(finalBilling.status).toBe('PAID');
  });
});
```

---

## ğŸ“Š **ç›£è¦–ãƒ»å“è³ªä¿è¨¼**

### **ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–**
```yaml
ç›£è¦–é …ç›®:
  - ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆæˆåŠŸç‡: > 99.9%
  - APIå¿œç­”æ™‚é–“: < 200ms
  - ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šæ•°: < 80%
  - ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡: < 80%
  - ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿç‡: < 0.1%

ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®š:
  - æˆåŠŸç‡ < 99%: å³åº§ã‚¢ãƒ©ãƒ¼ãƒˆ
  - å¿œç­”æ™‚é–“ > 500ms: è­¦å‘Š
  - ã‚¨ãƒ©ãƒ¼ç‡ > 0.1%: ç·Šæ€¥ã‚¢ãƒ©ãƒ¼ãƒˆ
```

### **å“è³ªãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ**
```yaml
æŠ€è¡“å“è³ª:
  - [ ] å…¨APIå‹•ä½œç¢ºèª
  - [ ] ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§100%
  - [ ] æ€§èƒ½åŸºæº–ã‚¯ãƒªã‚¢
  - [ ] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åŸºæº–ã‚¯ãƒªã‚¢

æ¥­å‹™å“è³ª:
  - [ ] ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³å‡¦ç†æ­£å¸¸å‹•ä½œ
  - [ ] æ³¨æ–‡å‡¦ç†æ­£å¸¸å‹•ä½œ
  - [ ] è«‹æ±‚å‡¦ç†æ­£å¸¸å‹•ä½œ
  - [ ] ä¼šå“¡å‡¦ç†æ­£å¸¸å‹•ä½œ
```

---

## ğŸ¯ **æˆåŠŸæŒ‡æ¨™**

### **Week 1å®Œäº†åŸºæº–**
- [ ] ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒå®Ÿè£…å®Œäº†
- [ ] åŸºæœ¬APIå®Ÿè£…å®Œäº†
- [ ] ãƒ‡ãƒ¼ã‚¿ç§»è¡Œã‚¹ã‚¯ãƒªãƒ—ãƒˆå‹•ä½œç¢ºèª
- [ ] åŸºæœ¬æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆåˆæ ¼

### **Week 2å®Œäº†åŸºæº–**
- [ ] å…¨ã‚·ã‚¹ãƒ†ãƒ çµ±åˆå®Œäº†
- [ ] çµ±åˆãƒ†ã‚¹ãƒˆåˆæ ¼
- [ ] æ€§èƒ½åŸºæº–ã‚¯ãƒªã‚¢
- [ ] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆåˆæ ¼

### **Week 3å®Œäº†åŸºæº–**
- [ ] æœ¬ç•ªç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†
- [ ] å…¨æ©Ÿèƒ½æ­£å¸¸å‹•ä½œç¢ºèª
- [ ] é‹ç”¨ç›£è¦–é–‹å§‹
- [ ] ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå®Œäº†

---

**å³æ™‚ç§»è¡Œã«ã‚ˆã‚Šã€3é€±é–“ã§ç¢ºå®Ÿã«ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã‚’å°å…¥ã—ã€ã‚·ã‚¹ãƒ†ãƒ ã®ä¿¡é ¼æ€§ã¨åŠ¹ç‡æ€§ã‚’å¤§å¹…ã«å‘ä¸Šã•ã›ã¾ã™ï¼**

---

**ä½œæˆè€…**: hotel-kanriçµ±åˆç®¡ç†ã‚·ã‚¹ãƒ†ãƒ   
**æ‰¿èªè€…**: ã‚·ã‚¹ãƒ†ãƒ çµ±æ‹¬è²¬ä»»è€…  
**é…å¸ƒå…ˆ**: hotel-commonãƒãƒ¼ãƒ ã€å…¨é–¢ä¿‚è€…




