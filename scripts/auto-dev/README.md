# タスク自動実行システム

## 📋 概要

Claude Codeに「DEV-0170を実行」と指示するだけで、子タスクを順に実行し、フロー全体を自動でこなすシステム。

---

## 🔄 実行フロー（v2.0.0）

```
DEV-0170を実行
    ↓
┌─────────────────────────────────────────────────────────┐
│ 1. 親タスク情報取得（Plane API）                        │
│ 2. 子タスク一覧取得                                     │
└─────────────────────────────────────────────────────────┘
    ↓
┌─────────────────────────────────────────────────────────┐
│ 各子タスクについて繰り返し:                             │
│                                                         │
│ ┌─────────────────────────────────────────────────────┐ │
│ │ a. タスクをIn Progressに                            │ │
│ │ b. SSOT確認                                         │ │
│ │    └→ 未存在なら Claude Codeで生成                  │ │
│ │ c. SSOT監査（マルチLLM）                             │ │
│ │    ├→ Gemini + GPT-4o 並列実行                     │ │
│ │    ├→ AND合成（両方Passのみ合格）                  │ │
│ │    └→ スコア95未満なら修正ループ                   │ │
│ │ d. 修正ループ（最大3回）                            │ │
│ │    └→ Claude Codeで修正 → GPT-4oで再監査           │ │
│ │ e. プロンプト生成                                   │ │
│ │ f. プロンプト監査                                   │ │
│ │    └→ 80点未満なら自動補強                         │ │
│ │ g. 実装（Claude Code）                              │ │
│ │ h. テスト実行                                       │ │
│ │    └→ 失敗なら修正（Claude Code）→再テスト         │ │
│ │ i. PR作成                                           │ │
│ │ j. タスクをDoneに                                   │ │
│ └─────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────┘
    ↓
┌─────────────────────────────────────────────────────────┐
│ 3. 全子タスク完了なら親タスクもDone                     │
└─────────────────────────────────────────────────────────┘
```

---

## 🚀 使い方

### 基本コマンド

```bash
# タスク実行
node scripts/auto-dev/run-task.cjs DEV-0170

# ドライラン（実際の変更なし）
node scripts/auto-dev/run-task.cjs DEV-0170 --dry-run
```

### Claude Codeから実行

```bash
claude
```

起動後：
```
DEV-0170を実行してください。
scripts/auto-dev/run-task.cjs を使用します。
```

または：
```
以下のコマンドを実行してください:
node scripts/auto-dev/run-task.cjs DEV-0170
```

---

## 📊 自動リトライ

| 状況 | リトライ回数 | 動作 |
|:-----|:-------------|:-----|
| SSOT未存在 | 1回 | Claude Codeで生成→監査へ |
| SSOT監査スコア<95 | 最大3回 | Claude Codeで修正→GPT-4oで再監査 |
| プロンプト監査<80 | - | 自動で必須項目を補強 |
| テスト失敗 | 最大3回 | Claude Codeで修正→再テスト |
| リトライ上限 | - | 停止して人間に通知 |

---

## 📁 出力

### ログ

```
evidence/auto-dev/logs/DEV-0170-2026-01-21T...json
```

### 内容

```json
{
  "taskId": "DEV-0170",
  "startTime": "2026-01-21T...",
  "endTime": "2026-01-21T...",
  "logs": [
    { "timestamp": "...", "level": "step", "message": "サブタスク開始: DEV-0172" },
    { "timestamp": "...", "level": "success", "message": "監査スコア: 85/100" },
    ...
  ]
}
```

---

## ⚙️ 設定

`run-task.cjs`の`CONFIG`で調整可能：

```javascript
const CONFIG = {
  maxRetries: 3,              // 最大リトライ回数
  auditPassScore: 95,         // SSOT監査合格スコア（95点以上）
  promptAuditPassScore: 80,   // プロンプト監査合格スコア
  evidenceDir: '...',         // Evidence保存先
  logsDir: '...',             // ログ保存先
  ssotDir: '...'              // SSOT保存先
};

// 監査モデル: Gemini + GPT-4o（AND合成）
// - 両モデルがPassした項目のみ合格
// - 最も厳格な品質担保
```

---

## 🔧 依存

- Node.js 18+
- Claude Code CLI（認証済み）
- OpenAI API Key（.env.mcp）
- Plane API（.env.mcp）
- gh CLI（認証済み）

---

## 🚨 注意事項

1. **Claude Code認証**
   - 事前に`claude`コマンドで認証を済ませておく

2. **Git状態**
   - 未コミットの変更がない状態で実行推奨

3. **API制限**
   - OpenAI APIのRate Limitに注意
   - 大量のタスクを連続実行する場合は間隔を空ける

4. **エラー時**
   - ログを確認して手動で対応
   - 途中から再開する場合は完了済みタスクをスキップ

---

## 📚 関連

- [SSOT監査システム](../ssot-audit/README.md)
- [ハイブリッドワークフロー](../../docs/standards/SSOT_HYBRID_WORKFLOW.md)
- [プロンプト生成](../prompt-generator/README.md)
