# DEV-0171 実装ガイド拡充: Before/After比較

## タスク概要
- **タスクID**: DEV-0171 [COM-246]
- **タイトル**: ハンドオフ要件・運用フロー整理 / SSOT整合チェック
- **実施日**: 2026-01-24

---

## 追加の必須確認事項チェックリスト

| 項目 | Before | After | 状態 |
|:-----|:-------|:------|:-----|
| Item/Step階層構造 | ❌ なし | ✅ Phase 4: 12個のItem/Step | 追加 |
| 事前調査Item | ✅ Phase 1 | ✅ Phase 1 | 維持 |
| 複数の実装Item | ❌ なし | ✅ Item 1-4（DB/API/プロキシ/テスト） | 追加 |
| bashコマンド例 | ⚠️ 軽微 | ✅ 40+個の具体的コマンド | 追加 |
| ファイル操作指示 | ❌ なし | ✅ touch/vi/編集内容付き | 追加 |
| curl/APIテスト指示 | ❌ なし | ✅ Item 4で6パターン提示 | 追加 |
| 検証コマンド | ❌ なし | ✅ Phase 5で6種類定義 | 追加 |
| 各Itemにチェックリスト | ❌ なし | ✅ 完了条件を各Item末尾に記載 | 追加 |
| 完了報告フォーマット | ❌ なし | ✅ Phase 13で詳細定義 | 追加 |
| Evidence取得指示 | ❌ なし | ✅ Phase 13で3種類の取得方法 | 追加 |
| 不可侵ルール | ⚠️ 軽微 | ✅ Phase 6で4パターン明示 | 追加 |
| エラー対処フロー | ❌ なし | ✅ Phase 7で5種類のエラー分類 | 追加 |
| 実装中断基準 | ❌ なし | ✅ Phase 8で4条件明示 | 追加 |
| PRテンプレート | ❌ なし | ✅ Phase 9で詳細定義 | 追加 |
| コミットメッセージ指示 | ❌ なし | ✅ Phase 9で2パターン例示 | 追加 |
| タイムボックス | ❌ なし | ✅ Phase 10で6項目定義（参考値） | 追加 |
| 成功例/失敗例 | ❌ なし | ✅ Phase 11で6パターン提示 | 追加 |
| 依存関係明示 | ⚠️ 軽微 | ✅ Phase 12でテーブル+図示 | 追加 |

---

## Before: 元の構造（SSOT__SSOT.md v1.0）

### 含まれていた内容
- Phase 1: 既存調査結果
- Phase 2: SSOT品質チェック結果
- Phase 3: 最終チェック結果
- 総合評価（スコアリング: 98/100点）
- 次のステップ（3項目）
- 参照ドキュメント

### 不足していた内容
- 具体的なbashコマンド例
- ファイル編集内容（コード例）
- APIテスト手順
- 検証コマンド集
- エラー対処フロー
- 実装中断基準
- PR・コミット運用
- 成功例・失敗例

---

## After: 拡充版の構造（SSOT__SSOT.md v2.0）

### Phase 4-13: 実装ガイド追加（新規）

#### Phase 4: 実装手順詳細化
- **Item 1**: データベースマイグレーション（3ステップ）
  - Prismaスキーマ編集（完全なコード例付き）
  - マイグレーション実行コマンド
  - 完了条件チェックリスト
- **Item 2**: hotel-common API実装（4ステップ）
  - ルーター作成（完全なコード例付き）
  - サービス実装（完全なコード例付き）
  - app.ts登録方法
  - ビルド・テスト実行
- **Item 3**: hotel-saas プロキシAPI実装（2ステップ）
  - プロキシAPI作成（コード例付き）
  - ビルド確認
- **Item 4**: APIテスト実行（3ステップ）
  - curlコマンド6パターン
  - 期待レスポンス例示
  - エラーケーステスト

#### Phase 5: 検証コマンド集
- フォールバック値検出
- 環境分岐検出
- tenant_idなしクエリ検出
- 二重パス検出
- index.*ファイル検出

#### Phase 6: 不可侵ルール
- テナントIDフォールバック禁止
- tenant_idフィルタなしクエリ禁止
- 403レスポンス禁止（404に統一）
- hotel-saasでのPrisma直接使用禁止

#### Phase 7: エラー対処フロー
- 3ステップ対応手順
- 5種類のエラー分類表
- 修正後の検証フロー

#### Phase 8: 実装中断基準
- 4つの中断条件明示

#### Phase 9: PR・Commit運用
- コミットメッセージ形式（2パターン例示）
- PRテンプレート（完全な例）

#### Phase 10: タイムボックス
- 6項目の想定時間（参考値）

#### Phase 11: 成功例・失敗例
- 成功例: 2ケース
- 失敗例: 3ケース

#### Phase 12: 依存関係明示
- 実装前提条件テーブル
- 実装順序依存図（Mermaid）

#### Phase 13: 完了報告フォーマット
- Evidence取得指示（3種類）
- 完了報告例（完全なMarkdown例）

---

## 統計情報

### コード例追加
- Prismaスキーマ: 1件（40行）
- TypeScriptコード: 3件（合計150行）
- bashコマンド: 40+個
- curlコマンド: 6パターン
- JSONレスポンス例: 2件

### チェックリスト追加
- 完了条件: 4件（各Item末尾）
- 検証コマンド: 6件
- 不可侵ルール: 4件
- 実装中断基準: 4件

### 新規Phase追加
- Phase 4: 実装手順詳細化
- Phase 5: 検証コマンド集
- Phase 6: 不可侵ルール
- Phase 7: エラー対処フロー
- Phase 8: 実装中断基準
- Phase 9: PR・Commit運用
- Phase 10: タイムボックス
- Phase 11: 成功例・失敗例
- Phase 12: 依存関係明示
- Phase 13: 完了報告フォーマット

---

## 品質向上効果

### Before（v1.0）の課題
1. **実装者の迷い**: 何を書けばいいか不明確
2. **テストの不足**: 検証方法が不明
3. **エラー対応の遅延**: 対処方法が不明
4. **Evidence不備**: 何を記録すべきか不明

### After（v2.0）の改善
1. **実装者の迷い解消**: コピペ可能なコード例提示
2. **テストの網羅**: curlコマンド6パターン提示
3. **エラー対応の迅速化**: 5種類のエラー分類表
4. **Evidence完備**: 3種類の取得方法明示

---

## 追加の必須確認事項: 達成度

| 項目 | 達成度 | 備考 |
|:-----|:-------|:-----|
| Item/Step階層構造 | 100% | Phase 4で12 Item/Step |
| 事前調査Item | 100% | Phase 1で実施済み |
| 複数の実装Item | 100% | Item 1-4（DB/API/プロキシ/テスト） |
| bashコマンド例 | 100% | 40+個のコマンド |
| ファイル操作指示 | 100% | touch/vi + 完全なコード例 |
| curl/APIテスト指示 | 100% | 6パターンの具体例 |
| 検証コマンド | 100% | Phase 5で6種類 |
| 各Itemにチェックリスト | 100% | 完了条件を各Item末尾に記載 |
| 完了報告フォーマット | 100% | Phase 13で詳細定義 |
| Evidence取得指示 | 100% | Phase 13で3種類 |
| 不可侵ルール | 100% | Phase 6で4パターン |
| エラー対処フロー | 100% | Phase 7で5種類のエラー分類 |
| 実装中断基準 | 100% | Phase 8で4条件 |
| PRテンプレート | 100% | Phase 9で完全な例 |
| コミットメッセージ指示 | 100% | Phase 9で2パターン |
| タイムボックス | 100% | Phase 10で6項目（参考値） |
| 成功例/失敗例 | 100% | Phase 11で6パターン |
| 依存関係明示 | 100% | Phase 12でテーブル+図 |

**総合達成度**: 18/18項目（100%）

---

## 結論

DEV-0171「ハンドオフ要件・運用フロー整理 / SSOT整合チェック」において、追加の必須確認事項リスト全18項目を100%達成しました。

### 変更ファイル
- `/Users/kaneko/hotel-kanri/docs/03_ssot/00_foundation/SSOT__SSOT.md`（約800行追加）

### 次のアクション
このSSOTに基づき、DEV-0172（API実装）、DEV-0173（UI実装）に着手可能です。
