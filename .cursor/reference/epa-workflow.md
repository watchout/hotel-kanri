# EPA（Evidence→Plan→Act）ワークフロー

**最終更新**: 2025-10-21  
**対象**: 全開発者・AI  
**参照方法**: `ripgrep MCP` または `/read-quote`

---

## 🎯 EPAとは？

**Evidence（証拠）→ Plan（計画）→ Act（実行）** の3段階で進める開発手法。

**目的：**
- ハルシネーション（幻覚）防止
- 仕様逸脱ゼロ
- 実装前の合意形成

---

## 📊 EPAフロー全体図

```
┌─────────────────────────────────────────────────────────┐
│ Step 0: タスク選択                                        │
│   /pick-task → Task: <alias> を確定                     │
└─────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────┐
│ Step 1: Evidence（証拠収集） ★最重要                      │
│                                                           │
│   必須3要素:                                              │
│   1. SSOT引用（仕様の根拠）                               │
│   2. 既存実装引用（現状把握）                             │
│   3. スキーマ引用（DB構造）                               │
│                                                           │
│   出力形式:                                               │
│   - 要点3つ（各1行）                                      │
│   - 引用（パス#L行番号）                                  │
│   - 最大5行                                               │
└─────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────┐
│ Step 2: Plan（計画提示）                                  │
│                                                           │
│   ルール:                                                 │
│   - 最大5ステップ                                         │
│   - 具体的な作業内容                                      │
│   - 工数見積もり（時間）                                  │
│                                                           │
│   例:                                                     │
│   1. 既存ルート/バリデータ把握（15分）                    │
│   2. 201/400/409分岐実装（30分）                         │
│   3. テスト追加（20分）                                   │
│   4. APIドキュ更新（10分）                                │
│   5. CI確認（5分）                                        │
└─────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────┐
│ Step 3: Ask（承認依頼） ⏸️                                │
│                                                           │
│   必ず待つ:                                               │
│   - ユーザーの承認                                        │
│   - または選択肢A/Bの回答                                 │
│                                                           │
│   ❌ 禁止: 承認前に実装開始                               │
└─────────────────────────────────────────────────────────┘
                          ↓
                  ユーザー承認
                          ↓
┌─────────────────────────────────────────────────────────┐
│ Step 4: Act（実装）                                       │
│                                                           │
│   既定: Diff only                                         │
│   - Unified Diff形式                                      │
│   - 説明・余談なし                                        │
│   - テストも含む                                          │
│                                                           │
│   例外: SSOT作成時は全文出力                              │
└─────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────┐
│ Step 5: Test & PR                                        │
│                                                           │
│   1. ローカルテスト実行                                   │
│   2. CI成功確認                                           │
│   3. PRテンプレにEvidence記入                             │
│   4. レビュー依頼                                         │
└─────────────────────────────────────────────────────────┘
```

---

## 📋 Evidence収集のチェックリスト

### ✅ 必須3要素

```markdown
1. SSOT引用（仕様の根拠）
   - どこに: docs/03_ssot/**/*.md
   - 何を: 該当機能の要件・Accept
   - 形式: パス#L行番号

2. 既存実装引用（現状把握）
   - どこに: apps/*/server/api, composables, etc
   - 何を: 関連する関数・型・エンドポイント
   - 形式: パス#L行番号

3. スキーマ引用（DB構造）
   - どこに: prisma/schema.prisma
   - 何を: 該当モデル・フィールド・制約
   - 形式: パス#L行番号
```

### ❌ よくある間違い

```markdown
❌ 間違い1: 「確認しました」（確認していない）
❌ 間違い2: パス指定なし（引用なし）
❌ 間違い3: 行番号なし（検証不可能）
❌ 間違い4: 要約のみ（原文引用なし）

✅ 正しい例:
1. SSOT #roles-create: Role作成はPOST /api/roles、name必須、ユニーク制約
   docs/SSOT_SAAS_PERMISSION_SYSTEM.md#L45-L52
   > POST /api/roles でRole作成。nameは必須でユニーク制約。
```

---

## 🎯 Plan作成のチェックリスト

### ✅ 必須要素

```markdown
1. 具体的なステップ（≤5）
2. 各ステップの工数見積もり
3. 依存関係の明記
4. リスクの列挙
```

### 例：良いPlan

```markdown
Plan:
1. 既存ルート/バリデータ把握（15分）
   - apps/server/src/routes/roles.ts 確認
   - yup schema パターン確認
2. POST /api/roles 実装（30分）
   - バリデーション追加
   - Prisma create 実行
   - エラーハンドリング（P2002）
3. テスト追加（20分）
   - 正常系: 201返却
   - 異常系: 409返却（重複）
4. APIドキュ更新（10分）
   - docs/api/roles.md に POST追加
5. CI確認（5分）

合計: 1時間20分
```

### ❌ 悪いPlan

```markdown
Plan:
1. 実装する
2. テストする
3. 完了

（具体性ゼロ、工数不明）
```

---

## ⏸️  Ask（承認待ち）のルール

### ✅ 必須

```markdown
- 必ず「承認お願いします」と明示
- または選択肢A/Bを提示
- 承認前に実装開始は絶対禁止
```

### 例：良いAsk

```markdown
Ask:
以下のいずれかを選択してください：

A) Diff only で実装開始
B) 詳細説明付きで実装開始
C) Plan再検討

または「OK。Diff only」と返信してください。
```

---

## 🚀 Act（実装）のルール

### ✅ 基本ルール

```markdown
既定: Diff only
- Unified Diff形式
- 説明・余談なし
- テストも含む

例外: SSOT作成時は全文出力
```

### 例：Diff only出力

```diff
--- a/apps/server/src/routes/roles.ts
+++ b/apps/server/src/routes/roles.ts
@@ -10,6 +10,15 @@
 router.get('/', async (req, res) => {
   // 既存のGET実装
 });
+
+router.post('/', async (req, res) => {
+  const { name } = req.body;
+  const role = await prisma.role.create({ data: { name } });
+  res.status(201).json(role);
+});

--- a/apps/server/test/roles.create.spec.ts
+++ b/apps/server/test/roles.create.spec.ts
（テスト差分）
```

---

## 📊 シーン別EPAパターン

### 🐛 バグ修正（b1）のEPA

```markdown
Evidence:
1. SSOT #tenant-isolation: 全クエリにtenant_id必須
2. バグコード: WHERE句にtenantIdフィルタ欠落
3. 正しい実装例: 他APIではtenantId使用済み

Plan:
1. セッションからtenantId取得ロジック追加
2. WHERE句にtenantIdフィルタ追加
3. 再現テスト作成
4. 他API横展開チェック
5. CI確認

Ask: 承認お願いします。
```

### 🔧 リファクタ（f1）のEPA

```markdown
Evidence:
1. 重複コードパターン（3箇所引用）
2. 既存テスト成功結果（250 tests passed）
3. 共通化後の差分見積もり（90行削減）

Plan:
1. 共通ユーティリティ作成＋単体テスト
2. 既存テスト実行（Before）
3. 20箇所を5箇所ずつ置換＋テスト
4. 全置換後テスト実行（After）
5. Before/After結果比較

Ask: 振る舞い不変でよろしいですか？
```

---

## 🔗 関連ドキュメント

- **EPA運用ガード**: `.cursor/rules/00-guardrails.md`
- **TaskCard利用ガイド**: `.cursor/reference/taskcard-usage-guide.md`
- **コマンドリファレンス**: `.cursor/reference/commands-reference.md`
