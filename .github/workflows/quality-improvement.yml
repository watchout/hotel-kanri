# =============================================================================
# Quality Improvement Gates (Non-Blocking)
# =============================================================================
# è¨­è¨ˆæ–¹é‡ï¼š
# - ã“ã‚Œã‚‰ã®ãƒã‚§ãƒƒã‚¯ã¯å“è³ªæ”¹å–„ã®æ¨å¥¨äº‹é …
# - å¤±æ•—ã—ã¦ã‚‚PRã¯ãƒ–ãƒ­ãƒƒã‚¯ã—ãªã„ï¼ˆè­¦å‘Šã®ã¿ï¼‰
# - æŠ€è¡“çš„è² å‚µã®å¯è¦–åŒ–ã¨æ®µéšçš„æ”¹å–„ã‚’ç›®çš„ã¨ã™ã‚‹
# =============================================================================

name: Quality Improvement (Non-Blocking)

on:
  pull_request:
    branches:
      - main
      - develop

jobs:
  # ==========================================
  # Check 1: TypeScriptå‹ãƒã‚§ãƒƒã‚¯ï¼ˆè­¦å‘Šã®ã¿ï¼‰
  # ==========================================
  typescript-check:
    name: TypeScriptå‹ãƒã‚§ãƒƒã‚¯ï¼ˆè­¦å‘Šï¼‰
    runs-on: ubuntu-latest
    continue-on-error: true  # â† å¤±æ•—ã—ã¦ã‚‚PRã‚’ãƒ–ãƒ­ãƒƒã‚¯ã—ãªã„
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Run TypeScript check
        run: |
          echo "âš ï¸  hotel-kanriã¯ç®¡ç†ãƒªãƒã‚¸ãƒˆãƒªã®ãŸã‚ã€å‹ãƒã‚§ãƒƒã‚¯ä¸è¦"
          echo "ğŸ’¡ å„ã‚·ã‚¹ãƒ†ãƒ ãƒªãƒã‚¸ãƒˆãƒªï¼ˆhotel-saas, hotel-commonï¼‰ã§å®Ÿè¡Œ"
          exit 0
  
  # ==========================================
  # Check 2: ESLintï¼ˆè­¦å‘Šã®ã¿ï¼‰
  # ==========================================
  eslint:
    name: ESLintï¼ˆè­¦å‘Šï¼‰
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Run ESLint
        run: |
          echo "âš ï¸  hotel-kanriã¯ç®¡ç†ãƒªãƒã‚¸ãƒˆãƒªã®ãŸã‚ã€lintä¸è¦"
          echo "ğŸ’¡ å„ã‚·ã‚¹ãƒ†ãƒ ãƒªãƒã‚¸ãƒˆãƒªï¼ˆhotel-saas, hotel-commonï¼‰ã§å®Ÿè¡Œ"
          exit 0
  
  # ==========================================
  # Check 3: ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ï¼ˆè­¦å‘Šã®ã¿ï¼‰
  # ==========================================
  test-coverage:
    name: ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ï¼ˆè­¦å‘Šï¼‰
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Run tests
        run: |
          echo "âš ï¸  hotel-kanriã¯ç®¡ç†ãƒªãƒã‚¸ãƒˆãƒªã®ãŸã‚ã€ãƒ†ã‚¹ãƒˆä¸è¦"
          echo "ğŸ’¡ å„ã‚·ã‚¹ãƒ†ãƒ ãƒªãƒã‚¸ãƒˆãƒªï¼ˆhotel-saas, hotel-commonï¼‰ã§å®Ÿè¡Œ"
          exit 0
  
  # ==========================================
  # Check 4: OpenAPI Lintï¼ˆè­¦å‘Šã®ã¿ï¼‰
  # ==========================================
  openapi-lint:
    name: OpenAPI Lintï¼ˆè­¦å‘Šï¼‰
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Spectral
        run: npm install -g @stoplight/spectral-cli
      
      - name: Lint OpenAPI specs
        run: |
          if [ -f ".spectral.yaml" ]; then
            spectral lint docs/03_ssot/openapi/*.yaml --ruleset .spectral.yaml || {
              echo "âš ï¸  OpenAPI Lint warnings detected"
              echo "ğŸ’¡ ã“ã‚Œã¯è­¦å‘Šã®ã¿ã§ã™ã€‚æ®µéšçš„ã«æ”¹å–„ã—ã¦ãã ã•ã„ã€‚"
            }
          else
            echo "âš ï¸  .spectral.yaml not found, skipping"
          fi
  
  # ==========================================
  # Summary
  # ==========================================
  quality-improvement-summary:
    name: Quality Improvement Summary
    runs-on: ubuntu-latest
    needs: [typescript-check, eslint, test-coverage, openapi-lint]
    if: always()
    steps:
      - name: Summary
        run: |
          echo "## ğŸ“Š Quality Improvement Results (Non-Blocking)"
          echo ""
          echo "âš ï¸  TypeScript: ${{ needs.typescript-check.result }}"
          echo "âš ï¸  ESLint: ${{ needs.eslint.result }}"
          echo "âš ï¸  Test Coverage: ${{ needs.test-coverage.result }}"
          echo "âš ï¸  OpenAPI Lint: ${{ needs.openapi-lint.result }}"
          echo ""
          echo "ğŸ’¡ ã“ã‚Œã‚‰ã¯è­¦å‘Šã®ã¿ã§ã™ã€‚æ®µéšçš„ã«æ”¹å–„ã—ã¦ãã ã•ã„ã€‚"
          echo "ğŸ“– æŠ€è¡“çš„è² å‚µãƒ¬ã‚¸ã‚¹ãƒˆãƒª: docs/tech-debt/DEBT_REGISTRY.md"

