name: OPS Policy Lint

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'ops/**'
      - '.cursorrules'
      - 'docs/**/*.md'
      - '.github/workflows/ops-policy-lint.yml'

jobs:
  policy-lint:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Install dependencies
        run: |
          npm install yaml glob
          
      - name: Load and validate policy
        run: |
          echo "ğŸ“– ops/policy.yml ã‚’èª­ã¿è¾¼ã¿ä¸­..."
          node - <<'EOF'
          const fs = require('fs');
          const yaml = require('yaml');
          
          try {
            const policy = yaml.parse(fs.readFileSync('ops/policy.yml', 'utf8'));
            console.log('âœ… ãƒãƒªã‚·ãƒ¼èª­ã¿è¾¼ã¿æˆåŠŸ');
            console.log(`   é€²æ—ç®¡ç†ãƒ„ãƒ¼ãƒ«: ${policy.progress.tool}`);
            console.log(`   ã‚«ãƒãƒ‹ã‚«ãƒ«: ${policy.progress.canonical}`);
          } catch (error) {
            console.error('âŒ ãƒãƒªã‚·ãƒ¼èª­ã¿è¾¼ã¿å¤±æ•—:', error.message);
            process.exit(1);
          }
          EOF
          
      - name: Run OPS Policy Lint
        run: |
          npm run ops:lint
          
      - name: Check for OPS:BEGIN/END blocks
        run: |
          echo "ğŸ” OPS:BEGIN/END ãƒ–ãƒ­ãƒƒã‚¯ã®å­˜åœ¨ç¢ºèª..."
          if grep -q "<!-- OPS:BEGIN progress" .cursorrules; then
            echo "âœ… OPSãƒ–ãƒ­ãƒƒã‚¯ãŒå­˜åœ¨ã—ã¾ã™"
          else
            echo "âš ï¸  OPSãƒ–ãƒ­ãƒƒã‚¯ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            echo "   npm run ops:apply ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„"
            exit 1
          fi
          
      - name: Display results
        if: always()
        run: |
          echo ""
          echo "=================================================="
          echo "âœ… OPS Policy Lint å®Œäº†"
          echo "=================================================="
          echo ""
          echo "é€²æ—ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ : Plane"
          echo "ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹: åˆæ ¼"
          echo ""

