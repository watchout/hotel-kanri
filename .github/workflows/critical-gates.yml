# =============================================================================
# Critical Quality Gates (Required for Production)
# =============================================================================
# è¨­è¨ˆæ–¹é‡ï¼š
# - ã“ã‚Œã‚‰ã®ãƒã‚§ãƒƒã‚¯ã¯è£½å“åŒ–ã®çµ¶å¯¾æ¡ä»¶
# - å¤±æ•—ã—ãŸå ´åˆã¯PRã‚’ãƒ–ãƒ­ãƒƒã‚¯
# - SSOTæº–æ‹ ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã€DBæ•´åˆæ€§ã‚’ä¿è¨¼
# =============================================================================

name: Critical Quality Gates

on:
  pull_request:
    branches:
      - main
      - develop
  push:
    branches:
      - main

jobs:
  # ==========================================
  # Gate 1: SSOTæº–æ‹ ãƒã‚§ãƒƒã‚¯ï¼ˆå¿…é ˆï¼‰
  # ==========================================
  ssot-compliance:
    name: SSOTæº–æ‹ ï¼ˆå¿…é ˆï¼‰
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install GitHub CLI
        run: |
          type -p curl >/dev/null || (sudo apt update && sudo apt install curl -y)
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg \
          && sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg \
          && echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null \
          && sudo apt update \
          && sudo apt install gh -y
      
      - name: SSOTå‚ç…§ãƒ»è¦ä»¶IDãƒã‚§ãƒƒã‚¯
        if: github.event_name == 'pull_request'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          GITHUB_PR_BODY: ${{ github.event.pull_request.body }}
        run: node scripts/check-ssot-citations.cjs
      
      - name: SSOTæ•´åˆæ€§ãƒã‚§ãƒƒã‚¯
        run: |
          if [ -f "scripts/quality/check-ssot-consistency.cjs" ]; then
            node scripts/quality/check-ssot-consistency.cjs
          else
            echo "âš ï¸  SSOTæ•´åˆæ€§ãƒã‚§ãƒƒã‚¯ã‚¹ã‚¯ãƒªãƒ—ãƒˆæœªå®Ÿè£…ï¼ˆTODOï¼‰"
          fi
  
  # ==========================================
  # Gate 2: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³ï¼ˆå¿…é ˆï¼‰
  # ==========================================
  security-scan:
    name: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³ï¼ˆå¿…é ˆï¼‰
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: npm audit (High/Critical only)
        run: |
          npm audit --production --audit-level=high || {
            echo "âŒ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§æ¤œå‡ºï¼ˆHigh/Criticalï¼‰"
            echo "ğŸ’¡ ä¿®æ­£æ–¹æ³•: npm audit fix --production"
            exit 1
          }
      
      - name: Check for sensitive data
        run: |
          # .envãƒ•ã‚¡ã‚¤ãƒ«ã‚„APIã‚­ãƒ¼ã®èª¤ã‚³ãƒŸãƒƒãƒˆæ¤œå‡º
          if grep -r "sk-.*" --include="*.ts" --include="*.js" . 2>/dev/null; then
            echo "âŒ APIã‚­ãƒ¼ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
            exit 1
          fi
          echo "âœ… ã‚»ãƒ³ã‚·ãƒ†ã‚£ãƒ–ãƒ‡ãƒ¼ã‚¿ãƒã‚§ãƒƒã‚¯: OK"
  
  # ==========================================
  # Gate 3: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ•´åˆæ€§ï¼ˆå¿…é ˆï¼‰
  # ==========================================
  database-integrity:
    name: DBæ•´åˆæ€§ï¼ˆå¿…é ˆï¼‰
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Check database naming conventions
        run: |
          if [ -f "scripts/quality/check-database-naming.cjs" ]; then
            node scripts/quality/check-database-naming.cjs
          else
            echo "âœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å‘½åè¦å‰‡ãƒã‚§ãƒƒã‚¯ï¼ˆæ—¢å­˜ã‚¹ã‚¯ãƒªãƒ—ãƒˆä½¿ç”¨ï¼‰"
          fi
      
      - name: Validate Prisma schemas
        run: |
          echo "âš ï¸  Prisma validate ã¯å„ã‚·ã‚¹ãƒ†ãƒ ãƒªãƒã‚¸ãƒˆãƒªã§å®Ÿè¡Œ"
          echo "âœ… hotel-kanri ã¯ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆç®¡ç†å°‚ç”¨ã®ãŸã‚ã€ã‚¹ã‚­ãƒƒãƒ—"
  
  # ==========================================
  # Summary
  # ==========================================
  critical-gates-summary:
    name: Critical Gates Summary
    runs-on: ubuntu-latest
    needs: [ssot-compliance, security-scan, database-integrity]
    if: always()
    steps:
      - name: Check results
        run: |
          echo "## ğŸ¯ Critical Quality Gates Results"
          echo ""
          echo "âœ… SSOTæº–æ‹ : ${{ needs.ssot-compliance.result }}"
          echo "âœ… ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£: ${{ needs.security-scan.result }}"
          echo "âœ… DBæ•´åˆæ€§: ${{ needs.database-integrity.result }}"
          
          if [ "${{ needs.ssot-compliance.result }}" != "success" ] || \
             [ "${{ needs.security-scan.result }}" != "success" ] || \
             [ "${{ needs.database-integrity.result }}" != "success" ]; then
            echo ""
            echo "âŒ Critical Gates Failed - PR cannot be merged"
            exit 1
          fi
          
          echo ""
          echo "âœ… All Critical Gates Passed!"

