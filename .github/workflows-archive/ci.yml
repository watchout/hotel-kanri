name: CI - Quality Gate

on:
  pull_request:
    branches:
      - main
      - develop
  push:
    branches:
      - main
      - develop

jobs:
  # ==========================================
  # Job: ops-policy-lintï¼ˆå¿…é ˆï¼‰
  # ==========================================
  ops-policy-lint:
    name: ops-policy-lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Validate ops policy
        run: node ops/scripts/validate-policy.js

  # ==========================================
  # Job: ssot-complianceï¼ˆå¿…é ˆï¼‰
  # ==========================================
  ssot-compliance:
    name: ssot-compliance
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Check SSOT citation and Requirement IDs in PR body
        if: github.event_name == 'pull_request'
        env:
          PR_BODY: ${{ github.event.pull_request.body }}
        run: |
          echo "Checking PR body for SSOT references and requirement IDs..."
          if ! echo "$PR_BODY" | grep -q "docs/03_ssot"; then
            echo "âŒ ã‚¨ãƒ©ãƒ¼: PRæœ¬æ–‡ã«SSOTå‚ç…§ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ (docs/03_ssot/...)" && exit 1
          fi
          if ! echo "$PR_BODY" | grep -qE "[A-Z]+-[0-9]+"; then
            echo "âŒ ã‚¨ãƒ©ãƒ¼: PRæœ¬æ–‡ã«è¦ä»¶IDï¼ˆXXX-nnnå½¢å¼ï¼‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“" && exit 1
          fi
          echo "âœ… SSOTæº–æ‹ ãƒã‚§ãƒƒã‚¯: åˆæ ¼"

  # ==========================================
  # Job: typescript-checkï¼ˆå¿…é ˆãƒ»ã“ã®ãƒªãƒã§ã¯No-Opï¼‰
  # ==========================================
  typescript-check:
    name: typescript-check
    runs-on: ubuntu-latest
    steps:
      - run: echo "No TypeScript sources to check in hotel-kanri. Skipping."

  # ==========================================
  # Job: eslintï¼ˆå¿…é ˆãƒ»ã“ã®ãƒªãƒã§ã¯No-Opï¼‰
  # ==========================================
  eslint:
    name: eslint
    runs-on: ubuntu-latest
    steps:
      - run: echo "No ESLint target in hotel-kanri. Skipping."

  # ==========================================
  # Job: unit-testsï¼ˆå¿…é ˆãƒ»ã“ã®ãƒªãƒã§ã¯No-Opï¼‰
  # ==========================================
  unit-tests:
    name: unit-tests
    runs-on: ubuntu-latest
    steps:
      - run: echo "No unit tests in hotel-kanri. Skipping."

  # ==========================================
  # Job: route-orderï¼ˆå¿…é ˆãƒ»kanriã§ã¯No-Opï¼‰
  # ==========================================
  route-order:
    name: route-order
    runs-on: ubuntu-latest
    steps:
      - run: echo "No API routes in hotel-kanri. Skipping route-order check."

  # ==========================================
  # æœ€çµ‚ã‚²ãƒ¼ãƒˆ: å…¨ã‚¸ãƒ§ãƒ–æˆåŠŸç¢ºèªï¼ˆå‚è€ƒï¼‰
  # ==========================================
  quality-gate:
    name: Quality Gate - All Checks Passed
    runs-on: ubuntu-latest
    needs:
      - ops-policy-lint
      - ssot-compliance
      - typescript-check
      - eslint
      - unit-tests
      - route-order
    steps:
      - run: |
          echo "âœ… å…¨ã¦ã®å¿…é ˆãƒã‚§ãƒƒã‚¯ãŒåˆæ ¼ã—ã¾ã—ãŸã€‚"
          echo "ğŸ‰ ãƒãƒ¼ã‚¸å¯èƒ½ãªçŠ¶æ…‹ã§ã™"
